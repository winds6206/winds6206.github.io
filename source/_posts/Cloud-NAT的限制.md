---
title: Cloud NAT的限制
tags:
  - GKE
  - GCP
  - Google Cloud Platform
  - Cloud NAT
date: 2021-05-10 22:04:32
---

## 前言

因公司產品是採用 GKE 的基礎設施，為了讓 GKE 對外有一個 static IP，所以有加上 Cloud NAT 的功能，一開始加上去並沒有什麼問題，但日子長了之後，某一天發現要再擴增 Node 時，沒有辦法順利擴增，查了好一段時間才知道，原來是 Cloud NAT 導致要擴增 Node 時沒有辦法擴增，這其實很難想像得到，因為基本上不會有理由去懷疑是 Cloud NAT 所致。

所以這邊紀錄一下遇到的問題，說不定你也正遇到跟我一樣的問題

<!--more-->

## Cloud NAT

在 Cloud NAT 的進階設定中，有一個欄位叫做「每個 VM
執行個體的最低通訊埠數量」，如果你是使用英文介面會顯示「Minimum ports per VM instance」，就是這個數值會去影響可以運行的機器數量，後來參考外國的一篇文章才了解到此設定的重要性(參考的資料放在文後)，此數值不僅會決定你所選取的 VPC 內可以使用的機器數量，還會決定你的每台機器從 NAT 出去的連線數量，以下詳細說明

### 連線量

「每個 VM 執行個體的最低通訊埠數量」所填入的數值，本質意義是在說明: 你指定的 VPC 底下的每一台機器透過 Cloud NAT 到相同目的 IP 與 port 且使用相同的通訊協定(TCP or UDP) 的連線數量。

舉例來說：預設數值為64，我的 VPC 內有三台機器，其中一台機器連線到 `TCP 1.1.1.1:1000` 此目的的數量有64條，這時此台機器要再連線此目的的連線就會被 drop 掉，導致後續的連線會異常，但是還是可以連線到「其他目的」。

> 此處的「其他目的」是指與 `TCP 1.1.1.1:1000` 不同的「目的IP」或「目的Port」或「通訊協定」

以下都是可以正常連線的目的，而且連線數是個別分開計算，這樣舉例會比較清楚

- UDP 1.1.1.1:1000
- TCP 2.2.2.2:1000
- UDP 2.2.2.2:1000
- TCP 2.2.2.2:2000
- UDP 2.2.2.2:3000

### 機器數量

再來要討論「每個 VM 執行個體的最低通訊埠數量」的數值要怎麼計算 VPC 底下可以開幾台 Node

每個 Cloud NAT 的 IP 有 65536 個連接埠分別給 TCP 與 UDP 使用，其中有 1024 個是公認通訊埠號(well-known port numbers)，所以實際可使用的連接埠為 64512(65536-1024)，如果使用 Google 給的預設數值64，那每個 NAT IP 可以支援相對應 VPC 底下高達 1008 台 Node (64512/64)，但是缺點就是可乘載的連線數量相對就比較少，如果想要擴增可乘載的機器數量，可以增加 NAT IP 來解決，如果在 Cloud NAT 放上第二組 NAT IP，此時 Node 就可以到 2016(1008*2) 那麼多。

## 參考資料

- https://medium.com/bluekiri/high-availability-nat-gateway-at-google-cloud-platform-with-cloud-nat-8a792b1c4cc4
