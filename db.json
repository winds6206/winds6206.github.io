{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"source/CNAME","path":"CNAME","modified":0,"renderable":0},{"_id":"source/google1629c45428e9c281.html","path":"google1629c45428e9c281.html","modified":0,"renderable":0},{"_id":"source/robots.txt","path":"robots.txt","modified":0,"renderable":0},{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/IMG_1598.jpg","path":"images/IMG_1598.jpg","modified":0,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/fire.png","path":"images/fire.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo-algolia-nebula-blue-full.svg","path":"images/logo-algolia-nebula-blue-full.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/js/algolia-search.js","path":"js/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/bookmark.js","path":"js/bookmark.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/local-search.js","path":"js/local-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/next-boot.js","path":"js/next-boot.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/motion.js","path":"js/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schedule.js","path":"js/schedule.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schemes/muse.js","path":"js/schemes/muse.js","modified":0,"renderable":1}],"Cache":[{"_id":"source/CNAME","hash":"0ac7d8db9d0ada5af098b6d9b746febb0b250df7","modified":1725866222640},{"_id":"source/robots.txt","hash":"0f803b6a44be5dfede03241dd039c32db4cbc130","modified":1725866222672},{"_id":"source/google1629c45428e9c281.html","hash":"89a43015d373e502e603183c576bc7029317103c","modified":1725866222672},{"_id":"source/about/index.md","hash":"0483c09e1bb413a6bc91e15fd8e3ba9a2d584978","modified":1725866222672},{"_id":"source/_data/post-body-end.njk","hash":"6c5186b77c4f99b5693c2affad4a02fb768d94e2","modified":1725866222640},{"_id":"source/_data/sidebar.njk","hash":"2be753db9e151a66903d27ff824e3a9cb789cad7","modified":1725866222640},{"_id":"source/_data/styles.styl","hash":"79ca0c069992d74201b1c592dad2292cc06408c6","modified":1725866222641},{"_id":"source/categories/index.md","hash":"689b642708b3a1925e0dce626073095e563fc746","modified":1725866222672},{"_id":"source/_drafts/cert-manager-in-kubernetes.md","hash":"1c7de769c5ddf99923e1b95d1124d069804aa28f","modified":1725866222642},{"_id":"source/_drafts/cloud-sql-proxy-in-docker.md","hash":"51aa59a088944adb6410444a85f33d4824efc4cb","modified":1725866222642},{"_id":"source/_drafts/GitHub-Pages自訂域名.md","hash":"5230d35d77229bf1afc743ee306bb9d8976c1740","modified":1725866222641},{"_id":"source/_drafts/hexo-filter-nofollow.md","hash":"f0f5588643b152f4f629067b050340c076cf49a8","modified":1725866222643},{"_id":"source/_drafts/max-execution-time-vs-request-terminate-timeout.md","hash":"b380d224eee47aef6b235898afeac0a021c2179c","modified":1725866222643},{"_id":"source/_drafts/homebrew-shallow-clone.md","hash":"666b18af2d59e7cdfc8d10c26e764f8910680210","modified":1725866222643},{"_id":"source/_drafts/stakater-reloader.md","hash":"4a987db8227db1d7df4b132e94544fa219b0873b","modified":1725866222644},{"_id":"source/_drafts/什麼是HSTS.md","hash":"02d6c36a063f1f76be4075dd0c3dbf69814caad4","modified":1725866222644},{"_id":"source/_drafts/如何自簽憑證.md","hash":"6e2435b24b33ffb9881d7ba60007d3d589a48293","modified":1725866222647},{"_id":"source/tags/index.md","hash":"abf434f92fafa0a5164379705beaf6ad697b995d","modified":1725866222673},{"_id":"source/_posts/auto-completion-case-insensitive.md","hash":"ab3cdd224fa497ba3c837edac4958e10ea8a3bc8","modified":1725866222648},{"_id":"source/_posts/ftp-in-kubernetes.md","hash":"d9e907442b6ec4b4e3f0c1eca6e590fafb39dde1","modified":1725866222649},{"_id":"source/_posts/cloud-NAT-limit.md","hash":"2b195079274a48a074496a346e05dbf22eaee277","modified":1725866222648},{"_id":"source/_posts/cloud-sql-auth-proxy.md","hash":"16c188654996e7e414db24b11ccb649443c8edf2","modified":1725866222649},{"_id":"source/_posts/github-pages.md","hash":"6e43e23277ed8a2ce2cf15f03ff55e3b509fd150","modified":1725866222655},{"_id":"source/_posts/gke-workload-identity.md","hash":"d3c11db805fc5851429609e0923ef1bced9e0672","modified":1725866222658},{"_id":"source/_posts/hexo-Disqus-feature.md","hash":"b5f1502aa262d9d5f6dbdd0b18aab4dbdb802765","modified":1725866222660},{"_id":"source/_posts/hexo-about-me.md","hash":"24d81181152975e59e90a6e856d6acf7bc5665a5","modified":1725866222663},{"_id":"source/_posts/hexo-abbrlink.md","hash":"d526759552658ae9a61a842818e50f842799db00","modified":1725866222663},{"_id":"source/_posts/hexo-categories.md","hash":"5fcbcc14f37b7339933fb0d1e16dde2320373b69","modified":1725866222663},{"_id":"source/_posts/hexo-insert-picture.md","hash":"3ebbb4961fa9315a36bb548833f64c1dec03da76","modified":1725866222664},{"_id":"source/_posts/hexo-new-draft.md","hash":"e18d5b8c9fa23cac5c86bdc7c208f4cee83e5a4c","modified":1725866222664},{"_id":"source/_posts/htpasswd.md","hash":"fe14a0dffc96549f62bc9d2e64114ceb7f102c2a","modified":1725866222664},{"_id":"source/_posts/hexo-tag.md","hash":"82cf4b425f1b48666604e6a60c3958696547baad","modified":1725866222664},{"_id":"source/_posts/kubernetes-network-policy.md","hash":"dd8238623fad8fbd69b65c29204a3b416733057f","modified":1725866222665},{"_id":"source/_posts/php-fpm-process-optimize.md","hash":"ac5d548b54fd5ba714e4f756f4e49daefb6b32bc","modified":1725866222665},{"_id":"source/_posts/php-fpm-upload-size.md","hash":"974a624fcb706c4541bbb8f17c152f020012469e","modified":1725866222665},{"_id":"source/_posts/ssh-connect-alert.md","hash":"0d8b2581d399c3fbec3a547b08dcdc67d94fad1a","modified":1725866222666},{"_id":"source/_posts/tcp-ip-time-wait.md","hash":"0dc3fb947dda11ec2cec9d2e383ddcfed364d8bf","modified":1725866222666},{"_id":"source/_drafts/什麼是HSTS/HSTS-0.png","hash":"85658a5c02341e7105919282ddfcdddc5de06d76","modified":1725866222645},{"_id":"source/_drafts/什麼是HSTS/HSTS-1.png","hash":"48e61166b402fb57ee005d386065b38469233266","modified":1725866222646},{"_id":"source/_drafts/什麼是HSTS/HSTS-2.png","hash":"e6d7cef853fb41cdaf4cfa169dd521590a9eaa78","modified":1725866222646},{"_id":"source/_drafts/什麼是HSTS/HSTS-3.png","hash":"6f1b3e315ce7ee03ec950f16a8352c6cec48699e","modified":1725866222647},{"_id":"source/_posts/ftp-in-kubernetes/mk-20240119114239.png","hash":"31bf014900c3ff0edde5447a39100b950ea13586","modified":1725866222653},{"_id":"source/_posts/ftp-in-kubernetes/mk-20240119114218.png","hash":"1c65b1dbebc6e892233b7c9eacd1dc75e8c45c06","modified":1725866222653},{"_id":"source/_posts/ftp-in-kubernetes/mk-20240119114300.png","hash":"f6702d4ca40801f955ccc747cad286a91d51cb7a","modified":1725866222654},{"_id":"source/_posts/tcp-ip-time-wait/mk-20240119120730.png","hash":"f7ae96036a7181cb54976e3191994ad54621b63b","modified":1725866222667},{"_id":"source/_posts/tcp-ip-time-wait/mk-20240119120856.png","hash":"969a04586b1308580341536e5aab8d514ccdbddf","modified":1725866222669},{"_id":"source/_posts/ftp-in-kubernetes/mk-20240119114200.png","hash":"a1aab3c4852f1b58ba54a80b59f76015d4bba23b","modified":1725866222652},{"_id":"source/_posts/gke-workload-identity/mk-20240118163311.png","hash":"e0070bc93a225be44a5c6b9f1faabb447c72eb67","modified":1725866222660},{"_id":"source/_posts/tcp-ip-time-wait/mk-20240119120822.png","hash":"95b3f1405908b5bfbfe767546b1381c4e989a375","modified":1725866222669},{"_id":"source/_posts/tcp-ip-time-wait/mk-20240119120657.png","hash":"e2aa58ca97d2b2f57ee441a6a0d05e7fc2076396","modified":1725866222667},{"_id":"source/_posts/hexo-Disqus-feature/mk-20240119114707.png","hash":"3669191fae8af4b81c6b7cafc1fa4143d136a20d","modified":1725866222662},{"_id":"source/_posts/tcp-ip-time-wait/mk-20240119120922.png","hash":"862ba77b07f5a6c370bec716b00077351496bbf2","modified":1725866222671},{"_id":"source/_posts/ftp-in-kubernetes/mk-20240119114134.png","hash":"fe2467190f00c1f2ef636bd7164c27811d8f32b1","modified":1725866222651},{"_id":"source/_posts/github-pages/mk-20240119120313.png","hash":"4d1131c702239e063d6eef7d08d546c99624dab7","modified":1725866222657},{"_id":"themes/next/.gitignore","hash":"4600f2b61b2fe0d61f824bda9aa2b5d072f0e635","modified":1725866222681},{"_id":"themes/next/.eslintrc.json","hash":"9c0762486f24a8c5e60f8b6c875e4c4728942649","modified":1725866222674},{"_id":"themes/next/.gitattributes","hash":"ec43734985e1cafd53d88ded3020103f7416123c","modified":1725866222674},{"_id":"themes/next/README.md","hash":"de109b73e09826f6bccceae60c618739a794f8f7","modified":1725866222682},{"_id":"themes/next/_vendors.yml","hash":"ba1a58b2ab243f56c9e78e2dd764a8935580ca3a","modified":1725866222683},{"_id":"themes/next/package.json","hash":"4f5f0137b27ef341f182a3dd9897b332480452c0","modified":1725866222722},{"_id":"themes/next/.editorconfig","hash":"8570735a8d8d034a3a175afd1dd40b39140b3e6a","modified":1725866222674},{"_id":"themes/next/renovate.json","hash":"cb29cc16e61b0b8a6dac34657d76822ae29ad5aa","modified":1725866222722},{"_id":"themes/next/.stylintrc","hash":"2cf4d637b56d8eb423f59656a11f6403aa90f550","modified":1725866222682},{"_id":"themes/next/LICENSE.md","hash":"68fc9a03d50fd4b5ea97092b05967d1819dea2c4","modified":1725866222682},{"_id":"themes/next/_config.yml","hash":"00d7df14446e491e13712c609e163410124302c1","modified":1725866222682},{"_id":"themes/next/.githooks/pre-commit","hash":"f473eac1aaaa96c947d67988bbed140bbab1a821","modified":1725866222675},{"_id":"themes/next/.githooks/install.js","hash":"4d77dbddf2eac1f3fc78f151d12ed22208ed655b","modified":1725866222674},{"_id":"themes/next/crowdin.yml","hash":"e026078448c77dcdd9ef50256bb6635a8f83dca6","modified":1725866222683},{"_id":"themes/next/.github/CODE_OF_CONDUCT.md","hash":"21cbff565a0445d3a880fff1ee417e309740a9ab","modified":1725866222675},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"eefd073dfb68884cd946f7ec6d3b3619031d7650","modified":1725866222676},{"_id":"themes/next/.github/PULL_REQUEST_TEMPLATE.md","hash":"3e9fbb78e3dee0ca1dc886d0c28b0148ba0ca499","modified":1725866222678},{"_id":"themes/next/.github/issue_label_bot.yaml","hash":"fca600ddef6f80c5e61aeed21722d191e5606e5b","modified":1725866222678},{"_id":"themes/next/.github/config.yml","hash":"7984e665e9de481a0e0e51fca5668337713f810b","modified":1725866222678},{"_id":"themes/next/.github/label-commenter-config.yml","hash":"1097fc47beeacfc1edb0248c27b17bf64bde3565","modified":1725866222678},{"_id":"themes/next/.github/labeler.yml","hash":"e7033752b1f7c35adb61c2b38aad0a9202cdd19b","modified":1725866222679},{"_id":"themes/next/languages/README.md","hash":"b2567e32805dda79601157351a07e5ca9fe01315","modified":1725866222686},{"_id":"themes/next/.github/release-drafter.yml","hash":"7662e31224a24154c4fe06b95ccbdff51ab8f2cc","modified":1725866222679},{"_id":"themes/next/languages/de.yml","hash":"4be7b8b76c81bf1853eb36d2e874b17546a0e792","modified":1725866222687},{"_id":"themes/next/languages/en.yml","hash":"814d81c27fed736055ee300e0a6505b26ff4313c","modified":1725866222687},{"_id":"themes/next/languages/default.yml","hash":"814d81c27fed736055ee300e0a6505b26ff4313c","modified":1725866222687},{"_id":"themes/next/languages/ar.yml","hash":"bca66db21c015dbd32970d8708b898518a773e1e","modified":1725866222686},{"_id":"themes/next/languages/es.yml","hash":"651e3b33d86a7cdb9fd7895ca28279f8b1a24faa","modified":1725866222687},{"_id":"themes/next/languages/fr.yml","hash":"b15dc05afdc94de02e5d3fee4f8d3dc5594dd37e","modified":1725866222688},{"_id":"themes/next/languages/fa.yml","hash":"6456d40dd42f44101d9d6e7054e9884e9163f948","modified":1725866222687},{"_id":"themes/next/languages/it.yml","hash":"c1eeab4992c76bfd436bb205ce58b1cfeef55ee6","modified":1725866222688},{"_id":"themes/next/languages/id.yml","hash":"14e794db4eca36b257994d81eb513e61d1edcbd6","modified":1725866222688},{"_id":"themes/next/languages/ko.yml","hash":"6387357ac2dd498e8b8d630d27050a59180d7e8f","modified":1725866222689},{"_id":"themes/next/languages/ja.yml","hash":"d48c4157e0e02e847aac7b513580d3364c81948c","modified":1725866222688},{"_id":"themes/next/languages/nl.yml","hash":"ecb8e39c6225f3c068a5fdd569ee7dafd5c41a1f","modified":1725866222689},{"_id":"themes/next/languages/pt.yml","hash":"63a3e1e728ba5e6e22150de7331bb8a654f34960","modified":1725866222689},{"_id":"themes/next/languages/pt-BR.yml","hash":"a1f27b3a592fc58f17d247f5563ff4a90a3da5f2","modified":1725866222689},{"_id":"themes/next/languages/ru.yml","hash":"e9af1afe529ca747a04b801401d394b2ad696fde","modified":1725866222689},{"_id":"themes/next/languages/tr.yml","hash":"55b38c7617c24bdc27c9de6cf39f4b191d154fb8","modified":1725866222690},{"_id":"themes/next/languages/si.yml","hash":"2a9861db4547a524b2609c1e7e1061d2e9d48ee4","modified":1725866222690},{"_id":"themes/next/languages/vi.yml","hash":"c669c34da544a563ceae3e196addc9df6a78e024","modified":1725866222691},{"_id":"themes/next/languages/uk.yml","hash":"7dd24580c0865c5a7bc4d391855045366a598936","modified":1725866222690},{"_id":"themes/next/languages/zh-HK.yml","hash":"59a3649f304ab3cab02cb1cc8c80c91860f53f3a","modified":1725866222691},{"_id":"themes/next/layout/_layout.njk","hash":"6915e19058b4b4e2b71707cb5ac6c936ef075e89","modified":1725866222692},{"_id":"themes/next/languages/zh-CN.yml","hash":"5a3ab21210304efef736e96bad254f789f42c567","modified":1725866222691},{"_id":"themes/next/languages/zh-TW.yml","hash":"b363ee4d02c87d2df1772d64e6d495edaa7e6d6b","modified":1725866222691},{"_id":"themes/next/layout/category.njk","hash":"0a590e87af50e57b15fc37695c9a3bf4a97c3d92","modified":1725866222721},{"_id":"themes/next/layout/archive.njk","hash":"d759f4d2cf5ddc6875ea250113a00662c1caf6d1","modified":1725866222721},{"_id":"themes/next/layout/index.njk","hash":"37ec3d1bcd20b8ac1d18e0d68f990450890b46cd","modified":1725866222721},{"_id":"themes/next/layout/page.njk","hash":"9cd3eca2c468bb46c7c5bf391bea4b025af178f6","modified":1725866222722},{"_id":"themes/next/layout/post.njk","hash":"6abeb85fb3e4c382ed4bb6049b12a807e6226e67","modified":1725866222722},{"_id":"themes/next/layout/tag.njk","hash":"6cd707f846bfd6becbcfb060c26958bb4015c31f","modified":1725866222722},{"_id":"themes/next/docs/LICENSE.txt","hash":"f5b14f791b7cfa1d16da981d929152e088a5d1b8","modified":1725866222684},{"_id":"themes/next/.github/ISSUE_TEMPLATE/bug-report.md","hash":"fc4dce84ed9a5d21d3a8833ff6d776c46f876115","modified":1725866222676},{"_id":"themes/next/docs/AUTHORS.md","hash":"a648823121563c34a177ae91f5a774b5e29f01a0","modified":1725866222684},{"_id":"themes/next/test/index.js","hash":"6bf0289846538be3e9a63809af98f00e1fbdd90b","modified":1725866222782},{"_id":"themes/next/docs/AGPL3.md","hash":"0d2b8c5fa8a614723be0767cc3bca39c49578036","modified":1725866222684},{"_id":"themes/next/.github/ISSUE_TEMPLATE/config.yml","hash":"c40ae7903b6cc99f94c9d45ac7ba8c2850bb1309","modified":1725866222677},{"_id":"themes/next/.github/workflows/labeler.yml","hash":"8b73c439dc796be141d521a4546bcfb7a5485534","modified":1725866222680},{"_id":"themes/next/.github/ISSUE_TEMPLATE/feature-request.md","hash":"4ecac91716eac59d7c2bc53cf6e95612d44da97b","modified":1725866222677},{"_id":"themes/next/.github/ISSUE_TEMPLATE/other.md","hash":"8cc5b5c116f6a052865a324512362f145d699202","modified":1725866222677},{"_id":"themes/next/.github/workflows/label-commenter.yml","hash":"44405477660289d4ed9beba1d054b15bb67bba06","modified":1725866222680},{"_id":"themes/next/.github/workflows/linter.yml","hash":"a3019edd2185c4c287a682fdd76043e107ed927b","modified":1725866222680},{"_id":"themes/next/.github/workflows/release-drafter.yml","hash":"4f3af81009cb922be91f718a67425377515ea69d","modified":1725866222681},{"_id":"themes/next/.github/workflows/stale.yml","hash":"e1d9cc9addc35cfb53f971f14d9d04065c941df0","modified":1725866222681},{"_id":"themes/next/.github/workflows/lock.yml","hash":"70bd0be3f33774e4b0ada3a59c901f8f9cff1013","modified":1725866222680},{"_id":"themes/next/.github/workflows/tester.yml","hash":"22aaaa3eba1a7ebcf0f78417fd9a7113ee7b6c6c","modified":1725866222681},{"_id":"themes/next/layout/_macro/sidebar.njk","hash":"eb786e8b35e354287cda345c524cd35ec955f692","modified":1725866222693},{"_id":"themes/next/layout/_macro/post-collapse.njk","hash":"1a30d751871dabfa80940042ddb1f77d07d830b9","modified":1725866222692},{"_id":"themes/next/layout/_macro/post.njk","hash":"b92d6c77d4b349c5d56fb8e0a44b578c194ef466","modified":1725866222693},{"_id":"themes/next/layout/_scripts/pjax.njk","hash":"28a3bcb1ce50924a5a48b0f3756ac3a8736867f1","modified":1725866222707},{"_id":"themes/next/layout/_scripts/noscript.njk","hash":"4f250d0bf80be06dd2c95c1d4c2ba2624b59cf2a","modified":1725866222707},{"_id":"themes/next/layout/_scripts/index.njk","hash":"6f0433940680c0f9db37542ca36f76e4bb1c1d50","modified":1725866222707},{"_id":"themes/next/layout/_scripts/vendors.njk","hash":"bada07da2a47ed6de6081796367b19dd9e906cfb","modified":1725866222708},{"_id":"themes/next/layout/_partials/comments.njk","hash":"334e8d8117a46c8c097788811322a62627952219","modified":1725866222694},{"_id":"themes/next/layout/_partials/footer.njk","hash":"d16fdaf94d66efc0242b0c26ed539017e3b4f795","modified":1725866222694},{"_id":"themes/next/layout/_partials/languages.njk","hash":"e43f22198cccb5f6e306b1ce0d28d12a4fb891f8","modified":1725866222698},{"_id":"themes/next/layout/_partials/pagination.njk","hash":"9876dbfc15713c7a47d4bcaa301f4757bd978269","modified":1725866222700},{"_id":"themes/next/layout/_partials/widgets.njk","hash":"852a750524decf1efa587cd52b09e387ed8315de","modified":1725866222706},{"_id":"themes/next/layout/_third-party/nprogress.njk","hash":"271139c3896a6d294f46f767cb21b2e848050841","modified":1725866222716},{"_id":"themes/next/scripts/events/index.js","hash":"89091bc943cd8b8c63b8af3d26fb0a027048e9ba","modified":1725866222723},{"_id":"themes/next/scripts/filters/locals.js","hash":"374c9211b3b6a5b2ad31f1bea69a22f2727f633a","modified":1725866222728},{"_id":"themes/next/scripts/filters/default-injects.js","hash":"872f01cb10e422a648ea505436532e776e92926b","modified":1725866222728},{"_id":"themes/next/scripts/filters/minify.js","hash":"be0574c64a38210e449c99d38a760452015060a3","modified":1725866222729},{"_id":"themes/next/scripts/helpers/engine.js","hash":"0208f17281a1afe3da1298dd52350eb838098349","modified":1725866222729},{"_id":"themes/next/scripts/filters/post.js","hash":"42a9b81c5449afa9d67770604478168333c93804","modified":1725866222729},{"_id":"themes/next/layout/_third-party/index.njk","hash":"467b45a4912369bcba77908151e76a3f3ad0fed2","modified":1725866222715},{"_id":"themes/next/scripts/helpers/font.js","hash":"3394185a7f0393c16ce52c8028f90da3e9239c55","modified":1725866222730},{"_id":"themes/next/scripts/helpers/next-config.js","hash":"413c51fa3caa87fe95d1d8f95e6023f096515632","modified":1725866222730},{"_id":"themes/next/scripts/helpers/next-url.js","hash":"577c510374cf9bcfa8d3a1027e42411a9324805e","modified":1725866222730},{"_id":"themes/next/scripts/helpers/next-vendors.js","hash":"afdd6a188a74c188f0dd154fac70efd4080ca262","modified":1725866222730},{"_id":"themes/next/scripts/tags/button.js","hash":"c6ad2ed544fbb25ecb5d820c36e76302504271b7","modified":1725866222731},{"_id":"themes/next/scripts/tags/index.js","hash":"17f9451ce1f10f78437f52218757d38d4e1591b0","modified":1725866222732},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"92c19d796bdb3320df9caea59bf52df7a95d9da9","modified":1725866222731},{"_id":"themes/next/scripts/tags/caniuse.js","hash":"935a311142a409c1896b3ae3f01fe7a9e2db1134","modified":1725866222731},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"79102d9e9bccff6224e77a77c4d2d363094ae3df","modified":1725866222732},{"_id":"themes/next/layout/_third-party/quicklink.njk","hash":"294b7f6a4fa566e369d8be0ce7b28f35b6c14563","modified":1725866222717},{"_id":"themes/next/scripts/tags/mermaid.js","hash":"4fb01ca650fa8b256b8d48f50dc1b18350bd3d6d","modified":1725866222732},{"_id":"themes/next/scripts/tags/link-grid.js","hash":"9e2c58d1a4d1dd84fa86144e5b4576b2fd10a37f","modified":1725866222732},{"_id":"themes/next/layout/_third-party/rating.njk","hash":"2731e262a6b88eaee2a3ca61e6a3583a7f594702","modified":1725866222717},{"_id":"themes/next/scripts/tags/label.js","hash":"8a73348186113bae0a51ea2f891c1bb882fab05a","modified":1725866222732},{"_id":"themes/next/scripts/tags/tabs.js","hash":"2bf00d56b3b289a7dd27e9b5820430a2457a19f3","modified":1725866222733},{"_id":"themes/next/scripts/tags/video.js","hash":"2ee926448583be8f95af1f2884ae2c9c4830151d","modified":1725866222733},{"_id":"themes/next/scripts/tags/pdf.js","hash":"344636b6fd7e27e8831c1e194039afc0d61931cd","modified":1725866222733},{"_id":"themes/next/scripts/tags/note.js","hash":"7b94ddb46b7d4b0fe815f2fbe4bd375f07f55363","modified":1725866222733},{"_id":"themes/next/source/css/_colors.styl","hash":"b37f9847d2f95632e911df670b51921a7d748068","modified":1725866222734},{"_id":"themes/next/source/css/main.styl","hash":"78ce791cc4ac95386cf6839ca72f5f7b51f86ee9","modified":1725866222768},{"_id":"themes/next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1725866222772},{"_id":"themes/next/source/css/_mixins.styl","hash":"8b0c0353d360b984d285860697b2ccbec78da462","modified":1725866222758},{"_id":"themes/next/source/images/avatar.gif","hash":"18c53e15eb0c84b139995f9334ed8522b40aeaf6","modified":1725866222772},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1725866222774},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1725866222774},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1725866222773},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1725866222775},{"_id":"themes/next/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1725866222775},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1725866222775},{"_id":"themes/next/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1725866222776},{"_id":"themes/next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1725866222776},{"_id":"themes/next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1725866222776},{"_id":"themes/next/source/images/logo-algolia-nebula-blue-full.svg","hash":"b85e274207b1392782476a0430feac98db1e7da0","modified":1725866222778},{"_id":"themes/next/source/js/algolia-search.js","hash":"a360423984cdd915d04365c51bcab440e52d7223","modified":1725866222778},{"_id":"themes/next/source/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1725866222778},{"_id":"themes/next/source/js/bookmark.js","hash":"e45e1fbb7c6d645e9c410759486216e570d02bef","modified":1725866222779},{"_id":"themes/next/source/js/local-search.js","hash":"da2051e7cab184ae4aa64457c5db7476b4645fdc","modified":1725866222779},{"_id":"themes/next/source/js/next-boot.js","hash":"873e52a851a6ce8dc61b870fa7083da4d2304b7b","modified":1725866222779},{"_id":"themes/next/test/helpers/font.js","hash":"342ef3c6fd2dcca2a8802a516ed6d7f389fd2ca2","modified":1725866222781},{"_id":"themes/next/source/js/motion.js","hash":"6d4bd07a6f8e1b4083119dca0acb5b289533b619","modified":1725866222779},{"_id":"themes/next/source/js/schedule.js","hash":"71d62fc3584c47ff2d4cc945226e412264399be9","modified":1725866222780},{"_id":"themes/next/test/helpers/index.js","hash":"63ba28afed697f7b3574436b1133b8ecc9c0c357","modified":1725866222781},{"_id":"themes/next/test/helpers/next-url.js","hash":"abc4ee5149df6172b2c36b6e85d1993ec748ddea","modified":1725866222782},{"_id":"themes/next/test/tags/caniuse.js","hash":"aa5e728445caeaf7c2ccd0f3fcb2cad0c93ca6d1","modified":1725866222783},{"_id":"themes/next/test/tags/button.js","hash":"48f2aa4c513e9e24bd6a811410520b74cd7ea88b","modified":1725866222782},{"_id":"themes/next/test/tags/center-quote.js","hash":"7667342fd1a1417eaf6a254012b84ae40e8d13dd","modified":1725866222783},{"_id":"themes/next/test/tags/group-pictures.js","hash":"f41640e5d0f552c0b0c4ac8876a2edb0fcf54e56","modified":1725866222783},{"_id":"themes/next/source/js/utils.js","hash":"42ef4f2c0c61aac8fbddd9534f5f86d83dc09c43","modified":1725866222780},{"_id":"themes/next/test/tags/index.js","hash":"e8779e54f0979b221858f8bb74dd081bb503b910","modified":1725866222784},{"_id":"themes/next/test/tags/label.js","hash":"4ebf3698c258ca978b997acbdd0dece44069c09d","modified":1725866222784},{"_id":"themes/next/test/tags/link-grid.js","hash":"88ec69e4dc1d493d21254ed9296a2514e91f0f8b","modified":1725866222784},{"_id":"themes/next/test/tags/mermaid.js","hash":"ab77be5f3c6d9a57c7b9dda6decf1906a736fef9","modified":1725866222785},{"_id":"themes/next/test/tags/note.js","hash":"3dcfcd65bf9f326972ea7571fdb1444200f5d07e","modified":1725866222785},{"_id":"themes/next/test/tags/pdf.js","hash":"fd6ea5123560a90f7e7c1eface23dbe1455db25f","modified":1725866222786},{"_id":"themes/next/test/tags/tabs.js","hash":"d63722919f9da2e44d6b952801e10a2915ea9c12","modified":1725866222786},{"_id":"themes/next/test/tags/video.js","hash":"b796fc4dceb20a30e730c322bb5474c0162464cc","modified":1725866222786},{"_id":"themes/next/test/validate/index.js","hash":"5a95ccc8598667535bd022e988055c0e019f3670","modified":1725866222787},{"_id":"themes/next/docs/zh-CN/CONTRIBUTING.md","hash":"8ee5ca39ac4a372a5c0f16e344bbe578af4aeae4","modified":1725866222685},{"_id":"themes/next/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"7a06d443f374bd1e84294067a0ac796afd9fbe60","modified":1725866222685},{"_id":"themes/next/docs/ru/README.md","hash":"63df0665005063108e1bc19df3cf8c4e46facb95","modified":1725866222685},{"_id":"themes/next/layout/_partials/head/head-unique.njk","hash":"37bdf020591feb0cf72327c9efd755bf78a0afd6","modified":1725866222695},{"_id":"themes/next/layout/_partials/header/brand.njk","hash":"ffb6c69a9c90793cbe9bf0544b55f7a41c016d8f","modified":1725866222696},{"_id":"themes/next/layout/_partials/head/head.njk","hash":"8f6521714044676e15d924da387b2aef45fc8fe6","modified":1725866222695},{"_id":"themes/next/docs/zh-CN/README.md","hash":"9abd8473985f2bf1557b1aac31b436c92d5450a7","modified":1725866222686},{"_id":"themes/next/layout/_partials/header/menu-item.njk","hash":"b46f412c0b4f775fd329d50357f722f5d7c1a3ba","modified":1725866222697},{"_id":"themes/next/layout/_partials/header/menu.njk","hash":"c9390824b57f23b7c8a5c23a9834514123673766","modified":1725866222697},{"_id":"themes/next/layout/_partials/header/sub-menu.njk","hash":"75a158a5b54a3a76ee6590f5e0e2dd4a9f0be869","modified":1725866222697},{"_id":"themes/next/layout/_partials/header/index.njk","hash":"53895b3af95667edc5bf5d7356f8a2b4fe091447","modified":1725866222696},{"_id":"themes/next/layout/_partials/post/post-followme.njk","hash":"154df0bb323c332d8c25343f258ee865e5553423","modified":1725866222701},{"_id":"themes/next/layout/_partials/post/post-copyright.njk","hash":"133942922e34abae9e4de7ea5591d77c0caa4b37","modified":1725866222700},{"_id":"themes/next/layout/_partials/post/post-footer.njk","hash":"8f14f3f8a1b2998d5114cc56b680fb5c419a6b07","modified":1725866222701},{"_id":"themes/next/layout/_partials/post/post-related.njk","hash":"f79c44692451db26efce704813f7a8872b7e63a0","modified":1725866222703},{"_id":"themes/next/layout/_partials/post/post-reward.njk","hash":"a9bb52d0537d27cfe670d80e716da6780786ab8a","modified":1725866222704},{"_id":"themes/next/layout/_partials/page/page-header.njk","hash":"7ed4f102a1825195cff8d7995bf9219f323a9034","modified":1725866222699},{"_id":"themes/next/layout/_partials/post/post-meta.njk","hash":"1410fad73e0a08a45166e4a055ba150fd06e8636","modified":1725866222703},{"_id":"themes/next/layout/_partials/page/breadcrumb.njk","hash":"edb3bb6d644b7407673c5ef3a426a244e98fcf89","modified":1725866222698},{"_id":"themes/next/layout/_partials/page/categories.njk","hash":"17156d99941f28a225951ffdcfa9a115e20dc2d2","modified":1725866222698},{"_id":"themes/next/layout/_partials/search/algolia-search.njk","hash":"efb2b6f19df02ba5ae623a1f274fff52aed21e6f","modified":1725866222704},{"_id":"themes/next/layout/_partials/page/schedule.njk","hash":"9d650333160ad1977fe42d9770869ff1660a95fe","modified":1725866222699},{"_id":"themes/next/layout/_partials/page/tags.njk","hash":"a18d1598e36cc72f2b0b24c3cc3c5990dfaa3254","modified":1725866222699},{"_id":"themes/next/layout/_partials/search/localsearch.njk","hash":"661f7acae43f0be694266323320f977d84119abe","modified":1725866222705},{"_id":"themes/next/layout/_partials/search/index.njk","hash":"8f6f256ab3b351ffc80f1f3f1d9834e9a7cfac31","modified":1725866222705},{"_id":"themes/next/layout/_third-party/analytics/cloudflare.njk","hash":"c978e9efd472c4825f93b83524b11f1c4f7efaab","modified":1725866222709},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.njk","hash":"4790058691b7d36cf6d2d6b4e93795a7b8d608ad","modified":1725866222709},{"_id":"themes/next/layout/_third-party/analytics/index.njk","hash":"2d36a481a70d5f450f1f166dc556ac1218b18537","modified":1725866222710},{"_id":"themes/next/layout/_partials/sidebar/site-overview.njk","hash":"c419158e19805e2db614a5f5651e3e534e4a5e4e","modified":1725866222706},{"_id":"themes/next/layout/_third-party/analytics/growingio.njk","hash":"5adea065641e8c55994dd2328ddae53215604928","modified":1725866222710},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.njk","hash":"ad197fd728dd7ac90f910fdf80ce848eab3ff187","modified":1725866222710},{"_id":"themes/next/layout/_third-party/chat/chatra.njk","hash":"f910618292c63871ca2e6c6e66c491f344fa7b1f","modified":1725866222711},{"_id":"themes/next/layout/_third-party/comments/changyan.njk","hash":"5c2cd9b6f02bcb6248d3f18638a58e329fe8c0d1","modified":1725866222712},{"_id":"themes/next/layout/_third-party/comments/disqusjs.njk","hash":"54eab4840443262432ec7c47e56e9859ace2a902","modified":1725866222713},{"_id":"themes/next/layout/_third-party/chat/tidio.njk","hash":"cba0e6e0fad08568a9e74ba9a5bee5341cfc04c1","modified":1725866222711},{"_id":"themes/next/layout/_third-party/comments/disqus.njk","hash":"cc1450d62d76e59968bdd25836694b8339207384","modified":1725866222713},{"_id":"themes/next/layout/_third-party/comments/gitalk.njk","hash":"089e05126e7e4033eff90a26f946c419f2a1e87a","modified":1725866222713},{"_id":"themes/next/layout/_third-party/comments/isso.njk","hash":"c1bf0753fc4bc5f21d61eaffbcc915a462c7d830","modified":1725866222714},{"_id":"themes/next/layout/_third-party/comments/livere.njk","hash":"6252b0353c6a36d03c68ebec1073293442221bd1","modified":1725866222714},{"_id":"themes/next/layout/_third-party/comments/utterances.njk","hash":"7a07bbfb09ddf70b919f0ebe1b00942c96152389","modified":1725866222714},{"_id":"themes/next/layout/_third-party/math/index.njk","hash":"47a982aec8830c2f9711b2aff59ff83f09deb09e","modified":1725866222715},{"_id":"themes/next/layout/_third-party/math/mathjax.njk","hash":"f4fd63b9f9230dadd1190f79d59313751925ed90","modified":1725866222716},{"_id":"themes/next/layout/_third-party/math/katex.njk","hash":"b6746dfad32cc8a46ff8f4194a7a16ca41744803","modified":1725866222716},{"_id":"themes/next/layout/_third-party/statistics/firestore.njk","hash":"0ff61346dc1327054ea2c211ba6fb654cdcdfd8d","modified":1725866222719},{"_id":"themes/next/layout/_third-party/statistics/busuanzi-counter.njk","hash":"a4bc501da0f22f7e420f0ca47e83988ce90b1368","modified":1725866222718},{"_id":"themes/next/layout/_third-party/statistics/lean-analytics.njk","hash":"811a3ad58c0a15550100bdc199bef8add1ad526c","modified":1725866222720},{"_id":"themes/next/layout/_third-party/statistics/index.njk","hash":"568ddf7955d11d93fb5e842b403a7ac8b1b7fdb1","modified":1725866222719},{"_id":"themes/next/scripts/events/lib/config.js","hash":"09b58494e9d9d25542d1d218f2d0ffc4d2da9f30","modified":1725866222723},{"_id":"themes/next/layout/_third-party/search/algolia-search.njk","hash":"97035261aa85c7d39c6ce1211cdefc6248c0446d","modified":1725866222717},{"_id":"themes/next/scripts/events/lib/highlight.js","hash":"6aec7b2c38c50989a23bfaa0d560e75c7f553e12","modified":1725866222724},{"_id":"themes/next/scripts/events/lib/injects.js","hash":"7b0ea8d28ced63977dc6539920eb044b1098adcb","modified":1725866222724},{"_id":"themes/next/scripts/events/lib/utils.js","hash":"b281be775b693f9bf32766c8f6ef703c72ac9b00","modified":1725866222724},{"_id":"themes/next/scripts/events/lib/vendors.js","hash":"d1ecc44f9f6e236bf910e36150767d36be4658b2","modified":1725866222724},{"_id":"themes/next/scripts/filters/comment/changyan.js","hash":"ecc93ba67af26b6715fc75001fa0c3131b726241","modified":1725866222725},{"_id":"themes/next/scripts/filters/comment/common.js","hash":"2486f3e0150c753e5f3af1a3665d074704b8ee2c","modified":1725866222725},{"_id":"themes/next/scripts/filters/comment/default-config.js","hash":"93ee5f9109dad885dc38c49bcee630c10f9dce6e","modified":1725866222725},{"_id":"themes/next/layout/_third-party/tags/mermaid.njk","hash":"0222d958b98afcf5949522e20fd15f8ca4de20e6","modified":1725866222720},{"_id":"themes/next/layout/_third-party/tags/pdf.njk","hash":"b6241ebbb091ef18b3d06cba08ac2e04e3f67a7d","modified":1725866222720},{"_id":"themes/next/scripts/filters/comment/disqus.js","hash":"cc1e2d5921c6990f94f3cf11b1ff7533a21da9b7","modified":1725866222726},{"_id":"themes/next/scripts/filters/comment/gitalk.js","hash":"7c0533bac4400689a0d5ab3a188ce42b9375de46","modified":1725866222727},{"_id":"themes/next/scripts/filters/comment/isso.js","hash":"ff8b5b5145220a17d0ecd9508ba9bd2d3b2da47d","modified":1725866222727},{"_id":"themes/next/scripts/filters/comment/utterances.js","hash":"d3bded697bc32dace689d2a6dfb6eb7514169d15","modified":1725866222727},{"_id":"themes/next/scripts/filters/comment/disqusjs.js","hash":"32a1d9ad50621a78d0243e176c8b05ff7866fd5b","modified":1725866222726},{"_id":"themes/next/scripts/filters/comment/livere.js","hash":"60be56c9ba590e5bcb80d1607ca7eeedde9fdfaa","modified":1725866222727},{"_id":"themes/next/layout/_third-party/search/localsearch.njk","hash":"767b6c714c22588bcd26ba70b0fc19b6810cbacd","modified":1725866222718},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"e1fbf169b9b6a194b518240cbd06ec3c48b83d61","modified":1725866222767},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"c65536a128b9bc9dbe2fbb1b235a3cded2891002","modified":1725866222767},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"e3be898f5ebcf435a26542653a9297ff2c71aeb0","modified":1725866222767},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"96e0a7c2a65ce68215e17e369085b2ea2f1334f2","modified":1725866222766},{"_id":"themes/next/source/js/schemes/muse.js","hash":"9d15d0d6a58b1df74827288f117af22b4b6aafe5","modified":1725866222780},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"ece860218125bdb2578f373ed4f5040c9670e4b1","modified":1725866222735},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"d4809783ded05625675b1b4bbd9e99d7f5f7d7f9","modified":1725866222734},{"_id":"themes/next/source/css/_variables/base.styl","hash":"32a1b73944561655087d80f025208a84e012b3cf","modified":1725866222768},{"_id":"themes/next/source/css/_common/components/index.styl","hash":"3c7ae405dd30b9b46494a6b9a6cb1b7ec6138ba9","modified":1725866222735},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"db5ddaa8fd2101b0fd7108ce4bbcb9f0649fa223","modified":1725866222748},{"_id":"themes/next/source/css/_common/scaffolding/buttons.styl","hash":"a042571d85ff7265f799004239a45f36b716b8a6","modified":1725866222749},{"_id":"themes/next/source/css/_common/components/reading-progress.styl","hash":"1cffb9c24eea18090b21b9cb908fe07cfeac0c03","modified":1725866222739},{"_id":"themes/next/source/css/_common/scaffolding/index.styl","hash":"523fb7b653b87ae37fc91fc8813e4ffad87b0d7e","modified":1725866222751},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"b56367ea676ea8e8783ea89cd4ab150c7da7a060","modified":1725866222751},{"_id":"themes/next/source/css/_common/scaffolding/comments.styl","hash":"e4fecc889ba3317a64e9abba5842c79dff9b7827","modified":1725866222749},{"_id":"themes/next/source/css/_common/scaffolding/pagination.styl","hash":"41cba8c4c5637a6b8f1b62e67673b33676f5d734","modified":1725866222752},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"e840b23d33023e6d45e018f6e84b683dd56efd8d","modified":1725866222752},{"_id":"themes/next/source/css/_common/scaffolding/toggles.styl","hash":"572a41499391677d84b16d8dbd6a996a3d5ce041","modified":1725866222757},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"fd49b521d67eaccc629f77b4e095cb7310327565","modified":1725866222758},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"4817e77577896ab5c0da434549917ee703a3f4cf","modified":1725866222759},{"_id":"themes/next/source/css/_schemes/Mist/_layout.styl","hash":"5604ac1e161099a4d3e5657d53507268866dc717","modified":1725866222760},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expand.styl","hash":"b332868d76d9f1651efd65abfc0d3c9d699b1a45","modified":1725866222760},{"_id":"themes/next/source/css/_common/outline/index.styl","hash":"0c9f72ad98807521cbdcee7b5bbe2e884311db39","modified":1725866222743},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"ab16a3dcdc0393b9b582ef59dcc13db9320e917c","modified":1725866222761},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"357b899ac0f0dfbbbebf1ea972030c7cefa463ce","modified":1725866222760},{"_id":"themes/next/source/css/_common/outline/mobile.styl","hash":"9f88d350df8115d26c6adbc2025a27ef9a42d7ff","modified":1725866222744},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"82a29572dd90451f75358a2ee2522b87304a0bb8","modified":1725866222762},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"8a70d51d8f7cd113e5fbc9f0e70c46a072f282c8","modified":1725866222762},{"_id":"themes/next/source/css/_schemes/Muse/_header.styl","hash":"06080fd963c904d96c00eff098a284e337953013","modified":1725866222762},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"72dc825c50357402c342d62ab60fc0c478ab6bc1","modified":1725866222765},{"_id":"themes/next/source/css/_schemes/Muse/_sub-menu.styl","hash":"c48ccd8d6651fe1a01faff8f01179456d39ba9b1","modified":1725866222763},{"_id":"themes/next/source/css/_schemes/Muse/_sidebar.styl","hash":"87e163de866938c668ec33e6ff8972b7a968e0af","modified":1725866222763},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"2d337a12c5c668ee64447bda5a9ed64eaed5b29e","modified":1725866222765},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"6eee86c8f0175d6c09e434053516cd8556f78d44","modified":1725866222764},{"_id":"themes/next/source/css/_schemes/Pisces/_header.styl","hash":"be5c46b983df08b9dbac1b4749b1a101b54b6b50","modified":1725866222764},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1725866222764},{"_id":"themes/next/source/css/_schemes/Pisces/_sub-menu.styl","hash":"778ed2ad5643b93970c95626b325defeb586733f","modified":1725866222766},{"_id":"themes/next/source/css/_common/components/pages/index.styl","hash":"7504dbc5c70262b048143b2c37d2b5aa2809afa2","modified":1725866222736},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"8000075b227749a7495eaf417cac6ccfbe441580","modified":1725866222766},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"b6e2eb1550a7845cb2adf86081a4ab6c7bde1e68","modified":1725866222735},{"_id":"themes/next/source/css/_common/components/pages/breadcrumb.styl","hash":"8afdc311c6b8db121758371f95cf1c5e77354f42","modified":1725866222735},{"_id":"themes/next/source/css/_common/components/pages/tag-cloud.styl","hash":"1a81d1a71fcf0699629ce6e72dfd0a15f3a2dd0a","modified":1725866222736},{"_id":"themes/next/source/css/_common/components/post/index.styl","hash":"b3fa752f72ca1413289b76c56fbd33a00e3d25d7","modified":1725866222737},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"6b816c2511242ee503fb5f34cd3e4dcdafc06b85","modified":1725866222736},{"_id":"themes/next/source/css/_common/components/post/post-body.styl","hash":"5d61dedb3bec1021d52894f9b379e4d0953f6a35","modified":1725866222737},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"ec37a36e94ba791663607a5022f763915778578f","modified":1725866222737},{"_id":"themes/next/source/css/_common/components/post/post-followme.styl","hash":"76d0dfb3a8b873a6180604ac6daecf38b6a963a2","modified":1725866222737},{"_id":"themes/next/source/css/_common/components/post/post-footer.styl","hash":"1d284f3ea03ba9b4feb76b375e539a8e0bccf1c3","modified":1725866222737},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"aa366d37389760c8595529b850f461569577a1c5","modified":1725866222738},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"9ac6f477177264c26a46e8333b8456720a0444dc","modified":1725866222738},{"_id":"themes/next/source/css/_common/components/post/post-header.styl","hash":"967021e5483495bdefac9e0b3e1c84c366c657fd","modified":1725866222738},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"b1181c5f12a70b8bf710586fcb0d7959841ee512","modified":1725866222738},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"5b5649b9749e3fd8b63aef22ceeece0a6e1df605","modified":1725866222738},{"_id":"themes/next/source/css/_common/components/third-party/math.styl","hash":"83c6588c51cd418336f4945813410a100ddfe2a4","modified":1725866222740},{"_id":"themes/next/source/css/_common/components/third-party/related-posts.styl","hash":"2c534d2b2dbc932ad65d335a720a7ba9612bac04","modified":1725866222740},{"_id":"themes/next/source/css/_common/components/third-party/index.styl","hash":"b457756758f0632767e8a560e3033059cbe4a67b","modified":1725866222739},{"_id":"themes/next/source/css/_common/components/third-party/gitalk.styl","hash":"7102f8e819b62cf7d121fd063dc663fd068feaa6","modified":1725866222739},{"_id":"themes/next/source/css/_common/components/third-party/utterances.styl","hash":"bf88d9c585d7b00463c46352402cfea415c29493","modified":1725866222740},{"_id":"themes/next/source/css/_common/components/third-party/search.styl","hash":"2896840ab8ac8ab2a7f76d18df893f290ac31625","modified":1725866222740},{"_id":"themes/next/source/css/_common/scaffolding/highlight/copy-code.styl","hash":"83ee4993710fc8daa1c8dbfccd5d5091fd244c30","modified":1725866222750},{"_id":"themes/next/source/css/_common/scaffolding/highlight/index.styl","hash":"08e79881d58d01afab6dbed37ab4f52356564d7e","modified":1725866222750},{"_id":"themes/next/source/css/_common/scaffolding/tags/blockquote-center.styl","hash":"15a5e273a8137550c93c8d2a60f9fcf86e04a89e","modified":1725866222753},{"_id":"themes/next/source/css/_common/scaffolding/tags/group-pictures.styl","hash":"393ff96234e4196b569d4b11496774eb78e147de","modified":1725866222753},{"_id":"themes/next/source/css/_common/scaffolding/tags/index.styl","hash":"cef4e779473daa3761709958243c6b8a57bbd814","modified":1725866222754},{"_id":"themes/next/source/css/_common/scaffolding/tags/label.styl","hash":"debee14539272fbe3835a7d3853af2230baa3501","modified":1725866222754},{"_id":"themes/next/source/css/_common/scaffolding/tags/pdf.styl","hash":"b49c64f8e9a6ca1c45c0ba98febf1974fdd03616","modified":1725866222756},{"_id":"themes/next/source/css/_common/scaffolding/tags/mermaid.styl","hash":"3c029a003e9bf747e1b9cc7c0c127f6028374876","modified":1725866222755},{"_id":"themes/next/source/css/_common/scaffolding/tags/note.styl","hash":"f53e6c12bd4805888f696386d00668f23cd335e7","modified":1725866222755},{"_id":"themes/next/source/css/_common/scaffolding/tags/tabs.styl","hash":"50b00218e854200c4ec0573a841e226d49c45cba","modified":1725866222756},{"_id":"themes/next/source/css/_common/scaffolding/tags/link-grid.styl","hash":"79ffcf92771cd48f4a686f9d8d7d610f39e9fc1f","modified":1725866222755},{"_id":"themes/next/source/css/_common/outline/header/bookmark.styl","hash":"d6d60f02b5e9f89dbfce180b3884030898022664","modified":1725866222741},{"_id":"themes/next/source/css/_common/outline/header/index.styl","hash":"f1778d2c56974b96dae429456d5c55be325c4946","modified":1725866222742},{"_id":"themes/next/source/css/_common/outline/header/menu.styl","hash":"392fd53a8dd4e3f33a853ebb24290a622300e0ff","modified":1725866222742},{"_id":"themes/next/source/css/_common/outline/header/github-banner.styl","hash":"cf194bea1c9e67fde871a04de3bc81df72c54277","modified":1725866222741},{"_id":"themes/next/source/css/_common/outline/header/site-meta.styl","hash":"9a47c9045e443b8d20932f9c564a3a05fa4c6b51","modified":1725866222743},{"_id":"themes/next/source/css/_common/outline/footer/index.styl","hash":"f11dca93e334b68a29e792f7abe682993fab7568","modified":1725866222741},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author-links.styl","hash":"52fc98b1435129eb3edb9293ced9e507741f1350","modified":1725866222745},{"_id":"themes/next/source/css/_common/outline/sidebar/index.styl","hash":"d180871d4440090241fc988736c1f3a7efb4b1ba","modified":1725866222744},{"_id":"themes/next/source/css/_common/outline/header/site-nav.styl","hash":"bf3ad8b4268f763a1e26377681644887694bc009","modified":1725866222743},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-blogroll.styl","hash":"9950c3188a28e1c63b5498b7bdcd14b12ace3e28","modified":1725866222745},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-dimmer.styl","hash":"fbdb63c6a8887d19b7137325ba7d6806f728139c","modified":1725866222746},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-button.styl","hash":"ab715dbf2b98bfeb5e7b7c43e92e5c02496cc2ea","modified":1725866222746},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author.styl","hash":"5b38ac4a0f1ade0e681aff0e3366c481d9cf3dcd","modified":1725866222745},{"_id":"themes/next/source/css/_common/outline/sidebar/site-state.styl","hash":"69eb1c282a8fd5dbab606cc09c34c5dc8e44e753","modified":1725866222748},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-nav.styl","hash":"f7ff85fe6c4efb8ff036fab2c3277b7d8bed69a8","modified":1725866222747},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toggle.styl","hash":"432e73bc4f99322af6af1852e0ea6e674919c31a","modified":1725866222747},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toc.styl","hash":"6394340c28a21f6aa90e786f3bfe24fb26595653","modified":1725866222747},{"_id":"themes/next/source/images/IMG_1598.jpg","hash":"d8d49bbd10eafe50277385dd96ebff38aac93ac0","modified":1725866222772},{"_id":"themes/next/source/images/fire.png","hash":"4d90ee49a3d4191fe21553a8ebf28c231ae037f5","modified":1725866222777},{"_id":"source/_posts/stakater-reloader.md","hash":"1f154fb83f844dcbe4b398f25f4d2b141a51d2b5","modified":1725866709369}],"Category":[{"name":"GCP","_id":"cm0uoc5ip0004k0lz5ojzgucv"},{"name":"GKE","_id":"cm0uoc5iu000ak0lz93lphm6h"},{"name":"Hexo","_id":"cm0uoc5ix000fk0lzei0icuye"},{"name":"PHP-FPM","_id":"cm0uoc5iz000kk0lzb0hohbn7"},{"name":"Other","_id":"cm0uoc5j3000tk0lzh2zqfxbo"},{"name":"Nginx","_id":"cm0uoc5j50012k0lz3bs7gx2n"},{"name":"Linux","_id":"cm0uoc5j7001ak0lzhd779el1"},{"name":"TCP/IP","_id":"cm0uoc5jh002gk0lz8hrzdzl6"}],"Data":[{"_id":"post-body-end","data":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n"},{"_id":"sidebar","data":"\n"},{"_id":"styles","data":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}],"Page":[{"title":"about","date":"2021-04-20T07:37:30.000Z","type":"about","_content":"","source":"about/index.md","raw":"---\ntitle: about\ndate: 2021-04-20 15:37:30\ntype: \"about\"\n---\n","updated":"2024-09-09T07:17:02.672Z","path":"about/index.html","comments":1,"layout":"page","_id":"cm0uoc5ig0000k0lz7dyoeaq0","content":"","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"","more":""},{"title":"tags","date":"2021-04-20T07:37:19.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2021-04-20 15:37:19\ntype: \"tags\"\n---\n","updated":"2024-09-09T07:17:02.673Z","path":"tags/index.html","comments":1,"layout":"page","_id":"cm0uoc5im0002k0lz78ol0122","content":"","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"","more":""},{"title":"categories","date":"2021-04-20T07:37:41.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2021-04-20 15:37:41\ntype: \"categories\"\n---\n","updated":"2024-09-09T07:17:02.672Z","path":"categories/index.html","comments":1,"layout":"page","_id":"cm0uoc5ir0006k0lz40p12eiy","content":"","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"","more":""}],"Post":[{"title":"在 Docker Engine 使用 Cloud SQL Auth Proxy","abbrlink":"8ebcb883","_content":"\n## 前言\n\n因為之前的 [透過 Auth Proxy 存取 Cloud SQL](https://blog.tonyjhang.tk/posts/8ebcb883/) 的篇幅有點長，所以決定把 Docker Engine 使用 Cloud SQL Auth Proxy 的方法另外寫一篇，在看這篇之前，如果還沒有閱讀過上一篇，可以點擊上面連結，先去看看，再回過頭來接續\n\n<!-- more -->\n\n## Cloud SQL Auth Proxy in a Docker container\n\n建立 Google Service Account\n```bash\ngcloud iam service-accounts create gsa-cloud-sql \\\n    --project=demo-123\n```\n\n並且賦予權限，以下三個 IAM 權限任一皆可\n\n- roles/cloudsql.client\n- roles/cloudsql.editor\n- roles/cloudsql.admin\n\n```bash\ngcloud projects add-iam-policy-binding demo-123 \\\n    --member \"serviceAccount:gsa-cloud-sql@demo-123.iam.gserviceaccount.com\" \\\n    --role \"roles/cloudsql.client\" \\\n    --project=demo-123\n```\n\n記得把 Google Service Account 的 JWT 下載到本機\n\n將 JWT 與連線資訊掛載到 container 內，讓容器拿著這把 Key 到 GCP 上做授權驗證\n```bash\n# Format\ndocker run -d \\\n  -v [LOCAL_PATH_TO_KEY_FILE]:/path/to/service-account-key.json \\\n  -p 127.0.0.1:3306:3306 \\\n  gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.2 \\\n  --credentials-file /path/to/service-account-key.json \\\n  [INSTANCE_CONNECTION_NAME]\n\n# Eample\nsudo docker run -d \\\n  -v /home/tony/key.json:/path/to/service-account-key.json \\\n  -p 127.0.0.1:3306:3306 \\\n  gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.2 \\\n  --credentials-file /path/to/service-account-key.json \\\n  demo-123:asia-east1:test\n```\n\n關於 `-p 127.0.0.1:3306:3306`，如果是要讓 Docker 環境內其他 container 可以存取，需要將 `127.0.0.1` 調整為 `0.0.0.0`，或者直接省略，如：`-p 3306:3306`，因為預設就是 `0.0.0.0`\n\n> Always specify 127.0.0.1 prefix in -p so that the Cloud SQL Auth proxy is not exposed outside the local host. The \"0.0.0.0\" in the instances parameter is required to make the port accessible from outside of the Docker container.\n\n連線名稱(connectionName) 的查詢方式，或者直接到網頁看\n```bash\n# Format\ngcloud sql instances describe [Instance_Name] --project=[Project_ID]\n\n# Example\ngcloud sql instances describe test --project=demo-123\n```\n\n最後使用 Cloud SQL 的使用者帳號與 Cloud SQL Auth Proxy 做連線驗證，也可以使用第三方工具來連線測試，例如：MySQL WorkBench, phpMyAdmin...\n\n```bash\nmysql -u [USERNAME] -p --host 127.0.0.1\n```\n\n## 參考資料\n\n- https://cloud.google.com/sql/docs/mysql/connect-auth-proxy","source":"_drafts/cloud-sql-proxy-in-docker.md","raw":"---\ntitle: 在 Docker Engine 使用 Cloud SQL Auth Proxy\ntags:\n  - GCP\n  - Cloud SQL\n  - Google Cloud Platform\ncategories:\n  - GCP\nabbrlink: 8ebcb883\n---\n\n## 前言\n\n因為之前的 [透過 Auth Proxy 存取 Cloud SQL](https://blog.tonyjhang.tk/posts/8ebcb883/) 的篇幅有點長，所以決定把 Docker Engine 使用 Cloud SQL Auth Proxy 的方法另外寫一篇，在看這篇之前，如果還沒有閱讀過上一篇，可以點擊上面連結，先去看看，再回過頭來接續\n\n<!-- more -->\n\n## Cloud SQL Auth Proxy in a Docker container\n\n建立 Google Service Account\n```bash\ngcloud iam service-accounts create gsa-cloud-sql \\\n    --project=demo-123\n```\n\n並且賦予權限，以下三個 IAM 權限任一皆可\n\n- roles/cloudsql.client\n- roles/cloudsql.editor\n- roles/cloudsql.admin\n\n```bash\ngcloud projects add-iam-policy-binding demo-123 \\\n    --member \"serviceAccount:gsa-cloud-sql@demo-123.iam.gserviceaccount.com\" \\\n    --role \"roles/cloudsql.client\" \\\n    --project=demo-123\n```\n\n記得把 Google Service Account 的 JWT 下載到本機\n\n將 JWT 與連線資訊掛載到 container 內，讓容器拿著這把 Key 到 GCP 上做授權驗證\n```bash\n# Format\ndocker run -d \\\n  -v [LOCAL_PATH_TO_KEY_FILE]:/path/to/service-account-key.json \\\n  -p 127.0.0.1:3306:3306 \\\n  gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.2 \\\n  --credentials-file /path/to/service-account-key.json \\\n  [INSTANCE_CONNECTION_NAME]\n\n# Eample\nsudo docker run -d \\\n  -v /home/tony/key.json:/path/to/service-account-key.json \\\n  -p 127.0.0.1:3306:3306 \\\n  gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.2 \\\n  --credentials-file /path/to/service-account-key.json \\\n  demo-123:asia-east1:test\n```\n\n關於 `-p 127.0.0.1:3306:3306`，如果是要讓 Docker 環境內其他 container 可以存取，需要將 `127.0.0.1` 調整為 `0.0.0.0`，或者直接省略，如：`-p 3306:3306`，因為預設就是 `0.0.0.0`\n\n> Always specify 127.0.0.1 prefix in -p so that the Cloud SQL Auth proxy is not exposed outside the local host. The \"0.0.0.0\" in the instances parameter is required to make the port accessible from outside of the Docker container.\n\n連線名稱(connectionName) 的查詢方式，或者直接到網頁看\n```bash\n# Format\ngcloud sql instances describe [Instance_Name] --project=[Project_ID]\n\n# Example\ngcloud sql instances describe test --project=demo-123\n```\n\n最後使用 Cloud SQL 的使用者帳號與 Cloud SQL Auth Proxy 做連線驗證，也可以使用第三方工具來連線測試，例如：MySQL WorkBench, phpMyAdmin...\n\n```bash\nmysql -u [USERNAME] -p --host 127.0.0.1\n```\n\n## 參考資料\n\n- https://cloud.google.com/sql/docs/mysql/connect-auth-proxy","slug":"cloud-sql-proxy-in-docker","published":0,"date":"2024-09-09T07:17:02.642Z","updated":"2024-09-09T07:17:02.642Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5ik0001k0lzb1se7eom","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>因為之前的 <a href=\"https://blog.tonyjhang.tk/posts/8ebcb883/\">透過 Auth Proxy 存取 Cloud SQL</a> 的篇幅有點長，所以決定把 Docker Engine 使用 Cloud SQL Auth Proxy 的方法另外寫一篇，在看這篇之前，如果還沒有閱讀過上一篇，可以點擊上面連結，先去看看，再回過頭來接續</p>\n<span id=\"more\"></span>\n\n<h2 id=\"Cloud-SQL-Auth-Proxy-in-a-Docker-container\"><a href=\"#Cloud-SQL-Auth-Proxy-in-a-Docker-container\" class=\"headerlink\" title=\"Cloud SQL Auth Proxy in a Docker container\"></a>Cloud SQL Auth Proxy in a Docker container</h2><p>建立 Google Service Account</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud iam service-accounts create gsa-cloud-sql \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>並且賦予權限，以下三個 IAM 權限任一皆可</p>\n<ul>\n<li>roles/cloudsql.client</li>\n<li>roles/cloudsql.editor</li>\n<li>roles/cloudsql.admin</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud projects add-iam-policy-binding demo-123 \\</span><br><span class=\"line\">    --member <span class=\"string\">&quot;serviceAccount:gsa-cloud-sql@demo-123.iam.gserviceaccount.com&quot;</span> \\</span><br><span class=\"line\">    --role <span class=\"string\">&quot;roles/cloudsql.client&quot;</span> \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>記得把 Google Service Account 的 JWT 下載到本機</p>\n<p>將 JWT 與連線資訊掛載到 container 內，讓容器拿著這把 Key 到 GCP 上做授權驗證</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Format</span></span><br><span class=\"line\">docker run -d \\</span><br><span class=\"line\">  -v [LOCAL_PATH_TO_KEY_FILE]:/path/to/service-account-key.json \\</span><br><span class=\"line\">  -p 127.0.0.1:3306:3306 \\</span><br><span class=\"line\">  gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.2 \\</span><br><span class=\"line\">  --credentials-file /path/to/service-account-key.json \\</span><br><span class=\"line\">  [INSTANCE_CONNECTION_NAME]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Eample</span></span><br><span class=\"line\">sudo docker run -d \\</span><br><span class=\"line\">  -v /home/tony/key.json:/path/to/service-account-key.json \\</span><br><span class=\"line\">  -p 127.0.0.1:3306:3306 \\</span><br><span class=\"line\">  gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.2 \\</span><br><span class=\"line\">  --credentials-file /path/to/service-account-key.json \\</span><br><span class=\"line\">  demo-123:asia-east1:<span class=\"built_in\">test</span></span><br></pre></td></tr></table></figure>\n\n<p>關於 <code>-p 127.0.0.1:3306:3306</code>，如果是要讓 Docker 環境內其他 container 可以存取，需要將 <code>127.0.0.1</code> 調整為 <code>0.0.0.0</code>，或者直接省略，如：<code>-p 3306:3306</code>，因為預設就是 <code>0.0.0.0</code></p>\n<blockquote>\n<p>Always specify 127.0.0.1 prefix in -p so that the Cloud SQL Auth proxy is not exposed outside the local host. The “0.0.0.0” in the instances parameter is required to make the port accessible from outside of the Docker container.</p>\n</blockquote>\n<p>連線名稱(connectionName) 的查詢方式，或者直接到網頁看</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Format</span></span><br><span class=\"line\">gcloud sql instances describe [Instance_Name] --project=[Project_ID]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Example</span></span><br><span class=\"line\">gcloud sql instances describe <span class=\"built_in\">test</span> --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>最後使用 Cloud SQL 的使用者帳號與 Cloud SQL Auth Proxy 做連線驗證，也可以使用第三方工具來連線測試，例如：MySQL WorkBench, phpMyAdmin…</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql -u [USERNAME] -p --host 127.0.0.1</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://cloud.google.com/sql/docs/mysql/connect-auth-proxy\">https://cloud.google.com/sql/docs/mysql/connect-auth-proxy</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>因為之前的 <a href=\"https://blog.tonyjhang.tk/posts/8ebcb883/\">透過 Auth Proxy 存取 Cloud SQL</a> 的篇幅有點長，所以決定把 Docker Engine 使用 Cloud SQL Auth Proxy 的方法另外寫一篇，在看這篇之前，如果還沒有閱讀過上一篇，可以點擊上面連結，先去看看，再回過頭來接續</p>","more":"<h2 id=\"Cloud-SQL-Auth-Proxy-in-a-Docker-container\"><a href=\"#Cloud-SQL-Auth-Proxy-in-a-Docker-container\" class=\"headerlink\" title=\"Cloud SQL Auth Proxy in a Docker container\"></a>Cloud SQL Auth Proxy in a Docker container</h2><p>建立 Google Service Account</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud iam service-accounts create gsa-cloud-sql \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>並且賦予權限，以下三個 IAM 權限任一皆可</p>\n<ul>\n<li>roles/cloudsql.client</li>\n<li>roles/cloudsql.editor</li>\n<li>roles/cloudsql.admin</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud projects add-iam-policy-binding demo-123 \\</span><br><span class=\"line\">    --member <span class=\"string\">&quot;serviceAccount:gsa-cloud-sql@demo-123.iam.gserviceaccount.com&quot;</span> \\</span><br><span class=\"line\">    --role <span class=\"string\">&quot;roles/cloudsql.client&quot;</span> \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>記得把 Google Service Account 的 JWT 下載到本機</p>\n<p>將 JWT 與連線資訊掛載到 container 內，讓容器拿著這把 Key 到 GCP 上做授權驗證</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Format</span></span><br><span class=\"line\">docker run -d \\</span><br><span class=\"line\">  -v [LOCAL_PATH_TO_KEY_FILE]:/path/to/service-account-key.json \\</span><br><span class=\"line\">  -p 127.0.0.1:3306:3306 \\</span><br><span class=\"line\">  gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.2 \\</span><br><span class=\"line\">  --credentials-file /path/to/service-account-key.json \\</span><br><span class=\"line\">  [INSTANCE_CONNECTION_NAME]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Eample</span></span><br><span class=\"line\">sudo docker run -d \\</span><br><span class=\"line\">  -v /home/tony/key.json:/path/to/service-account-key.json \\</span><br><span class=\"line\">  -p 127.0.0.1:3306:3306 \\</span><br><span class=\"line\">  gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.2 \\</span><br><span class=\"line\">  --credentials-file /path/to/service-account-key.json \\</span><br><span class=\"line\">  demo-123:asia-east1:<span class=\"built_in\">test</span></span><br></pre></td></tr></table></figure>\n\n<p>關於 <code>-p 127.0.0.1:3306:3306</code>，如果是要讓 Docker 環境內其他 container 可以存取，需要將 <code>127.0.0.1</code> 調整為 <code>0.0.0.0</code>，或者直接省略，如：<code>-p 3306:3306</code>，因為預設就是 <code>0.0.0.0</code></p>\n<blockquote>\n<p>Always specify 127.0.0.1 prefix in -p so that the Cloud SQL Auth proxy is not exposed outside the local host. The “0.0.0.0” in the instances parameter is required to make the port accessible from outside of the Docker container.</p>\n</blockquote>\n<p>連線名稱(connectionName) 的查詢方式，或者直接到網頁看</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Format</span></span><br><span class=\"line\">gcloud sql instances describe [Instance_Name] --project=[Project_ID]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Example</span></span><br><span class=\"line\">gcloud sql instances describe <span class=\"built_in\">test</span> --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>最後使用 Cloud SQL 的使用者帳號與 Cloud SQL Auth Proxy 做連線驗證，也可以使用第三方工具來連線測試，例如：MySQL WorkBench, phpMyAdmin…</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql -u [USERNAME] -p --host 127.0.0.1</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://cloud.google.com/sql/docs/mysql/connect-auth-proxy\">https://cloud.google.com/sql/docs/mysql/connect-auth-proxy</a></li>\n</ul>"},{"title":"在 GKE 內使用 Cert-Manager","abbrlink":"c0478787","_content":"\n## 前言\n\ncert-manager 可以幫助我們在使用 kubernetes 時，可以自動簽發 Let's Encrypt 憑證，並且搭配 Ingress 做使用。\n\n> Let's Encrypt 憑證有效期限為三個月，三個月到期會自動在重新簽發展延\n\n<!-- more -->\n\n本文章使用環境為 GKE 搭配 GKE Ingress 並且使用 HTTP-01 Challenge\n\n## 安裝 Cert-Manager\n\n首先需要在 Cluster 環境內安裝 Cert-Manager 核心元件\n\n安裝 Cert-Manager，如果有新版本，路徑會不同，這部份可以直接上官方文件查詢\n```bash\nkubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml\n```\n\n檢查安裝元件\n```bash\n$ kubectl get pods --namespace cert-manager\n\nNAME                                       READY   STATUS    RESTARTS   AGE\ncert-manager-75997f4b44-jsq7z              1/1     Running   0          4m38s\ncert-manager-cainjector-769785cd7b-95fcp   1/1     Running   0          4m38s\ncert-manager-webhook-6bc9944d78-dnggk      1/1     Running   0          4m38s\n```\n\n## 前製作業\n\n- 先預約 GKE Ingress 用的外網 IP\n- 設定DNS A紀錄\n\n確認 cert-manager 要與哪種 Ingress Controller 搭配，可參考以下資料：\n\nhttps://cert-manager.io/docs/getting-started/\n\n> 如果要使用 wildcard 憑證只能用 DNS-01 challenge\n\n## 佈署建議指南\n\n本章測試原始碼：https://github.com/winds6206/cert-manager\n\n### 佈署 application 內的 Nginx\n\n佈署服務\n```bash\ncd ./application/nginx\nkubectl apply -f .\n\ncd ./application/nginx-v2\nkubectl apply -f .\n```\n\n### 佈署 Ingress 和 NodePort Service\n\n以 80 為主，先確保可以正確導向到服務\n\n修改 Ingress 描述檔，並且佈署，域名記得跟著自身測試環境修改：\n\n- `kubernetes.io/ingress.global-static-ip-name` 改成自己預約的IP名稱\n- `kubernetes.io/ingress.allow-http` 改成 true\n- `networking.gke.io/v1beta1.FrontendConfig` 新增註解\n- `cert-manager.io/issuer` 新增註解\n- 下述片段新增註解\n```yaml\n#tls:\n#  - secretName: web-ssl\n#    hosts:\n#      - cert-manager-demo.example.com\n#      - cert-manager-demo-v2.example.com\n```\n\n整體如下：\n```yaml\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: cert-manager-demo-external-ingress\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.global-static-ip-name: \"cert-manager-demo-external-ingress\"\n    kubernetes.io/ingress.allow-http: \"true\" # default is true\n#    networking.gke.io/v1beta1.FrontendConfig: \"cert-manager-demo-external-ingress-http2https\"\n    ingressClassName: \"gce\" # This tells Google Cloud to create an External Load Balancer to realize this Ingress\n#    cert-manager.io/issuer: letsencrypt-production\nspec:\n#  tls:\n#    - secretName: web-ssl\n#      hosts:\n#        - cert-manager-demo.example.com\n#        - cert-manager-demo-v2.example.com\n  rules:\n    - host: cert-manager-demo.example.com\n      http:\n        paths:\n        - path: /*\n          pathType: ImplementationSpecific\n          backend:\n            service:\n              name: cert-manager-demo-for-external-ingress\n              port:\n                number: 80\n    - host: cert-manager-demo-v2.example.com\n      http:\n        paths:\n        - path: /*\n          pathType: ImplementationSpecific\n          backend:\n            service:\n              name: cert-manager-demo-v2-for-external-ingress\n              port:\n                number: 80\n```\n\n佈署服務\n```bash\ncd ./ingress\nkubectl apply -f svc-external-ingress.yaml\nkubectl apply -f cert-manager-demo-external-ingress.yaml\n```\n\n### 佈署 issuer 和 secret\n\n80 可以正常運行後，再將 issuer 佈署下去做憑證簽發，確認 80 和 443 是否可以分開正常運行\n\n先修改 Ingress 描述檔，將 cert-manager 相關的設定註解移除，並且重新佈署\n\n- `cert-manager.io/issuer` 註解移除\n- 下述片段註解移除，域名記得更換\n```yaml\ntls:\n  - secretName: web-ssl\n    hosts:\n      - cert-manager-demo.example.com\n      - cert-manager-demo-v2.example.com\n```\n\n整體如下：\n```yaml\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: cert-manager-demo-external-ingress\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.global-static-ip-name: \"cert-manager-demo-external-ingress\"\n    kubernetes.io/ingress.allow-http: \"true\" # default is true\n#    networking.gke.io/v1beta1.FrontendConfig: \"cert-manager-demo-external-ingress-http2https\"\n    ingressClassName: \"gce\" # This tells Google Cloud to create an External Load Balancer to realize this Ingress\n    cert-manager.io/issuer: letsencrypt-production\nspec:\n  tls:\n    - secretName: web-ssl\n      hosts:\n        - cert-manager-demo.example.com\n        - cert-manager-demo-v2.example.com\n  rules:\n    - host: cert-manager-demo.example.com\n      http:\n        paths:\n        - path: /*\n          pathType: ImplementationSpecific\n          backend:\n            service:\n              name: cert-manager-demo-for-external-ingress\n              port:\n                number: 80\n    - host: cert-manager-demo-v2.example.com\n      http:\n        paths:\n        - path: /*\n          pathType: ImplementationSpecific\n          backend:\n            service:\n              name: cert-manager-demo-v2-for-external-ingress\n              port:\n                number: 80\n```\n\n調整 issuer 描述檔，將 `spec.acme.email` 填入自己正確的 E-mail，再將 issuer 和 secret 佈署下去\n\n```bash\nkubectl apply -f issuer.yaml\nkubectl apply -f secret.yaml\n```\n\n憑證簽發狀態可以使用 `kubectl describe issuers.cert-manager.io [Issuer_Name]` 去確認，也可以使用 `kubectl get certificate` 去確認是否 READY\n\n確認簽證後，看看 80 跟 443 能不能正常存取網頁\n\n### 附加 https 跳轉功能\n\n最後將 http 自動跳轉 https 功能加上\n\n```bash\ncd ./ingress\nkubectl apply -f frontend-config.yaml\n```\n\n修改 Ingress 描述檔，並且重新佈署\n\n- `networking.gke.io/v1beta1.FrontendConfig` 移除註解\n\n整體如下：\n```yaml\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: cert-manager-demo-external-ingress\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.global-static-ip-name: \"cert-manager-demo-external-ingress\"\n    kubernetes.io/ingress.allow-http: \"true\" # default is true\n    networking.gke.io/v1beta1.FrontendConfig: \"cert-manager-demo-external-ingress-http2https\"\n    ingressClassName: \"gce\" # This tells Google Cloud to create an External Load Balancer to realize this Ingress\n    cert-manager.io/issuer: letsencrypt-production\nspec:\n  ...\n```\n\n測試 80 是否可以自動跳轉 443，這樣整個功能就完成囉\n\n## Q&A\n\n- Issuer vs ClusterIssuer\n- Let's Encrypt Issuer production vs staging\n- Issuer 中 E-mail 的作用\n\n### Issuer 和 ClusterIssuer 差異\n\ncert-manager 分為兩種 Issuer，分別為 Issuer 和 ClusterIssuer。\n\n兩者的差異就在於 Issuer 只能在單一 Namespace 使用，而 ClusterIssuer 屬於 cluster-wide 也就是說每個 Namespace 都可以 reference 到。\n\n兩者於 Manifest 的寫法差異僅在於 `kind` 與 `namespace`，如下參考\n\nIssuer\n```yaml\napiVersion: cert-manager.io/v1\nkind: Issuer\nmetadata:\n  name: letsencrypt-production\n  namespace: default\nspec:\n  acme:\n    # The ACME server URL\n    server: https://acme-v02.api.letsencrypt.org/directory\n    # Email address used for ACME registration\n    email: tony@example.com\n    # Name of a secret used to store the ACME account private key\n    privateKeySecretRef:\n      name: letsencrypt-production\n    # Enable the HTTP-01 challenge provider\n    solvers:\n    - http01:\n        ingress:\n          name: example-ingress\n```\n\nClusterIssuer \n```yaml\napiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-production\nspec:\n  acme:\n    # The ACME server URL\n    server: https://acme-v02.api.letsencrypt.org/directory\n    # Email address used for ACME registration\n    email: tony@example.com\n    # Name of a secret used to store the ACME account private key\n    privateKeySecretRef:\n      name: letsencrypt-production\n    # Enable the HTTP-01 challenge provider\n    solvers:\n    - http01:\n        ingress:\n          name: example-ingress\n```\n\n### Let's Encrypt Issuer production 和 staging 差異\n\nLet's Encrypt Issuer 分為 production 和 staging，兩者最大的差別在於 rate limits，production 有相當嚴格的 rate limits，如果是在測試階段很可能不小心就頂到限制，所以在測試階段建議先以 staging 來測試，確定沒問題後，在切換到 production。\n\n使用 staging 簽發出來的憑證依然屬於 untrusted certificates\n> Note that you'll see a warning about untrusted certificates from the staging issuer, but that's totally expected.\n\nproduction 和 staging 的 ACME server URL 如下：\n\n- production：https://acme-v02.api.letsencrypt.org/directory\n- staging：https://acme-staging-v02.api.letsencrypt.org/directory\n\n### Issuer 中 E-mail 的作用\n\n憑證註冊時會使用該組 E-mail 做註冊，並且在憑證即將到期時通知該組 E-mail\n\n> This email is required by Let's Encrypt and used to notify you of certificate expiration and updates.\n\n### Issuer, secret 與 Ingress 之間如何產生關聯\n\n在 GKE Ingress 的 Manifest 中有以下兩段：\n\n- `metadata.annotations.cert-manager.io/issuer`\n- `spec.tls.secretName`\n\n這兩段分別對應 Issuer 和 secret，當我們將 Issuer 和 secret 佈署後，在 certificate object 中會自動建立一個與 secret 同名的物件，透過 `describe certificate` 就可以發現到，系統會自動將先前建立的物件進行關聯。\n\n```bash\nkubectl describe certificate [Certificate_Name]\n```\n\n```yaml\n省略...\n\nSpec:\n  Dns Names:\n    ingress-nginx-demo.twister5-tc.website\n  Issuer Ref:\n    Group:      cert-manager.io\n    Kind:       Issuer\n    Name:       ingress-nginx-demo-external-ingress-letsencrypt-production\n  Secret Name:  ingress-nginx-demo-external-ingress-ssl\n\n省略...\n```\n\n從這邊我們可以很清楚的看到，`Spec.Issuer Ref.Name` 與 `Spec.Secret Name` 是有順利關聯起來\n\n當 Issuer 順利簽發出憑證後，會依據自身的 Manifest `spec.acme.privateKeySecretRef.name` 建立相對應名稱的 secret 並且將憑證內容儲存於此。\n\n前面有提到 Ingress 的描述檔內也有 Issuer 和 secret 的資訊，自然而然三者就會互相進行關聯。\n\n## 參考資料\n\n- https://cert-manager.io/docs/installation/kubectl/\n- https://cert-manager.io/docs/getting-started/\n- https://cert-manager.io/docs/tutorials/getting-started-with-cert-manager-on-google-kubernetes-engine-using-lets-encrypt-for-ingress-ssl/\n","source":"_drafts/cert-manager-in-kubernetes.md","raw":"---\ntitle: 在 GKE 內使用 Cert-Manager\ntags:\n  - GCP\n  - GKE\n  - Google Cloud Platform\n  - K8s\n  - Kubernetes\ncategories:\n  - GKE\nabbrlink: c0478787\n---\n\n## 前言\n\ncert-manager 可以幫助我們在使用 kubernetes 時，可以自動簽發 Let's Encrypt 憑證，並且搭配 Ingress 做使用。\n\n> Let's Encrypt 憑證有效期限為三個月，三個月到期會自動在重新簽發展延\n\n<!-- more -->\n\n本文章使用環境為 GKE 搭配 GKE Ingress 並且使用 HTTP-01 Challenge\n\n## 安裝 Cert-Manager\n\n首先需要在 Cluster 環境內安裝 Cert-Manager 核心元件\n\n安裝 Cert-Manager，如果有新版本，路徑會不同，這部份可以直接上官方文件查詢\n```bash\nkubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml\n```\n\n檢查安裝元件\n```bash\n$ kubectl get pods --namespace cert-manager\n\nNAME                                       READY   STATUS    RESTARTS   AGE\ncert-manager-75997f4b44-jsq7z              1/1     Running   0          4m38s\ncert-manager-cainjector-769785cd7b-95fcp   1/1     Running   0          4m38s\ncert-manager-webhook-6bc9944d78-dnggk      1/1     Running   0          4m38s\n```\n\n## 前製作業\n\n- 先預約 GKE Ingress 用的外網 IP\n- 設定DNS A紀錄\n\n確認 cert-manager 要與哪種 Ingress Controller 搭配，可參考以下資料：\n\nhttps://cert-manager.io/docs/getting-started/\n\n> 如果要使用 wildcard 憑證只能用 DNS-01 challenge\n\n## 佈署建議指南\n\n本章測試原始碼：https://github.com/winds6206/cert-manager\n\n### 佈署 application 內的 Nginx\n\n佈署服務\n```bash\ncd ./application/nginx\nkubectl apply -f .\n\ncd ./application/nginx-v2\nkubectl apply -f .\n```\n\n### 佈署 Ingress 和 NodePort Service\n\n以 80 為主，先確保可以正確導向到服務\n\n修改 Ingress 描述檔，並且佈署，域名記得跟著自身測試環境修改：\n\n- `kubernetes.io/ingress.global-static-ip-name` 改成自己預約的IP名稱\n- `kubernetes.io/ingress.allow-http` 改成 true\n- `networking.gke.io/v1beta1.FrontendConfig` 新增註解\n- `cert-manager.io/issuer` 新增註解\n- 下述片段新增註解\n```yaml\n#tls:\n#  - secretName: web-ssl\n#    hosts:\n#      - cert-manager-demo.example.com\n#      - cert-manager-demo-v2.example.com\n```\n\n整體如下：\n```yaml\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: cert-manager-demo-external-ingress\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.global-static-ip-name: \"cert-manager-demo-external-ingress\"\n    kubernetes.io/ingress.allow-http: \"true\" # default is true\n#    networking.gke.io/v1beta1.FrontendConfig: \"cert-manager-demo-external-ingress-http2https\"\n    ingressClassName: \"gce\" # This tells Google Cloud to create an External Load Balancer to realize this Ingress\n#    cert-manager.io/issuer: letsencrypt-production\nspec:\n#  tls:\n#    - secretName: web-ssl\n#      hosts:\n#        - cert-manager-demo.example.com\n#        - cert-manager-demo-v2.example.com\n  rules:\n    - host: cert-manager-demo.example.com\n      http:\n        paths:\n        - path: /*\n          pathType: ImplementationSpecific\n          backend:\n            service:\n              name: cert-manager-demo-for-external-ingress\n              port:\n                number: 80\n    - host: cert-manager-demo-v2.example.com\n      http:\n        paths:\n        - path: /*\n          pathType: ImplementationSpecific\n          backend:\n            service:\n              name: cert-manager-demo-v2-for-external-ingress\n              port:\n                number: 80\n```\n\n佈署服務\n```bash\ncd ./ingress\nkubectl apply -f svc-external-ingress.yaml\nkubectl apply -f cert-manager-demo-external-ingress.yaml\n```\n\n### 佈署 issuer 和 secret\n\n80 可以正常運行後，再將 issuer 佈署下去做憑證簽發，確認 80 和 443 是否可以分開正常運行\n\n先修改 Ingress 描述檔，將 cert-manager 相關的設定註解移除，並且重新佈署\n\n- `cert-manager.io/issuer` 註解移除\n- 下述片段註解移除，域名記得更換\n```yaml\ntls:\n  - secretName: web-ssl\n    hosts:\n      - cert-manager-demo.example.com\n      - cert-manager-demo-v2.example.com\n```\n\n整體如下：\n```yaml\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: cert-manager-demo-external-ingress\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.global-static-ip-name: \"cert-manager-demo-external-ingress\"\n    kubernetes.io/ingress.allow-http: \"true\" # default is true\n#    networking.gke.io/v1beta1.FrontendConfig: \"cert-manager-demo-external-ingress-http2https\"\n    ingressClassName: \"gce\" # This tells Google Cloud to create an External Load Balancer to realize this Ingress\n    cert-manager.io/issuer: letsencrypt-production\nspec:\n  tls:\n    - secretName: web-ssl\n      hosts:\n        - cert-manager-demo.example.com\n        - cert-manager-demo-v2.example.com\n  rules:\n    - host: cert-manager-demo.example.com\n      http:\n        paths:\n        - path: /*\n          pathType: ImplementationSpecific\n          backend:\n            service:\n              name: cert-manager-demo-for-external-ingress\n              port:\n                number: 80\n    - host: cert-manager-demo-v2.example.com\n      http:\n        paths:\n        - path: /*\n          pathType: ImplementationSpecific\n          backend:\n            service:\n              name: cert-manager-demo-v2-for-external-ingress\n              port:\n                number: 80\n```\n\n調整 issuer 描述檔，將 `spec.acme.email` 填入自己正確的 E-mail，再將 issuer 和 secret 佈署下去\n\n```bash\nkubectl apply -f issuer.yaml\nkubectl apply -f secret.yaml\n```\n\n憑證簽發狀態可以使用 `kubectl describe issuers.cert-manager.io [Issuer_Name]` 去確認，也可以使用 `kubectl get certificate` 去確認是否 READY\n\n確認簽證後，看看 80 跟 443 能不能正常存取網頁\n\n### 附加 https 跳轉功能\n\n最後將 http 自動跳轉 https 功能加上\n\n```bash\ncd ./ingress\nkubectl apply -f frontend-config.yaml\n```\n\n修改 Ingress 描述檔，並且重新佈署\n\n- `networking.gke.io/v1beta1.FrontendConfig` 移除註解\n\n整體如下：\n```yaml\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: cert-manager-demo-external-ingress\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.global-static-ip-name: \"cert-manager-demo-external-ingress\"\n    kubernetes.io/ingress.allow-http: \"true\" # default is true\n    networking.gke.io/v1beta1.FrontendConfig: \"cert-manager-demo-external-ingress-http2https\"\n    ingressClassName: \"gce\" # This tells Google Cloud to create an External Load Balancer to realize this Ingress\n    cert-manager.io/issuer: letsencrypt-production\nspec:\n  ...\n```\n\n測試 80 是否可以自動跳轉 443，這樣整個功能就完成囉\n\n## Q&A\n\n- Issuer vs ClusterIssuer\n- Let's Encrypt Issuer production vs staging\n- Issuer 中 E-mail 的作用\n\n### Issuer 和 ClusterIssuer 差異\n\ncert-manager 分為兩種 Issuer，分別為 Issuer 和 ClusterIssuer。\n\n兩者的差異就在於 Issuer 只能在單一 Namespace 使用，而 ClusterIssuer 屬於 cluster-wide 也就是說每個 Namespace 都可以 reference 到。\n\n兩者於 Manifest 的寫法差異僅在於 `kind` 與 `namespace`，如下參考\n\nIssuer\n```yaml\napiVersion: cert-manager.io/v1\nkind: Issuer\nmetadata:\n  name: letsencrypt-production\n  namespace: default\nspec:\n  acme:\n    # The ACME server URL\n    server: https://acme-v02.api.letsencrypt.org/directory\n    # Email address used for ACME registration\n    email: tony@example.com\n    # Name of a secret used to store the ACME account private key\n    privateKeySecretRef:\n      name: letsencrypt-production\n    # Enable the HTTP-01 challenge provider\n    solvers:\n    - http01:\n        ingress:\n          name: example-ingress\n```\n\nClusterIssuer \n```yaml\napiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-production\nspec:\n  acme:\n    # The ACME server URL\n    server: https://acme-v02.api.letsencrypt.org/directory\n    # Email address used for ACME registration\n    email: tony@example.com\n    # Name of a secret used to store the ACME account private key\n    privateKeySecretRef:\n      name: letsencrypt-production\n    # Enable the HTTP-01 challenge provider\n    solvers:\n    - http01:\n        ingress:\n          name: example-ingress\n```\n\n### Let's Encrypt Issuer production 和 staging 差異\n\nLet's Encrypt Issuer 分為 production 和 staging，兩者最大的差別在於 rate limits，production 有相當嚴格的 rate limits，如果是在測試階段很可能不小心就頂到限制，所以在測試階段建議先以 staging 來測試，確定沒問題後，在切換到 production。\n\n使用 staging 簽發出來的憑證依然屬於 untrusted certificates\n> Note that you'll see a warning about untrusted certificates from the staging issuer, but that's totally expected.\n\nproduction 和 staging 的 ACME server URL 如下：\n\n- production：https://acme-v02.api.letsencrypt.org/directory\n- staging：https://acme-staging-v02.api.letsencrypt.org/directory\n\n### Issuer 中 E-mail 的作用\n\n憑證註冊時會使用該組 E-mail 做註冊，並且在憑證即將到期時通知該組 E-mail\n\n> This email is required by Let's Encrypt and used to notify you of certificate expiration and updates.\n\n### Issuer, secret 與 Ingress 之間如何產生關聯\n\n在 GKE Ingress 的 Manifest 中有以下兩段：\n\n- `metadata.annotations.cert-manager.io/issuer`\n- `spec.tls.secretName`\n\n這兩段分別對應 Issuer 和 secret，當我們將 Issuer 和 secret 佈署後，在 certificate object 中會自動建立一個與 secret 同名的物件，透過 `describe certificate` 就可以發現到，系統會自動將先前建立的物件進行關聯。\n\n```bash\nkubectl describe certificate [Certificate_Name]\n```\n\n```yaml\n省略...\n\nSpec:\n  Dns Names:\n    ingress-nginx-demo.twister5-tc.website\n  Issuer Ref:\n    Group:      cert-manager.io\n    Kind:       Issuer\n    Name:       ingress-nginx-demo-external-ingress-letsencrypt-production\n  Secret Name:  ingress-nginx-demo-external-ingress-ssl\n\n省略...\n```\n\n從這邊我們可以很清楚的看到，`Spec.Issuer Ref.Name` 與 `Spec.Secret Name` 是有順利關聯起來\n\n當 Issuer 順利簽發出憑證後，會依據自身的 Manifest `spec.acme.privateKeySecretRef.name` 建立相對應名稱的 secret 並且將憑證內容儲存於此。\n\n前面有提到 Ingress 的描述檔內也有 Issuer 和 secret 的資訊，自然而然三者就會互相進行關聯。\n\n## 參考資料\n\n- https://cert-manager.io/docs/installation/kubectl/\n- https://cert-manager.io/docs/getting-started/\n- https://cert-manager.io/docs/tutorials/getting-started-with-cert-manager-on-google-kubernetes-engine-using-lets-encrypt-for-ingress-ssl/\n","slug":"cert-manager-in-kubernetes","published":0,"date":"2024-09-09T07:17:02.642Z","updated":"2024-09-09T07:17:02.642Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5io0003k0lz4z9ubsbd","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>cert-manager 可以幫助我們在使用 kubernetes 時，可以自動簽發 Let’s Encrypt 憑證，並且搭配 Ingress 做使用。</p>\n<blockquote>\n<p>Let’s Encrypt 憑證有效期限為三個月，三個月到期會自動在重新簽發展延</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<p>本文章使用環境為 GKE 搭配 GKE Ingress 並且使用 HTTP-01 Challenge</p>\n<h2 id=\"安裝-Cert-Manager\"><a href=\"#安裝-Cert-Manager\" class=\"headerlink\" title=\"安裝 Cert-Manager\"></a>安裝 Cert-Manager</h2><p>首先需要在 Cluster 環境內安裝 Cert-Manager 核心元件</p>\n<p>安裝 Cert-Manager，如果有新版本，路徑會不同，這部份可以直接上官方文件查詢</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml</span><br></pre></td></tr></table></figure>\n\n<p>檢查安裝元件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get pods --namespace cert-manager</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">cert-manager-75997f4b44-jsq7z              1/1     Running   0          4m38s</span><br><span class=\"line\">cert-manager-cainjector-769785cd7b-95fcp   1/1     Running   0          4m38s</span><br><span class=\"line\">cert-manager-webhook-6bc9944d78-dnggk      1/1     Running   0          4m38s</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"前製作業\"><a href=\"#前製作業\" class=\"headerlink\" title=\"前製作業\"></a>前製作業</h2><ul>\n<li>先預約 GKE Ingress 用的外網 IP</li>\n<li>設定DNS A紀錄</li>\n</ul>\n<p>確認 cert-manager 要與哪種 Ingress Controller 搭配，可參考以下資料：</p>\n<p><a href=\"https://cert-manager.io/docs/getting-started/\">https://cert-manager.io/docs/getting-started/</a></p>\n<blockquote>\n<p>如果要使用 wildcard 憑證只能用 DNS-01 challenge</p>\n</blockquote>\n<h2 id=\"佈署建議指南\"><a href=\"#佈署建議指南\" class=\"headerlink\" title=\"佈署建議指南\"></a>佈署建議指南</h2><p>本章測試原始碼：<a href=\"https://github.com/winds6206/cert-manager\">https://github.com/winds6206/cert-manager</a></p>\n<h3 id=\"佈署-application-內的-Nginx\"><a href=\"#佈署-application-內的-Nginx\" class=\"headerlink\" title=\"佈署 application 內的 Nginx\"></a>佈署 application 內的 Nginx</h3><p>佈署服務</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ./application/nginx</span><br><span class=\"line\">kubectl apply -f .</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> ./application/nginx-v2</span><br><span class=\"line\">kubectl apply -f .</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"佈署-Ingress-和-NodePort-Service\"><a href=\"#佈署-Ingress-和-NodePort-Service\" class=\"headerlink\" title=\"佈署 Ingress 和 NodePort Service\"></a>佈署 Ingress 和 NodePort Service</h3><p>以 80 為主，先確保可以正確導向到服務</p>\n<p>修改 Ingress 描述檔，並且佈署，域名記得跟著自身測試環境修改：</p>\n<ul>\n<li><code>kubernetes.io/ingress.global-static-ip-name</code> 改成自己預約的IP名稱</li>\n<li><code>kubernetes.io/ingress.allow-http</code> 改成 true</li>\n<li><code>networking.gke.io/v1beta1.FrontendConfig</code> 新增註解</li>\n<li><code>cert-manager.io/issuer</code> 新增註解</li>\n<li>下述片段新增註解<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#tls:</span></span><br><span class=\"line\"><span class=\"comment\">#  - secretName: web-ssl</span></span><br><span class=\"line\"><span class=\"comment\">#    hosts:</span></span><br><span class=\"line\"><span class=\"comment\">#      - cert-manager-demo.example.com</span></span><br><span class=\"line\"><span class=\"comment\">#      - cert-manager-demo-v2.example.com</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p>整體如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cert-manager-demo-external-ingress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.global-static-ip-name:</span> <span class=\"string\">&quot;cert-manager-demo-external-ingress&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.allow-http:</span> <span class=\"string\">&quot;true&quot;</span> <span class=\"comment\"># default is true</span></span><br><span class=\"line\"><span class=\"comment\">#    networking.gke.io/v1beta1.FrontendConfig: &quot;cert-manager-demo-external-ingress-http2https&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">ingressClassName:</span> <span class=\"string\">&quot;gce&quot;</span> <span class=\"comment\"># This tells Google Cloud to create an External Load Balancer to realize this Ingress</span></span><br><span class=\"line\"><span class=\"comment\">#    cert-manager.io/issuer: letsencrypt-production</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"comment\">#  tls:</span></span><br><span class=\"line\"><span class=\"comment\">#    - secretName: web-ssl</span></span><br><span class=\"line\"><span class=\"comment\">#      hosts:</span></span><br><span class=\"line\"><span class=\"comment\">#        - cert-manager-demo.example.com</span></span><br><span class=\"line\"><span class=\"comment\">#        - cert-manager-demo-v2.example.com</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">cert-manager-demo.example.com</span></span><br><span class=\"line\">      <span class=\"attr\">http:</span></span><br><span class=\"line\">        <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/*</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">ImplementationSpecific</span></span><br><span class=\"line\">          <span class=\"attr\">backend:</span></span><br><span class=\"line\">            <span class=\"attr\">service:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">cert-manager-demo-for-external-ingress</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span></span><br><span class=\"line\">                <span class=\"attr\">number:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">cert-manager-demo-v2.example.com</span></span><br><span class=\"line\">      <span class=\"attr\">http:</span></span><br><span class=\"line\">        <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/*</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">ImplementationSpecific</span></span><br><span class=\"line\">          <span class=\"attr\">backend:</span></span><br><span class=\"line\">            <span class=\"attr\">service:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">cert-manager-demo-v2-for-external-ingress</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span></span><br><span class=\"line\">                <span class=\"attr\">number:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n\n<p>佈署服務</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ./ingress</span><br><span class=\"line\">kubectl apply -f svc-external-ingress.yaml</span><br><span class=\"line\">kubectl apply -f cert-manager-demo-external-ingress.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"佈署-issuer-和-secret\"><a href=\"#佈署-issuer-和-secret\" class=\"headerlink\" title=\"佈署 issuer 和 secret\"></a>佈署 issuer 和 secret</h3><p>80 可以正常運行後，再將 issuer 佈署下去做憑證簽發，確認 80 和 443 是否可以分開正常運行</p>\n<p>先修改 Ingress 描述檔，將 cert-manager 相關的設定註解移除，並且重新佈署</p>\n<ul>\n<li><code>cert-manager.io/issuer</code> 註解移除</li>\n<li>下述片段註解移除，域名記得更換<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">tls:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">secretName:</span> <span class=\"string\">web-ssl</span></span><br><span class=\"line\">    <span class=\"attr\">hosts:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">cert-manager-demo.example.com</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">cert-manager-demo-v2.example.com</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p>整體如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cert-manager-demo-external-ingress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.global-static-ip-name:</span> <span class=\"string\">&quot;cert-manager-demo-external-ingress&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.allow-http:</span> <span class=\"string\">&quot;true&quot;</span> <span class=\"comment\"># default is true</span></span><br><span class=\"line\"><span class=\"comment\">#    networking.gke.io/v1beta1.FrontendConfig: &quot;cert-manager-demo-external-ingress-http2https&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">ingressClassName:</span> <span class=\"string\">&quot;gce&quot;</span> <span class=\"comment\"># This tells Google Cloud to create an External Load Balancer to realize this Ingress</span></span><br><span class=\"line\">    <span class=\"attr\">cert-manager.io/issuer:</span> <span class=\"string\">letsencrypt-production</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">tls:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">secretName:</span> <span class=\"string\">web-ssl</span></span><br><span class=\"line\">      <span class=\"attr\">hosts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">cert-manager-demo.example.com</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">cert-manager-demo-v2.example.com</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">cert-manager-demo.example.com</span></span><br><span class=\"line\">      <span class=\"attr\">http:</span></span><br><span class=\"line\">        <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/*</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">ImplementationSpecific</span></span><br><span class=\"line\">          <span class=\"attr\">backend:</span></span><br><span class=\"line\">            <span class=\"attr\">service:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">cert-manager-demo-for-external-ingress</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span></span><br><span class=\"line\">                <span class=\"attr\">number:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">cert-manager-demo-v2.example.com</span></span><br><span class=\"line\">      <span class=\"attr\">http:</span></span><br><span class=\"line\">        <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/*</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">ImplementationSpecific</span></span><br><span class=\"line\">          <span class=\"attr\">backend:</span></span><br><span class=\"line\">            <span class=\"attr\">service:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">cert-manager-demo-v2-for-external-ingress</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span></span><br><span class=\"line\">                <span class=\"attr\">number:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n\n<p>調整 issuer 描述檔，將 <code>spec.acme.email</code> 填入自己正確的 E-mail，再將 issuer 和 secret 佈署下去</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f issuer.yaml</span><br><span class=\"line\">kubectl apply -f secret.yaml</span><br></pre></td></tr></table></figure>\n\n<p>憑證簽發狀態可以使用 <code>kubectl describe issuers.cert-manager.io [Issuer_Name]</code> 去確認，也可以使用 <code>kubectl get certificate</code> 去確認是否 READY</p>\n<p>確認簽證後，看看 80 跟 443 能不能正常存取網頁</p>\n<h3 id=\"附加-https-跳轉功能\"><a href=\"#附加-https-跳轉功能\" class=\"headerlink\" title=\"附加 https 跳轉功能\"></a>附加 https 跳轉功能</h3><p>最後將 http 自動跳轉 https 功能加上</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ./ingress</span><br><span class=\"line\">kubectl apply -f frontend-config.yaml</span><br></pre></td></tr></table></figure>\n\n<p>修改 Ingress 描述檔，並且重新佈署</p>\n<ul>\n<li><code>networking.gke.io/v1beta1.FrontendConfig</code> 移除註解</li>\n</ul>\n<p>整體如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cert-manager-demo-external-ingress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.global-static-ip-name:</span> <span class=\"string\">&quot;cert-manager-demo-external-ingress&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.allow-http:</span> <span class=\"string\">&quot;true&quot;</span> <span class=\"comment\"># default is true</span></span><br><span class=\"line\">    <span class=\"attr\">networking.gke.io/v1beta1.FrontendConfig:</span> <span class=\"string\">&quot;cert-manager-demo-external-ingress-http2https&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">ingressClassName:</span> <span class=\"string\">&quot;gce&quot;</span> <span class=\"comment\"># This tells Google Cloud to create an External Load Balancer to realize this Ingress</span></span><br><span class=\"line\">    <span class=\"attr\">cert-manager.io/issuer:</span> <span class=\"string\">letsencrypt-production</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"string\">...</span></span><br></pre></td></tr></table></figure>\n\n<p>測試 80 是否可以自動跳轉 443，這樣整個功能就完成囉</p>\n<h2 id=\"Q-amp-A\"><a href=\"#Q-amp-A\" class=\"headerlink\" title=\"Q&amp;A\"></a>Q&amp;A</h2><ul>\n<li>Issuer vs ClusterIssuer</li>\n<li>Let’s Encrypt Issuer production vs staging</li>\n<li>Issuer 中 E-mail 的作用</li>\n</ul>\n<h3 id=\"Issuer-和-ClusterIssuer-差異\"><a href=\"#Issuer-和-ClusterIssuer-差異\" class=\"headerlink\" title=\"Issuer 和 ClusterIssuer 差異\"></a>Issuer 和 ClusterIssuer 差異</h3><p>cert-manager 分為兩種 Issuer，分別為 Issuer 和 ClusterIssuer。</p>\n<p>兩者的差異就在於 Issuer 只能在單一 Namespace 使用，而 ClusterIssuer 屬於 cluster-wide 也就是說每個 Namespace 都可以 reference 到。</p>\n<p>兩者於 Manifest 的寫法差異僅在於 <code>kind</code> 與 <code>namespace</code>，如下參考</p>\n<p>Issuer</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">cert-manager.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Issuer</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">letsencrypt-production</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">acme:</span></span><br><span class=\"line\">    <span class=\"comment\"># The ACME server URL</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"string\">https://acme-v02.api.letsencrypt.org/directory</span></span><br><span class=\"line\">    <span class=\"comment\"># Email address used for ACME registration</span></span><br><span class=\"line\">    <span class=\"attr\">email:</span> <span class=\"string\">tony@example.com</span></span><br><span class=\"line\">    <span class=\"comment\"># Name of a secret used to store the ACME account private key</span></span><br><span class=\"line\">    <span class=\"attr\">privateKeySecretRef:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">letsencrypt-production</span></span><br><span class=\"line\">    <span class=\"comment\"># Enable the HTTP-01 challenge provider</span></span><br><span class=\"line\">    <span class=\"attr\">solvers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">http01:</span></span><br><span class=\"line\">        <span class=\"attr\">ingress:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">example-ingress</span></span><br></pre></td></tr></table></figure>\n\n<p>ClusterIssuer </p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">cert-manager.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterIssuer</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">letsencrypt-production</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">acme:</span></span><br><span class=\"line\">    <span class=\"comment\"># The ACME server URL</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"string\">https://acme-v02.api.letsencrypt.org/directory</span></span><br><span class=\"line\">    <span class=\"comment\"># Email address used for ACME registration</span></span><br><span class=\"line\">    <span class=\"attr\">email:</span> <span class=\"string\">tony@example.com</span></span><br><span class=\"line\">    <span class=\"comment\"># Name of a secret used to store the ACME account private key</span></span><br><span class=\"line\">    <span class=\"attr\">privateKeySecretRef:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">letsencrypt-production</span></span><br><span class=\"line\">    <span class=\"comment\"># Enable the HTTP-01 challenge provider</span></span><br><span class=\"line\">    <span class=\"attr\">solvers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">http01:</span></span><br><span class=\"line\">        <span class=\"attr\">ingress:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">example-ingress</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Let’s-Encrypt-Issuer-production-和-staging-差異\"><a href=\"#Let’s-Encrypt-Issuer-production-和-staging-差異\" class=\"headerlink\" title=\"Let’s Encrypt Issuer production 和 staging 差異\"></a>Let’s Encrypt Issuer production 和 staging 差異</h3><p>Let’s Encrypt Issuer 分為 production 和 staging，兩者最大的差別在於 rate limits，production 有相當嚴格的 rate limits，如果是在測試階段很可能不小心就頂到限制，所以在測試階段建議先以 staging 來測試，確定沒問題後，在切換到 production。</p>\n<p>使用 staging 簽發出來的憑證依然屬於 untrusted certificates</p>\n<blockquote>\n<p>Note that you’ll see a warning about untrusted certificates from the staging issuer, but that’s totally expected.</p>\n</blockquote>\n<p>production 和 staging 的 ACME server URL 如下：</p>\n<ul>\n<li>production：<a href=\"https://acme-v02.api.letsencrypt.org/directory\">https://acme-v02.api.letsencrypt.org/directory</a></li>\n<li>staging：<a href=\"https://acme-staging-v02.api.letsencrypt.org/directory\">https://acme-staging-v02.api.letsencrypt.org/directory</a></li>\n</ul>\n<h3 id=\"Issuer-中-E-mail-的作用\"><a href=\"#Issuer-中-E-mail-的作用\" class=\"headerlink\" title=\"Issuer 中 E-mail 的作用\"></a>Issuer 中 E-mail 的作用</h3><p>憑證註冊時會使用該組 E-mail 做註冊，並且在憑證即將到期時通知該組 E-mail</p>\n<blockquote>\n<p>This email is required by Let’s Encrypt and used to notify you of certificate expiration and updates.</p>\n</blockquote>\n<h3 id=\"Issuer-secret-與-Ingress-之間如何產生關聯\"><a href=\"#Issuer-secret-與-Ingress-之間如何產生關聯\" class=\"headerlink\" title=\"Issuer, secret 與 Ingress 之間如何產生關聯\"></a>Issuer, secret 與 Ingress 之間如何產生關聯</h3><p>在 GKE Ingress 的 Manifest 中有以下兩段：</p>\n<ul>\n<li><code>metadata.annotations.cert-manager.io/issuer</code></li>\n<li><code>spec.tls.secretName</code></li>\n</ul>\n<p>這兩段分別對應 Issuer 和 secret，當我們將 Issuer 和 secret 佈署後，在 certificate object 中會自動建立一個與 secret 同名的物件，透過 <code>describe certificate</code> 就可以發現到，系統會自動將先前建立的物件進行關聯。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl describe certificate [Certificate_Name]</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">省略...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">Spec:</span></span><br><span class=\"line\">  <span class=\"attr\">Dns Names:</span></span><br><span class=\"line\">    <span class=\"string\">ingress-nginx-demo.twister5-tc.website</span></span><br><span class=\"line\">  <span class=\"attr\">Issuer Ref:</span></span><br><span class=\"line\">    <span class=\"attr\">Group:</span>      <span class=\"string\">cert-manager.io</span></span><br><span class=\"line\">    <span class=\"attr\">Kind:</span>       <span class=\"string\">Issuer</span></span><br><span class=\"line\">    <span class=\"attr\">Name:</span>       <span class=\"string\">ingress-nginx-demo-external-ingress-letsencrypt-production</span></span><br><span class=\"line\">  <span class=\"attr\">Secret Name:</span>  <span class=\"string\">ingress-nginx-demo-external-ingress-ssl</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">省略...</span></span><br></pre></td></tr></table></figure>\n\n<p>從這邊我們可以很清楚的看到，<code>Spec.Issuer Ref.Name</code> 與 <code>Spec.Secret Name</code> 是有順利關聯起來</p>\n<p>當 Issuer 順利簽發出憑證後，會依據自身的 Manifest <code>spec.acme.privateKeySecretRef.name</code> 建立相對應名稱的 secret 並且將憑證內容儲存於此。</p>\n<p>前面有提到 Ingress 的描述檔內也有 Issuer 和 secret 的資訊，自然而然三者就會互相進行關聯。</p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://cert-manager.io/docs/installation/kubectl/\">https://cert-manager.io/docs/installation/kubectl/</a></li>\n<li><a href=\"https://cert-manager.io/docs/getting-started/\">https://cert-manager.io/docs/getting-started/</a></li>\n<li><a href=\"https://cert-manager.io/docs/tutorials/getting-started-with-cert-manager-on-google-kubernetes-engine-using-lets-encrypt-for-ingress-ssl/\">https://cert-manager.io/docs/tutorials/getting-started-with-cert-manager-on-google-kubernetes-engine-using-lets-encrypt-for-ingress-ssl/</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>cert-manager 可以幫助我們在使用 kubernetes 時，可以自動簽發 Let’s Encrypt 憑證，並且搭配 Ingress 做使用。</p>\n<blockquote>\n<p>Let’s Encrypt 憑證有效期限為三個月，三個月到期會自動在重新簽發展延</p>\n</blockquote>","more":"<p>本文章使用環境為 GKE 搭配 GKE Ingress 並且使用 HTTP-01 Challenge</p>\n<h2 id=\"安裝-Cert-Manager\"><a href=\"#安裝-Cert-Manager\" class=\"headerlink\" title=\"安裝 Cert-Manager\"></a>安裝 Cert-Manager</h2><p>首先需要在 Cluster 環境內安裝 Cert-Manager 核心元件</p>\n<p>安裝 Cert-Manager，如果有新版本，路徑會不同，這部份可以直接上官方文件查詢</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml</span><br></pre></td></tr></table></figure>\n\n<p>檢查安裝元件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get pods --namespace cert-manager</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">cert-manager-75997f4b44-jsq7z              1/1     Running   0          4m38s</span><br><span class=\"line\">cert-manager-cainjector-769785cd7b-95fcp   1/1     Running   0          4m38s</span><br><span class=\"line\">cert-manager-webhook-6bc9944d78-dnggk      1/1     Running   0          4m38s</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"前製作業\"><a href=\"#前製作業\" class=\"headerlink\" title=\"前製作業\"></a>前製作業</h2><ul>\n<li>先預約 GKE Ingress 用的外網 IP</li>\n<li>設定DNS A紀錄</li>\n</ul>\n<p>確認 cert-manager 要與哪種 Ingress Controller 搭配，可參考以下資料：</p>\n<p><a href=\"https://cert-manager.io/docs/getting-started/\">https://cert-manager.io/docs/getting-started/</a></p>\n<blockquote>\n<p>如果要使用 wildcard 憑證只能用 DNS-01 challenge</p>\n</blockquote>\n<h2 id=\"佈署建議指南\"><a href=\"#佈署建議指南\" class=\"headerlink\" title=\"佈署建議指南\"></a>佈署建議指南</h2><p>本章測試原始碼：<a href=\"https://github.com/winds6206/cert-manager\">https://github.com/winds6206/cert-manager</a></p>\n<h3 id=\"佈署-application-內的-Nginx\"><a href=\"#佈署-application-內的-Nginx\" class=\"headerlink\" title=\"佈署 application 內的 Nginx\"></a>佈署 application 內的 Nginx</h3><p>佈署服務</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ./application/nginx</span><br><span class=\"line\">kubectl apply -f .</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> ./application/nginx-v2</span><br><span class=\"line\">kubectl apply -f .</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"佈署-Ingress-和-NodePort-Service\"><a href=\"#佈署-Ingress-和-NodePort-Service\" class=\"headerlink\" title=\"佈署 Ingress 和 NodePort Service\"></a>佈署 Ingress 和 NodePort Service</h3><p>以 80 為主，先確保可以正確導向到服務</p>\n<p>修改 Ingress 描述檔，並且佈署，域名記得跟著自身測試環境修改：</p>\n<ul>\n<li><code>kubernetes.io/ingress.global-static-ip-name</code> 改成自己預約的IP名稱</li>\n<li><code>kubernetes.io/ingress.allow-http</code> 改成 true</li>\n<li><code>networking.gke.io/v1beta1.FrontendConfig</code> 新增註解</li>\n<li><code>cert-manager.io/issuer</code> 新增註解</li>\n<li>下述片段新增註解<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#tls:</span></span><br><span class=\"line\"><span class=\"comment\">#  - secretName: web-ssl</span></span><br><span class=\"line\"><span class=\"comment\">#    hosts:</span></span><br><span class=\"line\"><span class=\"comment\">#      - cert-manager-demo.example.com</span></span><br><span class=\"line\"><span class=\"comment\">#      - cert-manager-demo-v2.example.com</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p>整體如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cert-manager-demo-external-ingress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.global-static-ip-name:</span> <span class=\"string\">&quot;cert-manager-demo-external-ingress&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.allow-http:</span> <span class=\"string\">&quot;true&quot;</span> <span class=\"comment\"># default is true</span></span><br><span class=\"line\"><span class=\"comment\">#    networking.gke.io/v1beta1.FrontendConfig: &quot;cert-manager-demo-external-ingress-http2https&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">ingressClassName:</span> <span class=\"string\">&quot;gce&quot;</span> <span class=\"comment\"># This tells Google Cloud to create an External Load Balancer to realize this Ingress</span></span><br><span class=\"line\"><span class=\"comment\">#    cert-manager.io/issuer: letsencrypt-production</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"comment\">#  tls:</span></span><br><span class=\"line\"><span class=\"comment\">#    - secretName: web-ssl</span></span><br><span class=\"line\"><span class=\"comment\">#      hosts:</span></span><br><span class=\"line\"><span class=\"comment\">#        - cert-manager-demo.example.com</span></span><br><span class=\"line\"><span class=\"comment\">#        - cert-manager-demo-v2.example.com</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">cert-manager-demo.example.com</span></span><br><span class=\"line\">      <span class=\"attr\">http:</span></span><br><span class=\"line\">        <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/*</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">ImplementationSpecific</span></span><br><span class=\"line\">          <span class=\"attr\">backend:</span></span><br><span class=\"line\">            <span class=\"attr\">service:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">cert-manager-demo-for-external-ingress</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span></span><br><span class=\"line\">                <span class=\"attr\">number:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">cert-manager-demo-v2.example.com</span></span><br><span class=\"line\">      <span class=\"attr\">http:</span></span><br><span class=\"line\">        <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/*</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">ImplementationSpecific</span></span><br><span class=\"line\">          <span class=\"attr\">backend:</span></span><br><span class=\"line\">            <span class=\"attr\">service:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">cert-manager-demo-v2-for-external-ingress</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span></span><br><span class=\"line\">                <span class=\"attr\">number:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n\n<p>佈署服務</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ./ingress</span><br><span class=\"line\">kubectl apply -f svc-external-ingress.yaml</span><br><span class=\"line\">kubectl apply -f cert-manager-demo-external-ingress.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"佈署-issuer-和-secret\"><a href=\"#佈署-issuer-和-secret\" class=\"headerlink\" title=\"佈署 issuer 和 secret\"></a>佈署 issuer 和 secret</h3><p>80 可以正常運行後，再將 issuer 佈署下去做憑證簽發，確認 80 和 443 是否可以分開正常運行</p>\n<p>先修改 Ingress 描述檔，將 cert-manager 相關的設定註解移除，並且重新佈署</p>\n<ul>\n<li><code>cert-manager.io/issuer</code> 註解移除</li>\n<li>下述片段註解移除，域名記得更換<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">tls:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">secretName:</span> <span class=\"string\">web-ssl</span></span><br><span class=\"line\">    <span class=\"attr\">hosts:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">cert-manager-demo.example.com</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">cert-manager-demo-v2.example.com</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p>整體如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cert-manager-demo-external-ingress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.global-static-ip-name:</span> <span class=\"string\">&quot;cert-manager-demo-external-ingress&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.allow-http:</span> <span class=\"string\">&quot;true&quot;</span> <span class=\"comment\"># default is true</span></span><br><span class=\"line\"><span class=\"comment\">#    networking.gke.io/v1beta1.FrontendConfig: &quot;cert-manager-demo-external-ingress-http2https&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">ingressClassName:</span> <span class=\"string\">&quot;gce&quot;</span> <span class=\"comment\"># This tells Google Cloud to create an External Load Balancer to realize this Ingress</span></span><br><span class=\"line\">    <span class=\"attr\">cert-manager.io/issuer:</span> <span class=\"string\">letsencrypt-production</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">tls:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">secretName:</span> <span class=\"string\">web-ssl</span></span><br><span class=\"line\">      <span class=\"attr\">hosts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">cert-manager-demo.example.com</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">cert-manager-demo-v2.example.com</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">cert-manager-demo.example.com</span></span><br><span class=\"line\">      <span class=\"attr\">http:</span></span><br><span class=\"line\">        <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/*</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">ImplementationSpecific</span></span><br><span class=\"line\">          <span class=\"attr\">backend:</span></span><br><span class=\"line\">            <span class=\"attr\">service:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">cert-manager-demo-for-external-ingress</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span></span><br><span class=\"line\">                <span class=\"attr\">number:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">cert-manager-demo-v2.example.com</span></span><br><span class=\"line\">      <span class=\"attr\">http:</span></span><br><span class=\"line\">        <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/*</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">ImplementationSpecific</span></span><br><span class=\"line\">          <span class=\"attr\">backend:</span></span><br><span class=\"line\">            <span class=\"attr\">service:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">cert-manager-demo-v2-for-external-ingress</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span></span><br><span class=\"line\">                <span class=\"attr\">number:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n\n<p>調整 issuer 描述檔，將 <code>spec.acme.email</code> 填入自己正確的 E-mail，再將 issuer 和 secret 佈署下去</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f issuer.yaml</span><br><span class=\"line\">kubectl apply -f secret.yaml</span><br></pre></td></tr></table></figure>\n\n<p>憑證簽發狀態可以使用 <code>kubectl describe issuers.cert-manager.io [Issuer_Name]</code> 去確認，也可以使用 <code>kubectl get certificate</code> 去確認是否 READY</p>\n<p>確認簽證後，看看 80 跟 443 能不能正常存取網頁</p>\n<h3 id=\"附加-https-跳轉功能\"><a href=\"#附加-https-跳轉功能\" class=\"headerlink\" title=\"附加 https 跳轉功能\"></a>附加 https 跳轉功能</h3><p>最後將 http 自動跳轉 https 功能加上</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ./ingress</span><br><span class=\"line\">kubectl apply -f frontend-config.yaml</span><br></pre></td></tr></table></figure>\n\n<p>修改 Ingress 描述檔，並且重新佈署</p>\n<ul>\n<li><code>networking.gke.io/v1beta1.FrontendConfig</code> 移除註解</li>\n</ul>\n<p>整體如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cert-manager-demo-external-ingress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.global-static-ip-name:</span> <span class=\"string\">&quot;cert-manager-demo-external-ingress&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.allow-http:</span> <span class=\"string\">&quot;true&quot;</span> <span class=\"comment\"># default is true</span></span><br><span class=\"line\">    <span class=\"attr\">networking.gke.io/v1beta1.FrontendConfig:</span> <span class=\"string\">&quot;cert-manager-demo-external-ingress-http2https&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">ingressClassName:</span> <span class=\"string\">&quot;gce&quot;</span> <span class=\"comment\"># This tells Google Cloud to create an External Load Balancer to realize this Ingress</span></span><br><span class=\"line\">    <span class=\"attr\">cert-manager.io/issuer:</span> <span class=\"string\">letsencrypt-production</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"string\">...</span></span><br></pre></td></tr></table></figure>\n\n<p>測試 80 是否可以自動跳轉 443，這樣整個功能就完成囉</p>\n<h2 id=\"Q-amp-A\"><a href=\"#Q-amp-A\" class=\"headerlink\" title=\"Q&amp;A\"></a>Q&amp;A</h2><ul>\n<li>Issuer vs ClusterIssuer</li>\n<li>Let’s Encrypt Issuer production vs staging</li>\n<li>Issuer 中 E-mail 的作用</li>\n</ul>\n<h3 id=\"Issuer-和-ClusterIssuer-差異\"><a href=\"#Issuer-和-ClusterIssuer-差異\" class=\"headerlink\" title=\"Issuer 和 ClusterIssuer 差異\"></a>Issuer 和 ClusterIssuer 差異</h3><p>cert-manager 分為兩種 Issuer，分別為 Issuer 和 ClusterIssuer。</p>\n<p>兩者的差異就在於 Issuer 只能在單一 Namespace 使用，而 ClusterIssuer 屬於 cluster-wide 也就是說每個 Namespace 都可以 reference 到。</p>\n<p>兩者於 Manifest 的寫法差異僅在於 <code>kind</code> 與 <code>namespace</code>，如下參考</p>\n<p>Issuer</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">cert-manager.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Issuer</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">letsencrypt-production</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">acme:</span></span><br><span class=\"line\">    <span class=\"comment\"># The ACME server URL</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"string\">https://acme-v02.api.letsencrypt.org/directory</span></span><br><span class=\"line\">    <span class=\"comment\"># Email address used for ACME registration</span></span><br><span class=\"line\">    <span class=\"attr\">email:</span> <span class=\"string\">tony@example.com</span></span><br><span class=\"line\">    <span class=\"comment\"># Name of a secret used to store the ACME account private key</span></span><br><span class=\"line\">    <span class=\"attr\">privateKeySecretRef:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">letsencrypt-production</span></span><br><span class=\"line\">    <span class=\"comment\"># Enable the HTTP-01 challenge provider</span></span><br><span class=\"line\">    <span class=\"attr\">solvers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">http01:</span></span><br><span class=\"line\">        <span class=\"attr\">ingress:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">example-ingress</span></span><br></pre></td></tr></table></figure>\n\n<p>ClusterIssuer </p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">cert-manager.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterIssuer</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">letsencrypt-production</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">acme:</span></span><br><span class=\"line\">    <span class=\"comment\"># The ACME server URL</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"string\">https://acme-v02.api.letsencrypt.org/directory</span></span><br><span class=\"line\">    <span class=\"comment\"># Email address used for ACME registration</span></span><br><span class=\"line\">    <span class=\"attr\">email:</span> <span class=\"string\">tony@example.com</span></span><br><span class=\"line\">    <span class=\"comment\"># Name of a secret used to store the ACME account private key</span></span><br><span class=\"line\">    <span class=\"attr\">privateKeySecretRef:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">letsencrypt-production</span></span><br><span class=\"line\">    <span class=\"comment\"># Enable the HTTP-01 challenge provider</span></span><br><span class=\"line\">    <span class=\"attr\">solvers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">http01:</span></span><br><span class=\"line\">        <span class=\"attr\">ingress:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">example-ingress</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Let’s-Encrypt-Issuer-production-和-staging-差異\"><a href=\"#Let’s-Encrypt-Issuer-production-和-staging-差異\" class=\"headerlink\" title=\"Let’s Encrypt Issuer production 和 staging 差異\"></a>Let’s Encrypt Issuer production 和 staging 差異</h3><p>Let’s Encrypt Issuer 分為 production 和 staging，兩者最大的差別在於 rate limits，production 有相當嚴格的 rate limits，如果是在測試階段很可能不小心就頂到限制，所以在測試階段建議先以 staging 來測試，確定沒問題後，在切換到 production。</p>\n<p>使用 staging 簽發出來的憑證依然屬於 untrusted certificates</p>\n<blockquote>\n<p>Note that you’ll see a warning about untrusted certificates from the staging issuer, but that’s totally expected.</p>\n</blockquote>\n<p>production 和 staging 的 ACME server URL 如下：</p>\n<ul>\n<li>production：<a href=\"https://acme-v02.api.letsencrypt.org/directory\">https://acme-v02.api.letsencrypt.org/directory</a></li>\n<li>staging：<a href=\"https://acme-staging-v02.api.letsencrypt.org/directory\">https://acme-staging-v02.api.letsencrypt.org/directory</a></li>\n</ul>\n<h3 id=\"Issuer-中-E-mail-的作用\"><a href=\"#Issuer-中-E-mail-的作用\" class=\"headerlink\" title=\"Issuer 中 E-mail 的作用\"></a>Issuer 中 E-mail 的作用</h3><p>憑證註冊時會使用該組 E-mail 做註冊，並且在憑證即將到期時通知該組 E-mail</p>\n<blockquote>\n<p>This email is required by Let’s Encrypt and used to notify you of certificate expiration and updates.</p>\n</blockquote>\n<h3 id=\"Issuer-secret-與-Ingress-之間如何產生關聯\"><a href=\"#Issuer-secret-與-Ingress-之間如何產生關聯\" class=\"headerlink\" title=\"Issuer, secret 與 Ingress 之間如何產生關聯\"></a>Issuer, secret 與 Ingress 之間如何產生關聯</h3><p>在 GKE Ingress 的 Manifest 中有以下兩段：</p>\n<ul>\n<li><code>metadata.annotations.cert-manager.io/issuer</code></li>\n<li><code>spec.tls.secretName</code></li>\n</ul>\n<p>這兩段分別對應 Issuer 和 secret，當我們將 Issuer 和 secret 佈署後，在 certificate object 中會自動建立一個與 secret 同名的物件，透過 <code>describe certificate</code> 就可以發現到，系統會自動將先前建立的物件進行關聯。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl describe certificate [Certificate_Name]</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">省略...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">Spec:</span></span><br><span class=\"line\">  <span class=\"attr\">Dns Names:</span></span><br><span class=\"line\">    <span class=\"string\">ingress-nginx-demo.twister5-tc.website</span></span><br><span class=\"line\">  <span class=\"attr\">Issuer Ref:</span></span><br><span class=\"line\">    <span class=\"attr\">Group:</span>      <span class=\"string\">cert-manager.io</span></span><br><span class=\"line\">    <span class=\"attr\">Kind:</span>       <span class=\"string\">Issuer</span></span><br><span class=\"line\">    <span class=\"attr\">Name:</span>       <span class=\"string\">ingress-nginx-demo-external-ingress-letsencrypt-production</span></span><br><span class=\"line\">  <span class=\"attr\">Secret Name:</span>  <span class=\"string\">ingress-nginx-demo-external-ingress-ssl</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">省略...</span></span><br></pre></td></tr></table></figure>\n\n<p>從這邊我們可以很清楚的看到，<code>Spec.Issuer Ref.Name</code> 與 <code>Spec.Secret Name</code> 是有順利關聯起來</p>\n<p>當 Issuer 順利簽發出憑證後，會依據自身的 Manifest <code>spec.acme.privateKeySecretRef.name</code> 建立相對應名稱的 secret 並且將憑證內容儲存於此。</p>\n<p>前面有提到 Ingress 的描述檔內也有 Issuer 和 secret 的資訊，自然而然三者就會互相進行關聯。</p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://cert-manager.io/docs/installation/kubectl/\">https://cert-manager.io/docs/installation/kubectl/</a></li>\n<li><a href=\"https://cert-manager.io/docs/getting-started/\">https://cert-manager.io/docs/getting-started/</a></li>\n<li><a href=\"https://cert-manager.io/docs/tutorials/getting-started-with-cert-manager-on-google-kubernetes-engine-using-lets-encrypt-for-ingress-ssl/\">https://cert-manager.io/docs/tutorials/getting-started-with-cert-manager-on-google-kubernetes-engine-using-lets-encrypt-for-ingress-ssl/</a></li>\n</ul>"},{"title":"hexo-filter-nofollow","abbrlink":"ad859434","_content":"\n## 前言\n\nhexo-filter-nofollow 套件可以讓搜尋引擎的 sipder 來爬取站點內容時，不要因為有外部連結的內容，而導致 spider 直接跑到外部連結去，這有可能導致 sipder 不會再回頭了。\n\nhexo-filter-nofollow 可以自動幫我們在外部連結加上 `rel=\"noopener external nofollow noreferrer\"` 的屬性，以便防止這樣的遺憾發生。\n\n<!-- more -->\n\n## hexo-filter-nofollow 的使用\n\n### 安裝與確認\n\n安裝指令\n\n```bash\nnpm install hexo-filter-nofollow --save\n```\n\n確認是否有正確安裝\n\n```bash\nnpm list | grep \"hexo-filter-nofollow\"\n```\n\n也可以直接到 node_module 目錄底下去看有沒有 hexo-abbrlink 套件\n\n```bash\ncd ./node_modules\nls | grep \"hexo-filter-nofollow\"\n```\n\n### 設定檔調整\n\n編輯設定檔\n\n```bash\nvim ./_config.yml\n```\n\n新增以下片段\n```\nnofollow:\n  enable: true\n  field: site\n  exclude:\n    - 'exclude1.com'\n    - 'exclude2.com'\n```\n\n選項說明就直接引用 [GitHub](https://github.com/hexojs/hexo-filter-nofollow) 上的說明，如果有要排除的域名，可以寫在 exclude，如果沒用到就註解掉\n\n- enable - Enable the plugin. Default value is `true`.\n- field - The scope you want the plugin to proceed, can be 'site' or 'post'. Default value is site.\n  - 'post' - Only add nofollow attribute to external links in your post content\n  - 'site' - Add nofollow attribute to external links of whole sites\n- exclude - Exclude hostname. Specify subdomain when applicable, including www.\n  - 'exclude1.com' does not apply to www.exclude1.com nor en.exclude1.com.\n\n## 參考資料\n\n- https://github.com/hexojs/hexo-filter-nofollow","source":"_drafts/hexo-filter-nofollow.md","raw":"---\ntitle: hexo-filter-nofollow\ntags:\n  - Hexo\n  - blog\ncategories:\n  - Hexo\nabbrlink: ad859434\n---\n\n## 前言\n\nhexo-filter-nofollow 套件可以讓搜尋引擎的 sipder 來爬取站點內容時，不要因為有外部連結的內容，而導致 spider 直接跑到外部連結去，這有可能導致 sipder 不會再回頭了。\n\nhexo-filter-nofollow 可以自動幫我們在外部連結加上 `rel=\"noopener external nofollow noreferrer\"` 的屬性，以便防止這樣的遺憾發生。\n\n<!-- more -->\n\n## hexo-filter-nofollow 的使用\n\n### 安裝與確認\n\n安裝指令\n\n```bash\nnpm install hexo-filter-nofollow --save\n```\n\n確認是否有正確安裝\n\n```bash\nnpm list | grep \"hexo-filter-nofollow\"\n```\n\n也可以直接到 node_module 目錄底下去看有沒有 hexo-abbrlink 套件\n\n```bash\ncd ./node_modules\nls | grep \"hexo-filter-nofollow\"\n```\n\n### 設定檔調整\n\n編輯設定檔\n\n```bash\nvim ./_config.yml\n```\n\n新增以下片段\n```\nnofollow:\n  enable: true\n  field: site\n  exclude:\n    - 'exclude1.com'\n    - 'exclude2.com'\n```\n\n選項說明就直接引用 [GitHub](https://github.com/hexojs/hexo-filter-nofollow) 上的說明，如果有要排除的域名，可以寫在 exclude，如果沒用到就註解掉\n\n- enable - Enable the plugin. Default value is `true`.\n- field - The scope you want the plugin to proceed, can be 'site' or 'post'. Default value is site.\n  - 'post' - Only add nofollow attribute to external links in your post content\n  - 'site' - Add nofollow attribute to external links of whole sites\n- exclude - Exclude hostname. Specify subdomain when applicable, including www.\n  - 'exclude1.com' does not apply to www.exclude1.com nor en.exclude1.com.\n\n## 參考資料\n\n- https://github.com/hexojs/hexo-filter-nofollow","slug":"hexo-filter-nofollow","published":0,"date":"2024-09-09T07:17:02.642Z","updated":"2024-09-09T07:17:02.643Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5is0007k0lz4taafnwh","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>hexo-filter-nofollow 套件可以讓搜尋引擎的 sipder 來爬取站點內容時，不要因為有外部連結的內容，而導致 spider 直接跑到外部連結去，這有可能導致 sipder 不會再回頭了。</p>\n<p>hexo-filter-nofollow 可以自動幫我們在外部連結加上 <code>rel=&quot;noopener external nofollow noreferrer&quot;</code> 的屬性，以便防止這樣的遺憾發生。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"hexo-filter-nofollow-的使用\"><a href=\"#hexo-filter-nofollow-的使用\" class=\"headerlink\" title=\"hexo-filter-nofollow 的使用\"></a>hexo-filter-nofollow 的使用</h2><h3 id=\"安裝與確認\"><a href=\"#安裝與確認\" class=\"headerlink\" title=\"安裝與確認\"></a>安裝與確認</h3><p>安裝指令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install hexo-filter-nofollow --save</span><br></pre></td></tr></table></figure>\n\n<p>確認是否有正確安裝</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm list | grep <span class=\"string\">&quot;hexo-filter-nofollow&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>也可以直接到 node_module 目錄底下去看有沒有 hexo-abbrlink 套件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ./node_modules</span><br><span class=\"line\">ls | grep <span class=\"string\">&quot;hexo-filter-nofollow&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"設定檔調整\"><a href=\"#設定檔調整\" class=\"headerlink\" title=\"設定檔調整\"></a>設定檔調整</h3><p>編輯設定檔</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim ./_config.yml</span><br></pre></td></tr></table></figure>\n\n<p>新增以下片段</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nofollow:</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\">  field: site</span><br><span class=\"line\">  exclude:</span><br><span class=\"line\">    - &#39;exclude1.com&#39;</span><br><span class=\"line\">    - &#39;exclude2.com&#39;</span><br></pre></td></tr></table></figure>\n\n<p>選項說明就直接引用 <a href=\"https://github.com/hexojs/hexo-filter-nofollow\">GitHub</a> 上的說明，如果有要排除的域名，可以寫在 exclude，如果沒用到就註解掉</p>\n<ul>\n<li>enable - Enable the plugin. Default value is <code>true</code>.</li>\n<li>field - The scope you want the plugin to proceed, can be ‘site’ or ‘post’. Default value is site.<ul>\n<li>‘post’ - Only add nofollow attribute to external links in your post content</li>\n<li>‘site’ - Add nofollow attribute to external links of whole sites</li>\n</ul>\n</li>\n<li>exclude - Exclude hostname. Specify subdomain when applicable, including www.<ul>\n<li>‘exclude1.com’ does not apply to <a href=\"http://www.exclude1.com/\">www.exclude1.com</a> nor en.exclude1.com.</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://github.com/hexojs/hexo-filter-nofollow\">https://github.com/hexojs/hexo-filter-nofollow</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>hexo-filter-nofollow 套件可以讓搜尋引擎的 sipder 來爬取站點內容時，不要因為有外部連結的內容，而導致 spider 直接跑到外部連結去，這有可能導致 sipder 不會再回頭了。</p>\n<p>hexo-filter-nofollow 可以自動幫我們在外部連結加上 <code>rel=&quot;noopener external nofollow noreferrer&quot;</code> 的屬性，以便防止這樣的遺憾發生。</p>","more":"<h2 id=\"hexo-filter-nofollow-的使用\"><a href=\"#hexo-filter-nofollow-的使用\" class=\"headerlink\" title=\"hexo-filter-nofollow 的使用\"></a>hexo-filter-nofollow 的使用</h2><h3 id=\"安裝與確認\"><a href=\"#安裝與確認\" class=\"headerlink\" title=\"安裝與確認\"></a>安裝與確認</h3><p>安裝指令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install hexo-filter-nofollow --save</span><br></pre></td></tr></table></figure>\n\n<p>確認是否有正確安裝</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm list | grep <span class=\"string\">&quot;hexo-filter-nofollow&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>也可以直接到 node_module 目錄底下去看有沒有 hexo-abbrlink 套件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ./node_modules</span><br><span class=\"line\">ls | grep <span class=\"string\">&quot;hexo-filter-nofollow&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"設定檔調整\"><a href=\"#設定檔調整\" class=\"headerlink\" title=\"設定檔調整\"></a>設定檔調整</h3><p>編輯設定檔</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim ./_config.yml</span><br></pre></td></tr></table></figure>\n\n<p>新增以下片段</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nofollow:</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\">  field: site</span><br><span class=\"line\">  exclude:</span><br><span class=\"line\">    - &#39;exclude1.com&#39;</span><br><span class=\"line\">    - &#39;exclude2.com&#39;</span><br></pre></td></tr></table></figure>\n\n<p>選項說明就直接引用 <a href=\"https://github.com/hexojs/hexo-filter-nofollow\">GitHub</a> 上的說明，如果有要排除的域名，可以寫在 exclude，如果沒用到就註解掉</p>\n<ul>\n<li>enable - Enable the plugin. Default value is <code>true</code>.</li>\n<li>field - The scope you want the plugin to proceed, can be ‘site’ or ‘post’. Default value is site.<ul>\n<li>‘post’ - Only add nofollow attribute to external links in your post content</li>\n<li>‘site’ - Add nofollow attribute to external links of whole sites</li>\n</ul>\n</li>\n<li>exclude - Exclude hostname. Specify subdomain when applicable, including www.<ul>\n<li>‘exclude1.com’ does not apply to <a href=\"http://www.exclude1.com/\">www.exclude1.com</a> nor en.exclude1.com.</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://github.com/hexojs/hexo-filter-nofollow\">https://github.com/hexojs/hexo-filter-nofollow</a></li>\n</ul>"},{"title":"GitHub Pages自訂域名","abbrlink":"17682405","_content":"\n## 前言\n\n\n\n## 參考資料\n\n- https://blog.hanklu.tw/post/2019/github-page-custom-domain/\n","source":"_drafts/GitHub-Pages自訂域名.md","raw":"---\ntitle: GitHub Pages自訂域名\ntags:\n  - Hexo\n  - GitHub\n  - GitHub Pages\n  - Domain\n  - DNS\n  - blog\nabbrlink: '17682405'\n---\n\n## 前言\n\n\n\n## 參考資料\n\n- https://blog.hanklu.tw/post/2019/github-page-custom-domain/\n","slug":"GitHub-Pages自訂域名","published":0,"date":"2024-09-09T07:17:02.641Z","updated":"2024-09-09T07:17:02.641Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5it0008k0lz1hbgfhpt","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://blog.hanklu.tw/post/2019/github-page-custom-domain/\">https://blog.hanklu.tw/post/2019/github-page-custom-domain/</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://blog.hanklu.tw/post/2019/github-page-custom-domain/\">https://blog.hanklu.tw/post/2019/github-page-custom-domain/</a></li>\n</ul>\n"},{"title":"max_execution_time 和 request_terminate_timeout 的比較","abbrlink":"3b4e9ba5","_content":"\n## 前言\n\n<!--more-->\n\n## 連線原理\n\n## 參考資料\n\n- https://www.twblogs.net/a/5eefd00bfcc715ab3d919a1d\n","source":"_drafts/max-execution-time-vs-request-terminate-timeout.md","raw":"---\ntitle: max_execution_time 和 request_terminate_timeout 的比較\ntags:\n  - PHP\n  - PHP-FPM\n  - Nginx\ncategories:\n  - PHP-FPM\nabbrlink: 3b4e9ba5\n---\n\n## 前言\n\n<!--more-->\n\n## 連線原理\n\n## 參考資料\n\n- https://www.twblogs.net/a/5eefd00bfcc715ab3d919a1d\n","slug":"max-execution-time-vs-request-terminate-timeout","published":0,"date":"2024-09-09T07:17:02.643Z","updated":"2024-09-09T07:17:02.643Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5iu0009k0lz24h6hocu","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><span id=\"more\"></span>\n\n<h2 id=\"連線原理\"><a href=\"#連線原理\" class=\"headerlink\" title=\"連線原理\"></a>連線原理</h2><h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://www.twblogs.net/a/5eefd00bfcc715ab3d919a1d\">https://www.twblogs.net/a/5eefd00bfcc715ab3d919a1d</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2>","more":"<h2 id=\"連線原理\"><a href=\"#連線原理\" class=\"headerlink\" title=\"連線原理\"></a>連線原理</h2><h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://www.twblogs.net/a/5eefd00bfcc715ab3d919a1d\">https://www.twblogs.net/a/5eefd00bfcc715ab3d919a1d</a></li>\n</ul>"},{"title":"Mac homebrew-core/homebrew-cask is a shallow clone","abbrlink":"e7b1d5c2","_content":"\n## 前言\n\n今天剛好要在 Mac 試著安裝 K3s 來試試，Mac 的安裝方式是使用 Homebrew 的方式來安裝，但是當我安裝到最後出現一些錯誤訊息，接著我拜訪 Google大神，大神告訴我要進行 `brew clean && brew update`\n\n但是當我輸入 `brew update` 就無情的跳出以下錯誤訊息\n\n<!-- more -->\n\n```\nError:\n homebrew-core is a shallow clone.\n homebrew-cask is a shallow clone.\nTo `brew update`, first run:\n git -C /usr/local/Homebrew/Library/Taps/homebrew/homebrew-core fetch --unshallow\n git -C /usr/local/Homebrew/Library/Taps/homebrew/homebrew-cask fetch --unshallow\nThese commands may take a few minutes to run due to the large size of the repositories.\nThis restriction has been made on GitHub's request because updating shallow\nclones is an extremely expensive operation due to the tree layout and traffic of\nHomebrew/homebrew-core and Homebrew/homebrew-cask. We don't do this for you\nautomatically to avoid repeatedly performing an expensive unshallow operation in\nCI systems (which should instead be fixed to not use shallow clones). Sorry for\nthe inconvenience!\n```\n\n## 解決方式\n\n我根據上述的指令「分別」運行了以下兩行指令\n\n```\ngit -C /usr/local/Homebrew/Library/Taps/homebrew/homebrew-core fetch --unshallow\ngit -C /usr/local/Homebrew/Library/Taps/homebrew/homebrew-cask fetch --unshallow\n```\n\n當我運行第一行時，大概過了一分鐘，電腦都沒有動靜，原本以為是不是當機了，所幸我就繼續等下去約莫 5~10分鐘後，終端機就開始有反應了，所以這邊要注意的是，當指令輸入後，需要一段時間的耐心等待，指令運行結果如下：\n\n```\n$ git -C /usr/local/Homebrew/Library/Taps/homebrew/homebrew-core fetch --unshallow\n\nremote: Enumerating objects: 783435, done.\nremote: Counting objects: 100% (783382/783382), done.\nremote: Compressing objects: 100% (261076/261076), done.\nremote: Total 773593 (delta 521667), reused 761412 (delta 509643), pack-reused 0\nReceiving objects: 100% (773593/773593), 309.85 MiB | 5.96 MiB/s, done.\nResolving deltas: 100% (521667/521667), completed with 8031 local objects.\nFrom https://github.com/Homebrew/homebrew-core\n  8c9395d92b..37e36e1536  master     -> origin/master\n```\n\n```\n$ git -C /usr/local/Homebrew/Library/Taps/homebrew/homebrew-cask fetch --unshallow\n\nremote: Enumerating objects: 440238, done.\nremote: Counting objects: 100% (440214/440214), done.\nremote: Compressing objects: 100% (130363/130363), done.\nremote: Total 433313 (delta 310180), reused 425457 (delta 302375), pack-reused 0\nReceiving objects: 100% (433313/433313), 189.23 MiB | 8.34 MiB/s, done.\nResolving deltas: 100% (310180/310180), completed with 5087 local objects.\nFrom https://github.com/Homebrew/homebrew-cask\n  8a81ad4b60..76273d1300  master     -> origin/master\n```\n\n最後再進行一次 `brew update` 就正常可以執行了，雖然我不是很清楚實際原因，但大概跟 Homebrew 抓源有一點關係，總之問題就這樣解決了，如果有遇到的朋友們，也可以參照試試看\n","source":"_drafts/homebrew-shallow-clone.md","raw":"---\ntitle: Mac homebrew-core/homebrew-cask is a shallow clone\ntags:\n  - Mac\n  - homebrew\n  - brew\ncategories:\n  - Other\nabbrlink: e7b1d5c2\n---\n\n## 前言\n\n今天剛好要在 Mac 試著安裝 K3s 來試試，Mac 的安裝方式是使用 Homebrew 的方式來安裝，但是當我安裝到最後出現一些錯誤訊息，接著我拜訪 Google大神，大神告訴我要進行 `brew clean && brew update`\n\n但是當我輸入 `brew update` 就無情的跳出以下錯誤訊息\n\n<!-- more -->\n\n```\nError:\n homebrew-core is a shallow clone.\n homebrew-cask is a shallow clone.\nTo `brew update`, first run:\n git -C /usr/local/Homebrew/Library/Taps/homebrew/homebrew-core fetch --unshallow\n git -C /usr/local/Homebrew/Library/Taps/homebrew/homebrew-cask fetch --unshallow\nThese commands may take a few minutes to run due to the large size of the repositories.\nThis restriction has been made on GitHub's request because updating shallow\nclones is an extremely expensive operation due to the tree layout and traffic of\nHomebrew/homebrew-core and Homebrew/homebrew-cask. We don't do this for you\nautomatically to avoid repeatedly performing an expensive unshallow operation in\nCI systems (which should instead be fixed to not use shallow clones). Sorry for\nthe inconvenience!\n```\n\n## 解決方式\n\n我根據上述的指令「分別」運行了以下兩行指令\n\n```\ngit -C /usr/local/Homebrew/Library/Taps/homebrew/homebrew-core fetch --unshallow\ngit -C /usr/local/Homebrew/Library/Taps/homebrew/homebrew-cask fetch --unshallow\n```\n\n當我運行第一行時，大概過了一分鐘，電腦都沒有動靜，原本以為是不是當機了，所幸我就繼續等下去約莫 5~10分鐘後，終端機就開始有反應了，所以這邊要注意的是，當指令輸入後，需要一段時間的耐心等待，指令運行結果如下：\n\n```\n$ git -C /usr/local/Homebrew/Library/Taps/homebrew/homebrew-core fetch --unshallow\n\nremote: Enumerating objects: 783435, done.\nremote: Counting objects: 100% (783382/783382), done.\nremote: Compressing objects: 100% (261076/261076), done.\nremote: Total 773593 (delta 521667), reused 761412 (delta 509643), pack-reused 0\nReceiving objects: 100% (773593/773593), 309.85 MiB | 5.96 MiB/s, done.\nResolving deltas: 100% (521667/521667), completed with 8031 local objects.\nFrom https://github.com/Homebrew/homebrew-core\n  8c9395d92b..37e36e1536  master     -> origin/master\n```\n\n```\n$ git -C /usr/local/Homebrew/Library/Taps/homebrew/homebrew-cask fetch --unshallow\n\nremote: Enumerating objects: 440238, done.\nremote: Counting objects: 100% (440214/440214), done.\nremote: Compressing objects: 100% (130363/130363), done.\nremote: Total 433313 (delta 310180), reused 425457 (delta 302375), pack-reused 0\nReceiving objects: 100% (433313/433313), 189.23 MiB | 8.34 MiB/s, done.\nResolving deltas: 100% (310180/310180), completed with 5087 local objects.\nFrom https://github.com/Homebrew/homebrew-cask\n  8a81ad4b60..76273d1300  master     -> origin/master\n```\n\n最後再進行一次 `brew update` 就正常可以執行了，雖然我不是很清楚實際原因，但大概跟 Homebrew 抓源有一點關係，總之問題就這樣解決了，如果有遇到的朋友們，也可以參照試試看\n","slug":"homebrew-shallow-clone","published":0,"date":"2024-09-09T07:17:02.643Z","updated":"2024-09-09T07:17:02.643Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5iw000dk0lz9wt89aqf","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>今天剛好要在 Mac 試著安裝 K3s 來試試，Mac 的安裝方式是使用 Homebrew 的方式來安裝，但是當我安裝到最後出現一些錯誤訊息，接著我拜訪 Google大神，大神告訴我要進行 <code>brew clean &amp;&amp; brew update</code></p>\n<p>但是當我輸入 <code>brew update</code> 就無情的跳出以下錯誤訊息</p>\n<span id=\"more\"></span>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Error:</span><br><span class=\"line\"> homebrew-core is a shallow clone.</span><br><span class=\"line\"> homebrew-cask is a shallow clone.</span><br><span class=\"line\">To &#96;brew update&#96;, first run:</span><br><span class=\"line\"> git -C &#x2F;usr&#x2F;local&#x2F;Homebrew&#x2F;Library&#x2F;Taps&#x2F;homebrew&#x2F;homebrew-core fetch --unshallow</span><br><span class=\"line\"> git -C &#x2F;usr&#x2F;local&#x2F;Homebrew&#x2F;Library&#x2F;Taps&#x2F;homebrew&#x2F;homebrew-cask fetch --unshallow</span><br><span class=\"line\">These commands may take a few minutes to run due to the large size of the repositories.</span><br><span class=\"line\">This restriction has been made on GitHub&#39;s request because updating shallow</span><br><span class=\"line\">clones is an extremely expensive operation due to the tree layout and traffic of</span><br><span class=\"line\">Homebrew&#x2F;homebrew-core and Homebrew&#x2F;homebrew-cask. We don&#39;t do this for you</span><br><span class=\"line\">automatically to avoid repeatedly performing an expensive unshallow operation in</span><br><span class=\"line\">CI systems (which should instead be fixed to not use shallow clones). Sorry for</span><br><span class=\"line\">the inconvenience!</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解決方式\"><a href=\"#解決方式\" class=\"headerlink\" title=\"解決方式\"></a>解決方式</h2><p>我根據上述的指令「分別」運行了以下兩行指令</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git -C &#x2F;usr&#x2F;local&#x2F;Homebrew&#x2F;Library&#x2F;Taps&#x2F;homebrew&#x2F;homebrew-core fetch --unshallow</span><br><span class=\"line\">git -C &#x2F;usr&#x2F;local&#x2F;Homebrew&#x2F;Library&#x2F;Taps&#x2F;homebrew&#x2F;homebrew-cask fetch --unshallow</span><br></pre></td></tr></table></figure>\n\n<p>當我運行第一行時，大概過了一分鐘，電腦都沒有動靜，原本以為是不是當機了，所幸我就繼續等下去約莫 5~10分鐘後，終端機就開始有反應了，所以這邊要注意的是，當指令輸入後，需要一段時間的耐心等待，指令運行結果如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git -C &#x2F;usr&#x2F;local&#x2F;Homebrew&#x2F;Library&#x2F;Taps&#x2F;homebrew&#x2F;homebrew-core fetch --unshallow</span><br><span class=\"line\"></span><br><span class=\"line\">remote: Enumerating objects: 783435, done.</span><br><span class=\"line\">remote: Counting objects: 100% (783382&#x2F;783382), done.</span><br><span class=\"line\">remote: Compressing objects: 100% (261076&#x2F;261076), done.</span><br><span class=\"line\">remote: Total 773593 (delta 521667), reused 761412 (delta 509643), pack-reused 0</span><br><span class=\"line\">Receiving objects: 100% (773593&#x2F;773593), 309.85 MiB | 5.96 MiB&#x2F;s, done.</span><br><span class=\"line\">Resolving deltas: 100% (521667&#x2F;521667), completed with 8031 local objects.</span><br><span class=\"line\">From https:&#x2F;&#x2F;github.com&#x2F;Homebrew&#x2F;homebrew-core</span><br><span class=\"line\">  8c9395d92b..37e36e1536  master     -&gt; origin&#x2F;master</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git -C &#x2F;usr&#x2F;local&#x2F;Homebrew&#x2F;Library&#x2F;Taps&#x2F;homebrew&#x2F;homebrew-cask fetch --unshallow</span><br><span class=\"line\"></span><br><span class=\"line\">remote: Enumerating objects: 440238, done.</span><br><span class=\"line\">remote: Counting objects: 100% (440214&#x2F;440214), done.</span><br><span class=\"line\">remote: Compressing objects: 100% (130363&#x2F;130363), done.</span><br><span class=\"line\">remote: Total 433313 (delta 310180), reused 425457 (delta 302375), pack-reused 0</span><br><span class=\"line\">Receiving objects: 100% (433313&#x2F;433313), 189.23 MiB | 8.34 MiB&#x2F;s, done.</span><br><span class=\"line\">Resolving deltas: 100% (310180&#x2F;310180), completed with 5087 local objects.</span><br><span class=\"line\">From https:&#x2F;&#x2F;github.com&#x2F;Homebrew&#x2F;homebrew-cask</span><br><span class=\"line\">  8a81ad4b60..76273d1300  master     -&gt; origin&#x2F;master</span><br></pre></td></tr></table></figure>\n\n<p>最後再進行一次 <code>brew update</code> 就正常可以執行了，雖然我不是很清楚實際原因，但大概跟 Homebrew 抓源有一點關係，總之問題就這樣解決了，如果有遇到的朋友們，也可以參照試試看</p>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>今天剛好要在 Mac 試著安裝 K3s 來試試，Mac 的安裝方式是使用 Homebrew 的方式來安裝，但是當我安裝到最後出現一些錯誤訊息，接著我拜訪 Google大神，大神告訴我要進行 <code>brew clean &amp;&amp; brew update</code></p>\n<p>但是當我輸入 <code>brew update</code> 就無情的跳出以下錯誤訊息</p>","more":"<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Error:</span><br><span class=\"line\"> homebrew-core is a shallow clone.</span><br><span class=\"line\"> homebrew-cask is a shallow clone.</span><br><span class=\"line\">To &#96;brew update&#96;, first run:</span><br><span class=\"line\"> git -C &#x2F;usr&#x2F;local&#x2F;Homebrew&#x2F;Library&#x2F;Taps&#x2F;homebrew&#x2F;homebrew-core fetch --unshallow</span><br><span class=\"line\"> git -C &#x2F;usr&#x2F;local&#x2F;Homebrew&#x2F;Library&#x2F;Taps&#x2F;homebrew&#x2F;homebrew-cask fetch --unshallow</span><br><span class=\"line\">These commands may take a few minutes to run due to the large size of the repositories.</span><br><span class=\"line\">This restriction has been made on GitHub&#39;s request because updating shallow</span><br><span class=\"line\">clones is an extremely expensive operation due to the tree layout and traffic of</span><br><span class=\"line\">Homebrew&#x2F;homebrew-core and Homebrew&#x2F;homebrew-cask. We don&#39;t do this for you</span><br><span class=\"line\">automatically to avoid repeatedly performing an expensive unshallow operation in</span><br><span class=\"line\">CI systems (which should instead be fixed to not use shallow clones). Sorry for</span><br><span class=\"line\">the inconvenience!</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解決方式\"><a href=\"#解決方式\" class=\"headerlink\" title=\"解決方式\"></a>解決方式</h2><p>我根據上述的指令「分別」運行了以下兩行指令</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git -C &#x2F;usr&#x2F;local&#x2F;Homebrew&#x2F;Library&#x2F;Taps&#x2F;homebrew&#x2F;homebrew-core fetch --unshallow</span><br><span class=\"line\">git -C &#x2F;usr&#x2F;local&#x2F;Homebrew&#x2F;Library&#x2F;Taps&#x2F;homebrew&#x2F;homebrew-cask fetch --unshallow</span><br></pre></td></tr></table></figure>\n\n<p>當我運行第一行時，大概過了一分鐘，電腦都沒有動靜，原本以為是不是當機了，所幸我就繼續等下去約莫 5~10分鐘後，終端機就開始有反應了，所以這邊要注意的是，當指令輸入後，需要一段時間的耐心等待，指令運行結果如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git -C &#x2F;usr&#x2F;local&#x2F;Homebrew&#x2F;Library&#x2F;Taps&#x2F;homebrew&#x2F;homebrew-core fetch --unshallow</span><br><span class=\"line\"></span><br><span class=\"line\">remote: Enumerating objects: 783435, done.</span><br><span class=\"line\">remote: Counting objects: 100% (783382&#x2F;783382), done.</span><br><span class=\"line\">remote: Compressing objects: 100% (261076&#x2F;261076), done.</span><br><span class=\"line\">remote: Total 773593 (delta 521667), reused 761412 (delta 509643), pack-reused 0</span><br><span class=\"line\">Receiving objects: 100% (773593&#x2F;773593), 309.85 MiB | 5.96 MiB&#x2F;s, done.</span><br><span class=\"line\">Resolving deltas: 100% (521667&#x2F;521667), completed with 8031 local objects.</span><br><span class=\"line\">From https:&#x2F;&#x2F;github.com&#x2F;Homebrew&#x2F;homebrew-core</span><br><span class=\"line\">  8c9395d92b..37e36e1536  master     -&gt; origin&#x2F;master</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git -C &#x2F;usr&#x2F;local&#x2F;Homebrew&#x2F;Library&#x2F;Taps&#x2F;homebrew&#x2F;homebrew-cask fetch --unshallow</span><br><span class=\"line\"></span><br><span class=\"line\">remote: Enumerating objects: 440238, done.</span><br><span class=\"line\">remote: Counting objects: 100% (440214&#x2F;440214), done.</span><br><span class=\"line\">remote: Compressing objects: 100% (130363&#x2F;130363), done.</span><br><span class=\"line\">remote: Total 433313 (delta 310180), reused 425457 (delta 302375), pack-reused 0</span><br><span class=\"line\">Receiving objects: 100% (433313&#x2F;433313), 189.23 MiB | 8.34 MiB&#x2F;s, done.</span><br><span class=\"line\">Resolving deltas: 100% (310180&#x2F;310180), completed with 5087 local objects.</span><br><span class=\"line\">From https:&#x2F;&#x2F;github.com&#x2F;Homebrew&#x2F;homebrew-cask</span><br><span class=\"line\">  8a81ad4b60..76273d1300  master     -&gt; origin&#x2F;master</span><br></pre></td></tr></table></figure>\n\n<p>最後再進行一次 <code>brew update</code> 就正常可以執行了，雖然我不是很清楚實際原因，但大概跟 Homebrew 抓源有一點關係，總之問題就這樣解決了，如果有遇到的朋友們，也可以參照試試看</p>"},{"title":"什麼是HSTS","abbrlink":"fbf0c319","_content":"\n## 前言\n\nHTTP 強制安全傳輸(HTTP Strict Transport Security, HSTS)，就是告訴瀏覽器該網站請強制使用 HTTPS 協定作加密連線，以減少連線過程可能遭遇的風險\n\n開啟 HSTS 後未來瀏覽器就會自動將 HTTP 轉為 HTTPS 請求，**即使憑證失效，使用者也無法忽略警告繼續瀏覽網站**。\n\n在 HTTP Repose Header 加入 Strict-Transport-Security(STS) 參數就能告訴瀏覽器該網站使用 HTTPS 連線，在遇到使用 HTTP 訪問時就能自動跳轉到 HTTPS。\n\n<!--more-->\n\n## HTTP To HTTPS 跳轉過程\n\n在還沒有 HTTPS 的年代，都以 80 port 明碼的方式與伺服器通訊，正常情況下可以返回資料\n\n![](HSTS-0.png)\n\n但如果瀏覽器與伺服器之間出現了 Hacker 劫持，伺服器所返回的資料就有可能被有所竄改\n\n![](HSTS-1.png)\n\n後來 SSL加密的出現，我們可以在伺服器端利用 301/302 跳轉強制讓走 80 的客戶自動導轉 443，這也是為了因應平時我們會在瀏覽器習慣性輸入 `www.example.com`。\n\n當瀏覽器走的是 HTTP，請求到達伺服器後，伺服器告訴瀏覽器 302 跳轉，然後瀏覽器重新請求，透過 HTTPS 方式，443 埠號通訊。\n\n![](HSTS-2.png)\n\n也因為不是直接輸入 `https://`，故第一次發起的請求還是使用 80 port，Hacker 利用這一點，也可以進行劫持的動作\n\n![](HSTS-3.png)\n\n## HSTS 運作原理\n\n1. 伺服器啟用 HSTS 功能，伺服器會在 Repose Header 中新增 Strict-Transport-Security，並設置 max-age 時間\n\n2. 客戶端第一次與伺服器連線時，伺服器回應時會帶上 STS Header\n\n3. 如果下次客戶端使用 HTTP 訪問時，只要 max-age 未過期，客戶端會進行內部 307 跳轉，使用 Chrome 瀏覽器開啟「開發人員工具」，可以看到 307 Redirect Internel 的狀態碼\n\n4. Redirect Internel 是客戶端本機瀏覽器 HTTP To HTTPS 跳轉過程，跳轉完成後客戶端就會以 HTTPS 訪問伺服器，這樣就能確保客戶端訪問伺服器時是使用 HTTPS 加密連線\n\n> 總結：使用 HSTS 時，當 max-age 未過期，客戶端會在「自己的瀏覽器」進行 307 跳轉成 HTTPS，再去訪問伺服器\n\n## HSTS 優點\n\n1. 啟用 HSTS 可以有效降低 MITM\n\n2. 保客戶端在有效時間內使用 HTTPS 訪問伺服器\n\n## HSTS 缺點\n\n1. 在瀏覽器未有 STS Header 時，首次使用 80 port 訪問伺服器時，有可能遭受 MITM\n\n2. 無法忽視憑證過期或失效，只要憑證過期或失效就無法訪問網站\n\n3. 如果客戶端在接收到 Strict-Transport-Security(STS) Response Header 前就已經是被劫持狀態，因客戶端並非直接與伺服器連線，故伺服器無法將 STS Response Header 帶給客戶端(因為都被中間人擋下來了)\n\n4. 若清除瀏覽器快取，下次訪問網站時，會使用 HTTP 訪問，伺服器回應會重新帶上 STS Header\n\n> 關於第一點首次訪問使用 HTTP 的問題，其實可以使用 Preload List 的方式來解決，後續會再寫一篇有關 Preload List\n\n## HSTS 的注意事項\n\n1. IP 的請求 HSTS 無法處理，例如：`http://1.1.1.1` Response Header 中設置了 STS，瀏覽器也不會理會\n\n2. HSTS 只能在 80 和 443 埠號之間的轉換，如果服務是 8080 埠號，即便設置了 STS 也無效\n\n3. 當憑證一旦失效，網站會無法順利開啟\n\n4. 如果伺服器的 HTTPS 沒有設定好就開啟了 STS 的 Response Header，並且設置了很長的過期時間，那麼在你伺服器 HTTPS 設定好之前，用戶都是沒辦法連到伺服器，除非 max-age 過期了(因為客戶端會強制使用 HTTPS 與伺服器連線)\n\n## 參考資料\n\n- https://free.com.tw/hsts-preload-list/\n- https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/668827/\n","source":"_drafts/什麼是HSTS.md","raw":"---\ntitle: 什麼是HSTS\ntags:\n  - HSTS\n  - SSL\n  - HTTPS\n  - Nginx\ncategories:\n  - Nginx\nabbrlink: fbf0c319\n---\n\n## 前言\n\nHTTP 強制安全傳輸(HTTP Strict Transport Security, HSTS)，就是告訴瀏覽器該網站請強制使用 HTTPS 協定作加密連線，以減少連線過程可能遭遇的風險\n\n開啟 HSTS 後未來瀏覽器就會自動將 HTTP 轉為 HTTPS 請求，**即使憑證失效，使用者也無法忽略警告繼續瀏覽網站**。\n\n在 HTTP Repose Header 加入 Strict-Transport-Security(STS) 參數就能告訴瀏覽器該網站使用 HTTPS 連線，在遇到使用 HTTP 訪問時就能自動跳轉到 HTTPS。\n\n<!--more-->\n\n## HTTP To HTTPS 跳轉過程\n\n在還沒有 HTTPS 的年代，都以 80 port 明碼的方式與伺服器通訊，正常情況下可以返回資料\n\n![](HSTS-0.png)\n\n但如果瀏覽器與伺服器之間出現了 Hacker 劫持，伺服器所返回的資料就有可能被有所竄改\n\n![](HSTS-1.png)\n\n後來 SSL加密的出現，我們可以在伺服器端利用 301/302 跳轉強制讓走 80 的客戶自動導轉 443，這也是為了因應平時我們會在瀏覽器習慣性輸入 `www.example.com`。\n\n當瀏覽器走的是 HTTP，請求到達伺服器後，伺服器告訴瀏覽器 302 跳轉，然後瀏覽器重新請求，透過 HTTPS 方式，443 埠號通訊。\n\n![](HSTS-2.png)\n\n也因為不是直接輸入 `https://`，故第一次發起的請求還是使用 80 port，Hacker 利用這一點，也可以進行劫持的動作\n\n![](HSTS-3.png)\n\n## HSTS 運作原理\n\n1. 伺服器啟用 HSTS 功能，伺服器會在 Repose Header 中新增 Strict-Transport-Security，並設置 max-age 時間\n\n2. 客戶端第一次與伺服器連線時，伺服器回應時會帶上 STS Header\n\n3. 如果下次客戶端使用 HTTP 訪問時，只要 max-age 未過期，客戶端會進行內部 307 跳轉，使用 Chrome 瀏覽器開啟「開發人員工具」，可以看到 307 Redirect Internel 的狀態碼\n\n4. Redirect Internel 是客戶端本機瀏覽器 HTTP To HTTPS 跳轉過程，跳轉完成後客戶端就會以 HTTPS 訪問伺服器，這樣就能確保客戶端訪問伺服器時是使用 HTTPS 加密連線\n\n> 總結：使用 HSTS 時，當 max-age 未過期，客戶端會在「自己的瀏覽器」進行 307 跳轉成 HTTPS，再去訪問伺服器\n\n## HSTS 優點\n\n1. 啟用 HSTS 可以有效降低 MITM\n\n2. 保客戶端在有效時間內使用 HTTPS 訪問伺服器\n\n## HSTS 缺點\n\n1. 在瀏覽器未有 STS Header 時，首次使用 80 port 訪問伺服器時，有可能遭受 MITM\n\n2. 無法忽視憑證過期或失效，只要憑證過期或失效就無法訪問網站\n\n3. 如果客戶端在接收到 Strict-Transport-Security(STS) Response Header 前就已經是被劫持狀態，因客戶端並非直接與伺服器連線，故伺服器無法將 STS Response Header 帶給客戶端(因為都被中間人擋下來了)\n\n4. 若清除瀏覽器快取，下次訪問網站時，會使用 HTTP 訪問，伺服器回應會重新帶上 STS Header\n\n> 關於第一點首次訪問使用 HTTP 的問題，其實可以使用 Preload List 的方式來解決，後續會再寫一篇有關 Preload List\n\n## HSTS 的注意事項\n\n1. IP 的請求 HSTS 無法處理，例如：`http://1.1.1.1` Response Header 中設置了 STS，瀏覽器也不會理會\n\n2. HSTS 只能在 80 和 443 埠號之間的轉換，如果服務是 8080 埠號，即便設置了 STS 也無效\n\n3. 當憑證一旦失效，網站會無法順利開啟\n\n4. 如果伺服器的 HTTPS 沒有設定好就開啟了 STS 的 Response Header，並且設置了很長的過期時間，那麼在你伺服器 HTTPS 設定好之前，用戶都是沒辦法連到伺服器，除非 max-age 過期了(因為客戶端會強制使用 HTTPS 與伺服器連線)\n\n## 參考資料\n\n- https://free.com.tw/hsts-preload-list/\n- https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/668827/\n","slug":"什麼是HSTS","published":0,"date":"2024-09-09T07:17:02.644Z","updated":"2024-09-09T07:17:02.644Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5iy000hk0lzg5ckfw8j","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>HTTP 強制安全傳輸(HTTP Strict Transport Security, HSTS)，就是告訴瀏覽器該網站請強制使用 HTTPS 協定作加密連線，以減少連線過程可能遭遇的風險</p>\n<p>開啟 HSTS 後未來瀏覽器就會自動將 HTTP 轉為 HTTPS 請求，<strong>即使憑證失效，使用者也無法忽略警告繼續瀏覽網站</strong>。</p>\n<p>在 HTTP Repose Header 加入 Strict-Transport-Security(STS) 參數就能告訴瀏覽器該網站使用 HTTPS 連線，在遇到使用 HTTP 訪問時就能自動跳轉到 HTTPS。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"HTTP-To-HTTPS-跳轉過程\"><a href=\"#HTTP-To-HTTPS-跳轉過程\" class=\"headerlink\" title=\"HTTP To HTTPS 跳轉過程\"></a>HTTP To HTTPS 跳轉過程</h2><p>在還沒有 HTTPS 的年代，都以 80 port 明碼的方式與伺服器通訊，正常情況下可以返回資料</p>\n<p><img src=\"HSTS-0.png\"></p>\n<p>但如果瀏覽器與伺服器之間出現了 Hacker 劫持，伺服器所返回的資料就有可能被有所竄改</p>\n<p><img src=\"HSTS-1.png\"></p>\n<p>後來 SSL加密的出現，我們可以在伺服器端利用 301/302 跳轉強制讓走 80 的客戶自動導轉 443，這也是為了因應平時我們會在瀏覽器習慣性輸入 <code>www.example.com</code>。</p>\n<p>當瀏覽器走的是 HTTP，請求到達伺服器後，伺服器告訴瀏覽器 302 跳轉，然後瀏覽器重新請求，透過 HTTPS 方式，443 埠號通訊。</p>\n<p><img src=\"HSTS-2.png\"></p>\n<p>也因為不是直接輸入 <code>https://</code>，故第一次發起的請求還是使用 80 port，Hacker 利用這一點，也可以進行劫持的動作</p>\n<p><img src=\"HSTS-3.png\"></p>\n<h2 id=\"HSTS-運作原理\"><a href=\"#HSTS-運作原理\" class=\"headerlink\" title=\"HSTS 運作原理\"></a>HSTS 運作原理</h2><ol>\n<li><p>伺服器啟用 HSTS 功能，伺服器會在 Repose Header 中新增 Strict-Transport-Security，並設置 max-age 時間</p>\n</li>\n<li><p>客戶端第一次與伺服器連線時，伺服器回應時會帶上 STS Header</p>\n</li>\n<li><p>如果下次客戶端使用 HTTP 訪問時，只要 max-age 未過期，客戶端會進行內部 307 跳轉，使用 Chrome 瀏覽器開啟「開發人員工具」，可以看到 307 Redirect Internel 的狀態碼</p>\n</li>\n<li><p>Redirect Internel 是客戶端本機瀏覽器 HTTP To HTTPS 跳轉過程，跳轉完成後客戶端就會以 HTTPS 訪問伺服器，這樣就能確保客戶端訪問伺服器時是使用 HTTPS 加密連線</p>\n</li>\n</ol>\n<blockquote>\n<p>總結：使用 HSTS 時，當 max-age 未過期，客戶端會在「自己的瀏覽器」進行 307 跳轉成 HTTPS，再去訪問伺服器</p>\n</blockquote>\n<h2 id=\"HSTS-優點\"><a href=\"#HSTS-優點\" class=\"headerlink\" title=\"HSTS 優點\"></a>HSTS 優點</h2><ol>\n<li><p>啟用 HSTS 可以有效降低 MITM</p>\n</li>\n<li><p>保客戶端在有效時間內使用 HTTPS 訪問伺服器</p>\n</li>\n</ol>\n<h2 id=\"HSTS-缺點\"><a href=\"#HSTS-缺點\" class=\"headerlink\" title=\"HSTS 缺點\"></a>HSTS 缺點</h2><ol>\n<li><p>在瀏覽器未有 STS Header 時，首次使用 80 port 訪問伺服器時，有可能遭受 MITM</p>\n</li>\n<li><p>無法忽視憑證過期或失效，只要憑證過期或失效就無法訪問網站</p>\n</li>\n<li><p>如果客戶端在接收到 Strict-Transport-Security(STS) Response Header 前就已經是被劫持狀態，因客戶端並非直接與伺服器連線，故伺服器無法將 STS Response Header 帶給客戶端(因為都被中間人擋下來了)</p>\n</li>\n<li><p>若清除瀏覽器快取，下次訪問網站時，會使用 HTTP 訪問，伺服器回應會重新帶上 STS Header</p>\n</li>\n</ol>\n<blockquote>\n<p>關於第一點首次訪問使用 HTTP 的問題，其實可以使用 Preload List 的方式來解決，後續會再寫一篇有關 Preload List</p>\n</blockquote>\n<h2 id=\"HSTS-的注意事項\"><a href=\"#HSTS-的注意事項\" class=\"headerlink\" title=\"HSTS 的注意事項\"></a>HSTS 的注意事項</h2><ol>\n<li><p>IP 的請求 HSTS 無法處理，例如：<code>http://1.1.1.1</code> Response Header 中設置了 STS，瀏覽器也不會理會</p>\n</li>\n<li><p>HSTS 只能在 80 和 443 埠號之間的轉換，如果服務是 8080 埠號，即便設置了 STS 也無效</p>\n</li>\n<li><p>當憑證一旦失效，網站會無法順利開啟</p>\n</li>\n<li><p>如果伺服器的 HTTPS 沒有設定好就開啟了 STS 的 Response Header，並且設置了很長的過期時間，那麼在你伺服器 HTTPS 設定好之前，用戶都是沒辦法連到伺服器，除非 max-age 過期了(因為客戶端會強制使用 HTTPS 與伺服器連線)</p>\n</li>\n</ol>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://free.com.tw/hsts-preload-list/\">https://free.com.tw/hsts-preload-list/</a></li>\n<li><a href=\"https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/668827/\">https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/668827/</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>HTTP 強制安全傳輸(HTTP Strict Transport Security, HSTS)，就是告訴瀏覽器該網站請強制使用 HTTPS 協定作加密連線，以減少連線過程可能遭遇的風險</p>\n<p>開啟 HSTS 後未來瀏覽器就會自動將 HTTP 轉為 HTTPS 請求，<strong>即使憑證失效，使用者也無法忽略警告繼續瀏覽網站</strong>。</p>\n<p>在 HTTP Repose Header 加入 Strict-Transport-Security(STS) 參數就能告訴瀏覽器該網站使用 HTTPS 連線，在遇到使用 HTTP 訪問時就能自動跳轉到 HTTPS。</p>","more":"<h2 id=\"HTTP-To-HTTPS-跳轉過程\"><a href=\"#HTTP-To-HTTPS-跳轉過程\" class=\"headerlink\" title=\"HTTP To HTTPS 跳轉過程\"></a>HTTP To HTTPS 跳轉過程</h2><p>在還沒有 HTTPS 的年代，都以 80 port 明碼的方式與伺服器通訊，正常情況下可以返回資料</p>\n<p><img src=\"HSTS-0.png\"></p>\n<p>但如果瀏覽器與伺服器之間出現了 Hacker 劫持，伺服器所返回的資料就有可能被有所竄改</p>\n<p><img src=\"HSTS-1.png\"></p>\n<p>後來 SSL加密的出現，我們可以在伺服器端利用 301/302 跳轉強制讓走 80 的客戶自動導轉 443，這也是為了因應平時我們會在瀏覽器習慣性輸入 <code>www.example.com</code>。</p>\n<p>當瀏覽器走的是 HTTP，請求到達伺服器後，伺服器告訴瀏覽器 302 跳轉，然後瀏覽器重新請求，透過 HTTPS 方式，443 埠號通訊。</p>\n<p><img src=\"HSTS-2.png\"></p>\n<p>也因為不是直接輸入 <code>https://</code>，故第一次發起的請求還是使用 80 port，Hacker 利用這一點，也可以進行劫持的動作</p>\n<p><img src=\"HSTS-3.png\"></p>\n<h2 id=\"HSTS-運作原理\"><a href=\"#HSTS-運作原理\" class=\"headerlink\" title=\"HSTS 運作原理\"></a>HSTS 運作原理</h2><ol>\n<li><p>伺服器啟用 HSTS 功能，伺服器會在 Repose Header 中新增 Strict-Transport-Security，並設置 max-age 時間</p>\n</li>\n<li><p>客戶端第一次與伺服器連線時，伺服器回應時會帶上 STS Header</p>\n</li>\n<li><p>如果下次客戶端使用 HTTP 訪問時，只要 max-age 未過期，客戶端會進行內部 307 跳轉，使用 Chrome 瀏覽器開啟「開發人員工具」，可以看到 307 Redirect Internel 的狀態碼</p>\n</li>\n<li><p>Redirect Internel 是客戶端本機瀏覽器 HTTP To HTTPS 跳轉過程，跳轉完成後客戶端就會以 HTTPS 訪問伺服器，這樣就能確保客戶端訪問伺服器時是使用 HTTPS 加密連線</p>\n</li>\n</ol>\n<blockquote>\n<p>總結：使用 HSTS 時，當 max-age 未過期，客戶端會在「自己的瀏覽器」進行 307 跳轉成 HTTPS，再去訪問伺服器</p>\n</blockquote>\n<h2 id=\"HSTS-優點\"><a href=\"#HSTS-優點\" class=\"headerlink\" title=\"HSTS 優點\"></a>HSTS 優點</h2><ol>\n<li><p>啟用 HSTS 可以有效降低 MITM</p>\n</li>\n<li><p>保客戶端在有效時間內使用 HTTPS 訪問伺服器</p>\n</li>\n</ol>\n<h2 id=\"HSTS-缺點\"><a href=\"#HSTS-缺點\" class=\"headerlink\" title=\"HSTS 缺點\"></a>HSTS 缺點</h2><ol>\n<li><p>在瀏覽器未有 STS Header 時，首次使用 80 port 訪問伺服器時，有可能遭受 MITM</p>\n</li>\n<li><p>無法忽視憑證過期或失效，只要憑證過期或失效就無法訪問網站</p>\n</li>\n<li><p>如果客戶端在接收到 Strict-Transport-Security(STS) Response Header 前就已經是被劫持狀態，因客戶端並非直接與伺服器連線，故伺服器無法將 STS Response Header 帶給客戶端(因為都被中間人擋下來了)</p>\n</li>\n<li><p>若清除瀏覽器快取，下次訪問網站時，會使用 HTTP 訪問，伺服器回應會重新帶上 STS Header</p>\n</li>\n</ol>\n<blockquote>\n<p>關於第一點首次訪問使用 HTTP 的問題，其實可以使用 Preload List 的方式來解決，後續會再寫一篇有關 Preload List</p>\n</blockquote>\n<h2 id=\"HSTS-的注意事項\"><a href=\"#HSTS-的注意事項\" class=\"headerlink\" title=\"HSTS 的注意事項\"></a>HSTS 的注意事項</h2><ol>\n<li><p>IP 的請求 HSTS 無法處理，例如：<code>http://1.1.1.1</code> Response Header 中設置了 STS，瀏覽器也不會理會</p>\n</li>\n<li><p>HSTS 只能在 80 和 443 埠號之間的轉換，如果服務是 8080 埠號，即便設置了 STS 也無效</p>\n</li>\n<li><p>當憑證一旦失效，網站會無法順利開啟</p>\n</li>\n<li><p>如果伺服器的 HTTPS 沒有設定好就開啟了 STS 的 Response Header，並且設置了很長的過期時間，那麼在你伺服器 HTTPS 設定好之前，用戶都是沒辦法連到伺服器，除非 max-age 過期了(因為客戶端會強制使用 HTTPS 與伺服器連線)</p>\n</li>\n</ol>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://free.com.tw/hsts-preload-list/\">https://free.com.tw/hsts-preload-list/</a></li>\n<li><a href=\"https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/668827/\">https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/668827/</a></li>\n</ul>"},{"title":"Auto Completion不區分大小寫","abbrlink":"3bc3c62d","date":"2021-05-11T08:25:56.000Z","_content":"\n## 前言\n\nBash Completion 可以讓你在使用 Bash 指令時，按「Tab」鍵，讓系統自動幫你把指令補齊，這可以加速你在輸入指令時的速度。\n\n但如果今天我想要進入 Test 的目錄，依照習慣預設輸入法會是小寫所以大部的人會輸入成\n\n- 輸入 `cd t` 再按 Tab 鍵\n\n此時系統就無法幫忙補齊，因為預設會區分大小寫，如果要忽略大小寫可以參考以下方式\n\n<!--more-->\n\n## 解決方式\n\n在家目錄底下有個 `.inputrc` 的檔案，可以最後面補上 `set completion-ignore-case On` 即可。 或者直接輸入以下指令\n\n```bash\necho 'set completion-ignore-case On' >> ~/.inputrc\n```\n\n## 參考資料\n\n- https://caloskao.org/linux-make-tab-auto-completion-case-insensitive-in-the-terminal/\n","source":"_posts/auto-completion-case-insensitive.md","raw":"---\ntitle: Auto Completion不區分大小寫\ntags:\n  - Bash\n  - Auto Completion\n  - Bash Completion\n  - Linux\ncategories:\n  - Linux\nabbrlink: 3bc3c62d\ndate: 2021-05-11 16:25:56\n---\n\n## 前言\n\nBash Completion 可以讓你在使用 Bash 指令時，按「Tab」鍵，讓系統自動幫你把指令補齊，這可以加速你在輸入指令時的速度。\n\n但如果今天我想要進入 Test 的目錄，依照習慣預設輸入法會是小寫所以大部的人會輸入成\n\n- 輸入 `cd t` 再按 Tab 鍵\n\n此時系統就無法幫忙補齊，因為預設會區分大小寫，如果要忽略大小寫可以參考以下方式\n\n<!--more-->\n\n## 解決方式\n\n在家目錄底下有個 `.inputrc` 的檔案，可以最後面補上 `set completion-ignore-case On` 即可。 或者直接輸入以下指令\n\n```bash\necho 'set completion-ignore-case On' >> ~/.inputrc\n```\n\n## 參考資料\n\n- https://caloskao.org/linux-make-tab-auto-completion-case-insensitive-in-the-terminal/\n","slug":"auto-completion-case-insensitive","published":1,"updated":"2024-09-09T07:17:02.648Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5iy000ik0lzfndaa6b0","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Bash Completion 可以讓你在使用 Bash 指令時，按「Tab」鍵，讓系統自動幫你把指令補齊，這可以加速你在輸入指令時的速度。</p>\n<p>但如果今天我想要進入 Test 的目錄，依照習慣預設輸入法會是小寫所以大部的人會輸入成</p>\n<ul>\n<li>輸入 <code>cd t</code> 再按 Tab 鍵</li>\n</ul>\n<p>此時系統就無法幫忙補齊，因為預設會區分大小寫，如果要忽略大小寫可以參考以下方式</p>\n<span id=\"more\"></span>\n\n<h2 id=\"解決方式\"><a href=\"#解決方式\" class=\"headerlink\" title=\"解決方式\"></a>解決方式</h2><p>在家目錄底下有個 <code>.inputrc</code> 的檔案，可以最後面補上 <code>set completion-ignore-case On</code> 即可。 或者直接輸入以下指令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&#x27;set completion-ignore-case On&#x27;</span> &gt;&gt; ~/.inputrc</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://caloskao.org/linux-make-tab-auto-completion-case-insensitive-in-the-terminal/\">https://caloskao.org/linux-make-tab-auto-completion-case-insensitive-in-the-terminal/</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Bash Completion 可以讓你在使用 Bash 指令時，按「Tab」鍵，讓系統自動幫你把指令補齊，這可以加速你在輸入指令時的速度。</p>\n<p>但如果今天我想要進入 Test 的目錄，依照習慣預設輸入法會是小寫所以大部的人會輸入成</p>\n<ul>\n<li>輸入 <code>cd t</code> 再按 Tab 鍵</li>\n</ul>\n<p>此時系統就無法幫忙補齊，因為預設會區分大小寫，如果要忽略大小寫可以參考以下方式</p>","more":"<h2 id=\"解決方式\"><a href=\"#解決方式\" class=\"headerlink\" title=\"解決方式\"></a>解決方式</h2><p>在家目錄底下有個 <code>.inputrc</code> 的檔案，可以最後面補上 <code>set completion-ignore-case On</code> 即可。 或者直接輸入以下指令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&#x27;set completion-ignore-case On&#x27;</span> &gt;&gt; ~/.inputrc</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://caloskao.org/linux-make-tab-auto-completion-case-insensitive-in-the-terminal/\">https://caloskao.org/linux-make-tab-auto-completion-case-insensitive-in-the-terminal/</a></li>\n</ul>"},{"title":"Cloud NAT的限制","abbrlink":"b9db6e7a","date":"2021-05-10T14:04:32.000Z","_content":"\n## 前言\n\n因公司產品是採用 GKE 的基礎設施，為了讓 GKE 對外有一個 static IP，所以有加上 Cloud NAT 的功能，一開始加上去並沒有什麼問題，但日子長了之後，某一天發現要再擴增 Node 時，沒有辦法順利擴增，查了好一段時間才知道，原來是 Cloud NAT 導致要擴增 Node 時沒有辦法擴增，這其實很難想像得到，因為基本上不會有理由去懷疑是 Cloud NAT 所致。\n\n所以這邊紀錄一下遇到的問題，說不定你也正遇到跟我一樣的問題\n\n<!--more-->\n\n## Cloud NAT\n\n在 Cloud NAT 的進階設定中，有一個欄位叫做「每個 VM\n執行個體的最低通訊埠數量」，如果你是使用英文介面會顯示「Minimum ports per VM instance」，就是這個數值會去影響可以運行的機器數量，後來參考外國的一篇文章才了解到此設定的重要性(參考的資料放在文後)，此數值不僅會決定你所選取的 VPC 內可以使用的機器數量，還會決定你的每台機器從 NAT 出去的連線數量，以下詳細說明\n\n### 連線量\n\n「每個 VM 執行個體的最低通訊埠數量」所填入的數值，本質意義是在說明: 你指定的 VPC 底下的每一台機器透過 Cloud NAT 到相同目的 IP 與 port 且使用相同的通訊協定(TCP or UDP) 的連線數量。\n\n舉例來說：預設數值為64，我的 VPC 內有三台機器，其中一台機器連線到 `TCP 1.1.1.1:1000` 此目的的數量有64條，這時此台機器要再連線此目的的連線就會被 drop 掉，導致後續的連線會異常，但是還是可以連線到「其他目的」。\n\n> 此處的「其他目的」是指與 `TCP 1.1.1.1:1000` 不同的「目的IP」或「目的Port」或「通訊協定」\n\n以下都是可以正常連線的目的，而且連線數是個別分開計算，這樣舉例會比較清楚\n\n- UDP 1.1.1.1:1000\n- TCP 2.2.2.2:1000\n- UDP 2.2.2.2:1000\n- TCP 2.2.2.2:2000\n- UDP 2.2.2.2:3000\n\n### 機器數量\n\n再來要討論「每個 VM 執行個體的最低通訊埠數量」的數值要怎麼計算 VPC 底下可以開幾台 Node\n\n每個 Cloud NAT 的 IP 有 65536 個連接埠分別給 TCP 與 UDP 使用，其中有 1024 個是公認通訊埠號(well-known port numbers)，所以實際可使用的連接埠為 64512(65536-1024)，如果使用 Google 給的預設數值64，那每個 NAT IP 可以支援相對應 VPC 底下高達 1008 台 Node (64512/64)，但是缺點就是可乘載的連線數量相對就比較少，如果想要擴增可乘載的機器數量，可以增加 NAT IP 來解決，如果在 Cloud NAT 放上第二組 NAT IP，此時 Node 就可以到 2016(1008*2) 那麼多。\n\n## 參考資料\n\n- https://medium.com/bluekiri/high-availability-nat-gateway-at-google-cloud-platform-with-cloud-nat-8a792b1c4cc4\n","source":"_posts/cloud-NAT-limit.md","raw":"---\ntitle: Cloud NAT的限制\ntags:\n  - GKE\n  - GCP\n  - Google Cloud Platform\n  - Cloud NAT\ncategories:\n  - GCP\nabbrlink: b9db6e7a\ndate: 2021-05-10 22:04:32\n---\n\n## 前言\n\n因公司產品是採用 GKE 的基礎設施，為了讓 GKE 對外有一個 static IP，所以有加上 Cloud NAT 的功能，一開始加上去並沒有什麼問題，但日子長了之後，某一天發現要再擴增 Node 時，沒有辦法順利擴增，查了好一段時間才知道，原來是 Cloud NAT 導致要擴增 Node 時沒有辦法擴增，這其實很難想像得到，因為基本上不會有理由去懷疑是 Cloud NAT 所致。\n\n所以這邊紀錄一下遇到的問題，說不定你也正遇到跟我一樣的問題\n\n<!--more-->\n\n## Cloud NAT\n\n在 Cloud NAT 的進階設定中，有一個欄位叫做「每個 VM\n執行個體的最低通訊埠數量」，如果你是使用英文介面會顯示「Minimum ports per VM instance」，就是這個數值會去影響可以運行的機器數量，後來參考外國的一篇文章才了解到此設定的重要性(參考的資料放在文後)，此數值不僅會決定你所選取的 VPC 內可以使用的機器數量，還會決定你的每台機器從 NAT 出去的連線數量，以下詳細說明\n\n### 連線量\n\n「每個 VM 執行個體的最低通訊埠數量」所填入的數值，本質意義是在說明: 你指定的 VPC 底下的每一台機器透過 Cloud NAT 到相同目的 IP 與 port 且使用相同的通訊協定(TCP or UDP) 的連線數量。\n\n舉例來說：預設數值為64，我的 VPC 內有三台機器，其中一台機器連線到 `TCP 1.1.1.1:1000` 此目的的數量有64條，這時此台機器要再連線此目的的連線就會被 drop 掉，導致後續的連線會異常，但是還是可以連線到「其他目的」。\n\n> 此處的「其他目的」是指與 `TCP 1.1.1.1:1000` 不同的「目的IP」或「目的Port」或「通訊協定」\n\n以下都是可以正常連線的目的，而且連線數是個別分開計算，這樣舉例會比較清楚\n\n- UDP 1.1.1.1:1000\n- TCP 2.2.2.2:1000\n- UDP 2.2.2.2:1000\n- TCP 2.2.2.2:2000\n- UDP 2.2.2.2:3000\n\n### 機器數量\n\n再來要討論「每個 VM 執行個體的最低通訊埠數量」的數值要怎麼計算 VPC 底下可以開幾台 Node\n\n每個 Cloud NAT 的 IP 有 65536 個連接埠分別給 TCP 與 UDP 使用，其中有 1024 個是公認通訊埠號(well-known port numbers)，所以實際可使用的連接埠為 64512(65536-1024)，如果使用 Google 給的預設數值64，那每個 NAT IP 可以支援相對應 VPC 底下高達 1008 台 Node (64512/64)，但是缺點就是可乘載的連線數量相對就比較少，如果想要擴增可乘載的機器數量，可以增加 NAT IP 來解決，如果在 Cloud NAT 放上第二組 NAT IP，此時 Node 就可以到 2016(1008*2) 那麼多。\n\n## 參考資料\n\n- https://medium.com/bluekiri/high-availability-nat-gateway-at-google-cloud-platform-with-cloud-nat-8a792b1c4cc4\n","slug":"cloud-NAT-limit","published":1,"updated":"2024-09-09T07:17:02.648Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5j0000mk0lz8zum81xn","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>因公司產品是採用 GKE 的基礎設施，為了讓 GKE 對外有一個 static IP，所以有加上 Cloud NAT 的功能，一開始加上去並沒有什麼問題，但日子長了之後，某一天發現要再擴增 Node 時，沒有辦法順利擴增，查了好一段時間才知道，原來是 Cloud NAT 導致要擴增 Node 時沒有辦法擴增，這其實很難想像得到，因為基本上不會有理由去懷疑是 Cloud NAT 所致。</p>\n<p>所以這邊紀錄一下遇到的問題，說不定你也正遇到跟我一樣的問題</p>\n<span id=\"more\"></span>\n\n<h2 id=\"Cloud-NAT\"><a href=\"#Cloud-NAT\" class=\"headerlink\" title=\"Cloud NAT\"></a>Cloud NAT</h2><p>在 Cloud NAT 的進階設定中，有一個欄位叫做「每個 VM<br>執行個體的最低通訊埠數量」，如果你是使用英文介面會顯示「Minimum ports per VM instance」，就是這個數值會去影響可以運行的機器數量，後來參考外國的一篇文章才了解到此設定的重要性(參考的資料放在文後)，此數值不僅會決定你所選取的 VPC 內可以使用的機器數量，還會決定你的每台機器從 NAT 出去的連線數量，以下詳細說明</p>\n<h3 id=\"連線量\"><a href=\"#連線量\" class=\"headerlink\" title=\"連線量\"></a>連線量</h3><p>「每個 VM 執行個體的最低通訊埠數量」所填入的數值，本質意義是在說明: 你指定的 VPC 底下的每一台機器透過 Cloud NAT 到相同目的 IP 與 port 且使用相同的通訊協定(TCP or UDP) 的連線數量。</p>\n<p>舉例來說：預設數值為64，我的 VPC 內有三台機器，其中一台機器連線到 <code>TCP 1.1.1.1:1000</code> 此目的的數量有64條，這時此台機器要再連線此目的的連線就會被 drop 掉，導致後續的連線會異常，但是還是可以連線到「其他目的」。</p>\n<blockquote>\n<p>此處的「其他目的」是指與 <code>TCP 1.1.1.1:1000</code> 不同的「目的IP」或「目的Port」或「通訊協定」</p>\n</blockquote>\n<p>以下都是可以正常連線的目的，而且連線數是個別分開計算，這樣舉例會比較清楚</p>\n<ul>\n<li>UDP 1.1.1.1:1000</li>\n<li>TCP 2.2.2.2:1000</li>\n<li>UDP 2.2.2.2:1000</li>\n<li>TCP 2.2.2.2:2000</li>\n<li>UDP 2.2.2.2:3000</li>\n</ul>\n<h3 id=\"機器數量\"><a href=\"#機器數量\" class=\"headerlink\" title=\"機器數量\"></a>機器數量</h3><p>再來要討論「每個 VM 執行個體的最低通訊埠數量」的數值要怎麼計算 VPC 底下可以開幾台 Node</p>\n<p>每個 Cloud NAT 的 IP 有 65536 個連接埠分別給 TCP 與 UDP 使用，其中有 1024 個是公認通訊埠號(well-known port numbers)，所以實際可使用的連接埠為 64512(65536-1024)，如果使用 Google 給的預設數值64，那每個 NAT IP 可以支援相對應 VPC 底下高達 1008 台 Node (64512/64)，但是缺點就是可乘載的連線數量相對就比較少，如果想要擴增可乘載的機器數量，可以增加 NAT IP 來解決，如果在 Cloud NAT 放上第二組 NAT IP，此時 Node 就可以到 2016(1008*2) 那麼多。</p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://medium.com/bluekiri/high-availability-nat-gateway-at-google-cloud-platform-with-cloud-nat-8a792b1c4cc4\">https://medium.com/bluekiri/high-availability-nat-gateway-at-google-cloud-platform-with-cloud-nat-8a792b1c4cc4</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>因公司產品是採用 GKE 的基礎設施，為了讓 GKE 對外有一個 static IP，所以有加上 Cloud NAT 的功能，一開始加上去並沒有什麼問題，但日子長了之後，某一天發現要再擴增 Node 時，沒有辦法順利擴增，查了好一段時間才知道，原來是 Cloud NAT 導致要擴增 Node 時沒有辦法擴增，這其實很難想像得到，因為基本上不會有理由去懷疑是 Cloud NAT 所致。</p>\n<p>所以這邊紀錄一下遇到的問題，說不定你也正遇到跟我一樣的問題</p>","more":"<h2 id=\"Cloud-NAT\"><a href=\"#Cloud-NAT\" class=\"headerlink\" title=\"Cloud NAT\"></a>Cloud NAT</h2><p>在 Cloud NAT 的進階設定中，有一個欄位叫做「每個 VM<br>執行個體的最低通訊埠數量」，如果你是使用英文介面會顯示「Minimum ports per VM instance」，就是這個數值會去影響可以運行的機器數量，後來參考外國的一篇文章才了解到此設定的重要性(參考的資料放在文後)，此數值不僅會決定你所選取的 VPC 內可以使用的機器數量，還會決定你的每台機器從 NAT 出去的連線數量，以下詳細說明</p>\n<h3 id=\"連線量\"><a href=\"#連線量\" class=\"headerlink\" title=\"連線量\"></a>連線量</h3><p>「每個 VM 執行個體的最低通訊埠數量」所填入的數值，本質意義是在說明: 你指定的 VPC 底下的每一台機器透過 Cloud NAT 到相同目的 IP 與 port 且使用相同的通訊協定(TCP or UDP) 的連線數量。</p>\n<p>舉例來說：預設數值為64，我的 VPC 內有三台機器，其中一台機器連線到 <code>TCP 1.1.1.1:1000</code> 此目的的數量有64條，這時此台機器要再連線此目的的連線就會被 drop 掉，導致後續的連線會異常，但是還是可以連線到「其他目的」。</p>\n<blockquote>\n<p>此處的「其他目的」是指與 <code>TCP 1.1.1.1:1000</code> 不同的「目的IP」或「目的Port」或「通訊協定」</p>\n</blockquote>\n<p>以下都是可以正常連線的目的，而且連線數是個別分開計算，這樣舉例會比較清楚</p>\n<ul>\n<li>UDP 1.1.1.1:1000</li>\n<li>TCP 2.2.2.2:1000</li>\n<li>UDP 2.2.2.2:1000</li>\n<li>TCP 2.2.2.2:2000</li>\n<li>UDP 2.2.2.2:3000</li>\n</ul>\n<h3 id=\"機器數量\"><a href=\"#機器數量\" class=\"headerlink\" title=\"機器數量\"></a>機器數量</h3><p>再來要討論「每個 VM 執行個體的最低通訊埠數量」的數值要怎麼計算 VPC 底下可以開幾台 Node</p>\n<p>每個 Cloud NAT 的 IP 有 65536 個連接埠分別給 TCP 與 UDP 使用，其中有 1024 個是公認通訊埠號(well-known port numbers)，所以實際可使用的連接埠為 64512(65536-1024)，如果使用 Google 給的預設數值64，那每個 NAT IP 可以支援相對應 VPC 底下高達 1008 台 Node (64512/64)，但是缺點就是可乘載的連線數量相對就比較少，如果想要擴增可乘載的機器數量，可以增加 NAT IP 來解決，如果在 Cloud NAT 放上第二組 NAT IP，此時 Node 就可以到 2016(1008*2) 那麼多。</p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://medium.com/bluekiri/high-availability-nat-gateway-at-google-cloud-platform-with-cloud-nat-8a792b1c4cc4\">https://medium.com/bluekiri/high-availability-nat-gateway-at-google-cloud-platform-with-cloud-nat-8a792b1c4cc4</a></li>\n</ul>"},{"title":"如何自簽憑證(Self-signed certificate)","abbrlink":"643d73cc","_content":"\n## 前言\n\n常常我們在自己本機或開發環境可能需要使用憑證，但是透過憑證認證機構（Certificate Authority，CA）來去做簽發會需要額外花費一筆費用，下面會使用 openssl 的指令來自簽憑證，自簽憑證因為非憑證認證機構所簽發，所以會被瀏覽器判定為不安全的，但還是有加密的效果\n\nGoogle Chrome 於2017年1月1日起，終止支援所有SHA-1憑證，所以下面的範例會以SHA-2(SHA256) 來簽發\n\n<!--more-->\n\n## 自簽憑證的方式\n\n安裝 openssl 套件，如果是用紅帽系列的作業系統，可以直接 yum 安裝，如果是使用 Mac OS X 或者其他作業系統，再自行依照個系統的方式來安裝\n\n```\nyum install openssl\n```\n\n產生私鑰(private key)，名稱為 ca.key，名稱可以自取 `[key_Name].key`\n\n```\nopenssl genrsa -out ca.key 4096\n```\n\n利用剛剛的私鑰來產生csr，這邊指令產生出來的檔案名稱為 ca.csr，名稱可以自取 `[csr_Name].csr`，記得加上 `-sha256` 參數\n\n> 如果是要拿到憑證認證機構(CA) 去簽發，就是拿 csr 去提交並驗證，完成後證認證機構就會給你 crt 檔案\n\n```\nopenssl req -new -sha256 -key ca.key -out ca.csr\n```\n\n再來系統會請你填入憑證資訊，以下僅供參考，請依照自己的實際環境填寫\n\n```\nCountry Name (2 letter code) []:TW → 一定要填兩個字母\nState or Province Name (full name) []:Taichung\nLocality Name (eg, city) []:Taichung\nOrganization Name (eg, company) []:abc\nOrganizational Unit Name (eg, section) []:RD\nCommon Name (eg, fully qualified host name) []:localhost → 依照自己的實際情況填寫，如果是跑 localhost 就填入 localhost\nEmail Address []:xx@gmail.com\n\nPlease enter the following 'extra' attributes\nto be sent with your certificate request\nA challenge password []: 直接 enter 略過\n```\n\n驗證是否為 SHA256 → Signature Algorithm: sha256WithRSAEncryption\n\n```\nopenssl req -in ca.csr -text\n```\n\n因為這邊訴求是自簽憑證，所以我們必須自己擔任憑證認證機構，自己簽發自己的 crt，拿著剛剛產生的 key 和 csr 來簽發，下面簽發到期天數是3650天，可以自行調整，輸出的 crt 的檔名為 ca.crt，名稱可以自取 `[crt_Name].crt`，這邊也要記得加上 `-sha256` 參數\n\n```\nopenssl x509 -req -days 3650 -in ca.csr -signkey ca.key -sha256 -out ca.crt\n```\n\n驗證是否為 SHA256 → Signature Algorithm: sha256WithRSAEncryption\n\n```\nopenssl x509 -in ca.crt -text\n```\n\n以上就是自簽憑證的方式\n\n## 參考資料\n\n- https://blog.codebar.tw/self-signed-certificate-by-using-openssl-ec22a0257a28\n- https://blog.gslin.org/archives/2014/11/20/5353/openssl-%E7%94%A2%E7%94%9F%E4%B8%A6%E7%B0%BD%E5%87%BA-sha2-sha256-%E7%9A%84%E6%86%91%E8%AD%89/\n","source":"_drafts/如何自簽憑證.md","raw":"---\ntitle: 如何自簽憑證(Self-signed certificate)\ntags:\n  - openssl\n  - CA\n  - HTTPS\n  - SSL憑證\n  - certificate\n  - SHA256\n  - SHA-2\ncategories:\n  - Linux\nabbrlink: 643d73cc\n---\n\n## 前言\n\n常常我們在自己本機或開發環境可能需要使用憑證，但是透過憑證認證機構（Certificate Authority，CA）來去做簽發會需要額外花費一筆費用，下面會使用 openssl 的指令來自簽憑證，自簽憑證因為非憑證認證機構所簽發，所以會被瀏覽器判定為不安全的，但還是有加密的效果\n\nGoogle Chrome 於2017年1月1日起，終止支援所有SHA-1憑證，所以下面的範例會以SHA-2(SHA256) 來簽發\n\n<!--more-->\n\n## 自簽憑證的方式\n\n安裝 openssl 套件，如果是用紅帽系列的作業系統，可以直接 yum 安裝，如果是使用 Mac OS X 或者其他作業系統，再自行依照個系統的方式來安裝\n\n```\nyum install openssl\n```\n\n產生私鑰(private key)，名稱為 ca.key，名稱可以自取 `[key_Name].key`\n\n```\nopenssl genrsa -out ca.key 4096\n```\n\n利用剛剛的私鑰來產生csr，這邊指令產生出來的檔案名稱為 ca.csr，名稱可以自取 `[csr_Name].csr`，記得加上 `-sha256` 參數\n\n> 如果是要拿到憑證認證機構(CA) 去簽發，就是拿 csr 去提交並驗證，完成後證認證機構就會給你 crt 檔案\n\n```\nopenssl req -new -sha256 -key ca.key -out ca.csr\n```\n\n再來系統會請你填入憑證資訊，以下僅供參考，請依照自己的實際環境填寫\n\n```\nCountry Name (2 letter code) []:TW → 一定要填兩個字母\nState or Province Name (full name) []:Taichung\nLocality Name (eg, city) []:Taichung\nOrganization Name (eg, company) []:abc\nOrganizational Unit Name (eg, section) []:RD\nCommon Name (eg, fully qualified host name) []:localhost → 依照自己的實際情況填寫，如果是跑 localhost 就填入 localhost\nEmail Address []:xx@gmail.com\n\nPlease enter the following 'extra' attributes\nto be sent with your certificate request\nA challenge password []: 直接 enter 略過\n```\n\n驗證是否為 SHA256 → Signature Algorithm: sha256WithRSAEncryption\n\n```\nopenssl req -in ca.csr -text\n```\n\n因為這邊訴求是自簽憑證，所以我們必須自己擔任憑證認證機構，自己簽發自己的 crt，拿著剛剛產生的 key 和 csr 來簽發，下面簽發到期天數是3650天，可以自行調整，輸出的 crt 的檔名為 ca.crt，名稱可以自取 `[crt_Name].crt`，這邊也要記得加上 `-sha256` 參數\n\n```\nopenssl x509 -req -days 3650 -in ca.csr -signkey ca.key -sha256 -out ca.crt\n```\n\n驗證是否為 SHA256 → Signature Algorithm: sha256WithRSAEncryption\n\n```\nopenssl x509 -in ca.crt -text\n```\n\n以上就是自簽憑證的方式\n\n## 參考資料\n\n- https://blog.codebar.tw/self-signed-certificate-by-using-openssl-ec22a0257a28\n- https://blog.gslin.org/archives/2014/11/20/5353/openssl-%E7%94%A2%E7%94%9F%E4%B8%A6%E7%B0%BD%E5%87%BA-sha2-sha256-%E7%9A%84%E6%86%91%E8%AD%89/\n","slug":"如何自簽憑證","published":0,"date":"2024-09-09T07:17:02.647Z","updated":"2024-09-09T07:17:02.647Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5j2000pk0lze92c4ml1","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>常常我們在自己本機或開發環境可能需要使用憑證，但是透過憑證認證機構（Certificate Authority，CA）來去做簽發會需要額外花費一筆費用，下面會使用 openssl 的指令來自簽憑證，自簽憑證因為非憑證認證機構所簽發，所以會被瀏覽器判定為不安全的，但還是有加密的效果</p>\n<p>Google Chrome 於2017年1月1日起，終止支援所有SHA-1憑證，所以下面的範例會以SHA-2(SHA256) 來簽發</p>\n<span id=\"more\"></span>\n\n<h2 id=\"自簽憑證的方式\"><a href=\"#自簽憑證的方式\" class=\"headerlink\" title=\"自簽憑證的方式\"></a>自簽憑證的方式</h2><p>安裝 openssl 套件，如果是用紅帽系列的作業系統，可以直接 yum 安裝，如果是使用 Mac OS X 或者其他作業系統，再自行依照個系統的方式來安裝</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install openssl</span><br></pre></td></tr></table></figure>\n\n<p>產生私鑰(private key)，名稱為 ca.key，名稱可以自取 <code>[key_Name].key</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl genrsa -out ca.key 4096</span><br></pre></td></tr></table></figure>\n\n<p>利用剛剛的私鑰來產生csr，這邊指令產生出來的檔案名稱為 ca.csr，名稱可以自取 <code>[csr_Name].csr</code>，記得加上 <code>-sha256</code> 參數</p>\n<blockquote>\n<p>如果是要拿到憑證認證機構(CA) 去簽發，就是拿 csr 去提交並驗證，完成後證認證機構就會給你 crt 檔案</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl req -new -sha256 -key ca.key -out ca.csr</span><br></pre></td></tr></table></figure>\n\n<p>再來系統會請你填入憑證資訊，以下僅供參考，請依照自己的實際環境填寫</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Country Name (2 letter code) []:TW → 一定要填兩個字母</span><br><span class=\"line\">State or Province Name (full name) []:Taichung</span><br><span class=\"line\">Locality Name (eg, city) []:Taichung</span><br><span class=\"line\">Organization Name (eg, company) []:abc</span><br><span class=\"line\">Organizational Unit Name (eg, section) []:RD</span><br><span class=\"line\">Common Name (eg, fully qualified host name) []:localhost → 依照自己的實際情況填寫，如果是跑 localhost 就填入 localhost</span><br><span class=\"line\">Email Address []:xx@gmail.com</span><br><span class=\"line\"></span><br><span class=\"line\">Please enter the following &#39;extra&#39; attributes</span><br><span class=\"line\">to be sent with your certificate request</span><br><span class=\"line\">A challenge password []: 直接 enter 略過</span><br></pre></td></tr></table></figure>\n\n<p>驗證是否為 SHA256 → Signature Algorithm: sha256WithRSAEncryption</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl req -in ca.csr -text</span><br></pre></td></tr></table></figure>\n\n<p>因為這邊訴求是自簽憑證，所以我們必須自己擔任憑證認證機構，自己簽發自己的 crt，拿著剛剛產生的 key 和 csr 來簽發，下面簽發到期天數是3650天，可以自行調整，輸出的 crt 的檔名為 ca.crt，名稱可以自取 <code>[crt_Name].crt</code>，這邊也要記得加上 <code>-sha256</code> 參數</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl x509 -req -days 3650 -in ca.csr -signkey ca.key -sha256 -out ca.crt</span><br></pre></td></tr></table></figure>\n\n<p>驗證是否為 SHA256 → Signature Algorithm: sha256WithRSAEncryption</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl x509 -in ca.crt -text</span><br></pre></td></tr></table></figure>\n\n<p>以上就是自簽憑證的方式</p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://blog.codebar.tw/self-signed-certificate-by-using-openssl-ec22a0257a28\">https://blog.codebar.tw/self-signed-certificate-by-using-openssl-ec22a0257a28</a></li>\n<li><a href=\"https://blog.gslin.org/archives/2014/11/20/5353/openssl-%E7%94%A2%E7%94%9F%E4%B8%A6%E7%B0%BD%E5%87%BA-sha2-sha256-%E7%9A%84%E6%86%91%E8%AD%89/\">https://blog.gslin.org/archives/2014/11/20/5353/openssl-%E7%94%A2%E7%94%9F%E4%B8%A6%E7%B0%BD%E5%87%BA-sha2-sha256-%E7%9A%84%E6%86%91%E8%AD%89/</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>常常我們在自己本機或開發環境可能需要使用憑證，但是透過憑證認證機構（Certificate Authority，CA）來去做簽發會需要額外花費一筆費用，下面會使用 openssl 的指令來自簽憑證，自簽憑證因為非憑證認證機構所簽發，所以會被瀏覽器判定為不安全的，但還是有加密的效果</p>\n<p>Google Chrome 於2017年1月1日起，終止支援所有SHA-1憑證，所以下面的範例會以SHA-2(SHA256) 來簽發</p>","more":"<h2 id=\"自簽憑證的方式\"><a href=\"#自簽憑證的方式\" class=\"headerlink\" title=\"自簽憑證的方式\"></a>自簽憑證的方式</h2><p>安裝 openssl 套件，如果是用紅帽系列的作業系統，可以直接 yum 安裝，如果是使用 Mac OS X 或者其他作業系統，再自行依照個系統的方式來安裝</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install openssl</span><br></pre></td></tr></table></figure>\n\n<p>產生私鑰(private key)，名稱為 ca.key，名稱可以自取 <code>[key_Name].key</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl genrsa -out ca.key 4096</span><br></pre></td></tr></table></figure>\n\n<p>利用剛剛的私鑰來產生csr，這邊指令產生出來的檔案名稱為 ca.csr，名稱可以自取 <code>[csr_Name].csr</code>，記得加上 <code>-sha256</code> 參數</p>\n<blockquote>\n<p>如果是要拿到憑證認證機構(CA) 去簽發，就是拿 csr 去提交並驗證，完成後證認證機構就會給你 crt 檔案</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl req -new -sha256 -key ca.key -out ca.csr</span><br></pre></td></tr></table></figure>\n\n<p>再來系統會請你填入憑證資訊，以下僅供參考，請依照自己的實際環境填寫</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Country Name (2 letter code) []:TW → 一定要填兩個字母</span><br><span class=\"line\">State or Province Name (full name) []:Taichung</span><br><span class=\"line\">Locality Name (eg, city) []:Taichung</span><br><span class=\"line\">Organization Name (eg, company) []:abc</span><br><span class=\"line\">Organizational Unit Name (eg, section) []:RD</span><br><span class=\"line\">Common Name (eg, fully qualified host name) []:localhost → 依照自己的實際情況填寫，如果是跑 localhost 就填入 localhost</span><br><span class=\"line\">Email Address []:xx@gmail.com</span><br><span class=\"line\"></span><br><span class=\"line\">Please enter the following &#39;extra&#39; attributes</span><br><span class=\"line\">to be sent with your certificate request</span><br><span class=\"line\">A challenge password []: 直接 enter 略過</span><br></pre></td></tr></table></figure>\n\n<p>驗證是否為 SHA256 → Signature Algorithm: sha256WithRSAEncryption</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl req -in ca.csr -text</span><br></pre></td></tr></table></figure>\n\n<p>因為這邊訴求是自簽憑證，所以我們必須自己擔任憑證認證機構，自己簽發自己的 crt，拿著剛剛產生的 key 和 csr 來簽發，下面簽發到期天數是3650天，可以自行調整，輸出的 crt 的檔名為 ca.crt，名稱可以自取 <code>[crt_Name].crt</code>，這邊也要記得加上 <code>-sha256</code> 參數</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl x509 -req -days 3650 -in ca.csr -signkey ca.key -sha256 -out ca.crt</span><br></pre></td></tr></table></figure>\n\n<p>驗證是否為 SHA256 → Signature Algorithm: sha256WithRSAEncryption</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl x509 -in ca.crt -text</span><br></pre></td></tr></table></figure>\n\n<p>以上就是自簽憑證的方式</p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://blog.codebar.tw/self-signed-certificate-by-using-openssl-ec22a0257a28\">https://blog.codebar.tw/self-signed-certificate-by-using-openssl-ec22a0257a28</a></li>\n<li><a href=\"https://blog.gslin.org/archives/2014/11/20/5353/openssl-%E7%94%A2%E7%94%9F%E4%B8%A6%E7%B0%BD%E5%87%BA-sha2-sha256-%E7%9A%84%E6%86%91%E8%AD%89/\">https://blog.gslin.org/archives/2014/11/20/5353/openssl-%E7%94%A2%E7%94%9F%E4%B8%A6%E7%B0%BD%E5%87%BA-sha2-sha256-%E7%9A%84%E6%86%91%E8%AD%89/</a></li>\n</ul>"},{"title":"透過 Auth Proxy 存取 Cloud SQL","abbrlink":"3850bdf7","date":"2024-01-29T02:53:21.000Z","_content":"\n\n## 前言\n\n一般來說，要連線到 Could SQL 需要透過 Proxy 與 GCP 做授權驗證，而該代理工具稱為「Cloud SQL Auth Proxy」\n\nCloud SQL Auth Proxy 是存取 Could SQL 的連線工具，讓我們無須額外設定網路授權或 SSL 的相關設定，提供較安全的存取方式。\n\n<!-- more -->\n\n使用 Cloud SQL Auth Proxy 的好處大致有三點：\n- 安全的加密連線\n- 透過 IAM 的簡易連線授權\n- 自動更新 OAuth 2.0 Token\n\n有興趣深入了解，可以參考[官方文件](https://cloud.google.com/sql/docs/mysql/sql-proxy)\n\n## 大致設定流程\n\n大前提：\n- Google Service Account 簡稱 GSA\n- Kubernetes Service Account 簡稱 KSA\n- Project ID 為 demo-123\n- Cloud SQL 使用的是 MySQL\n\n使用 Google Service Account/E-mail 加上 Cloud SQL Auth Proxy 來做授權驗證，簡單來說，就是透過 Google Service Account/E-mail 的 IAM 權限管控，來決定使用者是否能夠存取到 Cloud SQL 的服務，接著再使用 Cloud SQL 裡面的使用者帳號與 SQL 做連線操作。\n\n主要設定步驟如下\n\n1. 創建 Google Service Account 並賦予 IAM 權限 → roles/cloudsql.client\n\n以下三個 IAM 權限任一皆可\n\n- roles/cloudsql.client\n- roles/cloudsql.editor\n- roles/cloudsql.admin\n\n2. 下載 Google Service Account 的 JWT\n3. 將 JWT 交付給 Cloud SQL Auth Proxy 做授權驗證\n4. 使用 Cloud SQL 的使用者帳號與 Cloud SQL Auth Proxy 做連線\n\n## 本機使用 Cloud SQL Auth Proxy\n \n這種方式是透過 Auth Proxy 與 Cloud SQL 建立起一個 Tunnel，本機就可以直接與 Auth Proxy 連線存取到 Cloud SQL\n\n有兩種方式可以達到目的\n\n- 使用 Google Service Account\n- 使用 E-mail\n\n### 方法一：使用 Service Account\n\n下載相對應作業系統的 Cloud SQL Auth Proxy，並按照官方的方式修改權限\n\nhttps://cloud.google.com/sql/docs/mysql/connect-admin-proxy#cloud-sql-auth-proxy-docker-image_1\n\n建立 Google Service Account\n```bash\ngcloud iam service-accounts create gsa-cloud-sql \\\n    --project=demo-123\n```\n\n並且賦予權限\n> IAM 權限請參考前一節\n```bash\ngcloud projects add-iam-policy-binding demo-123 \\\n    --member \"serviceAccount:gsa-cloud-sql@demo-123.iam.gserviceaccount.com\" \\\n    --role \"roles/cloudsql.client\" \\\n    --project=demo-123\n```\n\n記得把 Google Service Account 的 JWT 下載到本機\n\n使用 TCP Socket 的方式啟用 Cloud SQL Auth Proxy\n```bash\n# Format\n./cloud-sql-proxy --address 0.0.0.0 --port 3306 \\\n    [INSTANCE_CONNECTION_NAME] \\\n    --credentials-file [PATH_TO_KEY_FILE]\n\n# Example\n./cloud-sql-proxy --address 0.0.0.0 --port 3306 \\\n    demo-123:asia-east1:test \\\n    --credentials-file ./demo-123-d617764af0fb.json\n```\n\n連線名稱(connectionName) 的查詢方式，或者直接到網頁看\n```bash\n# Format\ngcloud sql instances describe [Instance_Name] --project=[Project_ID]\n\n# Example\ngcloud sql instances describe test --project=demo-123\n```\n\n最後使用 Cloud SQL 的使用者帳號與 Cloud SQL Auth Proxy 做連線驗證，也可以使用第三方工具來連線測試，例如：MySQL WorkBench, phpMyAdmin...\n\n```bash\nmysql -u [USERNAME] -p --host 127.0.0.1\n```\n\n### 方法二：使用 E-mail\n\n改成使用自己的 E-mail 帳號賦予的 IAM 權限來做授權驗證，確認此帳號是否有存取 cloudSQL 的權限，所以**在 proxy 在與 GCP 做授權驗證前，我們必須手動使用 Cloud SDK 來登入 Google Cloud 並透過瀏覽器來確認 Cloud Identity credentials**，但是一般來說本機都已經有做過此動過了\n\n> uses the Cloud SDK to log in to Google Cloud and enters his Cloud Identity credentials through the web browser.\n\n如果還未執行 Cloud Identity credentials，可以使用下面指令，這部份就不多做說明，當作大家都已經知道如何登入\n```bash\ngcloud auth login\n```\n\n將自己的 E-mail 帳號新增 IAM 權限\n\n```bash\ngcloud projects add-iam-policy-binding demo-123 \\\n    --member \"user:tony@gmail.com\" \\\n    --role \"roles/cloudsql.client\" \\\n    --project=demo-123\n```\n\n產生應用程式使用的 credential，下了該指令後，會有網頁流程要跑，其實就是把你的 E-mail 的權限做成 json 檔，然後 Proxy 程式預設會去拿這支檔案來用\n```bash\ngcloud auth application-default login\n```\n\n這將會在 `${HOME}/.config/gcloud` 產生一個 json 檔 「application_default_credentials.json」，如要撤銷可以使用 `gcloud auth application-default revoke`，此時檔案將會被移除並撤銷\n\n接著直接在本機使用下面指令，可以發現這次的指令是不需要 `--credentials-file`，因為我們需要讓系統自動到 `${HOME}/.config/gcloud` 取得授權驗證\n\n```bash\n# Format\n./cloud-sql-proxy --port 3306 [INSTANCE_CONNECTION_NAME]\n\n# Example\n./cloud-sql-proxy --port 3306 demo-123:asia-east1:test\n```\n\n## Cloud SQL Auth Proxy in K8s\n\n在 GKE 內的 Pod 若是要存取 Cloud SQL，一樣是透過 Cloud SQL Auth Proxy 來做代理的動作，官方建議將 Auth Proxy 以 sidecar 的形式運行在需要使用的 Pod 上，並且依照不同服務給予不同的  Google Service Account，當然如果有特殊理由，也是可以多個 Pod 使用同一個 Cloud SQL Auth Proxy 進行存取。\n\n在 GKE 中使用 Google Service Account，原廠已經建議使用 Workload-Identity 的方式進行綁定，不建議再將 JWT 下載後以 Secret 方式掛載，對於還不知道 GKE Workload-Identity 或者想更進一步了解使用方式的，可以參考我的[另外一篇](https://blog.tonyjhang.dev/posts/7d4918c/#more)，裡面有更詳細的介紹。\n\nGoogle Service Account 的設定，前面已經有步驟，這邊不再重複贅述，直接從 Workload-Identity 中 KSA 和 GSA 綁定步驟開始\n\n建立 K8s ServiceAccount\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: ksa-cloud-sql-proxy\n  namespace: default\n  annotations:\n    iam.gke.io/gcp-service-account: gsa-cloud-sql-proxy@demo-123.iam.gserviceaccount.com\n```\n\n將 KSA(ksa-cloud-sql-proxy) 與 GSA(gsa-cloud-sql-proxy) 進行綁定\n```bash\ngcloud iam service-accounts add-iam-policy-binding gsa-cloud-sql-proxy@demo-123.iam.gserviceaccount.com \\\n    --role roles/iam.workloadIdentityUser \\\n    --member \"serviceAccount:demo-123.svc.id.goog[default/ksa-cloud-sql-proxy]\" \\\n    --project=demo-123\n```\n\n佈署 Cloud SQL Auth Proxy，這邊沒有以 sidecar 方式呈現，如果要以 sidecar 運行的話，可以再自己加以修改\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: cloud-sql-proxy\n  namespace: default\n  labels:\n    app: cloud-sql-proxy\n    product: demo\nspec:\n  type: ClusterIP\n  ports:\n  - port: 3306\n    protocol: TCP\n    targetPort: 3306\n  selector:\n    app: cloud-sql-proxy\n    product: demo\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: cloud-sql-proxy\n  namespace: default\n  labels:\n    app: cloud-sql-proxy\n    product: demo\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: cloud-sql-proxy\n      product: demo\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n  template:\n    metadata:\n      labels:\n        app: cloud-sql-proxy\n        product: demo\n    spec:\n      restartPolicy: Always\n      serviceAccountName: ksa-cloud-sql-proxy\n      containers:\n      - name: cloud-sql-proxy\n        image: gcr.io/cloudsql-docker/gce-proxy:1.33.14\n        imagePullPolicy: Always\n        ports:\n          - containerPort: 3306\n        command:\n          - /cloud_sql_proxy\n          - -instances=demo-123:asia-east1:test=tcp:0.0.0.0:3306\n        env:\n          - name: TZ\n            value: Asia/Taipei\n      nodeSelector:\n        iam.gke.io/gke-metadata-server-enabled: \"true\"\n```\n\n最後用 phpMyAdmin 測試連線情況\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: phpmyadmin\n    repo: demo\n  name: phpmyadmin\n  namespace: default\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: phpmyadmin\n      repo: demo\n  template:\n    metadata:\n      labels:\n        app: phpmyadmin\n        repo: demo\n    spec:\n      containers:\n      - env:\n        - name: PMA_HOST\n          value: cloud-sql-proxy.default.svc.cluster.local # 填入 cloud-sql-proxy 的 service \n        - name: PMA_PORT\n          value: \"3306\"\n        image: phpmyadmin:5.1.1\n        imagePullPolicy: Always\n        name: phpmyadmin\n      restartPolicy: Always\n```\n\n## 文後討論\n\n如果對於 GKE 上使用 Workload-Identity 不懂的，不妨先去[補一下](https://blog.tonyjhang.dev/posts/7d4918c/#more)\n\n官方文件在掛載 KSA 的 deployment 描述檔有加上 `spec.nodeSelector`，來確保服務正常跑在有啟用 Workload-Identity 的 Node 上\n\n```yaml\nspec:\n  nodeSelector:\n    iam.gke.io/gke-metadata-server-enabled: \"true\"\n```\n\n## 參考資料\n\n- https://cloud.google.com/sql/docs/mysql/connect-auth-proxy\n- https://cloud.google.com/sql/docs/mysql/sql-proxy#benefits_of_the\n- https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity","source":"_posts/cloud-sql-auth-proxy.md","raw":"---\ntitle: 透過 Auth Proxy 存取 Cloud SQL\ntags:\n  - GCP\n  - Cloud SQL\n  - Google Cloud Platform\ncategories:\n  - GCP\nabbrlink: 3850bdf7\ndate: 2024-01-29 10:53:21\n---\n\n\n## 前言\n\n一般來說，要連線到 Could SQL 需要透過 Proxy 與 GCP 做授權驗證，而該代理工具稱為「Cloud SQL Auth Proxy」\n\nCloud SQL Auth Proxy 是存取 Could SQL 的連線工具，讓我們無須額外設定網路授權或 SSL 的相關設定，提供較安全的存取方式。\n\n<!-- more -->\n\n使用 Cloud SQL Auth Proxy 的好處大致有三點：\n- 安全的加密連線\n- 透過 IAM 的簡易連線授權\n- 自動更新 OAuth 2.0 Token\n\n有興趣深入了解，可以參考[官方文件](https://cloud.google.com/sql/docs/mysql/sql-proxy)\n\n## 大致設定流程\n\n大前提：\n- Google Service Account 簡稱 GSA\n- Kubernetes Service Account 簡稱 KSA\n- Project ID 為 demo-123\n- Cloud SQL 使用的是 MySQL\n\n使用 Google Service Account/E-mail 加上 Cloud SQL Auth Proxy 來做授權驗證，簡單來說，就是透過 Google Service Account/E-mail 的 IAM 權限管控，來決定使用者是否能夠存取到 Cloud SQL 的服務，接著再使用 Cloud SQL 裡面的使用者帳號與 SQL 做連線操作。\n\n主要設定步驟如下\n\n1. 創建 Google Service Account 並賦予 IAM 權限 → roles/cloudsql.client\n\n以下三個 IAM 權限任一皆可\n\n- roles/cloudsql.client\n- roles/cloudsql.editor\n- roles/cloudsql.admin\n\n2. 下載 Google Service Account 的 JWT\n3. 將 JWT 交付給 Cloud SQL Auth Proxy 做授權驗證\n4. 使用 Cloud SQL 的使用者帳號與 Cloud SQL Auth Proxy 做連線\n\n## 本機使用 Cloud SQL Auth Proxy\n \n這種方式是透過 Auth Proxy 與 Cloud SQL 建立起一個 Tunnel，本機就可以直接與 Auth Proxy 連線存取到 Cloud SQL\n\n有兩種方式可以達到目的\n\n- 使用 Google Service Account\n- 使用 E-mail\n\n### 方法一：使用 Service Account\n\n下載相對應作業系統的 Cloud SQL Auth Proxy，並按照官方的方式修改權限\n\nhttps://cloud.google.com/sql/docs/mysql/connect-admin-proxy#cloud-sql-auth-proxy-docker-image_1\n\n建立 Google Service Account\n```bash\ngcloud iam service-accounts create gsa-cloud-sql \\\n    --project=demo-123\n```\n\n並且賦予權限\n> IAM 權限請參考前一節\n```bash\ngcloud projects add-iam-policy-binding demo-123 \\\n    --member \"serviceAccount:gsa-cloud-sql@demo-123.iam.gserviceaccount.com\" \\\n    --role \"roles/cloudsql.client\" \\\n    --project=demo-123\n```\n\n記得把 Google Service Account 的 JWT 下載到本機\n\n使用 TCP Socket 的方式啟用 Cloud SQL Auth Proxy\n```bash\n# Format\n./cloud-sql-proxy --address 0.0.0.0 --port 3306 \\\n    [INSTANCE_CONNECTION_NAME] \\\n    --credentials-file [PATH_TO_KEY_FILE]\n\n# Example\n./cloud-sql-proxy --address 0.0.0.0 --port 3306 \\\n    demo-123:asia-east1:test \\\n    --credentials-file ./demo-123-d617764af0fb.json\n```\n\n連線名稱(connectionName) 的查詢方式，或者直接到網頁看\n```bash\n# Format\ngcloud sql instances describe [Instance_Name] --project=[Project_ID]\n\n# Example\ngcloud sql instances describe test --project=demo-123\n```\n\n最後使用 Cloud SQL 的使用者帳號與 Cloud SQL Auth Proxy 做連線驗證，也可以使用第三方工具來連線測試，例如：MySQL WorkBench, phpMyAdmin...\n\n```bash\nmysql -u [USERNAME] -p --host 127.0.0.1\n```\n\n### 方法二：使用 E-mail\n\n改成使用自己的 E-mail 帳號賦予的 IAM 權限來做授權驗證，確認此帳號是否有存取 cloudSQL 的權限，所以**在 proxy 在與 GCP 做授權驗證前，我們必須手動使用 Cloud SDK 來登入 Google Cloud 並透過瀏覽器來確認 Cloud Identity credentials**，但是一般來說本機都已經有做過此動過了\n\n> uses the Cloud SDK to log in to Google Cloud and enters his Cloud Identity credentials through the web browser.\n\n如果還未執行 Cloud Identity credentials，可以使用下面指令，這部份就不多做說明，當作大家都已經知道如何登入\n```bash\ngcloud auth login\n```\n\n將自己的 E-mail 帳號新增 IAM 權限\n\n```bash\ngcloud projects add-iam-policy-binding demo-123 \\\n    --member \"user:tony@gmail.com\" \\\n    --role \"roles/cloudsql.client\" \\\n    --project=demo-123\n```\n\n產生應用程式使用的 credential，下了該指令後，會有網頁流程要跑，其實就是把你的 E-mail 的權限做成 json 檔，然後 Proxy 程式預設會去拿這支檔案來用\n```bash\ngcloud auth application-default login\n```\n\n這將會在 `${HOME}/.config/gcloud` 產生一個 json 檔 「application_default_credentials.json」，如要撤銷可以使用 `gcloud auth application-default revoke`，此時檔案將會被移除並撤銷\n\n接著直接在本機使用下面指令，可以發現這次的指令是不需要 `--credentials-file`，因為我們需要讓系統自動到 `${HOME}/.config/gcloud` 取得授權驗證\n\n```bash\n# Format\n./cloud-sql-proxy --port 3306 [INSTANCE_CONNECTION_NAME]\n\n# Example\n./cloud-sql-proxy --port 3306 demo-123:asia-east1:test\n```\n\n## Cloud SQL Auth Proxy in K8s\n\n在 GKE 內的 Pod 若是要存取 Cloud SQL，一樣是透過 Cloud SQL Auth Proxy 來做代理的動作，官方建議將 Auth Proxy 以 sidecar 的形式運行在需要使用的 Pod 上，並且依照不同服務給予不同的  Google Service Account，當然如果有特殊理由，也是可以多個 Pod 使用同一個 Cloud SQL Auth Proxy 進行存取。\n\n在 GKE 中使用 Google Service Account，原廠已經建議使用 Workload-Identity 的方式進行綁定，不建議再將 JWT 下載後以 Secret 方式掛載，對於還不知道 GKE Workload-Identity 或者想更進一步了解使用方式的，可以參考我的[另外一篇](https://blog.tonyjhang.dev/posts/7d4918c/#more)，裡面有更詳細的介紹。\n\nGoogle Service Account 的設定，前面已經有步驟，這邊不再重複贅述，直接從 Workload-Identity 中 KSA 和 GSA 綁定步驟開始\n\n建立 K8s ServiceAccount\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: ksa-cloud-sql-proxy\n  namespace: default\n  annotations:\n    iam.gke.io/gcp-service-account: gsa-cloud-sql-proxy@demo-123.iam.gserviceaccount.com\n```\n\n將 KSA(ksa-cloud-sql-proxy) 與 GSA(gsa-cloud-sql-proxy) 進行綁定\n```bash\ngcloud iam service-accounts add-iam-policy-binding gsa-cloud-sql-proxy@demo-123.iam.gserviceaccount.com \\\n    --role roles/iam.workloadIdentityUser \\\n    --member \"serviceAccount:demo-123.svc.id.goog[default/ksa-cloud-sql-proxy]\" \\\n    --project=demo-123\n```\n\n佈署 Cloud SQL Auth Proxy，這邊沒有以 sidecar 方式呈現，如果要以 sidecar 運行的話，可以再自己加以修改\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: cloud-sql-proxy\n  namespace: default\n  labels:\n    app: cloud-sql-proxy\n    product: demo\nspec:\n  type: ClusterIP\n  ports:\n  - port: 3306\n    protocol: TCP\n    targetPort: 3306\n  selector:\n    app: cloud-sql-proxy\n    product: demo\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: cloud-sql-proxy\n  namespace: default\n  labels:\n    app: cloud-sql-proxy\n    product: demo\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: cloud-sql-proxy\n      product: demo\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n  template:\n    metadata:\n      labels:\n        app: cloud-sql-proxy\n        product: demo\n    spec:\n      restartPolicy: Always\n      serviceAccountName: ksa-cloud-sql-proxy\n      containers:\n      - name: cloud-sql-proxy\n        image: gcr.io/cloudsql-docker/gce-proxy:1.33.14\n        imagePullPolicy: Always\n        ports:\n          - containerPort: 3306\n        command:\n          - /cloud_sql_proxy\n          - -instances=demo-123:asia-east1:test=tcp:0.0.0.0:3306\n        env:\n          - name: TZ\n            value: Asia/Taipei\n      nodeSelector:\n        iam.gke.io/gke-metadata-server-enabled: \"true\"\n```\n\n最後用 phpMyAdmin 測試連線情況\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: phpmyadmin\n    repo: demo\n  name: phpmyadmin\n  namespace: default\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: phpmyadmin\n      repo: demo\n  template:\n    metadata:\n      labels:\n        app: phpmyadmin\n        repo: demo\n    spec:\n      containers:\n      - env:\n        - name: PMA_HOST\n          value: cloud-sql-proxy.default.svc.cluster.local # 填入 cloud-sql-proxy 的 service \n        - name: PMA_PORT\n          value: \"3306\"\n        image: phpmyadmin:5.1.1\n        imagePullPolicy: Always\n        name: phpmyadmin\n      restartPolicy: Always\n```\n\n## 文後討論\n\n如果對於 GKE 上使用 Workload-Identity 不懂的，不妨先去[補一下](https://blog.tonyjhang.dev/posts/7d4918c/#more)\n\n官方文件在掛載 KSA 的 deployment 描述檔有加上 `spec.nodeSelector`，來確保服務正常跑在有啟用 Workload-Identity 的 Node 上\n\n```yaml\nspec:\n  nodeSelector:\n    iam.gke.io/gke-metadata-server-enabled: \"true\"\n```\n\n## 參考資料\n\n- https://cloud.google.com/sql/docs/mysql/connect-auth-proxy\n- https://cloud.google.com/sql/docs/mysql/sql-proxy#benefits_of_the\n- https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity","slug":"cloud-sql-auth-proxy","published":1,"updated":"2024-09-09T07:17:02.649Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5j3000uk0lzg6na64te","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>一般來說，要連線到 Could SQL 需要透過 Proxy 與 GCP 做授權驗證，而該代理工具稱為「Cloud SQL Auth Proxy」</p>\n<p>Cloud SQL Auth Proxy 是存取 Could SQL 的連線工具，讓我們無須額外設定網路授權或 SSL 的相關設定，提供較安全的存取方式。</p>\n<span id=\"more\"></span>\n\n<p>使用 Cloud SQL Auth Proxy 的好處大致有三點：</p>\n<ul>\n<li>安全的加密連線</li>\n<li>透過 IAM 的簡易連線授權</li>\n<li>自動更新 OAuth 2.0 Token</li>\n</ul>\n<p>有興趣深入了解，可以參考<a href=\"https://cloud.google.com/sql/docs/mysql/sql-proxy\">官方文件</a></p>\n<h2 id=\"大致設定流程\"><a href=\"#大致設定流程\" class=\"headerlink\" title=\"大致設定流程\"></a>大致設定流程</h2><p>大前提：</p>\n<ul>\n<li>Google Service Account 簡稱 GSA</li>\n<li>Kubernetes Service Account 簡稱 KSA</li>\n<li>Project ID 為 demo-123</li>\n<li>Cloud SQL 使用的是 MySQL</li>\n</ul>\n<p>使用 Google Service Account/E-mail 加上 Cloud SQL Auth Proxy 來做授權驗證，簡單來說，就是透過 Google Service Account/E-mail 的 IAM 權限管控，來決定使用者是否能夠存取到 Cloud SQL 的服務，接著再使用 Cloud SQL 裡面的使用者帳號與 SQL 做連線操作。</p>\n<p>主要設定步驟如下</p>\n<ol>\n<li>創建 Google Service Account 並賦予 IAM 權限 → roles/cloudsql.client</li>\n</ol>\n<p>以下三個 IAM 權限任一皆可</p>\n<ul>\n<li>roles/cloudsql.client</li>\n<li>roles/cloudsql.editor</li>\n<li>roles/cloudsql.admin</li>\n</ul>\n<ol start=\"2\">\n<li>下載 Google Service Account 的 JWT</li>\n<li>將 JWT 交付給 Cloud SQL Auth Proxy 做授權驗證</li>\n<li>使用 Cloud SQL 的使用者帳號與 Cloud SQL Auth Proxy 做連線</li>\n</ol>\n<h2 id=\"本機使用-Cloud-SQL-Auth-Proxy\"><a href=\"#本機使用-Cloud-SQL-Auth-Proxy\" class=\"headerlink\" title=\"本機使用 Cloud SQL Auth Proxy\"></a>本機使用 Cloud SQL Auth Proxy</h2><p>這種方式是透過 Auth Proxy 與 Cloud SQL 建立起一個 Tunnel，本機就可以直接與 Auth Proxy 連線存取到 Cloud SQL</p>\n<p>有兩種方式可以達到目的</p>\n<ul>\n<li>使用 Google Service Account</li>\n<li>使用 E-mail</li>\n</ul>\n<h3 id=\"方法一：使用-Service-Account\"><a href=\"#方法一：使用-Service-Account\" class=\"headerlink\" title=\"方法一：使用 Service Account\"></a>方法一：使用 Service Account</h3><p>下載相對應作業系統的 Cloud SQL Auth Proxy，並按照官方的方式修改權限</p>\n<p><a href=\"https://cloud.google.com/sql/docs/mysql/connect-admin-proxy#cloud-sql-auth-proxy-docker-image_1\">https://cloud.google.com/sql/docs/mysql/connect-admin-proxy#cloud-sql-auth-proxy-docker-image_1</a></p>\n<p>建立 Google Service Account</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud iam service-accounts create gsa-cloud-sql \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>並且賦予權限</p>\n<blockquote>\n<p>IAM 權限請參考前一節</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud projects add-iam-policy-binding demo-123 \\</span><br><span class=\"line\">    --member <span class=\"string\">&quot;serviceAccount:gsa-cloud-sql@demo-123.iam.gserviceaccount.com&quot;</span> \\</span><br><span class=\"line\">    --role <span class=\"string\">&quot;roles/cloudsql.client&quot;</span> \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>記得把 Google Service Account 的 JWT 下載到本機</p>\n<p>使用 TCP Socket 的方式啟用 Cloud SQL Auth Proxy</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Format</span></span><br><span class=\"line\">./cloud-sql-proxy --address 0.0.0.0 --port 3306 \\</span><br><span class=\"line\">    [INSTANCE_CONNECTION_NAME] \\</span><br><span class=\"line\">    --credentials-file [PATH_TO_KEY_FILE]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Example</span></span><br><span class=\"line\">./cloud-sql-proxy --address 0.0.0.0 --port 3306 \\</span><br><span class=\"line\">    demo-123:asia-east1:<span class=\"built_in\">test</span> \\</span><br><span class=\"line\">    --credentials-file ./demo-123-d617764af0fb.json</span><br></pre></td></tr></table></figure>\n\n<p>連線名稱(connectionName) 的查詢方式，或者直接到網頁看</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Format</span></span><br><span class=\"line\">gcloud sql instances describe [Instance_Name] --project=[Project_ID]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Example</span></span><br><span class=\"line\">gcloud sql instances describe <span class=\"built_in\">test</span> --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>最後使用 Cloud SQL 的使用者帳號與 Cloud SQL Auth Proxy 做連線驗證，也可以使用第三方工具來連線測試，例如：MySQL WorkBench, phpMyAdmin…</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql -u [USERNAME] -p --host 127.0.0.1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"方法二：使用-E-mail\"><a href=\"#方法二：使用-E-mail\" class=\"headerlink\" title=\"方法二：使用 E-mail\"></a>方法二：使用 E-mail</h3><p>改成使用自己的 E-mail 帳號賦予的 IAM 權限來做授權驗證，確認此帳號是否有存取 cloudSQL 的權限，所以<strong>在 proxy 在與 GCP 做授權驗證前，我們必須手動使用 Cloud SDK 來登入 Google Cloud 並透過瀏覽器來確認 Cloud Identity credentials</strong>，但是一般來說本機都已經有做過此動過了</p>\n<blockquote>\n<p>uses the Cloud SDK to log in to Google Cloud and enters his Cloud Identity credentials through the web browser.</p>\n</blockquote>\n<p>如果還未執行 Cloud Identity credentials，可以使用下面指令，這部份就不多做說明，當作大家都已經知道如何登入</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud auth login</span><br></pre></td></tr></table></figure>\n\n<p>將自己的 E-mail 帳號新增 IAM 權限</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud projects add-iam-policy-binding demo-123 \\</span><br><span class=\"line\">    --member <span class=\"string\">&quot;user:tony@gmail.com&quot;</span> \\</span><br><span class=\"line\">    --role <span class=\"string\">&quot;roles/cloudsql.client&quot;</span> \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>產生應用程式使用的 credential，下了該指令後，會有網頁流程要跑，其實就是把你的 E-mail 的權限做成 json 檔，然後 Proxy 程式預設會去拿這支檔案來用</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud auth application-default login</span><br></pre></td></tr></table></figure>\n\n<p>這將會在 <code>$&#123;HOME&#125;/.config/gcloud</code> 產生一個 json 檔 「application_default_credentials.json」，如要撤銷可以使用 <code>gcloud auth application-default revoke</code>，此時檔案將會被移除並撤銷</p>\n<p>接著直接在本機使用下面指令，可以發現這次的指令是不需要 <code>--credentials-file</code>，因為我們需要讓系統自動到 <code>$&#123;HOME&#125;/.config/gcloud</code> 取得授權驗證</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Format</span></span><br><span class=\"line\">./cloud-sql-proxy --port 3306 [INSTANCE_CONNECTION_NAME]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Example</span></span><br><span class=\"line\">./cloud-sql-proxy --port 3306 demo-123:asia-east1:<span class=\"built_in\">test</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Cloud-SQL-Auth-Proxy-in-K8s\"><a href=\"#Cloud-SQL-Auth-Proxy-in-K8s\" class=\"headerlink\" title=\"Cloud SQL Auth Proxy in K8s\"></a>Cloud SQL Auth Proxy in K8s</h2><p>在 GKE 內的 Pod 若是要存取 Cloud SQL，一樣是透過 Cloud SQL Auth Proxy 來做代理的動作，官方建議將 Auth Proxy 以 sidecar 的形式運行在需要使用的 Pod 上，並且依照不同服務給予不同的  Google Service Account，當然如果有特殊理由，也是可以多個 Pod 使用同一個 Cloud SQL Auth Proxy 進行存取。</p>\n<p>在 GKE 中使用 Google Service Account，原廠已經建議使用 Workload-Identity 的方式進行綁定，不建議再將 JWT 下載後以 Secret 方式掛載，對於還不知道 GKE Workload-Identity 或者想更進一步了解使用方式的，可以參考我的<a href=\"https://blog.tonyjhang.dev/posts/7d4918c/#more\">另外一篇</a>，裡面有更詳細的介紹。</p>\n<p>Google Service Account 的設定，前面已經有步驟，這邊不再重複贅述，直接從 Workload-Identity 中 KSA 和 GSA 綁定步驟開始</p>\n<p>建立 K8s ServiceAccount</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ksa-cloud-sql-proxy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">iam.gke.io/gcp-service-account:</span> <span class=\"string\">gsa-cloud-sql-proxy@demo-123.iam.gserviceaccount.com</span></span><br></pre></td></tr></table></figure>\n\n<p>將 KSA(ksa-cloud-sql-proxy) 與 GSA(gsa-cloud-sql-proxy) 進行綁定</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud iam service-accounts add-iam-policy-binding gsa-cloud-sql-proxy@demo-123.iam.gserviceaccount.com \\</span><br><span class=\"line\">    --role roles/iam.workloadIdentityUser \\</span><br><span class=\"line\">    --member <span class=\"string\">&quot;serviceAccount:demo-123.svc.id.goog[default/ksa-cloud-sql-proxy]&quot;</span> \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>佈署 Cloud SQL Auth Proxy，這邊沒有以 sidecar 方式呈現，如果要以 sidecar 運行的話，可以再自己加以修改</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">    <span class=\"attr\">product:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">    <span class=\"attr\">product:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">    <span class=\"attr\">product:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">      <span class=\"attr\">product:</span> <span class=\"string\">demo</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\">    <span class=\"attr\">rollingUpdate:</span></span><br><span class=\"line\">      <span class=\"attr\">maxSurge:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">maxUnavailable:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">        <span class=\"attr\">product:</span> <span class=\"string\">demo</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">ksa-cloud-sql-proxy</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">gcr.io/cloudsql-docker/gce-proxy:1.33.14</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">/cloud_sql_proxy</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">-instances=demo-123:asia-east1:test=tcp:0.0.0.0:3306</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">Asia/Taipei</span></span><br><span class=\"line\">      <span class=\"attr\">nodeSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">iam.gke.io/gke-metadata-server-enabled:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>最後用 phpMyAdmin 測試連線情況</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">phpmyadmin</span></span><br><span class=\"line\">    <span class=\"attr\">repo:</span> <span class=\"string\">demo</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">phpmyadmin</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">phpmyadmin</span></span><br><span class=\"line\">      <span class=\"attr\">repo:</span> <span class=\"string\">demo</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">phpmyadmin</span></span><br><span class=\"line\">        <span class=\"attr\">repo:</span> <span class=\"string\">demo</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">PMA_HOST</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">cloud-sql-proxy.default.svc.cluster.local</span> <span class=\"comment\"># 填入 cloud-sql-proxy 的 service </span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">PMA_PORT</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&quot;3306&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">phpmyadmin:5.1.1</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">phpmyadmin</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>如果對於 GKE 上使用 Workload-Identity 不懂的，不妨先去<a href=\"https://blog.tonyjhang.dev/posts/7d4918c/#more\">補一下</a></p>\n<p>官方文件在掛載 KSA 的 deployment 描述檔有加上 <code>spec.nodeSelector</code>，來確保服務正常跑在有啟用 Workload-Identity 的 Node 上</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">nodeSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">iam.gke.io/gke-metadata-server-enabled:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://cloud.google.com/sql/docs/mysql/connect-auth-proxy\">https://cloud.google.com/sql/docs/mysql/connect-auth-proxy</a></li>\n<li><a href=\"https://cloud.google.com/sql/docs/mysql/sql-proxy#benefits_of_the\">https://cloud.google.com/sql/docs/mysql/sql-proxy#benefits_of_the</a></li>\n<li><a href=\"https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity\">https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>一般來說，要連線到 Could SQL 需要透過 Proxy 與 GCP 做授權驗證，而該代理工具稱為「Cloud SQL Auth Proxy」</p>\n<p>Cloud SQL Auth Proxy 是存取 Could SQL 的連線工具，讓我們無須額外設定網路授權或 SSL 的相關設定，提供較安全的存取方式。</p>","more":"<p>使用 Cloud SQL Auth Proxy 的好處大致有三點：</p>\n<ul>\n<li>安全的加密連線</li>\n<li>透過 IAM 的簡易連線授權</li>\n<li>自動更新 OAuth 2.0 Token</li>\n</ul>\n<p>有興趣深入了解，可以參考<a href=\"https://cloud.google.com/sql/docs/mysql/sql-proxy\">官方文件</a></p>\n<h2 id=\"大致設定流程\"><a href=\"#大致設定流程\" class=\"headerlink\" title=\"大致設定流程\"></a>大致設定流程</h2><p>大前提：</p>\n<ul>\n<li>Google Service Account 簡稱 GSA</li>\n<li>Kubernetes Service Account 簡稱 KSA</li>\n<li>Project ID 為 demo-123</li>\n<li>Cloud SQL 使用的是 MySQL</li>\n</ul>\n<p>使用 Google Service Account/E-mail 加上 Cloud SQL Auth Proxy 來做授權驗證，簡單來說，就是透過 Google Service Account/E-mail 的 IAM 權限管控，來決定使用者是否能夠存取到 Cloud SQL 的服務，接著再使用 Cloud SQL 裡面的使用者帳號與 SQL 做連線操作。</p>\n<p>主要設定步驟如下</p>\n<ol>\n<li>創建 Google Service Account 並賦予 IAM 權限 → roles/cloudsql.client</li>\n</ol>\n<p>以下三個 IAM 權限任一皆可</p>\n<ul>\n<li>roles/cloudsql.client</li>\n<li>roles/cloudsql.editor</li>\n<li>roles/cloudsql.admin</li>\n</ul>\n<ol start=\"2\">\n<li>下載 Google Service Account 的 JWT</li>\n<li>將 JWT 交付給 Cloud SQL Auth Proxy 做授權驗證</li>\n<li>使用 Cloud SQL 的使用者帳號與 Cloud SQL Auth Proxy 做連線</li>\n</ol>\n<h2 id=\"本機使用-Cloud-SQL-Auth-Proxy\"><a href=\"#本機使用-Cloud-SQL-Auth-Proxy\" class=\"headerlink\" title=\"本機使用 Cloud SQL Auth Proxy\"></a>本機使用 Cloud SQL Auth Proxy</h2><p>這種方式是透過 Auth Proxy 與 Cloud SQL 建立起一個 Tunnel，本機就可以直接與 Auth Proxy 連線存取到 Cloud SQL</p>\n<p>有兩種方式可以達到目的</p>\n<ul>\n<li>使用 Google Service Account</li>\n<li>使用 E-mail</li>\n</ul>\n<h3 id=\"方法一：使用-Service-Account\"><a href=\"#方法一：使用-Service-Account\" class=\"headerlink\" title=\"方法一：使用 Service Account\"></a>方法一：使用 Service Account</h3><p>下載相對應作業系統的 Cloud SQL Auth Proxy，並按照官方的方式修改權限</p>\n<p><a href=\"https://cloud.google.com/sql/docs/mysql/connect-admin-proxy#cloud-sql-auth-proxy-docker-image_1\">https://cloud.google.com/sql/docs/mysql/connect-admin-proxy#cloud-sql-auth-proxy-docker-image_1</a></p>\n<p>建立 Google Service Account</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud iam service-accounts create gsa-cloud-sql \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>並且賦予權限</p>\n<blockquote>\n<p>IAM 權限請參考前一節</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud projects add-iam-policy-binding demo-123 \\</span><br><span class=\"line\">    --member <span class=\"string\">&quot;serviceAccount:gsa-cloud-sql@demo-123.iam.gserviceaccount.com&quot;</span> \\</span><br><span class=\"line\">    --role <span class=\"string\">&quot;roles/cloudsql.client&quot;</span> \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>記得把 Google Service Account 的 JWT 下載到本機</p>\n<p>使用 TCP Socket 的方式啟用 Cloud SQL Auth Proxy</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Format</span></span><br><span class=\"line\">./cloud-sql-proxy --address 0.0.0.0 --port 3306 \\</span><br><span class=\"line\">    [INSTANCE_CONNECTION_NAME] \\</span><br><span class=\"line\">    --credentials-file [PATH_TO_KEY_FILE]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Example</span></span><br><span class=\"line\">./cloud-sql-proxy --address 0.0.0.0 --port 3306 \\</span><br><span class=\"line\">    demo-123:asia-east1:<span class=\"built_in\">test</span> \\</span><br><span class=\"line\">    --credentials-file ./demo-123-d617764af0fb.json</span><br></pre></td></tr></table></figure>\n\n<p>連線名稱(connectionName) 的查詢方式，或者直接到網頁看</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Format</span></span><br><span class=\"line\">gcloud sql instances describe [Instance_Name] --project=[Project_ID]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Example</span></span><br><span class=\"line\">gcloud sql instances describe <span class=\"built_in\">test</span> --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>最後使用 Cloud SQL 的使用者帳號與 Cloud SQL Auth Proxy 做連線驗證，也可以使用第三方工具來連線測試，例如：MySQL WorkBench, phpMyAdmin…</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql -u [USERNAME] -p --host 127.0.0.1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"方法二：使用-E-mail\"><a href=\"#方法二：使用-E-mail\" class=\"headerlink\" title=\"方法二：使用 E-mail\"></a>方法二：使用 E-mail</h3><p>改成使用自己的 E-mail 帳號賦予的 IAM 權限來做授權驗證，確認此帳號是否有存取 cloudSQL 的權限，所以<strong>在 proxy 在與 GCP 做授權驗證前，我們必須手動使用 Cloud SDK 來登入 Google Cloud 並透過瀏覽器來確認 Cloud Identity credentials</strong>，但是一般來說本機都已經有做過此動過了</p>\n<blockquote>\n<p>uses the Cloud SDK to log in to Google Cloud and enters his Cloud Identity credentials through the web browser.</p>\n</blockquote>\n<p>如果還未執行 Cloud Identity credentials，可以使用下面指令，這部份就不多做說明，當作大家都已經知道如何登入</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud auth login</span><br></pre></td></tr></table></figure>\n\n<p>將自己的 E-mail 帳號新增 IAM 權限</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud projects add-iam-policy-binding demo-123 \\</span><br><span class=\"line\">    --member <span class=\"string\">&quot;user:tony@gmail.com&quot;</span> \\</span><br><span class=\"line\">    --role <span class=\"string\">&quot;roles/cloudsql.client&quot;</span> \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>產生應用程式使用的 credential，下了該指令後，會有網頁流程要跑，其實就是把你的 E-mail 的權限做成 json 檔，然後 Proxy 程式預設會去拿這支檔案來用</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud auth application-default login</span><br></pre></td></tr></table></figure>\n\n<p>這將會在 <code>$&#123;HOME&#125;/.config/gcloud</code> 產生一個 json 檔 「application_default_credentials.json」，如要撤銷可以使用 <code>gcloud auth application-default revoke</code>，此時檔案將會被移除並撤銷</p>\n<p>接著直接在本機使用下面指令，可以發現這次的指令是不需要 <code>--credentials-file</code>，因為我們需要讓系統自動到 <code>$&#123;HOME&#125;/.config/gcloud</code> 取得授權驗證</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Format</span></span><br><span class=\"line\">./cloud-sql-proxy --port 3306 [INSTANCE_CONNECTION_NAME]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Example</span></span><br><span class=\"line\">./cloud-sql-proxy --port 3306 demo-123:asia-east1:<span class=\"built_in\">test</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Cloud-SQL-Auth-Proxy-in-K8s\"><a href=\"#Cloud-SQL-Auth-Proxy-in-K8s\" class=\"headerlink\" title=\"Cloud SQL Auth Proxy in K8s\"></a>Cloud SQL Auth Proxy in K8s</h2><p>在 GKE 內的 Pod 若是要存取 Cloud SQL，一樣是透過 Cloud SQL Auth Proxy 來做代理的動作，官方建議將 Auth Proxy 以 sidecar 的形式運行在需要使用的 Pod 上，並且依照不同服務給予不同的  Google Service Account，當然如果有特殊理由，也是可以多個 Pod 使用同一個 Cloud SQL Auth Proxy 進行存取。</p>\n<p>在 GKE 中使用 Google Service Account，原廠已經建議使用 Workload-Identity 的方式進行綁定，不建議再將 JWT 下載後以 Secret 方式掛載，對於還不知道 GKE Workload-Identity 或者想更進一步了解使用方式的，可以參考我的<a href=\"https://blog.tonyjhang.dev/posts/7d4918c/#more\">另外一篇</a>，裡面有更詳細的介紹。</p>\n<p>Google Service Account 的設定，前面已經有步驟，這邊不再重複贅述，直接從 Workload-Identity 中 KSA 和 GSA 綁定步驟開始</p>\n<p>建立 K8s ServiceAccount</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ksa-cloud-sql-proxy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">iam.gke.io/gcp-service-account:</span> <span class=\"string\">gsa-cloud-sql-proxy@demo-123.iam.gserviceaccount.com</span></span><br></pre></td></tr></table></figure>\n\n<p>將 KSA(ksa-cloud-sql-proxy) 與 GSA(gsa-cloud-sql-proxy) 進行綁定</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud iam service-accounts add-iam-policy-binding gsa-cloud-sql-proxy@demo-123.iam.gserviceaccount.com \\</span><br><span class=\"line\">    --role roles/iam.workloadIdentityUser \\</span><br><span class=\"line\">    --member <span class=\"string\">&quot;serviceAccount:demo-123.svc.id.goog[default/ksa-cloud-sql-proxy]&quot;</span> \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>佈署 Cloud SQL Auth Proxy，這邊沒有以 sidecar 方式呈現，如果要以 sidecar 運行的話，可以再自己加以修改</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">    <span class=\"attr\">product:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">    <span class=\"attr\">product:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">    <span class=\"attr\">product:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">      <span class=\"attr\">product:</span> <span class=\"string\">demo</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\">    <span class=\"attr\">rollingUpdate:</span></span><br><span class=\"line\">      <span class=\"attr\">maxSurge:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">maxUnavailable:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">        <span class=\"attr\">product:</span> <span class=\"string\">demo</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">ksa-cloud-sql-proxy</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">cloud-sql-proxy</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">gcr.io/cloudsql-docker/gce-proxy:1.33.14</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">/cloud_sql_proxy</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">-instances=demo-123:asia-east1:test=tcp:0.0.0.0:3306</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">Asia/Taipei</span></span><br><span class=\"line\">      <span class=\"attr\">nodeSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">iam.gke.io/gke-metadata-server-enabled:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>最後用 phpMyAdmin 測試連線情況</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">phpmyadmin</span></span><br><span class=\"line\">    <span class=\"attr\">repo:</span> <span class=\"string\">demo</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">phpmyadmin</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">phpmyadmin</span></span><br><span class=\"line\">      <span class=\"attr\">repo:</span> <span class=\"string\">demo</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">phpmyadmin</span></span><br><span class=\"line\">        <span class=\"attr\">repo:</span> <span class=\"string\">demo</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">PMA_HOST</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">cloud-sql-proxy.default.svc.cluster.local</span> <span class=\"comment\"># 填入 cloud-sql-proxy 的 service </span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">PMA_PORT</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&quot;3306&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">phpmyadmin:5.1.1</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">phpmyadmin</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>如果對於 GKE 上使用 Workload-Identity 不懂的，不妨先去<a href=\"https://blog.tonyjhang.dev/posts/7d4918c/#more\">補一下</a></p>\n<p>官方文件在掛載 KSA 的 deployment 描述檔有加上 <code>spec.nodeSelector</code>，來確保服務正常跑在有啟用 Workload-Identity 的 Node 上</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">nodeSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">iam.gke.io/gke-metadata-server-enabled:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://cloud.google.com/sql/docs/mysql/connect-auth-proxy\">https://cloud.google.com/sql/docs/mysql/connect-auth-proxy</a></li>\n<li><a href=\"https://cloud.google.com/sql/docs/mysql/sql-proxy#benefits_of_the\">https://cloud.google.com/sql/docs/mysql/sql-proxy#benefits_of_the</a></li>\n<li><a href=\"https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity\">https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity</a></li>\n</ul>"},{"title":"在 K8s 使用 FTP","abbrlink":"2de962d3","date":"2021-04-26T08:15:09.000Z","_content":"\n## 前言\n\n近期因公司內部的需求，需要在本機存取 K8s 內持久化儲存的檔案，原先想使用 NFS 架構來做掛載存取，但是因為這樣有點過於麻煩，後來才想使用 FTP 來實現，下面說明如何在 K8s 實現 FTP 功能，讓本機環境可以存取到持久化硬碟。\n\n<!--more-->\n\n這邊實現的是 SFTP 使用 22 port 連線，存取認證方式可以是使用「金鑰」或是「帳號/密碼驗證」\n\n這邊先簡單羅列步驟：\n1. 產生 ssh 認證使用的金鑰\n2. 編寫 Dockerfile\n3. 編寫 K8s YAML 檔案\n4. 暴露一個 External LoadBalace\n5. 使用 FileZilla 測試\n\n> 環境是使用 GKE(Google Kubernetes Engine)\n\n## 產生 ssh 金鑰\n\n產生 ssh 金鑰是為了讓後續連線時，可以使用金鑰作為驗證，這邊是使用 Mac 的終端機產生，指令參照以下\n\n```bash\nssh-keygen -t rsa -b 4096 -f sftp_key\n```\n\n> Passphrase 設不設定都可以，如果有設定的話，最後以 FileZilla 測試時，private key 需要額外產生 .ppk 檔才能使用，後續會講解\n\n完成後，在你目前位置的目錄上會出現一對金鑰，一個為 public key 另一個為 private key\n\n> 一般來說，我們都會習慣把金鑰統一放置在本機家目錄底下的 .ssh 目錄內，如果自己有習慣的放置地方也可以放到自己習慣的位置\n\n## 編寫 Dockerfile\n\n我們需要將 public key 放進映像檔中，這樣在連線時才有辦法做金鑰驗證。 要實現這方式有兩個：\n\n- 在 ftp 服務啟動時以 volume 方式掛載 public key 到相對位置\n- 直接複製到映像檔內\n\n這邊採用的是第二種方式，編寫 Dockerfile 並將 public key 放進去，我們要將 public key 放到使用者家目錄底下的 `./.ssh/keys` 位置，所以我們需要建立相對應路徑，並將複製進去，可以參考以下\n\n```dockerfile\nFROM atmoz/sftp:alpine\n\nRUN mkdir -p /home/rd/.ssh/keys\nCOPY ./sftp_key.pub /home/rd/.ssh/keys/\n```\n\n這邊使用的 base image 是 atmoz/sftp:alpine，當然你也可以選擇其他版本(eg. debian...)。\n\n最後進行 docker build 的動作，並上傳到存放區\n\n```bash\ndocker build --no-cache -t custom-sftp:alpine -f Dockerfile .\n```\n\n## 編寫 K8s YAML 檔案\n\n因為我們要運行在 GKE 上面，需要編寫 YAML 以便運行與後續管理，這邊是使用 Deployment 的 Object，以下只截取部片重要片段，其餘部分需要自行補齊\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: ftp\n  namespace: default\n...\n    spec:\n      restartPolicy: Always\n      containers:\n      - name: ftp\n        image: [修改為剛剛上傳的映像檔路徑]\n        imagePullPolicy: Always\n        ports:\n          - containerPort: 22\n        args:\n          - rd::::upload\n        volumeMounts:\n          - name: volume-test\n            mountPath: /home/rd/upload/test\n            subPath: upload-image\n      volumes:\n        - name: volume-test\n          persistentVolumeClaim:\n            claimName: mypvc\n```\n\n### snippet 解析\n\n```\nargs:\n  - rd::::upload\n```\n\n啟動參數的意義，這邊是 `rd::::upload`，這表示使用者帳號為rd，並且在家目錄底下建立一個 upload 的目錄(`/home/rd/upload`)，以便做存取，這樣我們就能夠將持久化硬碟掛載到 `/home/rd/upload` 路徑底下。\n\n> 使用者帳號可以自訂，不一定要使用rd\n\n可以看到 rd 的帳號並沒有設定密碼，在沒有設定密碼的情況下，表示認證會使用金鑰認證，那如果要使用密碼驗證可以這樣表示\n\n```\nrd:12345:::upload\n```\n\n這樣表示密碼為 12345\n\n## 暴露一個 External LoadBalace\n\n暴露外部 LB 這樣可以讓本機去存取到 GKE 內的服務，但是白名單記得要設定，以提高安全性\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: ftp-proxy\n  namespace: default\nspec:\n  type: LoadBalancer\n  loadBalancerIP: [填入自己的外網IP]\n  loadBalancerSourceRanges:\n  - [填入自己的白名單]\n  ports:\n    - name: ssh\n      port: 22\n      protocol: TCP\n      targetPort: 22\n  selector:\n    app: ftp\n```\n\n### snippet 解析\n\n```\n...\nports:\n  - name: ssh\n    port: 22\n    protocol: TCP\n    targetPort: 22\n...\n```\n\n其中這段 port 有沒有要改成其他非預設 22 port 都可以，以安全性角度來說可以做個修改，例如 `port: 14322`。 這樣連線時就使用 14322 做連線，GKE 就會自動做 port 的 mapping。\n\n## 使用 FileZilla 測試\n\n最後我們可以下載 FileZilla Client 來測試，如果剛才編寫 Deployment 的 YAML 時，啟動參數有設定密碼的話，就可以直接填入相關資訊做連線測試了。\n\n填入資訊\n- 主機: 填入External LoadBalance 的 IP\n- 使用者名稱: 填入啟動參數設定的使用者\n- 密碼: 填入啟動參數設定的密碼\n- 連接埠: 預設是22，如果剛剛在編寫 External LoadBalace 時，有修改 port，這邊記得要跟著變\n\n如果是使用金鑰驗證，我們要先設定好 private key 的位置，開啟 FileZilla Client，依照下圖點選到設定位置\n\n點選 編輯 → 設定\n\n![](mk-20240119114134.png)\n\n選擇 SFTP 並點選「加入金鑰檔案」，此時會請你選擇 private key 的位置\n\n![](mk-20240119114200.png)\n\n這邊要注意一下，如果一開始產生金鑰時有設定 passphrase，會跳出此視窗，主要是因為他需要將 .key 轉成 .ppk，這邊直接點「是」\n\n![](mk-20240119114218.png)\n\n輸入設定的 passphrase\n\n![](mk-20240119114239.png)\n\n選擇鑰儲存 .ppk 的位置與命名\n\n![](mk-20240119114300.png)\n\n最後再回到主畫面將連線資訊填入，密碼不用填寫，當連線後，會請你輸入 passphrase 的密碼\n","source":"_posts/ftp-in-kubernetes.md","raw":"---\ntitle: 在 K8s 使用 FTP\ntags:\n  - GKE\n  - GCP\n  - Google Cloud Platform\n  - K8s\n  - Kubernetes\n  - FTP\ncategories:\n  - GKE\nabbrlink: 2de962d3\ndate: 2021-04-26 16:15:09\n---\n\n## 前言\n\n近期因公司內部的需求，需要在本機存取 K8s 內持久化儲存的檔案，原先想使用 NFS 架構來做掛載存取，但是因為這樣有點過於麻煩，後來才想使用 FTP 來實現，下面說明如何在 K8s 實現 FTP 功能，讓本機環境可以存取到持久化硬碟。\n\n<!--more-->\n\n這邊實現的是 SFTP 使用 22 port 連線，存取認證方式可以是使用「金鑰」或是「帳號/密碼驗證」\n\n這邊先簡單羅列步驟：\n1. 產生 ssh 認證使用的金鑰\n2. 編寫 Dockerfile\n3. 編寫 K8s YAML 檔案\n4. 暴露一個 External LoadBalace\n5. 使用 FileZilla 測試\n\n> 環境是使用 GKE(Google Kubernetes Engine)\n\n## 產生 ssh 金鑰\n\n產生 ssh 金鑰是為了讓後續連線時，可以使用金鑰作為驗證，這邊是使用 Mac 的終端機產生，指令參照以下\n\n```bash\nssh-keygen -t rsa -b 4096 -f sftp_key\n```\n\n> Passphrase 設不設定都可以，如果有設定的話，最後以 FileZilla 測試時，private key 需要額外產生 .ppk 檔才能使用，後續會講解\n\n完成後，在你目前位置的目錄上會出現一對金鑰，一個為 public key 另一個為 private key\n\n> 一般來說，我們都會習慣把金鑰統一放置在本機家目錄底下的 .ssh 目錄內，如果自己有習慣的放置地方也可以放到自己習慣的位置\n\n## 編寫 Dockerfile\n\n我們需要將 public key 放進映像檔中，這樣在連線時才有辦法做金鑰驗證。 要實現這方式有兩個：\n\n- 在 ftp 服務啟動時以 volume 方式掛載 public key 到相對位置\n- 直接複製到映像檔內\n\n這邊採用的是第二種方式，編寫 Dockerfile 並將 public key 放進去，我們要將 public key 放到使用者家目錄底下的 `./.ssh/keys` 位置，所以我們需要建立相對應路徑，並將複製進去，可以參考以下\n\n```dockerfile\nFROM atmoz/sftp:alpine\n\nRUN mkdir -p /home/rd/.ssh/keys\nCOPY ./sftp_key.pub /home/rd/.ssh/keys/\n```\n\n這邊使用的 base image 是 atmoz/sftp:alpine，當然你也可以選擇其他版本(eg. debian...)。\n\n最後進行 docker build 的動作，並上傳到存放區\n\n```bash\ndocker build --no-cache -t custom-sftp:alpine -f Dockerfile .\n```\n\n## 編寫 K8s YAML 檔案\n\n因為我們要運行在 GKE 上面，需要編寫 YAML 以便運行與後續管理，這邊是使用 Deployment 的 Object，以下只截取部片重要片段，其餘部分需要自行補齊\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: ftp\n  namespace: default\n...\n    spec:\n      restartPolicy: Always\n      containers:\n      - name: ftp\n        image: [修改為剛剛上傳的映像檔路徑]\n        imagePullPolicy: Always\n        ports:\n          - containerPort: 22\n        args:\n          - rd::::upload\n        volumeMounts:\n          - name: volume-test\n            mountPath: /home/rd/upload/test\n            subPath: upload-image\n      volumes:\n        - name: volume-test\n          persistentVolumeClaim:\n            claimName: mypvc\n```\n\n### snippet 解析\n\n```\nargs:\n  - rd::::upload\n```\n\n啟動參數的意義，這邊是 `rd::::upload`，這表示使用者帳號為rd，並且在家目錄底下建立一個 upload 的目錄(`/home/rd/upload`)，以便做存取，這樣我們就能夠將持久化硬碟掛載到 `/home/rd/upload` 路徑底下。\n\n> 使用者帳號可以自訂，不一定要使用rd\n\n可以看到 rd 的帳號並沒有設定密碼，在沒有設定密碼的情況下，表示認證會使用金鑰認證，那如果要使用密碼驗證可以這樣表示\n\n```\nrd:12345:::upload\n```\n\n這樣表示密碼為 12345\n\n## 暴露一個 External LoadBalace\n\n暴露外部 LB 這樣可以讓本機去存取到 GKE 內的服務，但是白名單記得要設定，以提高安全性\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: ftp-proxy\n  namespace: default\nspec:\n  type: LoadBalancer\n  loadBalancerIP: [填入自己的外網IP]\n  loadBalancerSourceRanges:\n  - [填入自己的白名單]\n  ports:\n    - name: ssh\n      port: 22\n      protocol: TCP\n      targetPort: 22\n  selector:\n    app: ftp\n```\n\n### snippet 解析\n\n```\n...\nports:\n  - name: ssh\n    port: 22\n    protocol: TCP\n    targetPort: 22\n...\n```\n\n其中這段 port 有沒有要改成其他非預設 22 port 都可以，以安全性角度來說可以做個修改，例如 `port: 14322`。 這樣連線時就使用 14322 做連線，GKE 就會自動做 port 的 mapping。\n\n## 使用 FileZilla 測試\n\n最後我們可以下載 FileZilla Client 來測試，如果剛才編寫 Deployment 的 YAML 時，啟動參數有設定密碼的話，就可以直接填入相關資訊做連線測試了。\n\n填入資訊\n- 主機: 填入External LoadBalance 的 IP\n- 使用者名稱: 填入啟動參數設定的使用者\n- 密碼: 填入啟動參數設定的密碼\n- 連接埠: 預設是22，如果剛剛在編寫 External LoadBalace 時，有修改 port，這邊記得要跟著變\n\n如果是使用金鑰驗證，我們要先設定好 private key 的位置，開啟 FileZilla Client，依照下圖點選到設定位置\n\n點選 編輯 → 設定\n\n![](mk-20240119114134.png)\n\n選擇 SFTP 並點選「加入金鑰檔案」，此時會請你選擇 private key 的位置\n\n![](mk-20240119114200.png)\n\n這邊要注意一下，如果一開始產生金鑰時有設定 passphrase，會跳出此視窗，主要是因為他需要將 .key 轉成 .ppk，這邊直接點「是」\n\n![](mk-20240119114218.png)\n\n輸入設定的 passphrase\n\n![](mk-20240119114239.png)\n\n選擇鑰儲存 .ppk 的位置與命名\n\n![](mk-20240119114300.png)\n\n最後再回到主畫面將連線資訊填入，密碼不用填寫，當連線後，會請你輸入 passphrase 的密碼\n","slug":"ftp-in-kubernetes","published":1,"updated":"2024-09-09T07:17:02.649Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5j4000wk0lzfcyu69ou","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>近期因公司內部的需求，需要在本機存取 K8s 內持久化儲存的檔案，原先想使用 NFS 架構來做掛載存取，但是因為這樣有點過於麻煩，後來才想使用 FTP 來實現，下面說明如何在 K8s 實現 FTP 功能，讓本機環境可以存取到持久化硬碟。</p>\n<span id=\"more\"></span>\n\n<p>這邊實現的是 SFTP 使用 22 port 連線，存取認證方式可以是使用「金鑰」或是「帳號/密碼驗證」</p>\n<p>這邊先簡單羅列步驟：</p>\n<ol>\n<li>產生 ssh 認證使用的金鑰</li>\n<li>編寫 Dockerfile</li>\n<li>編寫 K8s YAML 檔案</li>\n<li>暴露一個 External LoadBalace</li>\n<li>使用 FileZilla 測試</li>\n</ol>\n<blockquote>\n<p>環境是使用 GKE(Google Kubernetes Engine)</p>\n</blockquote>\n<h2 id=\"產生-ssh-金鑰\"><a href=\"#產生-ssh-金鑰\" class=\"headerlink\" title=\"產生 ssh 金鑰\"></a>產生 ssh 金鑰</h2><p>產生 ssh 金鑰是為了讓後續連線時，可以使用金鑰作為驗證，這邊是使用 Mac 的終端機產生，指令參照以下</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh-keygen -t rsa -b 4096 -f sftp_key</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Passphrase 設不設定都可以，如果有設定的話，最後以 FileZilla 測試時，private key 需要額外產生 .ppk 檔才能使用，後續會講解</p>\n</blockquote>\n<p>完成後，在你目前位置的目錄上會出現一對金鑰，一個為 public key 另一個為 private key</p>\n<blockquote>\n<p>一般來說，我們都會習慣把金鑰統一放置在本機家目錄底下的 .ssh 目錄內，如果自己有習慣的放置地方也可以放到自己習慣的位置</p>\n</blockquote>\n<h2 id=\"編寫-Dockerfile\"><a href=\"#編寫-Dockerfile\" class=\"headerlink\" title=\"編寫 Dockerfile\"></a>編寫 Dockerfile</h2><p>我們需要將 public key 放進映像檔中，這樣在連線時才有辦法做金鑰驗證。 要實現這方式有兩個：</p>\n<ul>\n<li>在 ftp 服務啟動時以 volume 方式掛載 public key 到相對位置</li>\n<li>直接複製到映像檔內</li>\n</ul>\n<p>這邊採用的是第二種方式，編寫 Dockerfile 並將 public key 放進去，我們要將 public key 放到使用者家目錄底下的 <code>./.ssh/keys</code> 位置，所以我們需要建立相對應路徑，並將複製進去，可以參考以下</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> atmoz/sftp:alpine</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> mkdir -p /home/rd/.ssh/keys</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"bash\"> ./sftp_key.pub /home/rd/.ssh/keys/</span></span><br></pre></td></tr></table></figure>\n\n<p>這邊使用的 base image 是 atmoz/sftp:alpine，當然你也可以選擇其他版本(eg. debian…)。</p>\n<p>最後進行 docker build 的動作，並上傳到存放區</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker build --no-cache -t custom-sftp:alpine -f Dockerfile .</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"編寫-K8s-YAML-檔案\"><a href=\"#編寫-K8s-YAML-檔案\" class=\"headerlink\" title=\"編寫 K8s YAML 檔案\"></a>編寫 K8s YAML 檔案</h2><p>因為我們要運行在 GKE 上面，需要編寫 YAML 以便運行與後續管理，這邊是使用 Deployment 的 Object，以下只截取部片重要片段，其餘部分需要自行補齊</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ftp</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"string\">...</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ftp</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> [<span class=\"string\">修改為剛剛上傳的映像檔路徑</span>]</span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">22</span></span><br><span class=\"line\">        <span class=\"attr\">args:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">rd::::upload</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">volume-test</span></span><br><span class=\"line\">            <span class=\"attr\">mountPath:</span> <span class=\"string\">/home/rd/upload/test</span></span><br><span class=\"line\">            <span class=\"attr\">subPath:</span> <span class=\"string\">upload-image</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">volume-test</span></span><br><span class=\"line\">          <span class=\"attr\">persistentVolumeClaim:</span></span><br><span class=\"line\">            <span class=\"attr\">claimName:</span> <span class=\"string\">mypvc</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"snippet-解析\"><a href=\"#snippet-解析\" class=\"headerlink\" title=\"snippet 解析\"></a>snippet 解析</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">args:</span><br><span class=\"line\">  - rd::::upload</span><br></pre></td></tr></table></figure>\n\n<p>啟動參數的意義，這邊是 <code>rd::::upload</code>，這表示使用者帳號為rd，並且在家目錄底下建立一個 upload 的目錄(<code>/home/rd/upload</code>)，以便做存取，這樣我們就能夠將持久化硬碟掛載到 <code>/home/rd/upload</code> 路徑底下。</p>\n<blockquote>\n<p>使用者帳號可以自訂，不一定要使用rd</p>\n</blockquote>\n<p>可以看到 rd 的帳號並沒有設定密碼，在沒有設定密碼的情況下，表示認證會使用金鑰認證，那如果要使用密碼驗證可以這樣表示</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rd:12345:::upload</span><br></pre></td></tr></table></figure>\n\n<p>這樣表示密碼為 12345</p>\n<h2 id=\"暴露一個-External-LoadBalace\"><a href=\"#暴露一個-External-LoadBalace\" class=\"headerlink\" title=\"暴露一個 External LoadBalace\"></a>暴露一個 External LoadBalace</h2><p>暴露外部 LB 這樣可以讓本機去存取到 GKE 內的服務，但是白名單記得要設定，以提高安全性</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ftp-proxy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">LoadBalancer</span></span><br><span class=\"line\">  <span class=\"attr\">loadBalancerIP:</span> [<span class=\"string\">填入自己的外網IP</span>]</span><br><span class=\"line\">  <span class=\"attr\">loadBalancerSourceRanges:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> [<span class=\"string\">填入自己的白名單</span>]</span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ssh</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">22</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">22</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">ftp</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"snippet-解析-1\"><a href=\"#snippet-解析-1\" class=\"headerlink\" title=\"snippet 解析\"></a>snippet 解析</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">ports:</span><br><span class=\"line\">  - name: ssh</span><br><span class=\"line\">    port: 22</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 22</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n\n<p>其中這段 port 有沒有要改成其他非預設 22 port 都可以，以安全性角度來說可以做個修改，例如 <code>port: 14322</code>。 這樣連線時就使用 14322 做連線，GKE 就會自動做 port 的 mapping。</p>\n<h2 id=\"使用-FileZilla-測試\"><a href=\"#使用-FileZilla-測試\" class=\"headerlink\" title=\"使用 FileZilla 測試\"></a>使用 FileZilla 測試</h2><p>最後我們可以下載 FileZilla Client 來測試，如果剛才編寫 Deployment 的 YAML 時，啟動參數有設定密碼的話，就可以直接填入相關資訊做連線測試了。</p>\n<p>填入資訊</p>\n<ul>\n<li>主機: 填入External LoadBalance 的 IP</li>\n<li>使用者名稱: 填入啟動參數設定的使用者</li>\n<li>密碼: 填入啟動參數設定的密碼</li>\n<li>連接埠: 預設是22，如果剛剛在編寫 External LoadBalace 時，有修改 port，這邊記得要跟著變</li>\n</ul>\n<p>如果是使用金鑰驗證，我們要先設定好 private key 的位置，開啟 FileZilla Client，依照下圖點選到設定位置</p>\n<p>點選 編輯 → 設定</p>\n<p><img src=\"mk-20240119114134.png\"></p>\n<p>選擇 SFTP 並點選「加入金鑰檔案」，此時會請你選擇 private key 的位置</p>\n<p><img src=\"mk-20240119114200.png\"></p>\n<p>這邊要注意一下，如果一開始產生金鑰時有設定 passphrase，會跳出此視窗，主要是因為他需要將 .key 轉成 .ppk，這邊直接點「是」</p>\n<p><img src=\"mk-20240119114218.png\"></p>\n<p>輸入設定的 passphrase</p>\n<p><img src=\"mk-20240119114239.png\"></p>\n<p>選擇鑰儲存 .ppk 的位置與命名</p>\n<p><img src=\"mk-20240119114300.png\"></p>\n<p>最後再回到主畫面將連線資訊填入，密碼不用填寫，當連線後，會請你輸入 passphrase 的密碼</p>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>近期因公司內部的需求，需要在本機存取 K8s 內持久化儲存的檔案，原先想使用 NFS 架構來做掛載存取，但是因為這樣有點過於麻煩，後來才想使用 FTP 來實現，下面說明如何在 K8s 實現 FTP 功能，讓本機環境可以存取到持久化硬碟。</p>","more":"<p>這邊實現的是 SFTP 使用 22 port 連線，存取認證方式可以是使用「金鑰」或是「帳號/密碼驗證」</p>\n<p>這邊先簡單羅列步驟：</p>\n<ol>\n<li>產生 ssh 認證使用的金鑰</li>\n<li>編寫 Dockerfile</li>\n<li>編寫 K8s YAML 檔案</li>\n<li>暴露一個 External LoadBalace</li>\n<li>使用 FileZilla 測試</li>\n</ol>\n<blockquote>\n<p>環境是使用 GKE(Google Kubernetes Engine)</p>\n</blockquote>\n<h2 id=\"產生-ssh-金鑰\"><a href=\"#產生-ssh-金鑰\" class=\"headerlink\" title=\"產生 ssh 金鑰\"></a>產生 ssh 金鑰</h2><p>產生 ssh 金鑰是為了讓後續連線時，可以使用金鑰作為驗證，這邊是使用 Mac 的終端機產生，指令參照以下</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh-keygen -t rsa -b 4096 -f sftp_key</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Passphrase 設不設定都可以，如果有設定的話，最後以 FileZilla 測試時，private key 需要額外產生 .ppk 檔才能使用，後續會講解</p>\n</blockquote>\n<p>完成後，在你目前位置的目錄上會出現一對金鑰，一個為 public key 另一個為 private key</p>\n<blockquote>\n<p>一般來說，我們都會習慣把金鑰統一放置在本機家目錄底下的 .ssh 目錄內，如果自己有習慣的放置地方也可以放到自己習慣的位置</p>\n</blockquote>\n<h2 id=\"編寫-Dockerfile\"><a href=\"#編寫-Dockerfile\" class=\"headerlink\" title=\"編寫 Dockerfile\"></a>編寫 Dockerfile</h2><p>我們需要將 public key 放進映像檔中，這樣在連線時才有辦法做金鑰驗證。 要實現這方式有兩個：</p>\n<ul>\n<li>在 ftp 服務啟動時以 volume 方式掛載 public key 到相對位置</li>\n<li>直接複製到映像檔內</li>\n</ul>\n<p>這邊採用的是第二種方式，編寫 Dockerfile 並將 public key 放進去，我們要將 public key 放到使用者家目錄底下的 <code>./.ssh/keys</code> 位置，所以我們需要建立相對應路徑，並將複製進去，可以參考以下</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> atmoz/sftp:alpine</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> mkdir -p /home/rd/.ssh/keys</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"bash\"> ./sftp_key.pub /home/rd/.ssh/keys/</span></span><br></pre></td></tr></table></figure>\n\n<p>這邊使用的 base image 是 atmoz/sftp:alpine，當然你也可以選擇其他版本(eg. debian…)。</p>\n<p>最後進行 docker build 的動作，並上傳到存放區</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker build --no-cache -t custom-sftp:alpine -f Dockerfile .</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"編寫-K8s-YAML-檔案\"><a href=\"#編寫-K8s-YAML-檔案\" class=\"headerlink\" title=\"編寫 K8s YAML 檔案\"></a>編寫 K8s YAML 檔案</h2><p>因為我們要運行在 GKE 上面，需要編寫 YAML 以便運行與後續管理，這邊是使用 Deployment 的 Object，以下只截取部片重要片段，其餘部分需要自行補齊</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ftp</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"string\">...</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ftp</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> [<span class=\"string\">修改為剛剛上傳的映像檔路徑</span>]</span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">22</span></span><br><span class=\"line\">        <span class=\"attr\">args:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">rd::::upload</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">volume-test</span></span><br><span class=\"line\">            <span class=\"attr\">mountPath:</span> <span class=\"string\">/home/rd/upload/test</span></span><br><span class=\"line\">            <span class=\"attr\">subPath:</span> <span class=\"string\">upload-image</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">volume-test</span></span><br><span class=\"line\">          <span class=\"attr\">persistentVolumeClaim:</span></span><br><span class=\"line\">            <span class=\"attr\">claimName:</span> <span class=\"string\">mypvc</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"snippet-解析\"><a href=\"#snippet-解析\" class=\"headerlink\" title=\"snippet 解析\"></a>snippet 解析</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">args:</span><br><span class=\"line\">  - rd::::upload</span><br></pre></td></tr></table></figure>\n\n<p>啟動參數的意義，這邊是 <code>rd::::upload</code>，這表示使用者帳號為rd，並且在家目錄底下建立一個 upload 的目錄(<code>/home/rd/upload</code>)，以便做存取，這樣我們就能夠將持久化硬碟掛載到 <code>/home/rd/upload</code> 路徑底下。</p>\n<blockquote>\n<p>使用者帳號可以自訂，不一定要使用rd</p>\n</blockquote>\n<p>可以看到 rd 的帳號並沒有設定密碼，在沒有設定密碼的情況下，表示認證會使用金鑰認證，那如果要使用密碼驗證可以這樣表示</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rd:12345:::upload</span><br></pre></td></tr></table></figure>\n\n<p>這樣表示密碼為 12345</p>\n<h2 id=\"暴露一個-External-LoadBalace\"><a href=\"#暴露一個-External-LoadBalace\" class=\"headerlink\" title=\"暴露一個 External LoadBalace\"></a>暴露一個 External LoadBalace</h2><p>暴露外部 LB 這樣可以讓本機去存取到 GKE 內的服務，但是白名單記得要設定，以提高安全性</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ftp-proxy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">LoadBalancer</span></span><br><span class=\"line\">  <span class=\"attr\">loadBalancerIP:</span> [<span class=\"string\">填入自己的外網IP</span>]</span><br><span class=\"line\">  <span class=\"attr\">loadBalancerSourceRanges:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> [<span class=\"string\">填入自己的白名單</span>]</span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ssh</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">22</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">22</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">ftp</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"snippet-解析-1\"><a href=\"#snippet-解析-1\" class=\"headerlink\" title=\"snippet 解析\"></a>snippet 解析</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">ports:</span><br><span class=\"line\">  - name: ssh</span><br><span class=\"line\">    port: 22</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 22</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n\n<p>其中這段 port 有沒有要改成其他非預設 22 port 都可以，以安全性角度來說可以做個修改，例如 <code>port: 14322</code>。 這樣連線時就使用 14322 做連線，GKE 就會自動做 port 的 mapping。</p>\n<h2 id=\"使用-FileZilla-測試\"><a href=\"#使用-FileZilla-測試\" class=\"headerlink\" title=\"使用 FileZilla 測試\"></a>使用 FileZilla 測試</h2><p>最後我們可以下載 FileZilla Client 來測試，如果剛才編寫 Deployment 的 YAML 時，啟動參數有設定密碼的話，就可以直接填入相關資訊做連線測試了。</p>\n<p>填入資訊</p>\n<ul>\n<li>主機: 填入External LoadBalance 的 IP</li>\n<li>使用者名稱: 填入啟動參數設定的使用者</li>\n<li>密碼: 填入啟動參數設定的密碼</li>\n<li>連接埠: 預設是22，如果剛剛在編寫 External LoadBalace 時，有修改 port，這邊記得要跟著變</li>\n</ul>\n<p>如果是使用金鑰驗證，我們要先設定好 private key 的位置，開啟 FileZilla Client，依照下圖點選到設定位置</p>\n<p>點選 編輯 → 設定</p>\n<p><img src=\"mk-20240119114134.png\"></p>\n<p>選擇 SFTP 並點選「加入金鑰檔案」，此時會請你選擇 private key 的位置</p>\n<p><img src=\"mk-20240119114200.png\"></p>\n<p>這邊要注意一下，如果一開始產生金鑰時有設定 passphrase，會跳出此視窗，主要是因為他需要將 .key 轉成 .ppk，這邊直接點「是」</p>\n<p><img src=\"mk-20240119114218.png\"></p>\n<p>輸入設定的 passphrase</p>\n<p><img src=\"mk-20240119114239.png\"></p>\n<p>選擇鑰儲存 .ppk 的位置與命名</p>\n<p><img src=\"mk-20240119114300.png\"></p>\n<p>最後再回到主畫面將連線資訊填入，密碼不用填寫，當連線後，會請你輸入 passphrase 的密碼</p>"},{"title":"使用GitHub Pages","abbrlink":"9836e9cf","date":"2021-05-03T06:58:14.000Z","_content":"\n## 前言\n\n當我們開發程式時，一定都會想到 GitHub 或 GiLab 等版控的工具，今天要來介紹一下 GitHub Pages，GitHub Pages 是由 GitHub 所提供的服務，可以讓 Repository 內的靜態檔案，以網頁的方式呈現出來，這代表著 GitHub Pages 提供了 Web Server 的服務，但僅僅支援靜態頁面，如果是後端相關的 code，例如: .php 的副檔名，GitHub Pages 是不會有作用的，所以很多人會使用 GitHub Pages 來架設自己的部落格(Blog)。\n\n<!--more-->\n\n## 如何使用 GitHub Pages\n\n這邊假設大家對於 Git 的使用都已經熟悉了，在依據下面幾個步驟就可以完成 GitHub Pages\n\n- 新增專案(Repository)\n- 建立測試檔\n- 測試網頁功能\n\n### 新增專案(Repository)\n\n在專案名稱的地方，填寫「`username`.github.io」，這個 `username` 指的是自己的 GitHub 帳號。 並設定為 Public，不建立 README.md 的檔案，後續要新增測試檔案時再自己針對目錄做 Git Initial。\n\n> 要使用 GitHub Pages，Repository 需要設定為 Public\n\n![](mk-20240119120313.png)\n\n### 建立測試檔\n\n接下來，在本機建立一個目錄並進入\n\n```bash\nmkdir username.github.io\ncd username.github.io\n```\n\n並寫一個測試的首頁 index.html\n\n```bash\necho \"Hello World\" > index.html\n```\n\n初始化目錄並設定 Rmote Repository\n\n```bash\ngit init\ngit remote add origin git@github.com:username/username.github.io.git\n```\n\n> 上述 username 請填入自己的 GitHub 帳號\n\n提交檔案並推上 GitHub\n\n```bash\ngit add --all\ngit commit -m \"Initial commit\"\ngit push -u origin master\n```\n\n### 測試網頁功能\n\n成功推送後，可以開啟 https://`username`.github.io 試試看，會顯示「Hello World」\n\n> 測試的時候，可以的話盡量開啟無痕視窗來測試，這樣比較不會因為多次修改而造成 cache 的問題\n\n## 參考資料\n\n- https://pages.github.com/\n","source":"_posts/github-pages.md","raw":"---\ntitle: 使用GitHub Pages\ntags:\n  - Hexo\n  - GitHub\n  - GitHub Pages\n  - blog\nabbrlink: 9836e9cf\ndate: 2021-05-03 14:58:14\n---\n\n## 前言\n\n當我們開發程式時，一定都會想到 GitHub 或 GiLab 等版控的工具，今天要來介紹一下 GitHub Pages，GitHub Pages 是由 GitHub 所提供的服務，可以讓 Repository 內的靜態檔案，以網頁的方式呈現出來，這代表著 GitHub Pages 提供了 Web Server 的服務，但僅僅支援靜態頁面，如果是後端相關的 code，例如: .php 的副檔名，GitHub Pages 是不會有作用的，所以很多人會使用 GitHub Pages 來架設自己的部落格(Blog)。\n\n<!--more-->\n\n## 如何使用 GitHub Pages\n\n這邊假設大家對於 Git 的使用都已經熟悉了，在依據下面幾個步驟就可以完成 GitHub Pages\n\n- 新增專案(Repository)\n- 建立測試檔\n- 測試網頁功能\n\n### 新增專案(Repository)\n\n在專案名稱的地方，填寫「`username`.github.io」，這個 `username` 指的是自己的 GitHub 帳號。 並設定為 Public，不建立 README.md 的檔案，後續要新增測試檔案時再自己針對目錄做 Git Initial。\n\n> 要使用 GitHub Pages，Repository 需要設定為 Public\n\n![](mk-20240119120313.png)\n\n### 建立測試檔\n\n接下來，在本機建立一個目錄並進入\n\n```bash\nmkdir username.github.io\ncd username.github.io\n```\n\n並寫一個測試的首頁 index.html\n\n```bash\necho \"Hello World\" > index.html\n```\n\n初始化目錄並設定 Rmote Repository\n\n```bash\ngit init\ngit remote add origin git@github.com:username/username.github.io.git\n```\n\n> 上述 username 請填入自己的 GitHub 帳號\n\n提交檔案並推上 GitHub\n\n```bash\ngit add --all\ngit commit -m \"Initial commit\"\ngit push -u origin master\n```\n\n### 測試網頁功能\n\n成功推送後，可以開啟 https://`username`.github.io 試試看，會顯示「Hello World」\n\n> 測試的時候，可以的話盡量開啟無痕視窗來測試，這樣比較不會因為多次修改而造成 cache 的問題\n\n## 參考資料\n\n- https://pages.github.com/\n","slug":"github-pages","published":1,"updated":"2024-09-09T07:17:02.655Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5j50010k0lze1tq1hir","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>當我們開發程式時，一定都會想到 GitHub 或 GiLab 等版控的工具，今天要來介紹一下 GitHub Pages，GitHub Pages 是由 GitHub 所提供的服務，可以讓 Repository 內的靜態檔案，以網頁的方式呈現出來，這代表著 GitHub Pages 提供了 Web Server 的服務，但僅僅支援靜態頁面，如果是後端相關的 code，例如: .php 的副檔名，GitHub Pages 是不會有作用的，所以很多人會使用 GitHub Pages 來架設自己的部落格(Blog)。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"如何使用-GitHub-Pages\"><a href=\"#如何使用-GitHub-Pages\" class=\"headerlink\" title=\"如何使用 GitHub Pages\"></a>如何使用 GitHub Pages</h2><p>這邊假設大家對於 Git 的使用都已經熟悉了，在依據下面幾個步驟就可以完成 GitHub Pages</p>\n<ul>\n<li>新增專案(Repository)</li>\n<li>建立測試檔</li>\n<li>測試網頁功能</li>\n</ul>\n<h3 id=\"新增專案-Repository\"><a href=\"#新增專案-Repository\" class=\"headerlink\" title=\"新增專案(Repository)\"></a>新增專案(Repository)</h3><p>在專案名稱的地方，填寫「<code>username</code>.github.io」，這個 <code>username</code> 指的是自己的 GitHub 帳號。 並設定為 Public，不建立 README.md 的檔案，後續要新增測試檔案時再自己針對目錄做 Git Initial。</p>\n<blockquote>\n<p>要使用 GitHub Pages，Repository 需要設定為 Public</p>\n</blockquote>\n<p><img src=\"mk-20240119120313.png\"></p>\n<h3 id=\"建立測試檔\"><a href=\"#建立測試檔\" class=\"headerlink\" title=\"建立測試檔\"></a>建立測試檔</h3><p>接下來，在本機建立一個目錄並進入</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir username.github.io</span><br><span class=\"line\"><span class=\"built_in\">cd</span> username.github.io</span><br></pre></td></tr></table></figure>\n\n<p>並寫一個測試的首頁 index.html</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Hello World&quot;</span> &gt; index.html</span><br></pre></td></tr></table></figure>\n\n<p>初始化目錄並設定 Rmote Repository</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git init</span><br><span class=\"line\">git remote add origin git@github.com:username/username.github.io.git</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>上述 username 請填入自己的 GitHub 帳號</p>\n</blockquote>\n<p>提交檔案並推上 GitHub</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git add --all</span><br><span class=\"line\">git commit -m <span class=\"string\">&quot;Initial commit&quot;</span></span><br><span class=\"line\">git push -u origin master</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"測試網頁功能\"><a href=\"#測試網頁功能\" class=\"headerlink\" title=\"測試網頁功能\"></a>測試網頁功能</h3><p>成功推送後，可以開啟 https://<code>username</code>.github.io 試試看，會顯示「Hello World」</p>\n<blockquote>\n<p>測試的時候，可以的話盡量開啟無痕視窗來測試，這樣比較不會因為多次修改而造成 cache 的問題</p>\n</blockquote>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://pages.github.com/\">https://pages.github.com/</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>當我們開發程式時，一定都會想到 GitHub 或 GiLab 等版控的工具，今天要來介紹一下 GitHub Pages，GitHub Pages 是由 GitHub 所提供的服務，可以讓 Repository 內的靜態檔案，以網頁的方式呈現出來，這代表著 GitHub Pages 提供了 Web Server 的服務，但僅僅支援靜態頁面，如果是後端相關的 code，例如: .php 的副檔名，GitHub Pages 是不會有作用的，所以很多人會使用 GitHub Pages 來架設自己的部落格(Blog)。</p>","more":"<h2 id=\"如何使用-GitHub-Pages\"><a href=\"#如何使用-GitHub-Pages\" class=\"headerlink\" title=\"如何使用 GitHub Pages\"></a>如何使用 GitHub Pages</h2><p>這邊假設大家對於 Git 的使用都已經熟悉了，在依據下面幾個步驟就可以完成 GitHub Pages</p>\n<ul>\n<li>新增專案(Repository)</li>\n<li>建立測試檔</li>\n<li>測試網頁功能</li>\n</ul>\n<h3 id=\"新增專案-Repository\"><a href=\"#新增專案-Repository\" class=\"headerlink\" title=\"新增專案(Repository)\"></a>新增專案(Repository)</h3><p>在專案名稱的地方，填寫「<code>username</code>.github.io」，這個 <code>username</code> 指的是自己的 GitHub 帳號。 並設定為 Public，不建立 README.md 的檔案，後續要新增測試檔案時再自己針對目錄做 Git Initial。</p>\n<blockquote>\n<p>要使用 GitHub Pages，Repository 需要設定為 Public</p>\n</blockquote>\n<p><img src=\"mk-20240119120313.png\"></p>\n<h3 id=\"建立測試檔\"><a href=\"#建立測試檔\" class=\"headerlink\" title=\"建立測試檔\"></a>建立測試檔</h3><p>接下來，在本機建立一個目錄並進入</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir username.github.io</span><br><span class=\"line\"><span class=\"built_in\">cd</span> username.github.io</span><br></pre></td></tr></table></figure>\n\n<p>並寫一個測試的首頁 index.html</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Hello World&quot;</span> &gt; index.html</span><br></pre></td></tr></table></figure>\n\n<p>初始化目錄並設定 Rmote Repository</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git init</span><br><span class=\"line\">git remote add origin git@github.com:username/username.github.io.git</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>上述 username 請填入自己的 GitHub 帳號</p>\n</blockquote>\n<p>提交檔案並推上 GitHub</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git add --all</span><br><span class=\"line\">git commit -m <span class=\"string\">&quot;Initial commit&quot;</span></span><br><span class=\"line\">git push -u origin master</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"測試網頁功能\"><a href=\"#測試網頁功能\" class=\"headerlink\" title=\"測試網頁功能\"></a>測試網頁功能</h3><p>成功推送後，可以開啟 https://<code>username</code>.github.io 試試看，會顯示「Hello World」</p>\n<blockquote>\n<p>測試的時候，可以的話盡量開啟無痕視窗來測試，這樣比較不會因為多次修改而造成 cache 的問題</p>\n</blockquote>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://pages.github.com/\">https://pages.github.com/</a></li>\n</ul>"},{"title":"GKE 上使用 Workload Identity","abbrlink":"7d4918c","date":"2024-01-22T08:48:56.000Z","_content":"\n\n## 前言\n\n以前在 GKE 內的應用程式若是有需要存取其他 GCP 上的服務時，會需要建立一個專用的 Service Account 並且將該帳戶賦予對應的權限，再將 JWT 掛載到應用程式。\n\n這對於管理與資安上都是一大的隱憂，只要 JWT 不小心被有心人士拿到，就可以有相對應的權限。\n\n<!-- more -->\n\n而 GKE 上 Workload Identity 就是用來解決 JWT 需要下載使用的問題，只要 JWT 不外流，對於安全性就更上一層樓了。 只需要 kubernetes service account(簡稱 KSA) 與 google service account(簡稱 GSA) 進行綁定，再將 KSA 賦予給 Pod，應用程式就會有相對應的權限可以使用。\n\n使用 Workload Identity 也是 Google 比較建議用來連接 GSA 的方式\n\n> Workload Identity is the recommended way for your workloads running on Google Kubernetes Engine (GKE) to access Google Cloud services in a secure and manageable way.\n\n## 啟用 Workload Identity\n\n要使用 Workload Identity，那就必須要先讓 GKE 支援 Workload Identity，可以從 Master Node 去確認有沒有啟用\n\n![](mk-20240118163311.png)\n\n如果一開始建立叢集時沒有預先啟動，那麼之後要啟動的話，所以有的 Worker Node 都必須重新生成過一遍才會生效，這點需要注意。\n\nGoogle 是建議啟用 Workload Identity 後，直接重新 create 新的 node pool\n\n> We recommend creating new node pools if you also need to modify your applications to be compatible with Workload Identity.\n\n## 確認自身權限\n\n先確認自身操作權限是否有以下兩個：\n- roles/container.admin (Kubernetes Engine 管理員)\n- roles/iam.serviceAccountAdmin (服務帳戶管理員)\n\n## 讓 Application 使用 Workload Identity\n\n溫馨小提醒：\n\n1. 這邊的 Project ID 統一用 demo-123\n2. 以下示範建議搭配[官方文件](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)的指令服用，這樣會比較清楚各欄位要填什麼\n3. 如果熟練的話也可自行將部份指令轉成描述檔(YAML)\n\n建立測試用 Namespace\n\n```bash\nkubectl create namespace workload-identity\n```\n\n建立測試用 kubernetes service account 在 workload-identity Namespace\n\n```bash\nkubectl create serviceaccount ksa-workload-identity \\\n    --namespace workload-identity\n```\n\n建立測試用 google service account\n\n```bash\ngcloud iam service-accounts create gsa-workload-identity \\\n    --project=demo-123\n```\n\n賦予測試的 GSA 一個權限\n\n```bash\ngcloud projects add-iam-policy-binding demo-123 \\\n    --member \"serviceAccount:gsa-workload-identity@demo-123.iam.gserviceaccount.com\" \\\n    --role \"roles/cloudbuild.builds.viewer\" \\\n    --project=demo-123\n```\n\n將 KSA(ksa-workload-identity) 與 GSA(gsa-workload-identity) 進行綁定，有兩種方式：\n\n- 使用 Google SDK\n- 使用 K8s 描述檔：管理上較方便\n\n**使用 Google SDK**\n\n```bash\ngcloud iam service-accounts add-iam-policy-binding gsa-workload-identity@demo-123.iam.gserviceaccount.com \\\n    --role roles/iam.workloadIdentityUser \\\n    --member \"serviceAccount:demo-123.svc.id.goog[workload-identity/ksa-workload-identity]\" \\\n    --project=demo-123\n```\n\n解除綁定的方式 `add-iam-policy-binding` 改成 `remove-iam-policy-binding`\n```bash\ngcloud iam service-accounts remove-iam-policy-binding gsa-workload-identity@demo-123.iam.gserviceaccount.com \\\n    --role roles/iam.workloadIdentityUser \\\n    --member \"serviceAccount:demo-123.svc.id.goog[workload-identity/ksa-workload-identity]\" \\\n    --project=demo-123\n```\n\n**使用 K8s 描述檔**\n\n```yaml\napiVersion: iam.cnrm.cloud.google.com/v1beta1\nkind: IAMPolicy\nmetadata:\n  name: iampolicy-workload-identity-sample\nspec:\n  resourceRef:\n    apiVersion: iam.cnrm.cloud.google.com/v1beta1\n    kind: IAMServiceAccount\n    name: gsa-workload-identity\n  bindings:\n    - role: roles/iam.workloadIdentityUser\n      members:\n        - serviceAccount:demo-123.svc.id.goog[workload-identity/ksa-workload-identity]\n```\n\n調整 KSA 的設定，新增 annotation 資訊\n\n```bash\nkubectl annotate serviceaccount ksa-workload-identity \\\n    --namespace workload-identity \\\n    iam.gke.io/gcp-service-account=gsa-workload-identity@demo-123.iam.gserviceaccount.com\n```\n\n前面一開始只是先建立 KSA，上方又在多新增 annotations，所以寫成描述檔會是下面這樣\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  annotations:\n    iam.gke.io/gcp-service-account=gsa-workload-identity@demo-123.iam.gserviceaccount.com\n  name: ksa-workload-identity\n  namespace: workload-identity\n```\n\n功能驗證的話有兩種，一種是直接將目標應用程式加上相關設定去測試，另外一種是 Google 提供的簡易測試，如下\n\n### Application 功能驗證\n\n在 Pod 或 Deployment 的描述檔新增以下片段，以便賦予 KSA，此時該應用服務就可以有相對應的 IAM 權限\n\n```yaml\nspec:\n  serviceAccountName: ksa-workload-identity\n  nodeSelector:\n    iam.gke.io/gke-metadata-server-enabled: \"true\"\n```\n\n### 簡易功能驗證\n\n佈署以下服務，假設檔名為 wi-test.yaml\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: workload-identity-test\n  namespace: workload-identity\nspec:\n  containers:\n  - image: google/cloud-sdk:slim\n    name: workload-identity-test\n    command: [\"sleep\",\"infinity\"]\n  serviceAccountName: ksa-workload-identity\n  nodeSelector:\n    iam.gke.io/gke-metadata-server-enabled: \"true\"\n```\n\n```bash\nkubectl apply -f wi-test.yaml\n```\n\n進入 Pod 內\n```bash\nkubectl exec -it workload-identity-test \\\n  --namespace workload-identity \\\n  -- /bin/bash\n```\n\n利用 curl 指令進行驗證：\n\n1. 回傳內容為 GSA E-mail\n```bash\ncurl -H \"Metadata-Flavor: Google\" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email\n```\n\n2. 取得 Token \n```bash\ncurl -H \"Metadata-Flavor: Google\" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token\n```\n\n清理 Pod\n```bash\nkubectl delete -f wi-test.yaml\n``` \n\n## 文後討論\n\n如果是使用 Autopilot clusters 在設定上會有些許不同，此時建議直接參考官方文件會比較恰當\n\n## 參考資料\n\n- https://cloud.google.com/kubernetes-engine/docs/concepts/workload-identity\n- https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity","source":"_posts/gke-workload-identity.md","raw":"---\ntitle: GKE 上使用 Workload Identity\ntags:\n  - GCP\n  - GKE\n  - Google Cloud Platform\n  - K8s\n  - Kubernetes\ncategories:\n  - GKE\nabbrlink: 7d4918c\ndate: 2024-01-22 16:48:56\n---\n\n\n## 前言\n\n以前在 GKE 內的應用程式若是有需要存取其他 GCP 上的服務時，會需要建立一個專用的 Service Account 並且將該帳戶賦予對應的權限，再將 JWT 掛載到應用程式。\n\n這對於管理與資安上都是一大的隱憂，只要 JWT 不小心被有心人士拿到，就可以有相對應的權限。\n\n<!-- more -->\n\n而 GKE 上 Workload Identity 就是用來解決 JWT 需要下載使用的問題，只要 JWT 不外流，對於安全性就更上一層樓了。 只需要 kubernetes service account(簡稱 KSA) 與 google service account(簡稱 GSA) 進行綁定，再將 KSA 賦予給 Pod，應用程式就會有相對應的權限可以使用。\n\n使用 Workload Identity 也是 Google 比較建議用來連接 GSA 的方式\n\n> Workload Identity is the recommended way for your workloads running on Google Kubernetes Engine (GKE) to access Google Cloud services in a secure and manageable way.\n\n## 啟用 Workload Identity\n\n要使用 Workload Identity，那就必須要先讓 GKE 支援 Workload Identity，可以從 Master Node 去確認有沒有啟用\n\n![](mk-20240118163311.png)\n\n如果一開始建立叢集時沒有預先啟動，那麼之後要啟動的話，所以有的 Worker Node 都必須重新生成過一遍才會生效，這點需要注意。\n\nGoogle 是建議啟用 Workload Identity 後，直接重新 create 新的 node pool\n\n> We recommend creating new node pools if you also need to modify your applications to be compatible with Workload Identity.\n\n## 確認自身權限\n\n先確認自身操作權限是否有以下兩個：\n- roles/container.admin (Kubernetes Engine 管理員)\n- roles/iam.serviceAccountAdmin (服務帳戶管理員)\n\n## 讓 Application 使用 Workload Identity\n\n溫馨小提醒：\n\n1. 這邊的 Project ID 統一用 demo-123\n2. 以下示範建議搭配[官方文件](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)的指令服用，這樣會比較清楚各欄位要填什麼\n3. 如果熟練的話也可自行將部份指令轉成描述檔(YAML)\n\n建立測試用 Namespace\n\n```bash\nkubectl create namespace workload-identity\n```\n\n建立測試用 kubernetes service account 在 workload-identity Namespace\n\n```bash\nkubectl create serviceaccount ksa-workload-identity \\\n    --namespace workload-identity\n```\n\n建立測試用 google service account\n\n```bash\ngcloud iam service-accounts create gsa-workload-identity \\\n    --project=demo-123\n```\n\n賦予測試的 GSA 一個權限\n\n```bash\ngcloud projects add-iam-policy-binding demo-123 \\\n    --member \"serviceAccount:gsa-workload-identity@demo-123.iam.gserviceaccount.com\" \\\n    --role \"roles/cloudbuild.builds.viewer\" \\\n    --project=demo-123\n```\n\n將 KSA(ksa-workload-identity) 與 GSA(gsa-workload-identity) 進行綁定，有兩種方式：\n\n- 使用 Google SDK\n- 使用 K8s 描述檔：管理上較方便\n\n**使用 Google SDK**\n\n```bash\ngcloud iam service-accounts add-iam-policy-binding gsa-workload-identity@demo-123.iam.gserviceaccount.com \\\n    --role roles/iam.workloadIdentityUser \\\n    --member \"serviceAccount:demo-123.svc.id.goog[workload-identity/ksa-workload-identity]\" \\\n    --project=demo-123\n```\n\n解除綁定的方式 `add-iam-policy-binding` 改成 `remove-iam-policy-binding`\n```bash\ngcloud iam service-accounts remove-iam-policy-binding gsa-workload-identity@demo-123.iam.gserviceaccount.com \\\n    --role roles/iam.workloadIdentityUser \\\n    --member \"serviceAccount:demo-123.svc.id.goog[workload-identity/ksa-workload-identity]\" \\\n    --project=demo-123\n```\n\n**使用 K8s 描述檔**\n\n```yaml\napiVersion: iam.cnrm.cloud.google.com/v1beta1\nkind: IAMPolicy\nmetadata:\n  name: iampolicy-workload-identity-sample\nspec:\n  resourceRef:\n    apiVersion: iam.cnrm.cloud.google.com/v1beta1\n    kind: IAMServiceAccount\n    name: gsa-workload-identity\n  bindings:\n    - role: roles/iam.workloadIdentityUser\n      members:\n        - serviceAccount:demo-123.svc.id.goog[workload-identity/ksa-workload-identity]\n```\n\n調整 KSA 的設定，新增 annotation 資訊\n\n```bash\nkubectl annotate serviceaccount ksa-workload-identity \\\n    --namespace workload-identity \\\n    iam.gke.io/gcp-service-account=gsa-workload-identity@demo-123.iam.gserviceaccount.com\n```\n\n前面一開始只是先建立 KSA，上方又在多新增 annotations，所以寫成描述檔會是下面這樣\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  annotations:\n    iam.gke.io/gcp-service-account=gsa-workload-identity@demo-123.iam.gserviceaccount.com\n  name: ksa-workload-identity\n  namespace: workload-identity\n```\n\n功能驗證的話有兩種，一種是直接將目標應用程式加上相關設定去測試，另外一種是 Google 提供的簡易測試，如下\n\n### Application 功能驗證\n\n在 Pod 或 Deployment 的描述檔新增以下片段，以便賦予 KSA，此時該應用服務就可以有相對應的 IAM 權限\n\n```yaml\nspec:\n  serviceAccountName: ksa-workload-identity\n  nodeSelector:\n    iam.gke.io/gke-metadata-server-enabled: \"true\"\n```\n\n### 簡易功能驗證\n\n佈署以下服務，假設檔名為 wi-test.yaml\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: workload-identity-test\n  namespace: workload-identity\nspec:\n  containers:\n  - image: google/cloud-sdk:slim\n    name: workload-identity-test\n    command: [\"sleep\",\"infinity\"]\n  serviceAccountName: ksa-workload-identity\n  nodeSelector:\n    iam.gke.io/gke-metadata-server-enabled: \"true\"\n```\n\n```bash\nkubectl apply -f wi-test.yaml\n```\n\n進入 Pod 內\n```bash\nkubectl exec -it workload-identity-test \\\n  --namespace workload-identity \\\n  -- /bin/bash\n```\n\n利用 curl 指令進行驗證：\n\n1. 回傳內容為 GSA E-mail\n```bash\ncurl -H \"Metadata-Flavor: Google\" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email\n```\n\n2. 取得 Token \n```bash\ncurl -H \"Metadata-Flavor: Google\" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token\n```\n\n清理 Pod\n```bash\nkubectl delete -f wi-test.yaml\n``` \n\n## 文後討論\n\n如果是使用 Autopilot clusters 在設定上會有些許不同，此時建議直接參考官方文件會比較恰當\n\n## 參考資料\n\n- https://cloud.google.com/kubernetes-engine/docs/concepts/workload-identity\n- https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity","slug":"gke-workload-identity","published":1,"updated":"2024-09-09T07:17:02.658Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5j60014k0lz7ucreg7u","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>以前在 GKE 內的應用程式若是有需要存取其他 GCP 上的服務時，會需要建立一個專用的 Service Account 並且將該帳戶賦予對應的權限，再將 JWT 掛載到應用程式。</p>\n<p>這對於管理與資安上都是一大的隱憂，只要 JWT 不小心被有心人士拿到，就可以有相對應的權限。</p>\n<span id=\"more\"></span>\n\n<p>而 GKE 上 Workload Identity 就是用來解決 JWT 需要下載使用的問題，只要 JWT 不外流，對於安全性就更上一層樓了。 只需要 kubernetes service account(簡稱 KSA) 與 google service account(簡稱 GSA) 進行綁定，再將 KSA 賦予給 Pod，應用程式就會有相對應的權限可以使用。</p>\n<p>使用 Workload Identity 也是 Google 比較建議用來連接 GSA 的方式</p>\n<blockquote>\n<p>Workload Identity is the recommended way for your workloads running on Google Kubernetes Engine (GKE) to access Google Cloud services in a secure and manageable way.</p>\n</blockquote>\n<h2 id=\"啟用-Workload-Identity\"><a href=\"#啟用-Workload-Identity\" class=\"headerlink\" title=\"啟用 Workload Identity\"></a>啟用 Workload Identity</h2><p>要使用 Workload Identity，那就必須要先讓 GKE 支援 Workload Identity，可以從 Master Node 去確認有沒有啟用</p>\n<p><img src=\"mk-20240118163311.png\"></p>\n<p>如果一開始建立叢集時沒有預先啟動，那麼之後要啟動的話，所以有的 Worker Node 都必須重新生成過一遍才會生效，這點需要注意。</p>\n<p>Google 是建議啟用 Workload Identity 後，直接重新 create 新的 node pool</p>\n<blockquote>\n<p>We recommend creating new node pools if you also need to modify your applications to be compatible with Workload Identity.</p>\n</blockquote>\n<h2 id=\"確認自身權限\"><a href=\"#確認自身權限\" class=\"headerlink\" title=\"確認自身權限\"></a>確認自身權限</h2><p>先確認自身操作權限是否有以下兩個：</p>\n<ul>\n<li>roles/container.admin (Kubernetes Engine 管理員)</li>\n<li>roles/iam.serviceAccountAdmin (服務帳戶管理員)</li>\n</ul>\n<h2 id=\"讓-Application-使用-Workload-Identity\"><a href=\"#讓-Application-使用-Workload-Identity\" class=\"headerlink\" title=\"讓 Application 使用 Workload Identity\"></a>讓 Application 使用 Workload Identity</h2><p>溫馨小提醒：</p>\n<ol>\n<li>這邊的 Project ID 統一用 demo-123</li>\n<li>以下示範建議搭配<a href=\"https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity\">官方文件</a>的指令服用，這樣會比較清楚各欄位要填什麼</li>\n<li>如果熟練的話也可自行將部份指令轉成描述檔(YAML)</li>\n</ol>\n<p>建立測試用 Namespace</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create namespace workload-identity</span><br></pre></td></tr></table></figure>\n\n<p>建立測試用 kubernetes service account 在 workload-identity Namespace</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create serviceaccount ksa-workload-identity \\</span><br><span class=\"line\">    --namespace workload-identity</span><br></pre></td></tr></table></figure>\n\n<p>建立測試用 google service account</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud iam service-accounts create gsa-workload-identity \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>賦予測試的 GSA 一個權限</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud projects add-iam-policy-binding demo-123 \\</span><br><span class=\"line\">    --member <span class=\"string\">&quot;serviceAccount:gsa-workload-identity@demo-123.iam.gserviceaccount.com&quot;</span> \\</span><br><span class=\"line\">    --role <span class=\"string\">&quot;roles/cloudbuild.builds.viewer&quot;</span> \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>將 KSA(ksa-workload-identity) 與 GSA(gsa-workload-identity) 進行綁定，有兩種方式：</p>\n<ul>\n<li>使用 Google SDK</li>\n<li>使用 K8s 描述檔：管理上較方便</li>\n</ul>\n<p><strong>使用 Google SDK</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud iam service-accounts add-iam-policy-binding gsa-workload-identity@demo-123.iam.gserviceaccount.com \\</span><br><span class=\"line\">    --role roles/iam.workloadIdentityUser \\</span><br><span class=\"line\">    --member <span class=\"string\">&quot;serviceAccount:demo-123.svc.id.goog[workload-identity/ksa-workload-identity]&quot;</span> \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>解除綁定的方式 <code>add-iam-policy-binding</code> 改成 <code>remove-iam-policy-binding</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud iam service-accounts remove-iam-policy-binding gsa-workload-identity@demo-123.iam.gserviceaccount.com \\</span><br><span class=\"line\">    --role roles/iam.workloadIdentityUser \\</span><br><span class=\"line\">    --member <span class=\"string\">&quot;serviceAccount:demo-123.svc.id.goog[workload-identity/ksa-workload-identity]&quot;</span> \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p><strong>使用 K8s 描述檔</strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">iam.cnrm.cloud.google.com/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">IAMPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">iampolicy-workload-identity-sample</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">resourceRef:</span></span><br><span class=\"line\">    <span class=\"attr\">apiVersion:</span> <span class=\"string\">iam.cnrm.cloud.google.com/v1beta1</span></span><br><span class=\"line\">    <span class=\"attr\">kind:</span> <span class=\"string\">IAMServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">gsa-workload-identity</span></span><br><span class=\"line\">  <span class=\"attr\">bindings:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">role:</span> <span class=\"string\">roles/iam.workloadIdentityUser</span></span><br><span class=\"line\">      <span class=\"attr\">members:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">serviceAccount:demo-123.svc.id.goog[workload-identity/ksa-workload-identity]</span></span><br></pre></td></tr></table></figure>\n\n<p>調整 KSA 的設定，新增 annotation 資訊</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl annotate serviceaccount ksa-workload-identity \\</span><br><span class=\"line\">    --namespace workload-identity \\</span><br><span class=\"line\">    iam.gke.io/gcp-service-account=gsa-workload-identity@demo-123.iam.gserviceaccount.com</span><br></pre></td></tr></table></figure>\n\n<p>前面一開始只是先建立 KSA，上方又在多新增 annotations，所以寫成描述檔會是下面這樣</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"string\">iam.gke.io/gcp-service-account=gsa-workload-identity@demo-123.iam.gserviceaccount.com</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ksa-workload-identity</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">workload-identity</span></span><br></pre></td></tr></table></figure>\n\n<p>功能驗證的話有兩種，一種是直接將目標應用程式加上相關設定去測試，另外一種是 Google 提供的簡易測試，如下</p>\n<h3 id=\"Application-功能驗證\"><a href=\"#Application-功能驗證\" class=\"headerlink\" title=\"Application 功能驗證\"></a>Application 功能驗證</h3><p>在 Pod 或 Deployment 的描述檔新增以下片段，以便賦予 KSA，此時該應用服務就可以有相對應的 IAM 權限</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">ksa-workload-identity</span></span><br><span class=\"line\">  <span class=\"attr\">nodeSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">iam.gke.io/gke-metadata-server-enabled:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"簡易功能驗證\"><a href=\"#簡易功能驗證\" class=\"headerlink\" title=\"簡易功能驗證\"></a>簡易功能驗證</h3><p>佈署以下服務，假設檔名為 wi-test.yaml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">workload-identity-test</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">workload-identity</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">google/cloud-sdk:slim</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">workload-identity-test</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span> [<span class=\"string\">&quot;sleep&quot;</span>,<span class=\"string\">&quot;infinity&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">ksa-workload-identity</span></span><br><span class=\"line\">  <span class=\"attr\">nodeSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">iam.gke.io/gke-metadata-server-enabled:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f wi-test.yaml</span><br></pre></td></tr></table></figure>\n\n<p>進入 Pod 內</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -it workload-identity-test \\</span><br><span class=\"line\">  --namespace workload-identity \\</span><br><span class=\"line\">  -- /bin/bash</span><br></pre></td></tr></table></figure>\n\n<p>利用 curl 指令進行驗證：</p>\n<ol>\n<li><p>回傳內容為 GSA E-mail</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -H <span class=\"string\">&quot;Metadata-Flavor: Google&quot;</span> http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email</span><br></pre></td></tr></table></figure></li>\n<li><p>取得 Token </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -H <span class=\"string\">&quot;Metadata-Flavor: Google&quot;</span> http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token</span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>清理 Pod</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl delete -f wi-test.yaml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>如果是使用 Autopilot clusters 在設定上會有些許不同，此時建議直接參考官方文件會比較恰當</p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://cloud.google.com/kubernetes-engine/docs/concepts/workload-identity\">https://cloud.google.com/kubernetes-engine/docs/concepts/workload-identity</a></li>\n<li><a href=\"https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity\">https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>以前在 GKE 內的應用程式若是有需要存取其他 GCP 上的服務時，會需要建立一個專用的 Service Account 並且將該帳戶賦予對應的權限，再將 JWT 掛載到應用程式。</p>\n<p>這對於管理與資安上都是一大的隱憂，只要 JWT 不小心被有心人士拿到，就可以有相對應的權限。</p>","more":"<p>而 GKE 上 Workload Identity 就是用來解決 JWT 需要下載使用的問題，只要 JWT 不外流，對於安全性就更上一層樓了。 只需要 kubernetes service account(簡稱 KSA) 與 google service account(簡稱 GSA) 進行綁定，再將 KSA 賦予給 Pod，應用程式就會有相對應的權限可以使用。</p>\n<p>使用 Workload Identity 也是 Google 比較建議用來連接 GSA 的方式</p>\n<blockquote>\n<p>Workload Identity is the recommended way for your workloads running on Google Kubernetes Engine (GKE) to access Google Cloud services in a secure and manageable way.</p>\n</blockquote>\n<h2 id=\"啟用-Workload-Identity\"><a href=\"#啟用-Workload-Identity\" class=\"headerlink\" title=\"啟用 Workload Identity\"></a>啟用 Workload Identity</h2><p>要使用 Workload Identity，那就必須要先讓 GKE 支援 Workload Identity，可以從 Master Node 去確認有沒有啟用</p>\n<p><img src=\"mk-20240118163311.png\"></p>\n<p>如果一開始建立叢集時沒有預先啟動，那麼之後要啟動的話，所以有的 Worker Node 都必須重新生成過一遍才會生效，這點需要注意。</p>\n<p>Google 是建議啟用 Workload Identity 後，直接重新 create 新的 node pool</p>\n<blockquote>\n<p>We recommend creating new node pools if you also need to modify your applications to be compatible with Workload Identity.</p>\n</blockquote>\n<h2 id=\"確認自身權限\"><a href=\"#確認自身權限\" class=\"headerlink\" title=\"確認自身權限\"></a>確認自身權限</h2><p>先確認自身操作權限是否有以下兩個：</p>\n<ul>\n<li>roles/container.admin (Kubernetes Engine 管理員)</li>\n<li>roles/iam.serviceAccountAdmin (服務帳戶管理員)</li>\n</ul>\n<h2 id=\"讓-Application-使用-Workload-Identity\"><a href=\"#讓-Application-使用-Workload-Identity\" class=\"headerlink\" title=\"讓 Application 使用 Workload Identity\"></a>讓 Application 使用 Workload Identity</h2><p>溫馨小提醒：</p>\n<ol>\n<li>這邊的 Project ID 統一用 demo-123</li>\n<li>以下示範建議搭配<a href=\"https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity\">官方文件</a>的指令服用，這樣會比較清楚各欄位要填什麼</li>\n<li>如果熟練的話也可自行將部份指令轉成描述檔(YAML)</li>\n</ol>\n<p>建立測試用 Namespace</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create namespace workload-identity</span><br></pre></td></tr></table></figure>\n\n<p>建立測試用 kubernetes service account 在 workload-identity Namespace</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create serviceaccount ksa-workload-identity \\</span><br><span class=\"line\">    --namespace workload-identity</span><br></pre></td></tr></table></figure>\n\n<p>建立測試用 google service account</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud iam service-accounts create gsa-workload-identity \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>賦予測試的 GSA 一個權限</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud projects add-iam-policy-binding demo-123 \\</span><br><span class=\"line\">    --member <span class=\"string\">&quot;serviceAccount:gsa-workload-identity@demo-123.iam.gserviceaccount.com&quot;</span> \\</span><br><span class=\"line\">    --role <span class=\"string\">&quot;roles/cloudbuild.builds.viewer&quot;</span> \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>將 KSA(ksa-workload-identity) 與 GSA(gsa-workload-identity) 進行綁定，有兩種方式：</p>\n<ul>\n<li>使用 Google SDK</li>\n<li>使用 K8s 描述檔：管理上較方便</li>\n</ul>\n<p><strong>使用 Google SDK</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud iam service-accounts add-iam-policy-binding gsa-workload-identity@demo-123.iam.gserviceaccount.com \\</span><br><span class=\"line\">    --role roles/iam.workloadIdentityUser \\</span><br><span class=\"line\">    --member <span class=\"string\">&quot;serviceAccount:demo-123.svc.id.goog[workload-identity/ksa-workload-identity]&quot;</span> \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p>解除綁定的方式 <code>add-iam-policy-binding</code> 改成 <code>remove-iam-policy-binding</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcloud iam service-accounts remove-iam-policy-binding gsa-workload-identity@demo-123.iam.gserviceaccount.com \\</span><br><span class=\"line\">    --role roles/iam.workloadIdentityUser \\</span><br><span class=\"line\">    --member <span class=\"string\">&quot;serviceAccount:demo-123.svc.id.goog[workload-identity/ksa-workload-identity]&quot;</span> \\</span><br><span class=\"line\">    --project=demo-123</span><br></pre></td></tr></table></figure>\n\n<p><strong>使用 K8s 描述檔</strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">iam.cnrm.cloud.google.com/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">IAMPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">iampolicy-workload-identity-sample</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">resourceRef:</span></span><br><span class=\"line\">    <span class=\"attr\">apiVersion:</span> <span class=\"string\">iam.cnrm.cloud.google.com/v1beta1</span></span><br><span class=\"line\">    <span class=\"attr\">kind:</span> <span class=\"string\">IAMServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">gsa-workload-identity</span></span><br><span class=\"line\">  <span class=\"attr\">bindings:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">role:</span> <span class=\"string\">roles/iam.workloadIdentityUser</span></span><br><span class=\"line\">      <span class=\"attr\">members:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">serviceAccount:demo-123.svc.id.goog[workload-identity/ksa-workload-identity]</span></span><br></pre></td></tr></table></figure>\n\n<p>調整 KSA 的設定，新增 annotation 資訊</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl annotate serviceaccount ksa-workload-identity \\</span><br><span class=\"line\">    --namespace workload-identity \\</span><br><span class=\"line\">    iam.gke.io/gcp-service-account=gsa-workload-identity@demo-123.iam.gserviceaccount.com</span><br></pre></td></tr></table></figure>\n\n<p>前面一開始只是先建立 KSA，上方又在多新增 annotations，所以寫成描述檔會是下面這樣</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"string\">iam.gke.io/gcp-service-account=gsa-workload-identity@demo-123.iam.gserviceaccount.com</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ksa-workload-identity</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">workload-identity</span></span><br></pre></td></tr></table></figure>\n\n<p>功能驗證的話有兩種，一種是直接將目標應用程式加上相關設定去測試，另外一種是 Google 提供的簡易測試，如下</p>\n<h3 id=\"Application-功能驗證\"><a href=\"#Application-功能驗證\" class=\"headerlink\" title=\"Application 功能驗證\"></a>Application 功能驗證</h3><p>在 Pod 或 Deployment 的描述檔新增以下片段，以便賦予 KSA，此時該應用服務就可以有相對應的 IAM 權限</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">ksa-workload-identity</span></span><br><span class=\"line\">  <span class=\"attr\">nodeSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">iam.gke.io/gke-metadata-server-enabled:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"簡易功能驗證\"><a href=\"#簡易功能驗證\" class=\"headerlink\" title=\"簡易功能驗證\"></a>簡易功能驗證</h3><p>佈署以下服務，假設檔名為 wi-test.yaml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">workload-identity-test</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">workload-identity</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">google/cloud-sdk:slim</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">workload-identity-test</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span> [<span class=\"string\">&quot;sleep&quot;</span>,<span class=\"string\">&quot;infinity&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">ksa-workload-identity</span></span><br><span class=\"line\">  <span class=\"attr\">nodeSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">iam.gke.io/gke-metadata-server-enabled:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f wi-test.yaml</span><br></pre></td></tr></table></figure>\n\n<p>進入 Pod 內</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -it workload-identity-test \\</span><br><span class=\"line\">  --namespace workload-identity \\</span><br><span class=\"line\">  -- /bin/bash</span><br></pre></td></tr></table></figure>\n\n<p>利用 curl 指令進行驗證：</p>\n<ol>\n<li><p>回傳內容為 GSA E-mail</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -H <span class=\"string\">&quot;Metadata-Flavor: Google&quot;</span> http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email</span><br></pre></td></tr></table></figure></li>\n<li><p>取得 Token </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -H <span class=\"string\">&quot;Metadata-Flavor: Google&quot;</span> http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token</span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>清理 Pod</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl delete -f wi-test.yaml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>如果是使用 Autopilot clusters 在設定上會有些許不同，此時建議直接參考官方文件會比較恰當</p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://cloud.google.com/kubernetes-engine/docs/concepts/workload-identity\">https://cloud.google.com/kubernetes-engine/docs/concepts/workload-identity</a></li>\n<li><a href=\"https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity\">https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity</a></li>\n</ul>"},{"title":"使用 hexo-abbrlink 優化文章連結","abbrlink":"94411fbc","date":"2024-01-24T08:38:31.000Z","_content":"\n\n## 前言\n\nHexo 產生文章連結時，預設是使用「年/月/日/文章Title」的格式，導致 URL 太多層，如果是中文標題，複製下來的連結會過於冗長，這不僅不利於 SEO，也容易在二次編輯文章時，導致原先的連結失效。\n\n最好的方式就是將文章的 URL 固定下來，這樣就可以一勞永逸，今天會使用 hexo-abbrlink 的套件來幫助我們達到固定 URL，而且不重複。\n\n<!-- more -->\n\n## hexo-abbrlink 的使用\n\n這邊先提供 hexo-abbrlink 的 github 專案連結：\n\n- https://github.com/rozbo/hexo-abbrlink\n\n以下的設定是依據我自身的設定提供參考\n\n### 安裝與確認\n\n安裝指令\n\n```bash\nnpm install hexo-abbrlink --save\n```\n\n確認是否有正確安裝\n\n```bash\nnpm list | grep \"hexo-abbrlink\"\n```\n\n也可以直接到 node_module 目錄底下去看有沒有 hexo-abbrlink 套件\n\n```bash\ncd ./node_modules\nls | grep \"hexo-abbrlink\"\n```\n\n### 設定檔調整\n\n編輯設定檔\n\n```bash\nvim ./_config.yml\n```\n\n新增以下片段，這邊只提供自身的設定，如果有需要更 detail 的設定可以參照 [hexo-abbrlink](https://github.com/rozbo/hexo-abbrlink) GitHub 專案\n\n```yaml\nabbrlink:\n  alg: crc32      #support crc16(default) and crc32\n  rep: hex        #support dec(default) and hex\n  drafts: true   #(true)Process draft,(false)Do not process draft. false(default)\n```\n\n註解預設的 permalink，並且在下面增加新的設定，之後就會依照該格式產生連結\n```yaml\n#permalink: :year/:month/:day/:title/\npermalink: posts/:abbrlink/\n```\n\n### 使用方式\n\n上述步驟都設定好之後，重新執行下述指令\n\n```bash\nhexo clean\nhexo generate\n```\n\n套件就會依據 Title 自動產生一組亂數的 abbrlink 在文章的 markdown 原檔案上方，如下\n\n```text\n---\ntitle: hexo-abbrlink 測試\ntags:\n  - Hexo\ncategories:\n  - Hexo\nabbrlink: 11e41c6\n---\n```\n\nabbrlink 一旦產生後，不論 Title 怎麼修改，abbrlink 都不會變動，除非將 abbrlink 刪除，重新 `hexo generate`\n\n確定 abbrlink 正常產出後，就可以 `hexo server` 進行本機測試，此時可以發現 URL 已經依照上面的設定改變了，會變成下面這種格式\n\n```text\nhttp://www.example.com/posts/11e41c6\n```\n\n最後確認無誤就可以佈署發布囉\n\n```bash\nhexo deploy\n```\n\n## 參考資料\n\n- https://github.com/rozbo/hexo-abbrlink","source":"_posts/hexo-abbrlink.md","raw":"---\ntitle: 使用 hexo-abbrlink 優化文章連結\ntags:\n  - Hexo\n  - blog\ncategories:\n  - Hexo\nabbrlink: 94411fbc\ndate: 2024-01-24 16:38:31\n---\n\n\n## 前言\n\nHexo 產生文章連結時，預設是使用「年/月/日/文章Title」的格式，導致 URL 太多層，如果是中文標題，複製下來的連結會過於冗長，這不僅不利於 SEO，也容易在二次編輯文章時，導致原先的連結失效。\n\n最好的方式就是將文章的 URL 固定下來，這樣就可以一勞永逸，今天會使用 hexo-abbrlink 的套件來幫助我們達到固定 URL，而且不重複。\n\n<!-- more -->\n\n## hexo-abbrlink 的使用\n\n這邊先提供 hexo-abbrlink 的 github 專案連結：\n\n- https://github.com/rozbo/hexo-abbrlink\n\n以下的設定是依據我自身的設定提供參考\n\n### 安裝與確認\n\n安裝指令\n\n```bash\nnpm install hexo-abbrlink --save\n```\n\n確認是否有正確安裝\n\n```bash\nnpm list | grep \"hexo-abbrlink\"\n```\n\n也可以直接到 node_module 目錄底下去看有沒有 hexo-abbrlink 套件\n\n```bash\ncd ./node_modules\nls | grep \"hexo-abbrlink\"\n```\n\n### 設定檔調整\n\n編輯設定檔\n\n```bash\nvim ./_config.yml\n```\n\n新增以下片段，這邊只提供自身的設定，如果有需要更 detail 的設定可以參照 [hexo-abbrlink](https://github.com/rozbo/hexo-abbrlink) GitHub 專案\n\n```yaml\nabbrlink:\n  alg: crc32      #support crc16(default) and crc32\n  rep: hex        #support dec(default) and hex\n  drafts: true   #(true)Process draft,(false)Do not process draft. false(default)\n```\n\n註解預設的 permalink，並且在下面增加新的設定，之後就會依照該格式產生連結\n```yaml\n#permalink: :year/:month/:day/:title/\npermalink: posts/:abbrlink/\n```\n\n### 使用方式\n\n上述步驟都設定好之後，重新執行下述指令\n\n```bash\nhexo clean\nhexo generate\n```\n\n套件就會依據 Title 自動產生一組亂數的 abbrlink 在文章的 markdown 原檔案上方，如下\n\n```text\n---\ntitle: hexo-abbrlink 測試\ntags:\n  - Hexo\ncategories:\n  - Hexo\nabbrlink: 11e41c6\n---\n```\n\nabbrlink 一旦產生後，不論 Title 怎麼修改，abbrlink 都不會變動，除非將 abbrlink 刪除，重新 `hexo generate`\n\n確定 abbrlink 正常產出後，就可以 `hexo server` 進行本機測試，此時可以發現 URL 已經依照上面的設定改變了，會變成下面這種格式\n\n```text\nhttp://www.example.com/posts/11e41c6\n```\n\n最後確認無誤就可以佈署發布囉\n\n```bash\nhexo deploy\n```\n\n## 參考資料\n\n- https://github.com/rozbo/hexo-abbrlink","slug":"hexo-abbrlink","published":1,"updated":"2024-09-09T07:17:02.663Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5j70018k0lz77913jkb","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Hexo 產生文章連結時，預設是使用「年/月/日/文章Title」的格式，導致 URL 太多層，如果是中文標題，複製下來的連結會過於冗長，這不僅不利於 SEO，也容易在二次編輯文章時，導致原先的連結失效。</p>\n<p>最好的方式就是將文章的 URL 固定下來，這樣就可以一勞永逸，今天會使用 hexo-abbrlink 的套件來幫助我們達到固定 URL，而且不重複。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"hexo-abbrlink-的使用\"><a href=\"#hexo-abbrlink-的使用\" class=\"headerlink\" title=\"hexo-abbrlink 的使用\"></a>hexo-abbrlink 的使用</h2><p>這邊先提供 hexo-abbrlink 的 github 專案連結：</p>\n<ul>\n<li><a href=\"https://github.com/rozbo/hexo-abbrlink\">https://github.com/rozbo/hexo-abbrlink</a></li>\n</ul>\n<p>以下的設定是依據我自身的設定提供參考</p>\n<h3 id=\"安裝與確認\"><a href=\"#安裝與確認\" class=\"headerlink\" title=\"安裝與確認\"></a>安裝與確認</h3><p>安裝指令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install hexo-abbrlink --save</span><br></pre></td></tr></table></figure>\n\n<p>確認是否有正確安裝</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm list | grep <span class=\"string\">&quot;hexo-abbrlink&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>也可以直接到 node_module 目錄底下去看有沒有 hexo-abbrlink 套件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ./node_modules</span><br><span class=\"line\">ls | grep <span class=\"string\">&quot;hexo-abbrlink&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"設定檔調整\"><a href=\"#設定檔調整\" class=\"headerlink\" title=\"設定檔調整\"></a>設定檔調整</h3><p>編輯設定檔</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim ./_config.yml</span><br></pre></td></tr></table></figure>\n\n<p>新增以下片段，這邊只提供自身的設定，如果有需要更 detail 的設定可以參照 <a href=\"https://github.com/rozbo/hexo-abbrlink\">hexo-abbrlink</a> GitHub 專案</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">abbrlink:</span></span><br><span class=\"line\">  <span class=\"attr\">alg:</span> <span class=\"string\">crc32</span>      <span class=\"comment\">#support crc16(default) and crc32</span></span><br><span class=\"line\">  <span class=\"attr\">rep:</span> <span class=\"string\">hex</span>        <span class=\"comment\">#support dec(default) and hex</span></span><br><span class=\"line\">  <span class=\"attr\">drafts:</span> <span class=\"literal\">true</span>   <span class=\"comment\">#(true)Process draft,(false)Do not process draft. false(default)</span></span><br></pre></td></tr></table></figure>\n\n<p>註解預設的 permalink，並且在下面增加新的設定，之後就會依照該格式產生連結</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#permalink: :year/:month/:day/:title/</span></span><br><span class=\"line\"><span class=\"attr\">permalink:</span> <span class=\"string\">posts/:abbrlink/</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用方式\"><a href=\"#使用方式\" class=\"headerlink\" title=\"使用方式\"></a>使用方式</h3><p>上述步驟都設定好之後，重新執行下述指令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo clean</span><br><span class=\"line\">hexo generate</span><br></pre></td></tr></table></figure>\n\n<p>套件就會依據 Title 自動產生一組亂數的 abbrlink 在文章的 markdown 原檔案上方，如下</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: hexo-abbrlink 測試</span><br><span class=\"line\">tags:</span><br><span class=\"line\">  - Hexo</span><br><span class=\"line\">categories:</span><br><span class=\"line\">  - Hexo</span><br><span class=\"line\">abbrlink: 11e41c6</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n\n<p>abbrlink 一旦產生後，不論 Title 怎麼修改，abbrlink 都不會變動，除非將 abbrlink 刪除，重新 <code>hexo generate</code></p>\n<p>確定 abbrlink 正常產出後，就可以 <code>hexo server</code> 進行本機測試，此時可以發現 URL 已經依照上面的設定改變了，會變成下面這種格式</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://www.example.com/posts/11e41c6</span><br></pre></td></tr></table></figure>\n\n<p>最後確認無誤就可以佈署發布囉</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo deploy</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://github.com/rozbo/hexo-abbrlink\">https://github.com/rozbo/hexo-abbrlink</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Hexo 產生文章連結時，預設是使用「年/月/日/文章Title」的格式，導致 URL 太多層，如果是中文標題，複製下來的連結會過於冗長，這不僅不利於 SEO，也容易在二次編輯文章時，導致原先的連結失效。</p>\n<p>最好的方式就是將文章的 URL 固定下來，這樣就可以一勞永逸，今天會使用 hexo-abbrlink 的套件來幫助我們達到固定 URL，而且不重複。</p>","more":"<h2 id=\"hexo-abbrlink-的使用\"><a href=\"#hexo-abbrlink-的使用\" class=\"headerlink\" title=\"hexo-abbrlink 的使用\"></a>hexo-abbrlink 的使用</h2><p>這邊先提供 hexo-abbrlink 的 github 專案連結：</p>\n<ul>\n<li><a href=\"https://github.com/rozbo/hexo-abbrlink\">https://github.com/rozbo/hexo-abbrlink</a></li>\n</ul>\n<p>以下的設定是依據我自身的設定提供參考</p>\n<h3 id=\"安裝與確認\"><a href=\"#安裝與確認\" class=\"headerlink\" title=\"安裝與確認\"></a>安裝與確認</h3><p>安裝指令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install hexo-abbrlink --save</span><br></pre></td></tr></table></figure>\n\n<p>確認是否有正確安裝</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm list | grep <span class=\"string\">&quot;hexo-abbrlink&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>也可以直接到 node_module 目錄底下去看有沒有 hexo-abbrlink 套件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ./node_modules</span><br><span class=\"line\">ls | grep <span class=\"string\">&quot;hexo-abbrlink&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"設定檔調整\"><a href=\"#設定檔調整\" class=\"headerlink\" title=\"設定檔調整\"></a>設定檔調整</h3><p>編輯設定檔</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim ./_config.yml</span><br></pre></td></tr></table></figure>\n\n<p>新增以下片段，這邊只提供自身的設定，如果有需要更 detail 的設定可以參照 <a href=\"https://github.com/rozbo/hexo-abbrlink\">hexo-abbrlink</a> GitHub 專案</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">abbrlink:</span></span><br><span class=\"line\">  <span class=\"attr\">alg:</span> <span class=\"string\">crc32</span>      <span class=\"comment\">#support crc16(default) and crc32</span></span><br><span class=\"line\">  <span class=\"attr\">rep:</span> <span class=\"string\">hex</span>        <span class=\"comment\">#support dec(default) and hex</span></span><br><span class=\"line\">  <span class=\"attr\">drafts:</span> <span class=\"literal\">true</span>   <span class=\"comment\">#(true)Process draft,(false)Do not process draft. false(default)</span></span><br></pre></td></tr></table></figure>\n\n<p>註解預設的 permalink，並且在下面增加新的設定，之後就會依照該格式產生連結</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#permalink: :year/:month/:day/:title/</span></span><br><span class=\"line\"><span class=\"attr\">permalink:</span> <span class=\"string\">posts/:abbrlink/</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用方式\"><a href=\"#使用方式\" class=\"headerlink\" title=\"使用方式\"></a>使用方式</h3><p>上述步驟都設定好之後，重新執行下述指令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo clean</span><br><span class=\"line\">hexo generate</span><br></pre></td></tr></table></figure>\n\n<p>套件就會依據 Title 自動產生一組亂數的 abbrlink 在文章的 markdown 原檔案上方，如下</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: hexo-abbrlink 測試</span><br><span class=\"line\">tags:</span><br><span class=\"line\">  - Hexo</span><br><span class=\"line\">categories:</span><br><span class=\"line\">  - Hexo</span><br><span class=\"line\">abbrlink: 11e41c6</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n\n<p>abbrlink 一旦產生後，不論 Title 怎麼修改，abbrlink 都不會變動，除非將 abbrlink 刪除，重新 <code>hexo generate</code></p>\n<p>確定 abbrlink 正常產出後，就可以 <code>hexo server</code> 進行本機測試，此時可以發現 URL 已經依照上面的設定改變了，會變成下面這種格式</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://www.example.com/posts/11e41c6</span><br></pre></td></tr></table></figure>\n\n<p>最後確認無誤就可以佈署發布囉</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo deploy</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://github.com/rozbo/hexo-abbrlink\">https://github.com/rozbo/hexo-abbrlink</a></li>\n</ul>"},{"title":"Hexo加入Disqus留言功能","abbrlink":"eed23cc9","date":"2021-08-16T02:38:09.000Z","_content":"\n## 前言\n\n當我們利用 Hexo 架設好部落格並選定主題後，我們可能會希望讀者們可以針對文章予以回饋，這時候留言板功能就顯得格外重要，在 Hexo 中我們可以整併 Disqus 留言功能進去，讓文章的結尾可以有一塊專門留言的留言板，好讓讀者能夠留下寶貴的意見或問題\n\n<!--more-->\n\n## Disqus 留言功能的使用\n\nDisqus 留言功能屬於第三方的功能，所以我們需要到 [Disqus 官方](https://disqus.com) 註冊帳號，註冊期間會請你填入 shortname，請留意一下，shortname 設定後是無法再修改的\n\n註冊後再到 `./themes/next/_config.yml` 內 Disqus 的區塊去做設定，將 enable 參數值改成 true，shortname 的值改成 Disqus 當時申請時所填入的 shortname\n\n```yaml\n# Disqus\n# For more information: https://disqus.com\ndisqus:\n  enable: false\n  shortname: YOUR_SHORTNAME\n  count: true\n```\n\n## 文後討論\n\n因 Disqus 屬於第三方管理，所以相關後台設定需要到 Disqus 登入自己的帳號來調整，例如：留言通知、更改語言等等...\n\n這邊順便提一下，Disqus 預設不允許讀者在沒有登入 Disqus 的情況下進行留言，如果想要讓讀者可以在沒有登入 Disqus 的情況下留言，可以到 Disqus 的後台下述路徑去調整\n\n```text\nSettings → Admin → Edit Settings → 選擇要修改的部落格 → Coummunity → Moderation → Guest Commenting打勾\n```\n\n> 路徑的部分可能隨時間官方會有所調整，若有更動，可能需要稍微找一下\n\n雖然如此，但是讀者最少還是得留下「名字」跟「E-mail」才能進行留言，如圖\n\n![](mk-20240119114707.png)","source":"_posts/hexo-Disqus-feature.md","raw":"---\ntitle: Hexo加入Disqus留言功能\ntags:\n  - Hexo\n  - blog\n  - Disqus\ncategories:\n  - Hexo\nabbrlink: eed23cc9\ndate: 2021-08-16 10:38:09\n---\n\n## 前言\n\n當我們利用 Hexo 架設好部落格並選定主題後，我們可能會希望讀者們可以針對文章予以回饋，這時候留言板功能就顯得格外重要，在 Hexo 中我們可以整併 Disqus 留言功能進去，讓文章的結尾可以有一塊專門留言的留言板，好讓讀者能夠留下寶貴的意見或問題\n\n<!--more-->\n\n## Disqus 留言功能的使用\n\nDisqus 留言功能屬於第三方的功能，所以我們需要到 [Disqus 官方](https://disqus.com) 註冊帳號，註冊期間會請你填入 shortname，請留意一下，shortname 設定後是無法再修改的\n\n註冊後再到 `./themes/next/_config.yml` 內 Disqus 的區塊去做設定，將 enable 參數值改成 true，shortname 的值改成 Disqus 當時申請時所填入的 shortname\n\n```yaml\n# Disqus\n# For more information: https://disqus.com\ndisqus:\n  enable: false\n  shortname: YOUR_SHORTNAME\n  count: true\n```\n\n## 文後討論\n\n因 Disqus 屬於第三方管理，所以相關後台設定需要到 Disqus 登入自己的帳號來調整，例如：留言通知、更改語言等等...\n\n這邊順便提一下，Disqus 預設不允許讀者在沒有登入 Disqus 的情況下進行留言，如果想要讓讀者可以在沒有登入 Disqus 的情況下留言，可以到 Disqus 的後台下述路徑去調整\n\n```text\nSettings → Admin → Edit Settings → 選擇要修改的部落格 → Coummunity → Moderation → Guest Commenting打勾\n```\n\n> 路徑的部分可能隨時間官方會有所調整，若有更動，可能需要稍微找一下\n\n雖然如此，但是讀者最少還是得留下「名字」跟「E-mail」才能進行留言，如圖\n\n![](mk-20240119114707.png)","slug":"hexo-Disqus-feature","published":1,"updated":"2024-09-09T07:17:02.660Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5j7001bk0lz7zpp8e7d","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>當我們利用 Hexo 架設好部落格並選定主題後，我們可能會希望讀者們可以針對文章予以回饋，這時候留言板功能就顯得格外重要，在 Hexo 中我們可以整併 Disqus 留言功能進去，讓文章的結尾可以有一塊專門留言的留言板，好讓讀者能夠留下寶貴的意見或問題</p>\n<span id=\"more\"></span>\n\n<h2 id=\"Disqus-留言功能的使用\"><a href=\"#Disqus-留言功能的使用\" class=\"headerlink\" title=\"Disqus 留言功能的使用\"></a>Disqus 留言功能的使用</h2><p>Disqus 留言功能屬於第三方的功能，所以我們需要到 <a href=\"https://disqus.com/\">Disqus 官方</a> 註冊帳號，註冊期間會請你填入 shortname，請留意一下，shortname 設定後是無法再修改的</p>\n<p>註冊後再到 <code>./themes/next/_config.yml</code> 內 Disqus 的區塊去做設定，將 enable 參數值改成 true，shortname 的值改成 Disqus 當時申請時所填入的 shortname</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Disqus</span></span><br><span class=\"line\"><span class=\"comment\"># For more information: https://disqus.com</span></span><br><span class=\"line\"><span class=\"attr\">disqus:</span></span><br><span class=\"line\">  <span class=\"attr\">enable:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">shortname:</span> <span class=\"string\">YOUR_SHORTNAME</span></span><br><span class=\"line\">  <span class=\"attr\">count:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>因 Disqus 屬於第三方管理，所以相關後台設定需要到 Disqus 登入自己的帳號來調整，例如：留言通知、更改語言等等…</p>\n<p>這邊順便提一下，Disqus 預設不允許讀者在沒有登入 Disqus 的情況下進行留言，如果想要讓讀者可以在沒有登入 Disqus 的情況下留言，可以到 Disqus 的後台下述路徑去調整</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Settings → Admin → Edit Settings → 選擇要修改的部落格 → Coummunity → Moderation → Guest Commenting打勾</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>路徑的部分可能隨時間官方會有所調整，若有更動，可能需要稍微找一下</p>\n</blockquote>\n<p>雖然如此，但是讀者最少還是得留下「名字」跟「E-mail」才能進行留言，如圖</p>\n<p><img src=\"mk-20240119114707.png\"></p>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>當我們利用 Hexo 架設好部落格並選定主題後，我們可能會希望讀者們可以針對文章予以回饋，這時候留言板功能就顯得格外重要，在 Hexo 中我們可以整併 Disqus 留言功能進去，讓文章的結尾可以有一塊專門留言的留言板，好讓讀者能夠留下寶貴的意見或問題</p>","more":"<h2 id=\"Disqus-留言功能的使用\"><a href=\"#Disqus-留言功能的使用\" class=\"headerlink\" title=\"Disqus 留言功能的使用\"></a>Disqus 留言功能的使用</h2><p>Disqus 留言功能屬於第三方的功能，所以我們需要到 <a href=\"https://disqus.com/\">Disqus 官方</a> 註冊帳號，註冊期間會請你填入 shortname，請留意一下，shortname 設定後是無法再修改的</p>\n<p>註冊後再到 <code>./themes/next/_config.yml</code> 內 Disqus 的區塊去做設定，將 enable 參數值改成 true，shortname 的值改成 Disqus 當時申請時所填入的 shortname</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Disqus</span></span><br><span class=\"line\"><span class=\"comment\"># For more information: https://disqus.com</span></span><br><span class=\"line\"><span class=\"attr\">disqus:</span></span><br><span class=\"line\">  <span class=\"attr\">enable:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">shortname:</span> <span class=\"string\">YOUR_SHORTNAME</span></span><br><span class=\"line\">  <span class=\"attr\">count:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>因 Disqus 屬於第三方管理，所以相關後台設定需要到 Disqus 登入自己的帳號來調整，例如：留言通知、更改語言等等…</p>\n<p>這邊順便提一下，Disqus 預設不允許讀者在沒有登入 Disqus 的情況下進行留言，如果想要讓讀者可以在沒有登入 Disqus 的情況下留言，可以到 Disqus 的後台下述路徑去調整</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Settings → Admin → Edit Settings → 選擇要修改的部落格 → Coummunity → Moderation → Guest Commenting打勾</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>路徑的部分可能隨時間官方會有所調整，若有更動，可能需要稍微找一下</p>\n</blockquote>\n<p>雖然如此，但是讀者最少還是得留下「名字」跟「E-mail」才能進行留言，如圖</p>\n<p><img src=\"mk-20240119114707.png\"></p>"},{"title":"Hexo的關於功能","abbrlink":"8be085a8","date":"2021-07-26T02:26:48.000Z","_content":"\n## 前言\n\nHexo 的關於(about) 功能，主要是可以讓讀者點進特定頁面來去了解作者本人，也就是作者的自我介紹頁，以下會介紹如何啟用與使用\n\n<!--more-->\n\n## 關於的使用\n\n啟用關於功能，讓關於連結出現在網站上，首先調整 `./themes/next/_config.yml` 中的下述設定，將 `about: /about/ || fa fa-user` 註解「取消」，這樣就可以讓網站出現關於的連結\n\n```\nmenu:\n  home: / || fa fa-home\n  about: /about/ || fa fa-user\n  tags: /tags/ || fa fa-tags\n  categories: /categories/ || fa fa-th\n  archives: /archives/ || fa fa-archive\n  #schedule: /schedule/ || fa fa-calendar\n  #sitemap: /sitemap.xml || fa fa-sitemap\n  #commonweal: /404/ || fa fa-heartbeat\n```\n\n只有連結並沒有用處，點擊關於連結時，要能夠顯示相關頁面，所以使用下述指令，讓 Hexo 幫你產生連結檔\n\n```bash\nhexo new page about\n```\n\nHexo 會在 `./source` 底下產生 about 目錄，目錄內會有一個 index.md 檔案\n\nabout 頁面建立後，還需將 index.md 檔案打開，並且加入 type 參數，如下\n\n```\n---\ntitle: about\ndate: 2021-04-20 15:37:19\ntype: \"about\"\n---\n```\n\n這樣基本上關於功能就已經完成設定\n\n使用時，只要在 `./source/about/index.md` 頁面以 Markdown 語法寫下自我介紹即可\n\n## 後記\n\n該篇與 Hexo的分類/標籤功能 設定方式極度雷同，如有需要可以搭配一起設定，另外兩篇請參考下面連結\n\n- [Hexo的分類功能](https://blog.tonyjhang.dev/posts/8bfb5405)\n- [Hexo的標籤功能](https://blog.tonyjhang.dev/posts/1436c3e2)\n","source":"_posts/hexo-about-me.md","raw":"---\ntitle: Hexo的關於功能\ntags:\n  - Hexo\n  - blog\ncategories:\n  - Hexo\nabbrlink: 8be085a8\ndate: 2021-07-26 10:26:48\n---\n\n## 前言\n\nHexo 的關於(about) 功能，主要是可以讓讀者點進特定頁面來去了解作者本人，也就是作者的自我介紹頁，以下會介紹如何啟用與使用\n\n<!--more-->\n\n## 關於的使用\n\n啟用關於功能，讓關於連結出現在網站上，首先調整 `./themes/next/_config.yml` 中的下述設定，將 `about: /about/ || fa fa-user` 註解「取消」，這樣就可以讓網站出現關於的連結\n\n```\nmenu:\n  home: / || fa fa-home\n  about: /about/ || fa fa-user\n  tags: /tags/ || fa fa-tags\n  categories: /categories/ || fa fa-th\n  archives: /archives/ || fa fa-archive\n  #schedule: /schedule/ || fa fa-calendar\n  #sitemap: /sitemap.xml || fa fa-sitemap\n  #commonweal: /404/ || fa fa-heartbeat\n```\n\n只有連結並沒有用處，點擊關於連結時，要能夠顯示相關頁面，所以使用下述指令，讓 Hexo 幫你產生連結檔\n\n```bash\nhexo new page about\n```\n\nHexo 會在 `./source` 底下產生 about 目錄，目錄內會有一個 index.md 檔案\n\nabout 頁面建立後，還需將 index.md 檔案打開，並且加入 type 參數，如下\n\n```\n---\ntitle: about\ndate: 2021-04-20 15:37:19\ntype: \"about\"\n---\n```\n\n這樣基本上關於功能就已經完成設定\n\n使用時，只要在 `./source/about/index.md` 頁面以 Markdown 語法寫下自我介紹即可\n\n## 後記\n\n該篇與 Hexo的分類/標籤功能 設定方式極度雷同，如有需要可以搭配一起設定，另外兩篇請參考下面連結\n\n- [Hexo的分類功能](https://blog.tonyjhang.dev/posts/8bfb5405)\n- [Hexo的標籤功能](https://blog.tonyjhang.dev/posts/1436c3e2)\n","slug":"hexo-about-me","published":1,"updated":"2024-09-09T07:17:02.663Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5j8001dk0lzgprm8613","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Hexo 的關於(about) 功能，主要是可以讓讀者點進特定頁面來去了解作者本人，也就是作者的自我介紹頁，以下會介紹如何啟用與使用</p>\n<span id=\"more\"></span>\n\n<h2 id=\"關於的使用\"><a href=\"#關於的使用\" class=\"headerlink\" title=\"關於的使用\"></a>關於的使用</h2><p>啟用關於功能，讓關於連結出現在網站上，首先調整 <code>./themes/next/_config.yml</code> 中的下述設定，將 <code>about: /about/ || fa fa-user</code> 註解「取消」，這樣就可以讓網站出現關於的連結</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">menu:</span><br><span class=\"line\">  home: &#x2F; || fa fa-home</span><br><span class=\"line\">  about: &#x2F;about&#x2F; || fa fa-user</span><br><span class=\"line\">  tags: &#x2F;tags&#x2F; || fa fa-tags</span><br><span class=\"line\">  categories: &#x2F;categories&#x2F; || fa fa-th</span><br><span class=\"line\">  archives: &#x2F;archives&#x2F; || fa fa-archive</span><br><span class=\"line\">  #schedule: &#x2F;schedule&#x2F; || fa fa-calendar</span><br><span class=\"line\">  #sitemap: &#x2F;sitemap.xml || fa fa-sitemap</span><br><span class=\"line\">  #commonweal: &#x2F;404&#x2F; || fa fa-heartbeat</span><br></pre></td></tr></table></figure>\n\n<p>只有連結並沒有用處，點擊關於連結時，要能夠顯示相關頁面，所以使用下述指令，讓 Hexo 幫你產生連結檔</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo new page about</span><br></pre></td></tr></table></figure>\n\n<p>Hexo 會在 <code>./source</code> 底下產生 about 目錄，目錄內會有一個 index.md 檔案</p>\n<p>about 頁面建立後，還需將 index.md 檔案打開，並且加入 type 參數，如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: about</span><br><span class=\"line\">date: 2021-04-20 15:37:19</span><br><span class=\"line\">type: &quot;about&quot;</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n\n<p>這樣基本上關於功能就已經完成設定</p>\n<p>使用時，只要在 <code>./source/about/index.md</code> 頁面以 Markdown 語法寫下自我介紹即可</p>\n<h2 id=\"後記\"><a href=\"#後記\" class=\"headerlink\" title=\"後記\"></a>後記</h2><p>該篇與 Hexo的分類/標籤功能 設定方式極度雷同，如有需要可以搭配一起設定，另外兩篇請參考下面連結</p>\n<ul>\n<li><a href=\"https://blog.tonyjhang.dev/posts/8bfb5405\">Hexo的分類功能</a></li>\n<li><a href=\"https://blog.tonyjhang.dev/posts/1436c3e2\">Hexo的標籤功能</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Hexo 的關於(about) 功能，主要是可以讓讀者點進特定頁面來去了解作者本人，也就是作者的自我介紹頁，以下會介紹如何啟用與使用</p>","more":"<h2 id=\"關於的使用\"><a href=\"#關於的使用\" class=\"headerlink\" title=\"關於的使用\"></a>關於的使用</h2><p>啟用關於功能，讓關於連結出現在網站上，首先調整 <code>./themes/next/_config.yml</code> 中的下述設定，將 <code>about: /about/ || fa fa-user</code> 註解「取消」，這樣就可以讓網站出現關於的連結</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">menu:</span><br><span class=\"line\">  home: &#x2F; || fa fa-home</span><br><span class=\"line\">  about: &#x2F;about&#x2F; || fa fa-user</span><br><span class=\"line\">  tags: &#x2F;tags&#x2F; || fa fa-tags</span><br><span class=\"line\">  categories: &#x2F;categories&#x2F; || fa fa-th</span><br><span class=\"line\">  archives: &#x2F;archives&#x2F; || fa fa-archive</span><br><span class=\"line\">  #schedule: &#x2F;schedule&#x2F; || fa fa-calendar</span><br><span class=\"line\">  #sitemap: &#x2F;sitemap.xml || fa fa-sitemap</span><br><span class=\"line\">  #commonweal: &#x2F;404&#x2F; || fa fa-heartbeat</span><br></pre></td></tr></table></figure>\n\n<p>只有連結並沒有用處，點擊關於連結時，要能夠顯示相關頁面，所以使用下述指令，讓 Hexo 幫你產生連結檔</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo new page about</span><br></pre></td></tr></table></figure>\n\n<p>Hexo 會在 <code>./source</code> 底下產生 about 目錄，目錄內會有一個 index.md 檔案</p>\n<p>about 頁面建立後，還需將 index.md 檔案打開，並且加入 type 參數，如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: about</span><br><span class=\"line\">date: 2021-04-20 15:37:19</span><br><span class=\"line\">type: &quot;about&quot;</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n\n<p>這樣基本上關於功能就已經完成設定</p>\n<p>使用時，只要在 <code>./source/about/index.md</code> 頁面以 Markdown 語法寫下自我介紹即可</p>\n<h2 id=\"後記\"><a href=\"#後記\" class=\"headerlink\" title=\"後記\"></a>後記</h2><p>該篇與 Hexo的分類/標籤功能 設定方式極度雷同，如有需要可以搭配一起設定，另外兩篇請參考下面連結</p>\n<ul>\n<li><a href=\"https://blog.tonyjhang.dev/posts/8bfb5405\">Hexo的分類功能</a></li>\n<li><a href=\"https://blog.tonyjhang.dev/posts/1436c3e2\">Hexo的標籤功能</a></li>\n</ul>"},{"title":"Hexo的分類功能","abbrlink":"8bfb5405","date":"2021-07-23T02:26:06.000Z","_content":"\n## 前言\n\nHexo 的分類功能其實跟資料夾的功能差不多，作者可以自行將文章做分類，讓讀者在找尋時可以依據分類來快速找到相關的文章，功能上與標籤(tags) 有點大同小異\n\n<!--more-->\n\n## 分類的使用\n\n啟用分類功能，讓分類連結出現在網站上，首先調整 `./themes/next/_config.yml` 中的下述設定，將 `categories: /categories/ || fa fa-th` 註解「取消」，這樣就可以讓網站出現分類的連結\n\n```\nmenu:\n  home: / || fa fa-home\n  about: /about/ || fa fa-user\n  tags: /tags/ || fa fa-tags\n  categories: /categories/ || fa fa-th\n  archives: /archives/ || fa fa-archive\n  #schedule: /schedule/ || fa fa-calendar\n  #sitemap: /sitemap.xml || fa fa-sitemap\n  #commonweal: /404/ || fa fa-heartbeat\n```\n\n只有連結並沒有用處，點擊分類連結時，要能夠顯示相關頁面，所以使用下述指令，讓 Hexo 幫你產生連結檔\n\n```bash\nhexo new page categories\n```\n\nHexo 會在 `./source` 底下產生 categories 目錄，目錄內會有一個 index.md 檔案\n\ncategories 頁面建立後，還需將 index.md 檔案打開，並且加入 type 參數，如下\n\n```\n---\ntitle: categories\ndate: 2021-04-20 15:37:19\ntype: \"categories\"\n---\n```\n\n這樣基本上分類功能就已經完成設定\n\n在使用時，只要在文章建立後加上 categories，並把要分類的值加上去即可，如下\n\n```\n---\ntitle: 分類測試\ndate: 2021-05-22 16:17:39\ncategories:\n  - Hexo\n---\n```\n\n這樣該篇文章就會被納入 Hexo 這個分類底下\n\n## 文後討論\n\n如果文章內的 categories 設定如下\n\n```\n---\ntitle: 分類測試\ndate: 2021-05-22 16:17:39\ncategories:\n  - Hexo\n  - NexT\n---\n```\n\n此時該文章將被分類到 Hexo 中的 NexT 底下，如：Hexo/NexT/分類測試\n\n## 後記\n\n該篇與 Hexo的標籤/關於功能 設定方式極度雷同，如有需要可以搭配一起設定，另外兩篇請參考下面連結\n\n- [Hexo的標籤功能](https://blog.tonyjhang.dev/posts/1436c3e2)\n- [Hexo的關於功能](https://blog.tonyjhang.dev/posts/8be085a8)\n","source":"_posts/hexo-categories.md","raw":"---\ntitle: Hexo的分類功能\ntags:\n  - Hexo\n  - blog\ncategories:\n  - Hexo\nabbrlink: 8bfb5405\ndate: 2021-07-23 10:26:06\n---\n\n## 前言\n\nHexo 的分類功能其實跟資料夾的功能差不多，作者可以自行將文章做分類，讓讀者在找尋時可以依據分類來快速找到相關的文章，功能上與標籤(tags) 有點大同小異\n\n<!--more-->\n\n## 分類的使用\n\n啟用分類功能，讓分類連結出現在網站上，首先調整 `./themes/next/_config.yml` 中的下述設定，將 `categories: /categories/ || fa fa-th` 註解「取消」，這樣就可以讓網站出現分類的連結\n\n```\nmenu:\n  home: / || fa fa-home\n  about: /about/ || fa fa-user\n  tags: /tags/ || fa fa-tags\n  categories: /categories/ || fa fa-th\n  archives: /archives/ || fa fa-archive\n  #schedule: /schedule/ || fa fa-calendar\n  #sitemap: /sitemap.xml || fa fa-sitemap\n  #commonweal: /404/ || fa fa-heartbeat\n```\n\n只有連結並沒有用處，點擊分類連結時，要能夠顯示相關頁面，所以使用下述指令，讓 Hexo 幫你產生連結檔\n\n```bash\nhexo new page categories\n```\n\nHexo 會在 `./source` 底下產生 categories 目錄，目錄內會有一個 index.md 檔案\n\ncategories 頁面建立後，還需將 index.md 檔案打開，並且加入 type 參數，如下\n\n```\n---\ntitle: categories\ndate: 2021-04-20 15:37:19\ntype: \"categories\"\n---\n```\n\n這樣基本上分類功能就已經完成設定\n\n在使用時，只要在文章建立後加上 categories，並把要分類的值加上去即可，如下\n\n```\n---\ntitle: 分類測試\ndate: 2021-05-22 16:17:39\ncategories:\n  - Hexo\n---\n```\n\n這樣該篇文章就會被納入 Hexo 這個分類底下\n\n## 文後討論\n\n如果文章內的 categories 設定如下\n\n```\n---\ntitle: 分類測試\ndate: 2021-05-22 16:17:39\ncategories:\n  - Hexo\n  - NexT\n---\n```\n\n此時該文章將被分類到 Hexo 中的 NexT 底下，如：Hexo/NexT/分類測試\n\n## 後記\n\n該篇與 Hexo的標籤/關於功能 設定方式極度雷同，如有需要可以搭配一起設定，另外兩篇請參考下面連結\n\n- [Hexo的標籤功能](https://blog.tonyjhang.dev/posts/1436c3e2)\n- [Hexo的關於功能](https://blog.tonyjhang.dev/posts/8be085a8)\n","slug":"hexo-categories","published":1,"updated":"2024-09-09T07:17:02.663Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5j9001hk0lze9df2u8m","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Hexo 的分類功能其實跟資料夾的功能差不多，作者可以自行將文章做分類，讓讀者在找尋時可以依據分類來快速找到相關的文章，功能上與標籤(tags) 有點大同小異</p>\n<span id=\"more\"></span>\n\n<h2 id=\"分類的使用\"><a href=\"#分類的使用\" class=\"headerlink\" title=\"分類的使用\"></a>分類的使用</h2><p>啟用分類功能，讓分類連結出現在網站上，首先調整 <code>./themes/next/_config.yml</code> 中的下述設定，將 <code>categories: /categories/ || fa fa-th</code> 註解「取消」，這樣就可以讓網站出現分類的連結</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">menu:</span><br><span class=\"line\">  home: &#x2F; || fa fa-home</span><br><span class=\"line\">  about: &#x2F;about&#x2F; || fa fa-user</span><br><span class=\"line\">  tags: &#x2F;tags&#x2F; || fa fa-tags</span><br><span class=\"line\">  categories: &#x2F;categories&#x2F; || fa fa-th</span><br><span class=\"line\">  archives: &#x2F;archives&#x2F; || fa fa-archive</span><br><span class=\"line\">  #schedule: &#x2F;schedule&#x2F; || fa fa-calendar</span><br><span class=\"line\">  #sitemap: &#x2F;sitemap.xml || fa fa-sitemap</span><br><span class=\"line\">  #commonweal: &#x2F;404&#x2F; || fa fa-heartbeat</span><br></pre></td></tr></table></figure>\n\n<p>只有連結並沒有用處，點擊分類連結時，要能夠顯示相關頁面，所以使用下述指令，讓 Hexo 幫你產生連結檔</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo new page categories</span><br></pre></td></tr></table></figure>\n\n<p>Hexo 會在 <code>./source</code> 底下產生 categories 目錄，目錄內會有一個 index.md 檔案</p>\n<p>categories 頁面建立後，還需將 index.md 檔案打開，並且加入 type 參數，如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: categories</span><br><span class=\"line\">date: 2021-04-20 15:37:19</span><br><span class=\"line\">type: &quot;categories&quot;</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n\n<p>這樣基本上分類功能就已經完成設定</p>\n<p>在使用時，只要在文章建立後加上 categories，並把要分類的值加上去即可，如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: 分類測試</span><br><span class=\"line\">date: 2021-05-22 16:17:39</span><br><span class=\"line\">categories:</span><br><span class=\"line\">  - Hexo</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n\n<p>這樣該篇文章就會被納入 Hexo 這個分類底下</p>\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>如果文章內的 categories 設定如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: 分類測試</span><br><span class=\"line\">date: 2021-05-22 16:17:39</span><br><span class=\"line\">categories:</span><br><span class=\"line\">  - Hexo</span><br><span class=\"line\">  - NexT</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n\n<p>此時該文章將被分類到 Hexo 中的 NexT 底下，如：Hexo/NexT/分類測試</p>\n<h2 id=\"後記\"><a href=\"#後記\" class=\"headerlink\" title=\"後記\"></a>後記</h2><p>該篇與 Hexo的標籤/關於功能 設定方式極度雷同，如有需要可以搭配一起設定，另外兩篇請參考下面連結</p>\n<ul>\n<li><a href=\"https://blog.tonyjhang.dev/posts/1436c3e2\">Hexo的標籤功能</a></li>\n<li><a href=\"https://blog.tonyjhang.dev/posts/8be085a8\">Hexo的關於功能</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Hexo 的分類功能其實跟資料夾的功能差不多，作者可以自行將文章做分類，讓讀者在找尋時可以依據分類來快速找到相關的文章，功能上與標籤(tags) 有點大同小異</p>","more":"<h2 id=\"分類的使用\"><a href=\"#分類的使用\" class=\"headerlink\" title=\"分類的使用\"></a>分類的使用</h2><p>啟用分類功能，讓分類連結出現在網站上，首先調整 <code>./themes/next/_config.yml</code> 中的下述設定，將 <code>categories: /categories/ || fa fa-th</code> 註解「取消」，這樣就可以讓網站出現分類的連結</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">menu:</span><br><span class=\"line\">  home: &#x2F; || fa fa-home</span><br><span class=\"line\">  about: &#x2F;about&#x2F; || fa fa-user</span><br><span class=\"line\">  tags: &#x2F;tags&#x2F; || fa fa-tags</span><br><span class=\"line\">  categories: &#x2F;categories&#x2F; || fa fa-th</span><br><span class=\"line\">  archives: &#x2F;archives&#x2F; || fa fa-archive</span><br><span class=\"line\">  #schedule: &#x2F;schedule&#x2F; || fa fa-calendar</span><br><span class=\"line\">  #sitemap: &#x2F;sitemap.xml || fa fa-sitemap</span><br><span class=\"line\">  #commonweal: &#x2F;404&#x2F; || fa fa-heartbeat</span><br></pre></td></tr></table></figure>\n\n<p>只有連結並沒有用處，點擊分類連結時，要能夠顯示相關頁面，所以使用下述指令，讓 Hexo 幫你產生連結檔</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo new page categories</span><br></pre></td></tr></table></figure>\n\n<p>Hexo 會在 <code>./source</code> 底下產生 categories 目錄，目錄內會有一個 index.md 檔案</p>\n<p>categories 頁面建立後，還需將 index.md 檔案打開，並且加入 type 參數，如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: categories</span><br><span class=\"line\">date: 2021-04-20 15:37:19</span><br><span class=\"line\">type: &quot;categories&quot;</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n\n<p>這樣基本上分類功能就已經完成設定</p>\n<p>在使用時，只要在文章建立後加上 categories，並把要分類的值加上去即可，如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: 分類測試</span><br><span class=\"line\">date: 2021-05-22 16:17:39</span><br><span class=\"line\">categories:</span><br><span class=\"line\">  - Hexo</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n\n<p>這樣該篇文章就會被納入 Hexo 這個分類底下</p>\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>如果文章內的 categories 設定如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: 分類測試</span><br><span class=\"line\">date: 2021-05-22 16:17:39</span><br><span class=\"line\">categories:</span><br><span class=\"line\">  - Hexo</span><br><span class=\"line\">  - NexT</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n\n<p>此時該文章將被分類到 Hexo 中的 NexT 底下，如：Hexo/NexT/分類測試</p>\n<h2 id=\"後記\"><a href=\"#後記\" class=\"headerlink\" title=\"後記\"></a>後記</h2><p>該篇與 Hexo的標籤/關於功能 設定方式極度雷同，如有需要可以搭配一起設定，另外兩篇請參考下面連結</p>\n<ul>\n<li><a href=\"https://blog.tonyjhang.dev/posts/1436c3e2\">Hexo的標籤功能</a></li>\n<li><a href=\"https://blog.tonyjhang.dev/posts/8be085a8\">Hexo的關於功能</a></li>\n</ul>"},{"title":"Hexo文章插入圖片","abbrlink":"21f441c6","date":"2021-07-20T04:21:06.000Z","_content":"\n## 前言\n\nHexo 中的文章是使用 Markdown 的語法，有時候文章中可能會需要一些圖片來予以輔助，這時候我們可能會需要調整一些設定來存放我們的圖片\n\n## 文章插入圖片\n\n這邊先講一下 Markdown 插入圖片的語法\n\n```\n![](圖片路徑)\n```\n\n<!--more-->\n\n再來我們可以更改 Hexo 的設定檔，來讓我們建立文章時，能夠自動將該文章存放圖片的目錄也一起建立起來，修改 `./_config.xml`，並將下面參數值調整為 true\n\n```yaml\npost_asset_folder: true\n```\n\n調整後當我們使用 `hexo new \"新文章\"` 建立文章後，就會自動在 `./source/_posts` 建立一個與文章相同名稱的目錄，然後就能將圖片放進去\n\n而 Markdown 要調用圖片時，圖片路徑只需要填上圖片名稱即可，例如：圖片名稱為 123.png\n\n```\n![](123.png)\n```\n\n## 文後討論\n\n上述方式對於每篇文章都需要插入圖片的使用者非常方便，但是如果你的文章只有少數幾篇需要圖片輔助的話，可能會造成 `./source/_posts` 會有很多空的目錄，所以如果只有少數幾篇需要使用到圖片的話，這邊給兩個建議：\n1. 設定自動建立圖片存放目錄，然後自己手動將無需使用到圖片的文章的目錄刪除\n2. 乾脆不要設定，自己手動建立與文章相同名稱的目錄來存放圖片\n","source":"_posts/hexo-insert-picture.md","raw":"---\ntitle: Hexo文章插入圖片\ntags:\n  - Hexo\n  - blog\ncategories:\n  - Hexo\nabbrlink: 21f441c6\ndate: 2021-07-20 12:21:06\n---\n\n## 前言\n\nHexo 中的文章是使用 Markdown 的語法，有時候文章中可能會需要一些圖片來予以輔助，這時候我們可能會需要調整一些設定來存放我們的圖片\n\n## 文章插入圖片\n\n這邊先講一下 Markdown 插入圖片的語法\n\n```\n![](圖片路徑)\n```\n\n<!--more-->\n\n再來我們可以更改 Hexo 的設定檔，來讓我們建立文章時，能夠自動將該文章存放圖片的目錄也一起建立起來，修改 `./_config.xml`，並將下面參數值調整為 true\n\n```yaml\npost_asset_folder: true\n```\n\n調整後當我們使用 `hexo new \"新文章\"` 建立文章後，就會自動在 `./source/_posts` 建立一個與文章相同名稱的目錄，然後就能將圖片放進去\n\n而 Markdown 要調用圖片時，圖片路徑只需要填上圖片名稱即可，例如：圖片名稱為 123.png\n\n```\n![](123.png)\n```\n\n## 文後討論\n\n上述方式對於每篇文章都需要插入圖片的使用者非常方便，但是如果你的文章只有少數幾篇需要圖片輔助的話，可能會造成 `./source/_posts` 會有很多空的目錄，所以如果只有少數幾篇需要使用到圖片的話，這邊給兩個建議：\n1. 設定自動建立圖片存放目錄，然後自己手動將無需使用到圖片的文章的目錄刪除\n2. 乾脆不要設定，自己手動建立與文章相同名稱的目錄來存放圖片\n","slug":"hexo-insert-picture","published":1,"updated":"2024-09-09T07:17:02.664Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5ja001jk0lz121u1gqd","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Hexo 中的文章是使用 Markdown 的語法，有時候文章中可能會需要一些圖片來予以輔助，這時候我們可能會需要調整一些設定來存放我們的圖片</p>\n<h2 id=\"文章插入圖片\"><a href=\"#文章插入圖片\" class=\"headerlink\" title=\"文章插入圖片\"></a>文章插入圖片</h2><p>這邊先講一下 Markdown 插入圖片的語法</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">![](圖片路徑)</span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<p>再來我們可以更改 Hexo 的設定檔，來讓我們建立文章時，能夠自動將該文章存放圖片的目錄也一起建立起來，修改 <code>./_config.xml</code>，並將下面參數值調整為 true</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">post_asset_folder:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<p>調整後當我們使用 <code>hexo new &quot;新文章&quot;</code> 建立文章後，就會自動在 <code>./source/_posts</code> 建立一個與文章相同名稱的目錄，然後就能將圖片放進去</p>\n<p>而 Markdown 要調用圖片時，圖片路徑只需要填上圖片名稱即可，例如：圖片名稱為 123.png</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">![](123.png)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>上述方式對於每篇文章都需要插入圖片的使用者非常方便，但是如果你的文章只有少數幾篇需要圖片輔助的話，可能會造成 <code>./source/_posts</code> 會有很多空的目錄，所以如果只有少數幾篇需要使用到圖片的話，這邊給兩個建議：</p>\n<ol>\n<li>設定自動建立圖片存放目錄，然後自己手動將無需使用到圖片的文章的目錄刪除</li>\n<li>乾脆不要設定，自己手動建立與文章相同名稱的目錄來存放圖片</li>\n</ol>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Hexo 中的文章是使用 Markdown 的語法，有時候文章中可能會需要一些圖片來予以輔助，這時候我們可能會需要調整一些設定來存放我們的圖片</p>\n<h2 id=\"文章插入圖片\"><a href=\"#文章插入圖片\" class=\"headerlink\" title=\"文章插入圖片\"></a>文章插入圖片</h2><p>這邊先講一下 Markdown 插入圖片的語法</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">![](圖片路徑)</span><br></pre></td></tr></table></figure>","more":"<p>再來我們可以更改 Hexo 的設定檔，來讓我們建立文章時，能夠自動將該文章存放圖片的目錄也一起建立起來，修改 <code>./_config.xml</code>，並將下面參數值調整為 true</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">post_asset_folder:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<p>調整後當我們使用 <code>hexo new &quot;新文章&quot;</code> 建立文章後，就會自動在 <code>./source/_posts</code> 建立一個與文章相同名稱的目錄，然後就能將圖片放進去</p>\n<p>而 Markdown 要調用圖片時，圖片路徑只需要填上圖片名稱即可，例如：圖片名稱為 123.png</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">![](123.png)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>上述方式對於每篇文章都需要插入圖片的使用者非常方便，但是如果你的文章只有少數幾篇需要圖片輔助的話，可能會造成 <code>./source/_posts</code> 會有很多空的目錄，所以如果只有少數幾篇需要使用到圖片的話，這邊給兩個建議：</p>\n<ol>\n<li>設定自動建立圖片存放目錄，然後自己手動將無需使用到圖片的文章的目錄刪除</li>\n<li>乾脆不要設定，自己手動建立與文章相同名稱的目錄來存放圖片</li>\n</ol>"},{"title":"Hexo建立草稿","abbrlink":"946e0e0b","date":"2021-05-03T02:26:06.000Z","_content":"\n## 前言\n\n使用 Hexo 來當作技術部落格不僅簡單且快速，在剛開始架設完成後，可以使用指令 `hexo new [title]` 來建立文章並且撰寫，但是這樣的方式會延伸一個問題，如果這篇文章還處理撰寫的階段，但是我有修改其他已完成的文章需要發佈出去，但是不想把未完成的文章也一起發佈，此時就會有一些困擾，此篇會來說明如果使用 Hexo 的草稿功能。\n\n<!--more-->\n\n## Hexo 草稿\n\n一般來說，我們建立文章都是使用此指令\n\n```bash\nhexo new [Title] [FileName]\n```\n\n如果今天要建立 Hexo 草稿，我們可以將上述指令改成\n\n```bash\nhexo new draft [Title] [FileName]\n```\n\n那此時產生出來的草稿會放在 `./source/_drafts`\n\n> 如果是使用 `hexo new [title]` 則會放在 `./source/_posts`\n\n當我們要發佈一篇文章時，我們會使用 `hexo g` 和 `hexo d` 來編譯產生靜態檔與發佈文章，而草稿目錄內的文章不會被發佈出去，是 **因為 `hexo g` 並不會編譯 `./source/_drafts` 底下的檔案**。\n\n如果放在草稿目錄底下的文章完成後，想在本機先預覽檢查時，可以使用此指令\n\n> 此處「文後討論」有補充說明\n\n```bash\nhexo s --draft\n```\n\n確認文章沒問題後，我們就可以將草稿 publish，使用此指令\n\n> 這邊的 publish 是將檔案從 _drafts 移動到 _posts\n\n```bash\nhexo publish [FileName]  # 這邊是接 FileName，不包含副檔名 .md\n```\n\n接下來就跟放在 _posts 底下的文章發佈沒有兩樣，先進行移除舊的靜態檔與快取\n\n```bash\nhexo cl\n```\n\n然後進行編譯的動作\n\n```bash\nhexo g\n```\n\n最後再發佈\n\n```bash\nhexo d\n```\n\n## 文後討論\n\n看完上述，你可能會想，那能不能讓 `hexo s` 自動將 _drafts 底下的檔案自動預覽出來，而不要在指令後面又多加一個參數 `--draft`?\n\n答案是 可以的!\n\n只要去調整 `./_config.yml` 內的設定，將下面的參數值由 false 調整為 true 即可\n\n> 非 themes 底下的 _config.yml\n\n```yaml\nrender_drafts: true\n```\n\n調整之後，以後要預覽 _drafts 內的文章，就跟一般放在 _posts 底下的一樣，只要使用 `hexo s` 通通都可以在本機預覽得到。\n\n## 參考資料\n\n- https://www.dazhuanlan.com/2019/11/02/5dbc7ecc737a5/\n","source":"_posts/hexo-new-draft.md","raw":"---\ntitle: Hexo建立草稿\ntags:\n  - Hexo\n  - blog\ncategories:\n  - Hexo\nabbrlink: 946e0e0b\ndate: 2021-05-03 10:26:06\n---\n\n## 前言\n\n使用 Hexo 來當作技術部落格不僅簡單且快速，在剛開始架設完成後，可以使用指令 `hexo new [title]` 來建立文章並且撰寫，但是這樣的方式會延伸一個問題，如果這篇文章還處理撰寫的階段，但是我有修改其他已完成的文章需要發佈出去，但是不想把未完成的文章也一起發佈，此時就會有一些困擾，此篇會來說明如果使用 Hexo 的草稿功能。\n\n<!--more-->\n\n## Hexo 草稿\n\n一般來說，我們建立文章都是使用此指令\n\n```bash\nhexo new [Title] [FileName]\n```\n\n如果今天要建立 Hexo 草稿，我們可以將上述指令改成\n\n```bash\nhexo new draft [Title] [FileName]\n```\n\n那此時產生出來的草稿會放在 `./source/_drafts`\n\n> 如果是使用 `hexo new [title]` 則會放在 `./source/_posts`\n\n當我們要發佈一篇文章時，我們會使用 `hexo g` 和 `hexo d` 來編譯產生靜態檔與發佈文章，而草稿目錄內的文章不會被發佈出去，是 **因為 `hexo g` 並不會編譯 `./source/_drafts` 底下的檔案**。\n\n如果放在草稿目錄底下的文章完成後，想在本機先預覽檢查時，可以使用此指令\n\n> 此處「文後討論」有補充說明\n\n```bash\nhexo s --draft\n```\n\n確認文章沒問題後，我們就可以將草稿 publish，使用此指令\n\n> 這邊的 publish 是將檔案從 _drafts 移動到 _posts\n\n```bash\nhexo publish [FileName]  # 這邊是接 FileName，不包含副檔名 .md\n```\n\n接下來就跟放在 _posts 底下的文章發佈沒有兩樣，先進行移除舊的靜態檔與快取\n\n```bash\nhexo cl\n```\n\n然後進行編譯的動作\n\n```bash\nhexo g\n```\n\n最後再發佈\n\n```bash\nhexo d\n```\n\n## 文後討論\n\n看完上述，你可能會想，那能不能讓 `hexo s` 自動將 _drafts 底下的檔案自動預覽出來，而不要在指令後面又多加一個參數 `--draft`?\n\n答案是 可以的!\n\n只要去調整 `./_config.yml` 內的設定，將下面的參數值由 false 調整為 true 即可\n\n> 非 themes 底下的 _config.yml\n\n```yaml\nrender_drafts: true\n```\n\n調整之後，以後要預覽 _drafts 內的文章，就跟一般放在 _posts 底下的一樣，只要使用 `hexo s` 通通都可以在本機預覽得到。\n\n## 參考資料\n\n- https://www.dazhuanlan.com/2019/11/02/5dbc7ecc737a5/\n","slug":"hexo-new-draft","published":1,"updated":"2024-09-09T07:17:02.664Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5jb001mk0lzep013wtt","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>使用 Hexo 來當作技術部落格不僅簡單且快速，在剛開始架設完成後，可以使用指令 <code>hexo new [title]</code> 來建立文章並且撰寫，但是這樣的方式會延伸一個問題，如果這篇文章還處理撰寫的階段，但是我有修改其他已完成的文章需要發佈出去，但是不想把未完成的文章也一起發佈，此時就會有一些困擾，此篇會來說明如果使用 Hexo 的草稿功能。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"Hexo-草稿\"><a href=\"#Hexo-草稿\" class=\"headerlink\" title=\"Hexo 草稿\"></a>Hexo 草稿</h2><p>一般來說，我們建立文章都是使用此指令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo new [Title] [FileName]</span><br></pre></td></tr></table></figure>\n\n<p>如果今天要建立 Hexo 草稿，我們可以將上述指令改成</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo new draft [Title] [FileName]</span><br></pre></td></tr></table></figure>\n\n<p>那此時產生出來的草稿會放在 <code>./source/_drafts</code></p>\n<blockquote>\n<p>如果是使用 <code>hexo new [title]</code> 則會放在 <code>./source/_posts</code></p>\n</blockquote>\n<p>當我們要發佈一篇文章時，我們會使用 <code>hexo g</code> 和 <code>hexo d</code> 來編譯產生靜態檔與發佈文章，而草稿目錄內的文章不會被發佈出去，是 <strong>因為 <code>hexo g</code> 並不會編譯 <code>./source/_drafts</code> 底下的檔案</strong>。</p>\n<p>如果放在草稿目錄底下的文章完成後，想在本機先預覽檢查時，可以使用此指令</p>\n<blockquote>\n<p>此處「文後討論」有補充說明</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo s --draft</span><br></pre></td></tr></table></figure>\n\n<p>確認文章沒問題後，我們就可以將草稿 publish，使用此指令</p>\n<blockquote>\n<p>這邊的 publish 是將檔案從 _drafts 移動到 _posts</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo publish [FileName]  <span class=\"comment\"># 這邊是接 FileName，不包含副檔名 .md</span></span><br></pre></td></tr></table></figure>\n\n<p>接下來就跟放在 _posts 底下的文章發佈沒有兩樣，先進行移除舊的靜態檔與快取</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo cl</span><br></pre></td></tr></table></figure>\n\n<p>然後進行編譯的動作</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo g</span><br></pre></td></tr></table></figure>\n\n<p>最後再發佈</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo d</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>看完上述，你可能會想，那能不能讓 <code>hexo s</code> 自動將 _drafts 底下的檔案自動預覽出來，而不要在指令後面又多加一個參數 <code>--draft</code>?</p>\n<p>答案是 可以的!</p>\n<p>只要去調整 <code>./_config.yml</code> 內的設定，將下面的參數值由 false 調整為 true 即可</p>\n<blockquote>\n<p>非 themes 底下的 _config.yml</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">render_drafts:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<p>調整之後，以後要預覽 _drafts 內的文章，就跟一般放在 _posts 底下的一樣，只要使用 <code>hexo s</code> 通通都可以在本機預覽得到。</p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://www.dazhuanlan.com/2019/11/02/5dbc7ecc737a5/\">https://www.dazhuanlan.com/2019/11/02/5dbc7ecc737a5/</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>使用 Hexo 來當作技術部落格不僅簡單且快速，在剛開始架設完成後，可以使用指令 <code>hexo new [title]</code> 來建立文章並且撰寫，但是這樣的方式會延伸一個問題，如果這篇文章還處理撰寫的階段，但是我有修改其他已完成的文章需要發佈出去，但是不想把未完成的文章也一起發佈，此時就會有一些困擾，此篇會來說明如果使用 Hexo 的草稿功能。</p>","more":"<h2 id=\"Hexo-草稿\"><a href=\"#Hexo-草稿\" class=\"headerlink\" title=\"Hexo 草稿\"></a>Hexo 草稿</h2><p>一般來說，我們建立文章都是使用此指令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo new [Title] [FileName]</span><br></pre></td></tr></table></figure>\n\n<p>如果今天要建立 Hexo 草稿，我們可以將上述指令改成</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo new draft [Title] [FileName]</span><br></pre></td></tr></table></figure>\n\n<p>那此時產生出來的草稿會放在 <code>./source/_drafts</code></p>\n<blockquote>\n<p>如果是使用 <code>hexo new [title]</code> 則會放在 <code>./source/_posts</code></p>\n</blockquote>\n<p>當我們要發佈一篇文章時，我們會使用 <code>hexo g</code> 和 <code>hexo d</code> 來編譯產生靜態檔與發佈文章，而草稿目錄內的文章不會被發佈出去，是 <strong>因為 <code>hexo g</code> 並不會編譯 <code>./source/_drafts</code> 底下的檔案</strong>。</p>\n<p>如果放在草稿目錄底下的文章完成後，想在本機先預覽檢查時，可以使用此指令</p>\n<blockquote>\n<p>此處「文後討論」有補充說明</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo s --draft</span><br></pre></td></tr></table></figure>\n\n<p>確認文章沒問題後，我們就可以將草稿 publish，使用此指令</p>\n<blockquote>\n<p>這邊的 publish 是將檔案從 _drafts 移動到 _posts</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo publish [FileName]  <span class=\"comment\"># 這邊是接 FileName，不包含副檔名 .md</span></span><br></pre></td></tr></table></figure>\n\n<p>接下來就跟放在 _posts 底下的文章發佈沒有兩樣，先進行移除舊的靜態檔與快取</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo cl</span><br></pre></td></tr></table></figure>\n\n<p>然後進行編譯的動作</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo g</span><br></pre></td></tr></table></figure>\n\n<p>最後再發佈</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo d</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>看完上述，你可能會想，那能不能讓 <code>hexo s</code> 自動將 _drafts 底下的檔案自動預覽出來，而不要在指令後面又多加一個參數 <code>--draft</code>?</p>\n<p>答案是 可以的!</p>\n<p>只要去調整 <code>./_config.yml</code> 內的設定，將下面的參數值由 false 調整為 true 即可</p>\n<blockquote>\n<p>非 themes 底下的 _config.yml</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">render_drafts:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<p>調整之後，以後要預覽 _drafts 內的文章，就跟一般放在 _posts 底下的一樣，只要使用 <code>hexo s</code> 通通都可以在本機預覽得到。</p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://www.dazhuanlan.com/2019/11/02/5dbc7ecc737a5/\">https://www.dazhuanlan.com/2019/11/02/5dbc7ecc737a5/</a></li>\n</ul>"},{"title":"htpasswd的使用","abbrlink":"c66ce192","date":"2024-01-08T07:21:44.000Z","_content":"\n\n## 前言\n\n之前在測試 Traefik BasicAuth 功能時，需要使用 MD5/SHA1/Bcrypt 三種其中一種方式來加密密碼，並寫到設定檔裡\n\n常見的 Nginx/Apache 也有內建網頁的基本身份驗證，這時候也會需要使用 htpasswd 來將使用者的密碼加密並寫進設定檔\n\n下面會介紹如何使用 htpasswd 指令來產生加密密碼\n\n<!--more-->\n\n## htpasswd的使用\n\n其實使用的方式很簡單，只要將使用者的「帳號」與「密碼」丟給 htpasswd，他就會自動幫你加密指定密碼並且整理好格式輸出給你使用，詳細可以參考下面的實際範例\n\n使用 Bcrypt 加密密碼\n```\n# Format\nhtpasswd -nb -B [username] [password]\n\n# Example\nhtpasswd -nb -B tony 1234\n\n# Output\ntony:$2y$05$c1xVKSuI8mbPRNll.t.P0OjXC2RShcGww2PBslit0mk.wnatG1cIy\n```\n\n使用 MD5 加密密碼\n```\n# Format\nhtpasswd -nb -m [username] [password]\n\n# Example\nhtpasswd -nb -m tony 1234\n\n# Output\ntony:$apr1$eRtkDKOy$shi95jDEBupv6F5XcpXyL/\n```\n\n使用 SHA1 加密密碼\n```\n# Format\nhtpasswd -nb -s [username] [password]\n\n# Example\nhtpasswd -nb -s tony 1234\n\n# Output\ntony:{SHA}cRDtpNCeBiql5KOQsKVyrA0sAiA=\n```\n\n## 文後討論\n\n最詳細的使用說明，可以使用 `--help` 來檢視\n\n```\n$ htpasswd --help\n\nUsage:\n\thtpasswd [-cimBdpsDv] [-C cost] passwordfile username\n\thtpasswd -b[cmBdpsDv] [-C cost] passwordfile username password\n\n\thtpasswd -n[imBdps] [-C cost] username\n\thtpasswd -nb[mBdps] [-C cost] username password\n -c  Create a new file.\n -n  Don't update file; display results on stdout.\n -b  Use the password from the command line rather than prompting for it.\n -i  Read password from stdin without verification (for script usage).\n -m  Force MD5 encryption of the password (default).\n -B  Force bcrypt encryption of the password (very secure).\n -C  Set the computing time used for the bcrypt algorithm\n     (higher is more secure but slower, default: 5, valid: 4 to 31).\n -d  Force CRYPT encryption of the password (8 chars max, insecure).\n -s  Force SHA encryption of the password (insecure).\n -p  Do not encrypt the password (plaintext, insecure).\n -D  Delete the specified user.\n -v  Verify password for the specified user.\nOn other systems than Windows and NetWare the '-p' flag will probably not work.\nThe SHA algorithm does not use a salt and is less secure than the MD5 algorithm.\n```\n","source":"_posts/htpasswd.md","raw":"---\ntitle: htpasswd的使用\ntags:\n  - htpasswd\n  - MD5\n  - SHA1\n  - Bcrypt\n  - Linux\n  - Nginx\n  - Apache\ncategories:\n  - Linux\nabbrlink: c66ce192\ndate: 2024-01-08 15:21:44\n---\n\n\n## 前言\n\n之前在測試 Traefik BasicAuth 功能時，需要使用 MD5/SHA1/Bcrypt 三種其中一種方式來加密密碼，並寫到設定檔裡\n\n常見的 Nginx/Apache 也有內建網頁的基本身份驗證，這時候也會需要使用 htpasswd 來將使用者的密碼加密並寫進設定檔\n\n下面會介紹如何使用 htpasswd 指令來產生加密密碼\n\n<!--more-->\n\n## htpasswd的使用\n\n其實使用的方式很簡單，只要將使用者的「帳號」與「密碼」丟給 htpasswd，他就會自動幫你加密指定密碼並且整理好格式輸出給你使用，詳細可以參考下面的實際範例\n\n使用 Bcrypt 加密密碼\n```\n# Format\nhtpasswd -nb -B [username] [password]\n\n# Example\nhtpasswd -nb -B tony 1234\n\n# Output\ntony:$2y$05$c1xVKSuI8mbPRNll.t.P0OjXC2RShcGww2PBslit0mk.wnatG1cIy\n```\n\n使用 MD5 加密密碼\n```\n# Format\nhtpasswd -nb -m [username] [password]\n\n# Example\nhtpasswd -nb -m tony 1234\n\n# Output\ntony:$apr1$eRtkDKOy$shi95jDEBupv6F5XcpXyL/\n```\n\n使用 SHA1 加密密碼\n```\n# Format\nhtpasswd -nb -s [username] [password]\n\n# Example\nhtpasswd -nb -s tony 1234\n\n# Output\ntony:{SHA}cRDtpNCeBiql5KOQsKVyrA0sAiA=\n```\n\n## 文後討論\n\n最詳細的使用說明，可以使用 `--help` 來檢視\n\n```\n$ htpasswd --help\n\nUsage:\n\thtpasswd [-cimBdpsDv] [-C cost] passwordfile username\n\thtpasswd -b[cmBdpsDv] [-C cost] passwordfile username password\n\n\thtpasswd -n[imBdps] [-C cost] username\n\thtpasswd -nb[mBdps] [-C cost] username password\n -c  Create a new file.\n -n  Don't update file; display results on stdout.\n -b  Use the password from the command line rather than prompting for it.\n -i  Read password from stdin without verification (for script usage).\n -m  Force MD5 encryption of the password (default).\n -B  Force bcrypt encryption of the password (very secure).\n -C  Set the computing time used for the bcrypt algorithm\n     (higher is more secure but slower, default: 5, valid: 4 to 31).\n -d  Force CRYPT encryption of the password (8 chars max, insecure).\n -s  Force SHA encryption of the password (insecure).\n -p  Do not encrypt the password (plaintext, insecure).\n -D  Delete the specified user.\n -v  Verify password for the specified user.\nOn other systems than Windows and NetWare the '-p' flag will probably not work.\nThe SHA algorithm does not use a salt and is less secure than the MD5 algorithm.\n```\n","slug":"htpasswd","published":1,"updated":"2024-09-09T07:17:02.664Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5jb001pk0lzhqj0ajs0","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>之前在測試 Traefik BasicAuth 功能時，需要使用 MD5/SHA1/Bcrypt 三種其中一種方式來加密密碼，並寫到設定檔裡</p>\n<p>常見的 Nginx/Apache 也有內建網頁的基本身份驗證，這時候也會需要使用 htpasswd 來將使用者的密碼加密並寫進設定檔</p>\n<p>下面會介紹如何使用 htpasswd 指令來產生加密密碼</p>\n<span id=\"more\"></span>\n\n<h2 id=\"htpasswd的使用\"><a href=\"#htpasswd的使用\" class=\"headerlink\" title=\"htpasswd的使用\"></a>htpasswd的使用</h2><p>其實使用的方式很簡單，只要將使用者的「帳號」與「密碼」丟給 htpasswd，他就會自動幫你加密指定密碼並且整理好格式輸出給你使用，詳細可以參考下面的實際範例</p>\n<p>使用 Bcrypt 加密密碼</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Format</span><br><span class=\"line\">htpasswd -nb -B [username] [password]</span><br><span class=\"line\"></span><br><span class=\"line\"># Example</span><br><span class=\"line\">htpasswd -nb -B tony 1234</span><br><span class=\"line\"></span><br><span class=\"line\"># Output</span><br><span class=\"line\">tony:$2y$05$c1xVKSuI8mbPRNll.t.P0OjXC2RShcGww2PBslit0mk.wnatG1cIy</span><br></pre></td></tr></table></figure>\n\n<p>使用 MD5 加密密碼</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Format</span><br><span class=\"line\">htpasswd -nb -m [username] [password]</span><br><span class=\"line\"></span><br><span class=\"line\"># Example</span><br><span class=\"line\">htpasswd -nb -m tony 1234</span><br><span class=\"line\"></span><br><span class=\"line\"># Output</span><br><span class=\"line\">tony:$apr1$eRtkDKOy$shi95jDEBupv6F5XcpXyL&#x2F;</span><br></pre></td></tr></table></figure>\n\n<p>使用 SHA1 加密密碼</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Format</span><br><span class=\"line\">htpasswd -nb -s [username] [password]</span><br><span class=\"line\"></span><br><span class=\"line\"># Example</span><br><span class=\"line\">htpasswd -nb -s tony 1234</span><br><span class=\"line\"></span><br><span class=\"line\"># Output</span><br><span class=\"line\">tony:&#123;SHA&#125;cRDtpNCeBiql5KOQsKVyrA0sAiA&#x3D;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>最詳細的使用說明，可以使用 <code>--help</code> 來檢視</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ htpasswd --help</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:</span><br><span class=\"line\">\thtpasswd [-cimBdpsDv] [-C cost] passwordfile username</span><br><span class=\"line\">\thtpasswd -b[cmBdpsDv] [-C cost] passwordfile username password</span><br><span class=\"line\"></span><br><span class=\"line\">\thtpasswd -n[imBdps] [-C cost] username</span><br><span class=\"line\">\thtpasswd -nb[mBdps] [-C cost] username password</span><br><span class=\"line\"> -c  Create a new file.</span><br><span class=\"line\"> -n  Don&#39;t update file; display results on stdout.</span><br><span class=\"line\"> -b  Use the password from the command line rather than prompting for it.</span><br><span class=\"line\"> -i  Read password from stdin without verification (for script usage).</span><br><span class=\"line\"> -m  Force MD5 encryption of the password (default).</span><br><span class=\"line\"> -B  Force bcrypt encryption of the password (very secure).</span><br><span class=\"line\"> -C  Set the computing time used for the bcrypt algorithm</span><br><span class=\"line\">     (higher is more secure but slower, default: 5, valid: 4 to 31).</span><br><span class=\"line\"> -d  Force CRYPT encryption of the password (8 chars max, insecure).</span><br><span class=\"line\"> -s  Force SHA encryption of the password (insecure).</span><br><span class=\"line\"> -p  Do not encrypt the password (plaintext, insecure).</span><br><span class=\"line\"> -D  Delete the specified user.</span><br><span class=\"line\"> -v  Verify password for the specified user.</span><br><span class=\"line\">On other systems than Windows and NetWare the &#39;-p&#39; flag will probably not work.</span><br><span class=\"line\">The SHA algorithm does not use a salt and is less secure than the MD5 algorithm.</span><br></pre></td></tr></table></figure>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>之前在測試 Traefik BasicAuth 功能時，需要使用 MD5/SHA1/Bcrypt 三種其中一種方式來加密密碼，並寫到設定檔裡</p>\n<p>常見的 Nginx/Apache 也有內建網頁的基本身份驗證，這時候也會需要使用 htpasswd 來將使用者的密碼加密並寫進設定檔</p>\n<p>下面會介紹如何使用 htpasswd 指令來產生加密密碼</p>","more":"<h2 id=\"htpasswd的使用\"><a href=\"#htpasswd的使用\" class=\"headerlink\" title=\"htpasswd的使用\"></a>htpasswd的使用</h2><p>其實使用的方式很簡單，只要將使用者的「帳號」與「密碼」丟給 htpasswd，他就會自動幫你加密指定密碼並且整理好格式輸出給你使用，詳細可以參考下面的實際範例</p>\n<p>使用 Bcrypt 加密密碼</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Format</span><br><span class=\"line\">htpasswd -nb -B [username] [password]</span><br><span class=\"line\"></span><br><span class=\"line\"># Example</span><br><span class=\"line\">htpasswd -nb -B tony 1234</span><br><span class=\"line\"></span><br><span class=\"line\"># Output</span><br><span class=\"line\">tony:$2y$05$c1xVKSuI8mbPRNll.t.P0OjXC2RShcGww2PBslit0mk.wnatG1cIy</span><br></pre></td></tr></table></figure>\n\n<p>使用 MD5 加密密碼</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Format</span><br><span class=\"line\">htpasswd -nb -m [username] [password]</span><br><span class=\"line\"></span><br><span class=\"line\"># Example</span><br><span class=\"line\">htpasswd -nb -m tony 1234</span><br><span class=\"line\"></span><br><span class=\"line\"># Output</span><br><span class=\"line\">tony:$apr1$eRtkDKOy$shi95jDEBupv6F5XcpXyL&#x2F;</span><br></pre></td></tr></table></figure>\n\n<p>使用 SHA1 加密密碼</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Format</span><br><span class=\"line\">htpasswd -nb -s [username] [password]</span><br><span class=\"line\"></span><br><span class=\"line\"># Example</span><br><span class=\"line\">htpasswd -nb -s tony 1234</span><br><span class=\"line\"></span><br><span class=\"line\"># Output</span><br><span class=\"line\">tony:&#123;SHA&#125;cRDtpNCeBiql5KOQsKVyrA0sAiA&#x3D;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>最詳細的使用說明，可以使用 <code>--help</code> 來檢視</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ htpasswd --help</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:</span><br><span class=\"line\">\thtpasswd [-cimBdpsDv] [-C cost] passwordfile username</span><br><span class=\"line\">\thtpasswd -b[cmBdpsDv] [-C cost] passwordfile username password</span><br><span class=\"line\"></span><br><span class=\"line\">\thtpasswd -n[imBdps] [-C cost] username</span><br><span class=\"line\">\thtpasswd -nb[mBdps] [-C cost] username password</span><br><span class=\"line\"> -c  Create a new file.</span><br><span class=\"line\"> -n  Don&#39;t update file; display results on stdout.</span><br><span class=\"line\"> -b  Use the password from the command line rather than prompting for it.</span><br><span class=\"line\"> -i  Read password from stdin without verification (for script usage).</span><br><span class=\"line\"> -m  Force MD5 encryption of the password (default).</span><br><span class=\"line\"> -B  Force bcrypt encryption of the password (very secure).</span><br><span class=\"line\"> -C  Set the computing time used for the bcrypt algorithm</span><br><span class=\"line\">     (higher is more secure but slower, default: 5, valid: 4 to 31).</span><br><span class=\"line\"> -d  Force CRYPT encryption of the password (8 chars max, insecure).</span><br><span class=\"line\"> -s  Force SHA encryption of the password (insecure).</span><br><span class=\"line\"> -p  Do not encrypt the password (plaintext, insecure).</span><br><span class=\"line\"> -D  Delete the specified user.</span><br><span class=\"line\"> -v  Verify password for the specified user.</span><br><span class=\"line\">On other systems than Windows and NetWare the &#39;-p&#39; flag will probably not work.</span><br><span class=\"line\">The SHA algorithm does not use a salt and is less secure than the MD5 algorithm.</span><br></pre></td></tr></table></figure>"},{"title":"Hexo的標籤功能","abbrlink":"1436c3e2","date":"2021-07-21T03:32:57.000Z","_content":"\n## 前言\n\nHexo 網站中的文章可以使用標籤(tags)，標籤有點像是關鍵字的作用，可以替每篇不同的文章給予不同的標籤，這可以讓讀者針對標籤來快速篩選文章\n\n<!--more-->\n\n## 標籤的使用\n\n啟用標籤功能，讓標籤連結出現在網站上，首先調整 `./themes/next/_config.yml` 中的下述設定，將 `tags: /tags/ || fa fa-tags` 註解「取消」，這樣就可以讓網站出現標籤的連結\n\n```\nmenu:\n  home: / || fa fa-home\n  about: /about/ || fa fa-user\n  tags: /tags/ || fa fa-tags\n  categories: /categories/ || fa fa-th\n  archives: /archives/ || fa fa-archive\n  #schedule: /schedule/ || fa fa-calendar\n  #sitemap: /sitemap.xml || fa fa-sitemap\n  #commonweal: /404/ || fa fa-heartbeat\n```\n\n只有連結並沒有用處，點擊標籤連結時，要能夠顯示相關頁面，所以使用下述指令，讓 Hexo 幫你產生連結檔\n\n```bash\nhexo new page tags\n```\n\nHexo 會在 `./source` 底下產生 tags 目錄，目錄內會有一個 index.md 檔案\n\ntags 頁面建立後，還需將 index.md 檔案打開，並且加入 type 參數，如下\n\n```\n---\ntitle: tags\ndate: 2021-04-20 15:37:19\ntype: \"tags\"\n---\n```\n\n這樣基本上標籤功能就已經完成設定\n\n在使用時，只要在文章建立後加上 tags，並把要標籤的值加上去即可，如下\n\n```\n---\ntitle: 標籤測試\ntags:\n  - TEST\n  - TAG\ndate: 2021-05-22 16:17:39\n---\n```\n\n## 後記\n\n該篇與 Hexo的分類/關於功能 設定方式極度雷同，如有需要可以搭配一起設定，另外兩篇請參考下面連結\n\n- [Hexo的分類功能](https://blog.tonyjhang.dev/posts/8bfb5405)\n- [Hexo的關於功能](https://blog.tonyjhang.dev/posts/8be085a8)\n","source":"_posts/hexo-tag.md","raw":"---\ntitle: Hexo的標籤功能\ntags:\n  - Hexo\n  - blog\ncategories:\n  - Hexo\nabbrlink: 1436c3e2\ndate: 2021-07-21 11:32:57\n---\n\n## 前言\n\nHexo 網站中的文章可以使用標籤(tags)，標籤有點像是關鍵字的作用，可以替每篇不同的文章給予不同的標籤，這可以讓讀者針對標籤來快速篩選文章\n\n<!--more-->\n\n## 標籤的使用\n\n啟用標籤功能，讓標籤連結出現在網站上，首先調整 `./themes/next/_config.yml` 中的下述設定，將 `tags: /tags/ || fa fa-tags` 註解「取消」，這樣就可以讓網站出現標籤的連結\n\n```\nmenu:\n  home: / || fa fa-home\n  about: /about/ || fa fa-user\n  tags: /tags/ || fa fa-tags\n  categories: /categories/ || fa fa-th\n  archives: /archives/ || fa fa-archive\n  #schedule: /schedule/ || fa fa-calendar\n  #sitemap: /sitemap.xml || fa fa-sitemap\n  #commonweal: /404/ || fa fa-heartbeat\n```\n\n只有連結並沒有用處，點擊標籤連結時，要能夠顯示相關頁面，所以使用下述指令，讓 Hexo 幫你產生連結檔\n\n```bash\nhexo new page tags\n```\n\nHexo 會在 `./source` 底下產生 tags 目錄，目錄內會有一個 index.md 檔案\n\ntags 頁面建立後，還需將 index.md 檔案打開，並且加入 type 參數，如下\n\n```\n---\ntitle: tags\ndate: 2021-04-20 15:37:19\ntype: \"tags\"\n---\n```\n\n這樣基本上標籤功能就已經完成設定\n\n在使用時，只要在文章建立後加上 tags，並把要標籤的值加上去即可，如下\n\n```\n---\ntitle: 標籤測試\ntags:\n  - TEST\n  - TAG\ndate: 2021-05-22 16:17:39\n---\n```\n\n## 後記\n\n該篇與 Hexo的分類/關於功能 設定方式極度雷同，如有需要可以搭配一起設定，另外兩篇請參考下面連結\n\n- [Hexo的分類功能](https://blog.tonyjhang.dev/posts/8bfb5405)\n- [Hexo的關於功能](https://blog.tonyjhang.dev/posts/8be085a8)\n","slug":"hexo-tag","published":1,"updated":"2024-09-09T07:17:02.664Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5jc001tk0lz22gt1832","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Hexo 網站中的文章可以使用標籤(tags)，標籤有點像是關鍵字的作用，可以替每篇不同的文章給予不同的標籤，這可以讓讀者針對標籤來快速篩選文章</p>\n<span id=\"more\"></span>\n\n<h2 id=\"標籤的使用\"><a href=\"#標籤的使用\" class=\"headerlink\" title=\"標籤的使用\"></a>標籤的使用</h2><p>啟用標籤功能，讓標籤連結出現在網站上，首先調整 <code>./themes/next/_config.yml</code> 中的下述設定，將 <code>tags: /tags/ || fa fa-tags</code> 註解「取消」，這樣就可以讓網站出現標籤的連結</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">menu:</span><br><span class=\"line\">  home: &#x2F; || fa fa-home</span><br><span class=\"line\">  about: &#x2F;about&#x2F; || fa fa-user</span><br><span class=\"line\">  tags: &#x2F;tags&#x2F; || fa fa-tags</span><br><span class=\"line\">  categories: &#x2F;categories&#x2F; || fa fa-th</span><br><span class=\"line\">  archives: &#x2F;archives&#x2F; || fa fa-archive</span><br><span class=\"line\">  #schedule: &#x2F;schedule&#x2F; || fa fa-calendar</span><br><span class=\"line\">  #sitemap: &#x2F;sitemap.xml || fa fa-sitemap</span><br><span class=\"line\">  #commonweal: &#x2F;404&#x2F; || fa fa-heartbeat</span><br></pre></td></tr></table></figure>\n\n<p>只有連結並沒有用處，點擊標籤連結時，要能夠顯示相關頁面，所以使用下述指令，讓 Hexo 幫你產生連結檔</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo new page tags</span><br></pre></td></tr></table></figure>\n\n<p>Hexo 會在 <code>./source</code> 底下產生 tags 目錄，目錄內會有一個 index.md 檔案</p>\n<p>tags 頁面建立後，還需將 index.md 檔案打開，並且加入 type 參數，如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: tags</span><br><span class=\"line\">date: 2021-04-20 15:37:19</span><br><span class=\"line\">type: &quot;tags&quot;</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n\n<p>這樣基本上標籤功能就已經完成設定</p>\n<p>在使用時，只要在文章建立後加上 tags，並把要標籤的值加上去即可，如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: 標籤測試</span><br><span class=\"line\">tags:</span><br><span class=\"line\">  - TEST</span><br><span class=\"line\">  - TAG</span><br><span class=\"line\">date: 2021-05-22 16:17:39</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"後記\"><a href=\"#後記\" class=\"headerlink\" title=\"後記\"></a>後記</h2><p>該篇與 Hexo的分類/關於功能 設定方式極度雷同，如有需要可以搭配一起設定，另外兩篇請參考下面連結</p>\n<ul>\n<li><a href=\"https://blog.tonyjhang.dev/posts/8bfb5405\">Hexo的分類功能</a></li>\n<li><a href=\"https://blog.tonyjhang.dev/posts/8be085a8\">Hexo的關於功能</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Hexo 網站中的文章可以使用標籤(tags)，標籤有點像是關鍵字的作用，可以替每篇不同的文章給予不同的標籤，這可以讓讀者針對標籤來快速篩選文章</p>","more":"<h2 id=\"標籤的使用\"><a href=\"#標籤的使用\" class=\"headerlink\" title=\"標籤的使用\"></a>標籤的使用</h2><p>啟用標籤功能，讓標籤連結出現在網站上，首先調整 <code>./themes/next/_config.yml</code> 中的下述設定，將 <code>tags: /tags/ || fa fa-tags</code> 註解「取消」，這樣就可以讓網站出現標籤的連結</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">menu:</span><br><span class=\"line\">  home: &#x2F; || fa fa-home</span><br><span class=\"line\">  about: &#x2F;about&#x2F; || fa fa-user</span><br><span class=\"line\">  tags: &#x2F;tags&#x2F; || fa fa-tags</span><br><span class=\"line\">  categories: &#x2F;categories&#x2F; || fa fa-th</span><br><span class=\"line\">  archives: &#x2F;archives&#x2F; || fa fa-archive</span><br><span class=\"line\">  #schedule: &#x2F;schedule&#x2F; || fa fa-calendar</span><br><span class=\"line\">  #sitemap: &#x2F;sitemap.xml || fa fa-sitemap</span><br><span class=\"line\">  #commonweal: &#x2F;404&#x2F; || fa fa-heartbeat</span><br></pre></td></tr></table></figure>\n\n<p>只有連結並沒有用處，點擊標籤連結時，要能夠顯示相關頁面，所以使用下述指令，讓 Hexo 幫你產生連結檔</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo new page tags</span><br></pre></td></tr></table></figure>\n\n<p>Hexo 會在 <code>./source</code> 底下產生 tags 目錄，目錄內會有一個 index.md 檔案</p>\n<p>tags 頁面建立後，還需將 index.md 檔案打開，並且加入 type 參數，如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: tags</span><br><span class=\"line\">date: 2021-04-20 15:37:19</span><br><span class=\"line\">type: &quot;tags&quot;</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n\n<p>這樣基本上標籤功能就已經完成設定</p>\n<p>在使用時，只要在文章建立後加上 tags，並把要標籤的值加上去即可，如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: 標籤測試</span><br><span class=\"line\">tags:</span><br><span class=\"line\">  - TEST</span><br><span class=\"line\">  - TAG</span><br><span class=\"line\">date: 2021-05-22 16:17:39</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"後記\"><a href=\"#後記\" class=\"headerlink\" title=\"後記\"></a>後記</h2><p>該篇與 Hexo的分類/關於功能 設定方式極度雷同，如有需要可以搭配一起設定，另外兩篇請參考下面連結</p>\n<ul>\n<li><a href=\"https://blog.tonyjhang.dev/posts/8bfb5405\">Hexo的分類功能</a></li>\n<li><a href=\"https://blog.tonyjhang.dev/posts/8be085a8\">Hexo的關於功能</a></li>\n</ul>"},{"title":"如何修改PHP-FPM上傳檔案大小限制","abbrlink":"452fc7c7","date":"2021-05-22T08:17:39.000Z","_content":"\n## 前言\n\n網頁上傳檔案屬於後端運作，如果檔案太大可能會造成上傳失敗，如果是採 Nginx + PHP-FPM 的架構，此時需要修改後端(PHP-FPM) `php.ini` 的相關參數設定。\n\n可以分為兩個面向：\n\n- 檔案上傳大小限制\n- 腳本執行時間或網路連線時間的長短限制\n\n<!--more-->\n\n相關參數如下：\n\n> 此處的數值為預設值\n\n```text\n# 檔案上傳大小限制相關參數\nupload_max_filesize = 2M\npost_max_size = 8M\nmemory_limit = 128M\n\n# 腳本執行時間或網路連線時間的限制\nmax_execution_time = 60\nmax_input_time = 60\ndefault_socket_timeout = 60\n```\n\n## 解決方式\n\n依照自身需求，調整 `php.ini` 的相關參數設定\n\n```text\n# 上傳單一檔案大小\nupload_max_filesize = 100M\n\n# 使用表單 POST 給 PHP 的大小上限(所有檔案大小加總)\npost_max_size = 8M\n\n# 單一 PHP 腳本使用記憶體的上限\nmemory_limit = 128M\n```\n\n這邊需要注意的是，上述參數之間的值有大小原則需要注意\n\n```text\nmemory_limit > post_max_size > upload_max_filesize\n```\n\n到此就可以讓上傳檔案的大小再往上提升，不過接下來你可能會遇到檔案傳送到一半會斷線的情況，這代表傳送的檔案較大需要較多的時間，此時就需要再調整有關腳本執行的時間與網路連線的相關設定。\n\n---\n\n有關 PHP 腳本執行的時間與網路連線時間長短的相關參數：\n\n> 此處的數值為預設值\n\n```text\n# PHP 腳本執行的時間上限(秒)，可避免無窮迴圈\nmax_execution_time = 30\n\n# 每個 PHP 腳本接收資料的時間上限(秒)，如果網路較慢，時間可能需要拉長\nmax_input_time = 60\n\n# Socket 無回應斷線時間上限\ndefault_socket_timeout = 60\n```\n\n> `max_input_time` 數值若為 -1 表示無限制時間\n\n此處可以依照自身的 PHP 腳本與網路環境來調整到符合自身的需求\n\n## 參考資料\n\n- https://blog.gtwang.org/web-development/php-ini-large-file-upload-configuration/\n","source":"_posts/php-fpm-upload-size.md","raw":"---\ntitle: 如何修改PHP-FPM上傳檔案大小限制\ntags:\n  - PHP-FPM\n  - PHP\ncategories:\n  - PHP-FPM\nabbrlink: 452fc7c7\ndate: 2021-05-22 16:17:39\n---\n\n## 前言\n\n網頁上傳檔案屬於後端運作，如果檔案太大可能會造成上傳失敗，如果是採 Nginx + PHP-FPM 的架構，此時需要修改後端(PHP-FPM) `php.ini` 的相關參數設定。\n\n可以分為兩個面向：\n\n- 檔案上傳大小限制\n- 腳本執行時間或網路連線時間的長短限制\n\n<!--more-->\n\n相關參數如下：\n\n> 此處的數值為預設值\n\n```text\n# 檔案上傳大小限制相關參數\nupload_max_filesize = 2M\npost_max_size = 8M\nmemory_limit = 128M\n\n# 腳本執行時間或網路連線時間的限制\nmax_execution_time = 60\nmax_input_time = 60\ndefault_socket_timeout = 60\n```\n\n## 解決方式\n\n依照自身需求，調整 `php.ini` 的相關參數設定\n\n```text\n# 上傳單一檔案大小\nupload_max_filesize = 100M\n\n# 使用表單 POST 給 PHP 的大小上限(所有檔案大小加總)\npost_max_size = 8M\n\n# 單一 PHP 腳本使用記憶體的上限\nmemory_limit = 128M\n```\n\n這邊需要注意的是，上述參數之間的值有大小原則需要注意\n\n```text\nmemory_limit > post_max_size > upload_max_filesize\n```\n\n到此就可以讓上傳檔案的大小再往上提升，不過接下來你可能會遇到檔案傳送到一半會斷線的情況，這代表傳送的檔案較大需要較多的時間，此時就需要再調整有關腳本執行的時間與網路連線的相關設定。\n\n---\n\n有關 PHP 腳本執行的時間與網路連線時間長短的相關參數：\n\n> 此處的數值為預設值\n\n```text\n# PHP 腳本執行的時間上限(秒)，可避免無窮迴圈\nmax_execution_time = 30\n\n# 每個 PHP 腳本接收資料的時間上限(秒)，如果網路較慢，時間可能需要拉長\nmax_input_time = 60\n\n# Socket 無回應斷線時間上限\ndefault_socket_timeout = 60\n```\n\n> `max_input_time` 數值若為 -1 表示無限制時間\n\n此處可以依照自身的 PHP 腳本與網路環境來調整到符合自身的需求\n\n## 參考資料\n\n- https://blog.gtwang.org/web-development/php-ini-large-file-upload-configuration/\n","slug":"php-fpm-upload-size","published":1,"updated":"2024-09-09T07:17:02.665Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5jd001wk0lz6hc251xq","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>網頁上傳檔案屬於後端運作，如果檔案太大可能會造成上傳失敗，如果是採 Nginx + PHP-FPM 的架構，此時需要修改後端(PHP-FPM) <code>php.ini</code> 的相關參數設定。</p>\n<p>可以分為兩個面向：</p>\n<ul>\n<li>檔案上傳大小限制</li>\n<li>腳本執行時間或網路連線時間的長短限制</li>\n</ul>\n<span id=\"more\"></span>\n\n<p>相關參數如下：</p>\n<blockquote>\n<p>此處的數值為預設值</p>\n</blockquote>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 檔案上傳大小限制相關參數</span><br><span class=\"line\">upload_max_filesize = 2M</span><br><span class=\"line\">post_max_size = 8M</span><br><span class=\"line\">memory_limit = 128M</span><br><span class=\"line\"></span><br><span class=\"line\"># 腳本執行時間或網路連線時間的限制</span><br><span class=\"line\">max_execution_time = 60</span><br><span class=\"line\">max_input_time = 60</span><br><span class=\"line\">default_socket_timeout = 60</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解決方式\"><a href=\"#解決方式\" class=\"headerlink\" title=\"解決方式\"></a>解決方式</h2><p>依照自身需求，調整 <code>php.ini</code> 的相關參數設定</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 上傳單一檔案大小</span><br><span class=\"line\">upload_max_filesize = 100M</span><br><span class=\"line\"></span><br><span class=\"line\"># 使用表單 POST 給 PHP 的大小上限(所有檔案大小加總)</span><br><span class=\"line\">post_max_size = 8M</span><br><span class=\"line\"></span><br><span class=\"line\"># 單一 PHP 腳本使用記憶體的上限</span><br><span class=\"line\">memory_limit = 128M</span><br></pre></td></tr></table></figure>\n\n<p>這邊需要注意的是，上述參數之間的值有大小原則需要注意</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">memory_limit &gt; post_max_size &gt; upload_max_filesize</span><br></pre></td></tr></table></figure>\n\n<p>到此就可以讓上傳檔案的大小再往上提升，不過接下來你可能會遇到檔案傳送到一半會斷線的情況，這代表傳送的檔案較大需要較多的時間，此時就需要再調整有關腳本執行的時間與網路連線的相關設定。</p>\n<hr>\n<p>有關 PHP 腳本執行的時間與網路連線時間長短的相關參數：</p>\n<blockquote>\n<p>此處的數值為預設值</p>\n</blockquote>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># PHP 腳本執行的時間上限(秒)，可避免無窮迴圈</span><br><span class=\"line\">max_execution_time = 30</span><br><span class=\"line\"></span><br><span class=\"line\"># 每個 PHP 腳本接收資料的時間上限(秒)，如果網路較慢，時間可能需要拉長</span><br><span class=\"line\">max_input_time = 60</span><br><span class=\"line\"></span><br><span class=\"line\"># Socket 無回應斷線時間上限</span><br><span class=\"line\">default_socket_timeout = 60</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p><code>max_input_time</code> 數值若為 -1 表示無限制時間</p>\n</blockquote>\n<p>此處可以依照自身的 PHP 腳本與網路環境來調整到符合自身的需求</p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://blog.gtwang.org/web-development/php-ini-large-file-upload-configuration/\">https://blog.gtwang.org/web-development/php-ini-large-file-upload-configuration/</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>網頁上傳檔案屬於後端運作，如果檔案太大可能會造成上傳失敗，如果是採 Nginx + PHP-FPM 的架構，此時需要修改後端(PHP-FPM) <code>php.ini</code> 的相關參數設定。</p>\n<p>可以分為兩個面向：</p>\n<ul>\n<li>檔案上傳大小限制</li>\n<li>腳本執行時間或網路連線時間的長短限制</li>\n</ul>","more":"<p>相關參數如下：</p>\n<blockquote>\n<p>此處的數值為預設值</p>\n</blockquote>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 檔案上傳大小限制相關參數</span><br><span class=\"line\">upload_max_filesize = 2M</span><br><span class=\"line\">post_max_size = 8M</span><br><span class=\"line\">memory_limit = 128M</span><br><span class=\"line\"></span><br><span class=\"line\"># 腳本執行時間或網路連線時間的限制</span><br><span class=\"line\">max_execution_time = 60</span><br><span class=\"line\">max_input_time = 60</span><br><span class=\"line\">default_socket_timeout = 60</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"解決方式\"><a href=\"#解決方式\" class=\"headerlink\" title=\"解決方式\"></a>解決方式</h2><p>依照自身需求，調整 <code>php.ini</code> 的相關參數設定</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 上傳單一檔案大小</span><br><span class=\"line\">upload_max_filesize = 100M</span><br><span class=\"line\"></span><br><span class=\"line\"># 使用表單 POST 給 PHP 的大小上限(所有檔案大小加總)</span><br><span class=\"line\">post_max_size = 8M</span><br><span class=\"line\"></span><br><span class=\"line\"># 單一 PHP 腳本使用記憶體的上限</span><br><span class=\"line\">memory_limit = 128M</span><br></pre></td></tr></table></figure>\n\n<p>這邊需要注意的是，上述參數之間的值有大小原則需要注意</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">memory_limit &gt; post_max_size &gt; upload_max_filesize</span><br></pre></td></tr></table></figure>\n\n<p>到此就可以讓上傳檔案的大小再往上提升，不過接下來你可能會遇到檔案傳送到一半會斷線的情況，這代表傳送的檔案較大需要較多的時間，此時就需要再調整有關腳本執行的時間與網路連線的相關設定。</p>\n<hr>\n<p>有關 PHP 腳本執行的時間與網路連線時間長短的相關參數：</p>\n<blockquote>\n<p>此處的數值為預設值</p>\n</blockquote>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># PHP 腳本執行的時間上限(秒)，可避免無窮迴圈</span><br><span class=\"line\">max_execution_time = 30</span><br><span class=\"line\"></span><br><span class=\"line\"># 每個 PHP 腳本接收資料的時間上限(秒)，如果網路較慢，時間可能需要拉長</span><br><span class=\"line\">max_input_time = 60</span><br><span class=\"line\"></span><br><span class=\"line\"># Socket 無回應斷線時間上限</span><br><span class=\"line\">default_socket_timeout = 60</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p><code>max_input_time</code> 數值若為 -1 表示無限制時間</p>\n</blockquote>\n<p>此處可以依照自身的 PHP 腳本與網路環境來調整到符合自身的需求</p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://blog.gtwang.org/web-development/php-ini-large-file-upload-configuration/\">https://blog.gtwang.org/web-development/php-ini-large-file-upload-configuration/</a></li>\n</ul>"},{"title":"Kubernetes Network Policy","abbrlink":"e08900fb","date":"2024-01-16T05:51:16.000Z","_content":"\n\n## 前言\n\n在 K8s 中，預設所有 Pod 不管是在哪個 Namespace，預設都是相通，若是想要進一步限制 Pod 之間的存取，可以使用 Network Policy 來達成。\n\n在 Google Kubernetes Engine 的環境中，可以自行啟用「Calico Kubernetes Network 政策」，即可輕鬆簡單的直接使用。\n\n<!--more-->\n\n## Network Policy 描述檔\n\n基本範例\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: demo-network-policy\n  namespace: default\nspec:\n  podSelector:\n    matchLabels:\n      app: nginx-vts\n  policyTypes:\n  - Ingress\n  - Egress\n  ingress:\n  - from:\n    - podSelector:\n        matchLabels:\n          repo: sugar\n    - namespaceSelector:\n        matchLabels:\n          department: rd\n    - ipBlock:\n        cidr: 172.17.0.0/16\n        except:\n        - 172.17.1.0/24\n    ports:\n    - protocol: TCP\n      port: 9453\n  egress:\n  - to:\n    - ipBlock:\n        cidr: 10.0.0.0/24\n    ports:\n    - protocol: TCP\n      port: 9527\n```\n\n### 分段解析\n\n#### Part 1\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: demo-network-policy\n  namespace: default\nspec:\n  podSelector:\n    matchLabels:\n      app: nginx-vts\n  policyTypes:\n  - Ingress\n  - Egress\n...\n```\n\n在 `default` Namespace 中只要帶有 Label 為 `app=nginx-vts` 的 pod，接會被套上 Network Policy，並且進(ingress) 出(egress)流量皆會被限制。\n\n> 如果沒有設定 `spec.podSelector`，代表會套用到 `default` Namespace 中的所有 pod\n\n至於進(ingress) 出(egress)流量的限制細節，需要再往後設定\n\n#### Part 2\n\nIngress 流量的詳細設定\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: demo-network-policy\n  namespace: default\nspec:\n  podSelector:\n    matchLabels:\n      app: nginx-vts\n  policyTypes:\n  - Ingress\n  - Egress\n  ingress:\n  - from:\n    - podSelector:\n        matchLabels:\n          repo: sugar\n    - namespaceSelector:\n        matchLabels:\n          department: rd\n    # IP 範圍，而非 IP 封鎖\n    - ipBlock:\n        cidr: 172.17.0.0/16\n        except:\n        - 172.17.1.0/24\n    ports:\n    - protocol: TCP\n      port: 9453\n...\n```\n\nIngress from：管理從外部進來的流量，也就「允許」進來 Pod 的流量\n\n允許存取的來源白名單：\n\n- 允許 `default` Namespace 中帶有 `repo=sugar` Label 的 Pod\n- 允許帶有 `department=rd` Label 的 Namespace 中所有 Pod\n- 來源 IP 範圍 172.17.0.0/16 (不含 172.17.1.0/24)\n\n綜合 Part 1 的解析，會變成如下：\n\n- 允許 `default` Namespace 中帶有 `repo=sugar` Label 的 Pod，存取 `default` Namespace 中帶有 `app=nginx-vts` 標籤 Pod 的 9453 Port\n- 允許帶有 `department=rd` Label 的 Namespace 中所有 Pod，存取 `default` Namespace 中帶有 `app=nginx-vts` 標籤 Pod 的 9453 Port\n- 允許來源 IP 為 172.17.0.0/16(但排除 172.17.1.0/24)，存取 `default` Namespace 中帶有 `app=nginx-vts` 標籤 Pod 的 9453 Port\n\n#### Part 3\n\nEgress 流量的詳細設定\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: demo-network-policy\n  namespace: default\nspec:\n  podSelector:\n    matchLabels:\n      app: nginx-vts\n  policyTypes:\n  - Ingress\n  - Egress\n...\n  egress:\n  - to:\n    # IP 範圍，而非 IP 封鎖\n    - ipBlock:\n        cidr: 10.0.0.0/24\n    ports:\n    - protocol: TCP\n      port: 9527\n```\n\nEgress to：管理從內部出去的流量，也就是「允許」從 Pod 的出去到達的目的流量\n\n「允許」從 Pod 的出去到達的目的流量白名單：\n\n- 只允許對外連線(egress) 到 IP 範圍 10.0.0.0/24 的 通訊協定 TCP 且目的 Port 為 9527。\n\n綜合 Part 1 的解析，會變成如下：\n\n「在 `default` 的命名空間中只要帶有 Label 為 `app=nginx-vts` 的 pod，只允許對外連線(egress) 到 IP 範圍 10.0.0.0/24 的 通訊協定 TCP 且目的 Port 為 9527」\n\n#### 結論\n\n從上述的解析中可以推論，不管是 Ingress 或是 Egress，對於設定上皆有三種白名單的細部控制：`podSelector`、`namespaceSelector`、`ipBlock`\n\n## 預設政策(default policy)\n\n基本概念(重要)：\n\n- 若要選擇所有的 pod，則將 `podSelector` 設定為 `{}`\n- 若是設定 `policyType`，就表示要全部拒絕該種連線(ingress/egress) 的流量\n- 若要打開上面的限制(也就是白名單)，則要在 `spec.ingress` 或 `spec.egress` 中設定\n\n綜合上述，可以推理出四種情況：\n\n- 拒絕從外面進來的流量，要在 `spec.policyTypes` 中包含 Ingress，並且略過 ingress 細部設定\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: deny-all-ingress\n  namespace: default\nspec:\n  podSelector: {}\n  policyTypes:\n  - Ingress\n```\n\n- 拒絕從內部出去的流量，要在 `spec.policyTypes` 中包含 Egress，並且略過 egress 細部設定\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: deny-all-egress\n  namespace: default\nspec:\n  podSelector: {}\n  policyTypes:\n  - Egress\n```\n\n- 接受從外面進來的網路流量，要在 `spec.policyTypes` 中包含 Ingress，並將 `spec.ingress` 設定為 `{}`\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-all-ingress\n  namespace: default\nspec:\n  podSelector: {}\n  policyTypes:\n  - Ingress\n  ingress:\n  - {}\n```\n\n- 接受從內部出去的網路流向，要在 `spec.policyTypes` 中包含 Egress，並將 `spec.egress` 設定為 `{}`\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-all-egress\n  namespace: default\nspec:\n  podSelector: {}\n  policyTypes:\n  - Egress\n  egress:\n  - {}\n```\n\n在理解完上述情況後後，記得帶上 Namespace 的概念進去，這樣才知道該條政策的作用範圍：\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-all-egress\n  namespace: default\nspec:\n  podSelector: {}\n...\n```\n\n在 `default` Namespace 中所有的 pod(`podSelector: {}`)，皆會被套上 Network Policy，並且進(ingress) 出(egress)流量皆會被限制。\n\n## 更多的使用場景\n\n下述參考資料中，有更多的使用場景可以參照：\n\nhttps://kubernetes.feisky.xyz/concepts/objects/network-policy#shi-yong-chang-jing\n\n### 只允許同一個 Namespace 間的 Pod 相互訪問\n\n只允許 `monitoring` Namespace 間的 Pod 可以相互訪問，其他 Namespace 的 Pod 無法訪問 `monitoring` Namespace 的 Pod\n\n```yaml\nkind: NetworkPolicy\napiVersion: networking.k8s.io/v1\nmetadata:\n  namespace: monitoring\n  name: deny-other-namespaces\nspec:\n  podSelector: {}\n  policyTypes:\n  - Ingress\n  ingress:\n  - from:\n    - podSelector: {}\n```\n\n### 禁止同一個 Namespace 間的 Pod 相互訪問，但是跨 Namespace 不在此限\n\n禁止 `default` Namespace 間的 Pod 相互訪問，但 `default` Namespace 可以訪問其他 Namespace 的 Pod，其他 Namespace 的 Pod 也可以訪問 `default` Namespace 的 Pod \n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: default-deny\n  namespace: default\nspec:\n  podSelector: {}\n  policyTypes:\n  - Ingress\n```\n\n## 參考資料\n\n- https://godleon.github.io/blog/Kubernetes/k8s-Network-Policy-Overview/\n- https://kubernetes.feisky.xyz/concepts/objects/network-policy#shi-yong-chang-jing\n","source":"_posts/kubernetes-network-policy.md","raw":"---\ntitle: Kubernetes Network Policy\ntags:\n  - GCP\n  - GKE\n  - Google Cloud Platform\n  - K8s\n  - Kubernetes\ncategories:\n  - GKE\nabbrlink: e08900fb\ndate: 2024-01-16 13:51:16\n---\n\n\n## 前言\n\n在 K8s 中，預設所有 Pod 不管是在哪個 Namespace，預設都是相通，若是想要進一步限制 Pod 之間的存取，可以使用 Network Policy 來達成。\n\n在 Google Kubernetes Engine 的環境中，可以自行啟用「Calico Kubernetes Network 政策」，即可輕鬆簡單的直接使用。\n\n<!--more-->\n\n## Network Policy 描述檔\n\n基本範例\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: demo-network-policy\n  namespace: default\nspec:\n  podSelector:\n    matchLabels:\n      app: nginx-vts\n  policyTypes:\n  - Ingress\n  - Egress\n  ingress:\n  - from:\n    - podSelector:\n        matchLabels:\n          repo: sugar\n    - namespaceSelector:\n        matchLabels:\n          department: rd\n    - ipBlock:\n        cidr: 172.17.0.0/16\n        except:\n        - 172.17.1.0/24\n    ports:\n    - protocol: TCP\n      port: 9453\n  egress:\n  - to:\n    - ipBlock:\n        cidr: 10.0.0.0/24\n    ports:\n    - protocol: TCP\n      port: 9527\n```\n\n### 分段解析\n\n#### Part 1\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: demo-network-policy\n  namespace: default\nspec:\n  podSelector:\n    matchLabels:\n      app: nginx-vts\n  policyTypes:\n  - Ingress\n  - Egress\n...\n```\n\n在 `default` Namespace 中只要帶有 Label 為 `app=nginx-vts` 的 pod，接會被套上 Network Policy，並且進(ingress) 出(egress)流量皆會被限制。\n\n> 如果沒有設定 `spec.podSelector`，代表會套用到 `default` Namespace 中的所有 pod\n\n至於進(ingress) 出(egress)流量的限制細節，需要再往後設定\n\n#### Part 2\n\nIngress 流量的詳細設定\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: demo-network-policy\n  namespace: default\nspec:\n  podSelector:\n    matchLabels:\n      app: nginx-vts\n  policyTypes:\n  - Ingress\n  - Egress\n  ingress:\n  - from:\n    - podSelector:\n        matchLabels:\n          repo: sugar\n    - namespaceSelector:\n        matchLabels:\n          department: rd\n    # IP 範圍，而非 IP 封鎖\n    - ipBlock:\n        cidr: 172.17.0.0/16\n        except:\n        - 172.17.1.0/24\n    ports:\n    - protocol: TCP\n      port: 9453\n...\n```\n\nIngress from：管理從外部進來的流量，也就「允許」進來 Pod 的流量\n\n允許存取的來源白名單：\n\n- 允許 `default` Namespace 中帶有 `repo=sugar` Label 的 Pod\n- 允許帶有 `department=rd` Label 的 Namespace 中所有 Pod\n- 來源 IP 範圍 172.17.0.0/16 (不含 172.17.1.0/24)\n\n綜合 Part 1 的解析，會變成如下：\n\n- 允許 `default` Namespace 中帶有 `repo=sugar` Label 的 Pod，存取 `default` Namespace 中帶有 `app=nginx-vts` 標籤 Pod 的 9453 Port\n- 允許帶有 `department=rd` Label 的 Namespace 中所有 Pod，存取 `default` Namespace 中帶有 `app=nginx-vts` 標籤 Pod 的 9453 Port\n- 允許來源 IP 為 172.17.0.0/16(但排除 172.17.1.0/24)，存取 `default` Namespace 中帶有 `app=nginx-vts` 標籤 Pod 的 9453 Port\n\n#### Part 3\n\nEgress 流量的詳細設定\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: demo-network-policy\n  namespace: default\nspec:\n  podSelector:\n    matchLabels:\n      app: nginx-vts\n  policyTypes:\n  - Ingress\n  - Egress\n...\n  egress:\n  - to:\n    # IP 範圍，而非 IP 封鎖\n    - ipBlock:\n        cidr: 10.0.0.0/24\n    ports:\n    - protocol: TCP\n      port: 9527\n```\n\nEgress to：管理從內部出去的流量，也就是「允許」從 Pod 的出去到達的目的流量\n\n「允許」從 Pod 的出去到達的目的流量白名單：\n\n- 只允許對外連線(egress) 到 IP 範圍 10.0.0.0/24 的 通訊協定 TCP 且目的 Port 為 9527。\n\n綜合 Part 1 的解析，會變成如下：\n\n「在 `default` 的命名空間中只要帶有 Label 為 `app=nginx-vts` 的 pod，只允許對外連線(egress) 到 IP 範圍 10.0.0.0/24 的 通訊協定 TCP 且目的 Port 為 9527」\n\n#### 結論\n\n從上述的解析中可以推論，不管是 Ingress 或是 Egress，對於設定上皆有三種白名單的細部控制：`podSelector`、`namespaceSelector`、`ipBlock`\n\n## 預設政策(default policy)\n\n基本概念(重要)：\n\n- 若要選擇所有的 pod，則將 `podSelector` 設定為 `{}`\n- 若是設定 `policyType`，就表示要全部拒絕該種連線(ingress/egress) 的流量\n- 若要打開上面的限制(也就是白名單)，則要在 `spec.ingress` 或 `spec.egress` 中設定\n\n綜合上述，可以推理出四種情況：\n\n- 拒絕從外面進來的流量，要在 `spec.policyTypes` 中包含 Ingress，並且略過 ingress 細部設定\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: deny-all-ingress\n  namespace: default\nspec:\n  podSelector: {}\n  policyTypes:\n  - Ingress\n```\n\n- 拒絕從內部出去的流量，要在 `spec.policyTypes` 中包含 Egress，並且略過 egress 細部設定\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: deny-all-egress\n  namespace: default\nspec:\n  podSelector: {}\n  policyTypes:\n  - Egress\n```\n\n- 接受從外面進來的網路流量，要在 `spec.policyTypes` 中包含 Ingress，並將 `spec.ingress` 設定為 `{}`\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-all-ingress\n  namespace: default\nspec:\n  podSelector: {}\n  policyTypes:\n  - Ingress\n  ingress:\n  - {}\n```\n\n- 接受從內部出去的網路流向，要在 `spec.policyTypes` 中包含 Egress，並將 `spec.egress` 設定為 `{}`\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-all-egress\n  namespace: default\nspec:\n  podSelector: {}\n  policyTypes:\n  - Egress\n  egress:\n  - {}\n```\n\n在理解完上述情況後後，記得帶上 Namespace 的概念進去，這樣才知道該條政策的作用範圍：\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-all-egress\n  namespace: default\nspec:\n  podSelector: {}\n...\n```\n\n在 `default` Namespace 中所有的 pod(`podSelector: {}`)，皆會被套上 Network Policy，並且進(ingress) 出(egress)流量皆會被限制。\n\n## 更多的使用場景\n\n下述參考資料中，有更多的使用場景可以參照：\n\nhttps://kubernetes.feisky.xyz/concepts/objects/network-policy#shi-yong-chang-jing\n\n### 只允許同一個 Namespace 間的 Pod 相互訪問\n\n只允許 `monitoring` Namespace 間的 Pod 可以相互訪問，其他 Namespace 的 Pod 無法訪問 `monitoring` Namespace 的 Pod\n\n```yaml\nkind: NetworkPolicy\napiVersion: networking.k8s.io/v1\nmetadata:\n  namespace: monitoring\n  name: deny-other-namespaces\nspec:\n  podSelector: {}\n  policyTypes:\n  - Ingress\n  ingress:\n  - from:\n    - podSelector: {}\n```\n\n### 禁止同一個 Namespace 間的 Pod 相互訪問，但是跨 Namespace 不在此限\n\n禁止 `default` Namespace 間的 Pod 相互訪問，但 `default` Namespace 可以訪問其他 Namespace 的 Pod，其他 Namespace 的 Pod 也可以訪問 `default` Namespace 的 Pod \n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: default-deny\n  namespace: default\nspec:\n  podSelector: {}\n  policyTypes:\n  - Ingress\n```\n\n## 參考資料\n\n- https://godleon.github.io/blog/Kubernetes/k8s-Network-Policy-Overview/\n- https://kubernetes.feisky.xyz/concepts/objects/network-policy#shi-yong-chang-jing\n","slug":"kubernetes-network-policy","published":1,"updated":"2024-09-09T07:17:02.665Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5je0020k0lzh54zaukk","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在 K8s 中，預設所有 Pod 不管是在哪個 Namespace，預設都是相通，若是想要進一步限制 Pod 之間的存取，可以使用 Network Policy 來達成。</p>\n<p>在 Google Kubernetes Engine 的環境中，可以自行啟用「Calico Kubernetes Network 政策」，即可輕鬆簡單的直接使用。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"Network-Policy-描述檔\"><a href=\"#Network-Policy-描述檔\" class=\"headerlink\" title=\"Network Policy 描述檔\"></a>Network Policy 描述檔</h2><p>基本範例</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">demo-network-policy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-vts</span></span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br><span class=\"line\">  <span class=\"attr\">ingress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">from:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">          <span class=\"attr\">repo:</span> <span class=\"string\">sugar</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">namespaceSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">          <span class=\"attr\">department:</span> <span class=\"string\">rd</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">ipBlock:</span></span><br><span class=\"line\">        <span class=\"attr\">cidr:</span> <span class=\"number\">172.17</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/16</span></span><br><span class=\"line\">        <span class=\"attr\">except:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"number\">172.17</span><span class=\"number\">.1</span><span class=\"number\">.0</span><span class=\"string\">/24</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9453</span></span><br><span class=\"line\">  <span class=\"attr\">egress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">to:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">ipBlock:</span></span><br><span class=\"line\">        <span class=\"attr\">cidr:</span> <span class=\"number\">10.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/24</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9527</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"分段解析\"><a href=\"#分段解析\" class=\"headerlink\" title=\"分段解析\"></a>分段解析</h3><h4 id=\"Part-1\"><a href=\"#Part-1\" class=\"headerlink\" title=\"Part 1\"></a>Part 1</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">demo-network-policy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-vts</span></span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br><span class=\"line\"><span class=\"string\">...</span></span><br></pre></td></tr></table></figure>\n\n<p>在 <code>default</code> Namespace 中只要帶有 Label 為 <code>app=nginx-vts</code> 的 pod，接會被套上 Network Policy，並且進(ingress) 出(egress)流量皆會被限制。</p>\n<blockquote>\n<p>如果沒有設定 <code>spec.podSelector</code>，代表會套用到 <code>default</code> Namespace 中的所有 pod</p>\n</blockquote>\n<p>至於進(ingress) 出(egress)流量的限制細節，需要再往後設定</p>\n<h4 id=\"Part-2\"><a href=\"#Part-2\" class=\"headerlink\" title=\"Part 2\"></a>Part 2</h4><p>Ingress 流量的詳細設定</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">demo-network-policy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-vts</span></span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br><span class=\"line\">  <span class=\"attr\">ingress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">from:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">          <span class=\"attr\">repo:</span> <span class=\"string\">sugar</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">namespaceSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">          <span class=\"attr\">department:</span> <span class=\"string\">rd</span></span><br><span class=\"line\">    <span class=\"comment\"># IP 範圍，而非 IP 封鎖</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">ipBlock:</span></span><br><span class=\"line\">        <span class=\"attr\">cidr:</span> <span class=\"number\">172.17</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/16</span></span><br><span class=\"line\">        <span class=\"attr\">except:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"number\">172.17</span><span class=\"number\">.1</span><span class=\"number\">.0</span><span class=\"string\">/24</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9453</span></span><br><span class=\"line\"><span class=\"string\">...</span></span><br></pre></td></tr></table></figure>\n\n<p>Ingress from：管理從外部進來的流量，也就「允許」進來 Pod 的流量</p>\n<p>允許存取的來源白名單：</p>\n<ul>\n<li>允許 <code>default</code> Namespace 中帶有 <code>repo=sugar</code> Label 的 Pod</li>\n<li>允許帶有 <code>department=rd</code> Label 的 Namespace 中所有 Pod</li>\n<li>來源 IP 範圍 172.17.0.0/16 (不含 172.17.1.0/24)</li>\n</ul>\n<p>綜合 Part 1 的解析，會變成如下：</p>\n<ul>\n<li>允許 <code>default</code> Namespace 中帶有 <code>repo=sugar</code> Label 的 Pod，存取 <code>default</code> Namespace 中帶有 <code>app=nginx-vts</code> 標籤 Pod 的 9453 Port</li>\n<li>允許帶有 <code>department=rd</code> Label 的 Namespace 中所有 Pod，存取 <code>default</code> Namespace 中帶有 <code>app=nginx-vts</code> 標籤 Pod 的 9453 Port</li>\n<li>允許來源 IP 為 172.17.0.0/16(但排除 172.17.1.0/24)，存取 <code>default</code> Namespace 中帶有 <code>app=nginx-vts</code> 標籤 Pod 的 9453 Port</li>\n</ul>\n<h4 id=\"Part-3\"><a href=\"#Part-3\" class=\"headerlink\" title=\"Part 3\"></a>Part 3</h4><p>Egress 流量的詳細設定</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">demo-network-policy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-vts</span></span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br><span class=\"line\"><span class=\"string\">...</span></span><br><span class=\"line\">  <span class=\"attr\">egress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">to:</span></span><br><span class=\"line\">    <span class=\"comment\"># IP 範圍，而非 IP 封鎖</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">ipBlock:</span></span><br><span class=\"line\">        <span class=\"attr\">cidr:</span> <span class=\"number\">10.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/24</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9527</span></span><br></pre></td></tr></table></figure>\n\n<p>Egress to：管理從內部出去的流量，也就是「允許」從 Pod 的出去到達的目的流量</p>\n<p>「允許」從 Pod 的出去到達的目的流量白名單：</p>\n<ul>\n<li>只允許對外連線(egress) 到 IP 範圍 10.0.0.0/24 的 通訊協定 TCP 且目的 Port 為 9527。</li>\n</ul>\n<p>綜合 Part 1 的解析，會變成如下：</p>\n<p>「在 <code>default</code> 的命名空間中只要帶有 Label 為 <code>app=nginx-vts</code> 的 pod，只允許對外連線(egress) 到 IP 範圍 10.0.0.0/24 的 通訊協定 TCP 且目的 Port 為 9527」</p>\n<h4 id=\"結論\"><a href=\"#結論\" class=\"headerlink\" title=\"結論\"></a>結論</h4><p>從上述的解析中可以推論，不管是 Ingress 或是 Egress，對於設定上皆有三種白名單的細部控制：<code>podSelector</code>、<code>namespaceSelector</code>、<code>ipBlock</code></p>\n<h2 id=\"預設政策-default-policy\"><a href=\"#預設政策-default-policy\" class=\"headerlink\" title=\"預設政策(default policy)\"></a>預設政策(default policy)</h2><p>基本概念(重要)：</p>\n<ul>\n<li>若要選擇所有的 pod，則將 <code>podSelector</code> 設定為 <code>&#123;&#125;</code></li>\n<li>若是設定 <code>policyType</code>，就表示要全部拒絕該種連線(ingress/egress) 的流量</li>\n<li>若要打開上面的限制(也就是白名單)，則要在 <code>spec.ingress</code> 或 <code>spec.egress</code> 中設定</li>\n</ul>\n<p>綜合上述，可以推理出四種情況：</p>\n<ul>\n<li>拒絕從外面進來的流量，要在 <code>spec.policyTypes</code> 中包含 Ingress，並且略過 ingress 細部設定</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">deny-all-ingress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>拒絕從內部出去的流量，要在 <code>spec.policyTypes</code> 中包含 Egress，並且略過 egress 細部設定</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">deny-all-egress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>接受從外面進來的網路流量，要在 <code>spec.policyTypes</code> 中包含 Ingress，並將 <code>spec.ingress</code> 設定為 <code>&#123;&#125;</code></li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">allow-all-ingress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"attr\">ingress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> &#123;&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>接受從內部出去的網路流向，要在 <code>spec.policyTypes</code> 中包含 Egress，並將 <code>spec.egress</code> 設定為 <code>&#123;&#125;</code></li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">allow-all-egress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br><span class=\"line\">  <span class=\"attr\">egress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> &#123;&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在理解完上述情況後後，記得帶上 Namespace 的概念進去，這樣才知道該條政策的作用範圍：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">allow-all-egress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br><span class=\"line\"><span class=\"string\">...</span></span><br></pre></td></tr></table></figure>\n\n<p>在 <code>default</code> Namespace 中所有的 pod(<code>podSelector: &#123;&#125;</code>)，皆會被套上 Network Policy，並且進(ingress) 出(egress)流量皆會被限制。</p>\n<h2 id=\"更多的使用場景\"><a href=\"#更多的使用場景\" class=\"headerlink\" title=\"更多的使用場景\"></a>更多的使用場景</h2><p>下述參考資料中，有更多的使用場景可以參照：</p>\n<p><a href=\"https://kubernetes.feisky.xyz/concepts/objects/network-policy#shi-yong-chang-jing\">https://kubernetes.feisky.xyz/concepts/objects/network-policy#shi-yong-chang-jing</a></p>\n<h3 id=\"只允許同一個-Namespace-間的-Pod-相互訪問\"><a href=\"#只允許同一個-Namespace-間的-Pod-相互訪問\" class=\"headerlink\" title=\"只允許同一個 Namespace 間的 Pod 相互訪問\"></a>只允許同一個 Namespace 間的 Pod 相互訪問</h3><p>只允許 <code>monitoring</code> Namespace 間的 Pod 可以相互訪問，其他 Namespace 的 Pod 無法訪問 <code>monitoring</code> Namespace 的 Pod</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">deny-other-namespaces</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"attr\">ingress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">from:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"禁止同一個-Namespace-間的-Pod-相互訪問，但是跨-Namespace-不在此限\"><a href=\"#禁止同一個-Namespace-間的-Pod-相互訪問，但是跨-Namespace-不在此限\" class=\"headerlink\" title=\"禁止同一個 Namespace 間的 Pod 相互訪問，但是跨 Namespace 不在此限\"></a>禁止同一個 Namespace 間的 Pod 相互訪問，但是跨 Namespace 不在此限</h3><p>禁止 <code>default</code> Namespace 間的 Pod 相互訪問，但 <code>default</code> Namespace 可以訪問其他 Namespace 的 Pod，其他 Namespace 的 Pod 也可以訪問 <code>default</code> Namespace 的 Pod </p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">default-deny</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://godleon.github.io/blog/Kubernetes/k8s-Network-Policy-Overview/\">https://godleon.github.io/blog/Kubernetes/k8s-Network-Policy-Overview/</a></li>\n<li><a href=\"https://kubernetes.feisky.xyz/concepts/objects/network-policy#shi-yong-chang-jing\">https://kubernetes.feisky.xyz/concepts/objects/network-policy#shi-yong-chang-jing</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在 K8s 中，預設所有 Pod 不管是在哪個 Namespace，預設都是相通，若是想要進一步限制 Pod 之間的存取，可以使用 Network Policy 來達成。</p>\n<p>在 Google Kubernetes Engine 的環境中，可以自行啟用「Calico Kubernetes Network 政策」，即可輕鬆簡單的直接使用。</p>","more":"<h2 id=\"Network-Policy-描述檔\"><a href=\"#Network-Policy-描述檔\" class=\"headerlink\" title=\"Network Policy 描述檔\"></a>Network Policy 描述檔</h2><p>基本範例</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">demo-network-policy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-vts</span></span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br><span class=\"line\">  <span class=\"attr\">ingress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">from:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">          <span class=\"attr\">repo:</span> <span class=\"string\">sugar</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">namespaceSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">          <span class=\"attr\">department:</span> <span class=\"string\">rd</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">ipBlock:</span></span><br><span class=\"line\">        <span class=\"attr\">cidr:</span> <span class=\"number\">172.17</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/16</span></span><br><span class=\"line\">        <span class=\"attr\">except:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"number\">172.17</span><span class=\"number\">.1</span><span class=\"number\">.0</span><span class=\"string\">/24</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9453</span></span><br><span class=\"line\">  <span class=\"attr\">egress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">to:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">ipBlock:</span></span><br><span class=\"line\">        <span class=\"attr\">cidr:</span> <span class=\"number\">10.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/24</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9527</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"分段解析\"><a href=\"#分段解析\" class=\"headerlink\" title=\"分段解析\"></a>分段解析</h3><h4 id=\"Part-1\"><a href=\"#Part-1\" class=\"headerlink\" title=\"Part 1\"></a>Part 1</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">demo-network-policy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-vts</span></span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br><span class=\"line\"><span class=\"string\">...</span></span><br></pre></td></tr></table></figure>\n\n<p>在 <code>default</code> Namespace 中只要帶有 Label 為 <code>app=nginx-vts</code> 的 pod，接會被套上 Network Policy，並且進(ingress) 出(egress)流量皆會被限制。</p>\n<blockquote>\n<p>如果沒有設定 <code>spec.podSelector</code>，代表會套用到 <code>default</code> Namespace 中的所有 pod</p>\n</blockquote>\n<p>至於進(ingress) 出(egress)流量的限制細節，需要再往後設定</p>\n<h4 id=\"Part-2\"><a href=\"#Part-2\" class=\"headerlink\" title=\"Part 2\"></a>Part 2</h4><p>Ingress 流量的詳細設定</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">demo-network-policy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-vts</span></span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br><span class=\"line\">  <span class=\"attr\">ingress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">from:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">          <span class=\"attr\">repo:</span> <span class=\"string\">sugar</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">namespaceSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">          <span class=\"attr\">department:</span> <span class=\"string\">rd</span></span><br><span class=\"line\">    <span class=\"comment\"># IP 範圍，而非 IP 封鎖</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">ipBlock:</span></span><br><span class=\"line\">        <span class=\"attr\">cidr:</span> <span class=\"number\">172.17</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/16</span></span><br><span class=\"line\">        <span class=\"attr\">except:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"number\">172.17</span><span class=\"number\">.1</span><span class=\"number\">.0</span><span class=\"string\">/24</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9453</span></span><br><span class=\"line\"><span class=\"string\">...</span></span><br></pre></td></tr></table></figure>\n\n<p>Ingress from：管理從外部進來的流量，也就「允許」進來 Pod 的流量</p>\n<p>允許存取的來源白名單：</p>\n<ul>\n<li>允許 <code>default</code> Namespace 中帶有 <code>repo=sugar</code> Label 的 Pod</li>\n<li>允許帶有 <code>department=rd</code> Label 的 Namespace 中所有 Pod</li>\n<li>來源 IP 範圍 172.17.0.0/16 (不含 172.17.1.0/24)</li>\n</ul>\n<p>綜合 Part 1 的解析，會變成如下：</p>\n<ul>\n<li>允許 <code>default</code> Namespace 中帶有 <code>repo=sugar</code> Label 的 Pod，存取 <code>default</code> Namespace 中帶有 <code>app=nginx-vts</code> 標籤 Pod 的 9453 Port</li>\n<li>允許帶有 <code>department=rd</code> Label 的 Namespace 中所有 Pod，存取 <code>default</code> Namespace 中帶有 <code>app=nginx-vts</code> 標籤 Pod 的 9453 Port</li>\n<li>允許來源 IP 為 172.17.0.0/16(但排除 172.17.1.0/24)，存取 <code>default</code> Namespace 中帶有 <code>app=nginx-vts</code> 標籤 Pod 的 9453 Port</li>\n</ul>\n<h4 id=\"Part-3\"><a href=\"#Part-3\" class=\"headerlink\" title=\"Part 3\"></a>Part 3</h4><p>Egress 流量的詳細設定</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">demo-network-policy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-vts</span></span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br><span class=\"line\"><span class=\"string\">...</span></span><br><span class=\"line\">  <span class=\"attr\">egress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">to:</span></span><br><span class=\"line\">    <span class=\"comment\"># IP 範圍，而非 IP 封鎖</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">ipBlock:</span></span><br><span class=\"line\">        <span class=\"attr\">cidr:</span> <span class=\"number\">10.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/24</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9527</span></span><br></pre></td></tr></table></figure>\n\n<p>Egress to：管理從內部出去的流量，也就是「允許」從 Pod 的出去到達的目的流量</p>\n<p>「允許」從 Pod 的出去到達的目的流量白名單：</p>\n<ul>\n<li>只允許對外連線(egress) 到 IP 範圍 10.0.0.0/24 的 通訊協定 TCP 且目的 Port 為 9527。</li>\n</ul>\n<p>綜合 Part 1 的解析，會變成如下：</p>\n<p>「在 <code>default</code> 的命名空間中只要帶有 Label 為 <code>app=nginx-vts</code> 的 pod，只允許對外連線(egress) 到 IP 範圍 10.0.0.0/24 的 通訊協定 TCP 且目的 Port 為 9527」</p>\n<h4 id=\"結論\"><a href=\"#結論\" class=\"headerlink\" title=\"結論\"></a>結論</h4><p>從上述的解析中可以推論，不管是 Ingress 或是 Egress，對於設定上皆有三種白名單的細部控制：<code>podSelector</code>、<code>namespaceSelector</code>、<code>ipBlock</code></p>\n<h2 id=\"預設政策-default-policy\"><a href=\"#預設政策-default-policy\" class=\"headerlink\" title=\"預設政策(default policy)\"></a>預設政策(default policy)</h2><p>基本概念(重要)：</p>\n<ul>\n<li>若要選擇所有的 pod，則將 <code>podSelector</code> 設定為 <code>&#123;&#125;</code></li>\n<li>若是設定 <code>policyType</code>，就表示要全部拒絕該種連線(ingress/egress) 的流量</li>\n<li>若要打開上面的限制(也就是白名單)，則要在 <code>spec.ingress</code> 或 <code>spec.egress</code> 中設定</li>\n</ul>\n<p>綜合上述，可以推理出四種情況：</p>\n<ul>\n<li>拒絕從外面進來的流量，要在 <code>spec.policyTypes</code> 中包含 Ingress，並且略過 ingress 細部設定</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">deny-all-ingress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>拒絕從內部出去的流量，要在 <code>spec.policyTypes</code> 中包含 Egress，並且略過 egress 細部設定</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">deny-all-egress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>接受從外面進來的網路流量，要在 <code>spec.policyTypes</code> 中包含 Ingress，並將 <code>spec.ingress</code> 設定為 <code>&#123;&#125;</code></li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">allow-all-ingress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"attr\">ingress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> &#123;&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>接受從內部出去的網路流向，要在 <code>spec.policyTypes</code> 中包含 Egress，並將 <code>spec.egress</code> 設定為 <code>&#123;&#125;</code></li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">allow-all-egress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br><span class=\"line\">  <span class=\"attr\">egress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> &#123;&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在理解完上述情況後後，記得帶上 Namespace 的概念進去，這樣才知道該條政策的作用範圍：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">allow-all-egress</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br><span class=\"line\"><span class=\"string\">...</span></span><br></pre></td></tr></table></figure>\n\n<p>在 <code>default</code> Namespace 中所有的 pod(<code>podSelector: &#123;&#125;</code>)，皆會被套上 Network Policy，並且進(ingress) 出(egress)流量皆會被限制。</p>\n<h2 id=\"更多的使用場景\"><a href=\"#更多的使用場景\" class=\"headerlink\" title=\"更多的使用場景\"></a>更多的使用場景</h2><p>下述參考資料中，有更多的使用場景可以參照：</p>\n<p><a href=\"https://kubernetes.feisky.xyz/concepts/objects/network-policy#shi-yong-chang-jing\">https://kubernetes.feisky.xyz/concepts/objects/network-policy#shi-yong-chang-jing</a></p>\n<h3 id=\"只允許同一個-Namespace-間的-Pod-相互訪問\"><a href=\"#只允許同一個-Namespace-間的-Pod-相互訪問\" class=\"headerlink\" title=\"只允許同一個 Namespace 間的 Pod 相互訪問\"></a>只允許同一個 Namespace 間的 Pod 相互訪問</h3><p>只允許 <code>monitoring</code> Namespace 間的 Pod 可以相互訪問，其他 Namespace 的 Pod 無法訪問 <code>monitoring</code> Namespace 的 Pod</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">monitoring</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">deny-other-namespaces</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"attr\">ingress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">from:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"禁止同一個-Namespace-間的-Pod-相互訪問，但是跨-Namespace-不在此限\"><a href=\"#禁止同一個-Namespace-間的-Pod-相互訪問，但是跨-Namespace-不在此限\" class=\"headerlink\" title=\"禁止同一個 Namespace 間的 Pod 相互訪問，但是跨 Namespace 不在此限\"></a>禁止同一個 Namespace 間的 Pod 相互訪問，但是跨 Namespace 不在此限</h3><p>禁止 <code>default</code> Namespace 間的 Pod 相互訪問，但 <code>default</code> Namespace 可以訪問其他 Namespace 的 Pod，其他 Namespace 的 Pod 也可以訪問 <code>default</code> Namespace 的 Pod </p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">default-deny</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://godleon.github.io/blog/Kubernetes/k8s-Network-Policy-Overview/\">https://godleon.github.io/blog/Kubernetes/k8s-Network-Policy-Overview/</a></li>\n<li><a href=\"https://kubernetes.feisky.xyz/concepts/objects/network-policy#shi-yong-chang-jing\">https://kubernetes.feisky.xyz/concepts/objects/network-policy#shi-yong-chang-jing</a></li>\n</ul>"},{"title":"PHP-FPM行程優化","abbrlink":"66a05136","date":"2021-04-29T09:21:21.000Z","_content":"\n## 前言\n\n近期公司內部 PHP-FPM 有頂到一些行程相關的上限，導致網頁要處理後端程式時無法處理，進而造成服務異常。 而這樣子的問題不外乎可以從 LOG 去看到一些觸發到這個問題的根本原因是什麼。\n\n以下列了兩個行程不夠時常見的 Error Log\n\n```text\nWARNING: [pool www] server reached pm.max_children setting (5), consider raising it\n```\n\n```text\nWARNING: [pool www] seems busy (you may need to increase pm.start_servers, or pm.min/max_spare_servers), spawning 32 children, there are 0 idle, and 19 total child\n```\n\n<!--more-->\n\nPHP-FPM 行程優化相關參數，以下為預設值，需要依照每台機器狀態不同去調教\n\n```text\npm = dynamic\npm.max_children = 5\npm.start_servers = 2\npm.min_spare_servers = 1\npm.max_spare_servers = 3\n\npm.max_requests = 500\npm.process_idle_timeout = 10s # 需搭配 pm = ondemand\n```\n\n以下會針對每個項目去解釋其用途\n\n## pm (Process Manager)\n\npm 為行程管理(Process Manager) 的縮寫，此參數主要是在設定 pm 要使用哪種模式來管理行程，可以區分兩大類型，共三種模式可以選擇，預設是使用 dynamic\n\n### 固定行程數量\n- static: 設定此模式，只有 `pm.max_children` 參數會生效，行程數量則根據 `pm.max_children`，效能較好，因為 child process 會保持一個固定的數量，但是比較佔記憶體，因為即便請求較少量時，依然會佔用，所以較不建議使用此模式\n\n### 動態行程數量\n\n皆根據 `pm.max_children`、`pm.start_servers`、`pm.min_spare_servers`、`pm.max_spare_servers` 動態調整\n\n- dynamic: 根據使用量用多寡開行程，但當使用量比較低時，會保留固定行程(根據 `pm.min_spare_servers` 或 `pm.max_spare_servers`)，隨時等著接收新的連線\n- ondemand: 用多少量就開多少行程\n\n#### dynamic 實際運作\n\n當我們設定 `pm = dynamic` 並啟動時，首先會產生一定數量的行程(根據 `pm.start_servers`)，此參數可以想像成是最小數量的子程序，而最大數量的子程序則根據 `pm.max_children`，有了最大和最小子程序數量，也就是說服務過程中子程序數量會在最大和最小子程序數量間變化。\n\n而閒置的子程序數量則由 `pm.min_spare_servers`、`pm.max_spare_servers` 控制，超過 `pm.max_spare_servers` 的閒置子程序則會被 Kill。\n\n因為 dynamic 模式可以針對伺服器的回應做最大的優化，但相反的代價是可能造成更多記憶體的佔用，這邊舉例來說，假設 `pm.max_spare_servers = 10`、`pm.max_children = 20`，在某個尖峰時段，這時候最大數量的子程序 20 個都處於忙碌狀態，0個閒置的子程序，過了尖峰時段，請求下降，而當初忙碌的 20 個子程序目前處於閒置狀態，此時 PHP-FPM 只會 Kill 掉 10 個子程序，而最後剩下 10 個閒置的子程序來等待請求，這也就是會造成在尖峰後請求數大量減少後，記憶體卻沒有大量降低的主要原因，而如果把主機重啟，記憶體則會將得更低，這是因為重啟用子程序數量會變成最小閒置行程數量(`pm.min_spare_servers`)\n\n#### ondemand 實際運作\n\n`pm = ondemand` 的運作方式與 dynamic 恰好相反，dynamic 針對伺服器的回應做最大的優化，而 ondemand 則是最佳化記憶體。\n\n而運作方式是，每個閒置的子程序在持續閒置超過 `pm.process_idle_timeout` 設定的時間，就會被 Kill 掉，這樣的模式讓主機在尖峰時期過後可以自然地降低記憶體的使用率，如果長時間都沒有請求連線時，只會有一個 PHP-FPM 主程序。\n\n那壞處則是，如果遇到尖峰時期，或 `pm.process_idle_timeout` 設定得太短的話，會造成伺服器頻繁的建立子程序，而造成效能不佳\n\n## pm.max_children(最大行程數量)\n\n`pm.max_children` 參數在 `pm` 等於 `static` 即為開啟的行程數，而在 `dynamic` 與 `ondemand` 模式下，則是代表最大可開啟的行程數量。\n\n最大行程數量的多寡是根據本身主機的記憶體大小來決定，當記憶體越大時，就可以設定較多的行程數量。 此設定值如果設太小的話會造成處理請求的速度下降，設定太大的話會造成當機，因為記憶體耗盡，所以要依硬體資源來調較。\n\n可以利用以下指令去查詢行程使用的記憶體量\n\n```bash\n$ ps -ylC php-fpm --sort:rss\n\nS   UID     PID    PPID  C PRI  NI   RSS    SZ WCHAN  TTY          TIME CMD\nS     0       1       0  0  80   0  4760 20195 do_epo ?        00:02:11 php-fpm\nS    33       9       1  0  80   0 20260 22581 -      ?        00:01:20 php-fpm\nS    33       8       1  0  80   0 20464 22582 -      ?        00:01:42 php-fpm\nS    33       7       1  0  80   0 20476 22584 -      ?        00:01:43 php-fpm\n```\n\nRSS 欄位為子程序使用的記憶體大小，單位為KB，20476 約莫 20MB，但是因為每個子程序所使用的記憶體大小都不太一樣，所以我們可以使用下面的指令來求出子程序平均使用記憶體大小\n\n```\nps --no-headers -o \"rss,cmd\" -C php-fpm | awk '{ sum+=$1 } END { printf (\"%d%s\\n\", sum/NR/1024,\"Mb\") }'\n```\n\n至於 `pm.max_children` 應該要設定多少才合理，以下有一個計算公式\n\n```\npm.max_children = Total RAM / Max child process size\n```\n\n> 這邊的 Total RAM 需要扣除已經使用的記憶體，例如系統或其他程序使用後所剩餘的記憶體\n\n## pm.start_servers(初始行程數量)\n\n`pm.start_servers` 可設定 PHP-FPM 服務在一開始啟動時，要配置多少個行程\n\n`pm.start_servers` 同樣有一個計算公式可以參考\n\n```\npm.start_servers = min_spare_servers + (max_spare_servers - min_spare_servers) / 2\n```\n\n## pm.min_spare_servers(最小閒置行程數量)\n\n`pm.min_spare_servers` 設定 PHP-FPM 最小閒置行程的數量\n\n## pm.max_spare_servers(最大閒置行程數量)\n\n`pm.max_spare_servers` 設定 PHP-FPM 最大閒置行程的數量\n\n> 這邊需要注意的是 `pm.max_spare_servers` 的值只能小於等於 `pm.max_children`\n\n## pm.max_requests(單一行程可處理連線數)\n\n`pm.max_requests` 可設定單一 PHP-FPM 最多可以處理多少個連線，當一個行程處理的連線數達到設定值時，此行程會被 Kill 掉，而重新產生另一個新的行程\n\n## 參考資料\n\n- https://kejyuntw.gitbooks.io/ubuntu-learning-notes/content/web/php/web-php-max-children.html\n- https://support.plesk.com/hc/en-us/articles/360011988053-How-to-calculate-pm-max-children-value-\n- https://www.mdeditor.tw/pl/p9Vf/zh-tw\n","source":"_posts/php-fpm-process-optimize.md","raw":"---\ntitle: PHP-FPM行程優化\ntags:\n  - PHP-FPM\n  - PHP\ncategories:\n  - PHP-FPM\nabbrlink: 66a05136\ndate: 2021-04-29 17:21:21\n---\n\n## 前言\n\n近期公司內部 PHP-FPM 有頂到一些行程相關的上限，導致網頁要處理後端程式時無法處理，進而造成服務異常。 而這樣子的問題不外乎可以從 LOG 去看到一些觸發到這個問題的根本原因是什麼。\n\n以下列了兩個行程不夠時常見的 Error Log\n\n```text\nWARNING: [pool www] server reached pm.max_children setting (5), consider raising it\n```\n\n```text\nWARNING: [pool www] seems busy (you may need to increase pm.start_servers, or pm.min/max_spare_servers), spawning 32 children, there are 0 idle, and 19 total child\n```\n\n<!--more-->\n\nPHP-FPM 行程優化相關參數，以下為預設值，需要依照每台機器狀態不同去調教\n\n```text\npm = dynamic\npm.max_children = 5\npm.start_servers = 2\npm.min_spare_servers = 1\npm.max_spare_servers = 3\n\npm.max_requests = 500\npm.process_idle_timeout = 10s # 需搭配 pm = ondemand\n```\n\n以下會針對每個項目去解釋其用途\n\n## pm (Process Manager)\n\npm 為行程管理(Process Manager) 的縮寫，此參數主要是在設定 pm 要使用哪種模式來管理行程，可以區分兩大類型，共三種模式可以選擇，預設是使用 dynamic\n\n### 固定行程數量\n- static: 設定此模式，只有 `pm.max_children` 參數會生效，行程數量則根據 `pm.max_children`，效能較好，因為 child process 會保持一個固定的數量，但是比較佔記憶體，因為即便請求較少量時，依然會佔用，所以較不建議使用此模式\n\n### 動態行程數量\n\n皆根據 `pm.max_children`、`pm.start_servers`、`pm.min_spare_servers`、`pm.max_spare_servers` 動態調整\n\n- dynamic: 根據使用量用多寡開行程，但當使用量比較低時，會保留固定行程(根據 `pm.min_spare_servers` 或 `pm.max_spare_servers`)，隨時等著接收新的連線\n- ondemand: 用多少量就開多少行程\n\n#### dynamic 實際運作\n\n當我們設定 `pm = dynamic` 並啟動時，首先會產生一定數量的行程(根據 `pm.start_servers`)，此參數可以想像成是最小數量的子程序，而最大數量的子程序則根據 `pm.max_children`，有了最大和最小子程序數量，也就是說服務過程中子程序數量會在最大和最小子程序數量間變化。\n\n而閒置的子程序數量則由 `pm.min_spare_servers`、`pm.max_spare_servers` 控制，超過 `pm.max_spare_servers` 的閒置子程序則會被 Kill。\n\n因為 dynamic 模式可以針對伺服器的回應做最大的優化，但相反的代價是可能造成更多記憶體的佔用，這邊舉例來說，假設 `pm.max_spare_servers = 10`、`pm.max_children = 20`，在某個尖峰時段，這時候最大數量的子程序 20 個都處於忙碌狀態，0個閒置的子程序，過了尖峰時段，請求下降，而當初忙碌的 20 個子程序目前處於閒置狀態，此時 PHP-FPM 只會 Kill 掉 10 個子程序，而最後剩下 10 個閒置的子程序來等待請求，這也就是會造成在尖峰後請求數大量減少後，記憶體卻沒有大量降低的主要原因，而如果把主機重啟，記憶體則會將得更低，這是因為重啟用子程序數量會變成最小閒置行程數量(`pm.min_spare_servers`)\n\n#### ondemand 實際運作\n\n`pm = ondemand` 的運作方式與 dynamic 恰好相反，dynamic 針對伺服器的回應做最大的優化，而 ondemand 則是最佳化記憶體。\n\n而運作方式是，每個閒置的子程序在持續閒置超過 `pm.process_idle_timeout` 設定的時間，就會被 Kill 掉，這樣的模式讓主機在尖峰時期過後可以自然地降低記憶體的使用率，如果長時間都沒有請求連線時，只會有一個 PHP-FPM 主程序。\n\n那壞處則是，如果遇到尖峰時期，或 `pm.process_idle_timeout` 設定得太短的話，會造成伺服器頻繁的建立子程序，而造成效能不佳\n\n## pm.max_children(最大行程數量)\n\n`pm.max_children` 參數在 `pm` 等於 `static` 即為開啟的行程數，而在 `dynamic` 與 `ondemand` 模式下，則是代表最大可開啟的行程數量。\n\n最大行程數量的多寡是根據本身主機的記憶體大小來決定，當記憶體越大時，就可以設定較多的行程數量。 此設定值如果設太小的話會造成處理請求的速度下降，設定太大的話會造成當機，因為記憶體耗盡，所以要依硬體資源來調較。\n\n可以利用以下指令去查詢行程使用的記憶體量\n\n```bash\n$ ps -ylC php-fpm --sort:rss\n\nS   UID     PID    PPID  C PRI  NI   RSS    SZ WCHAN  TTY          TIME CMD\nS     0       1       0  0  80   0  4760 20195 do_epo ?        00:02:11 php-fpm\nS    33       9       1  0  80   0 20260 22581 -      ?        00:01:20 php-fpm\nS    33       8       1  0  80   0 20464 22582 -      ?        00:01:42 php-fpm\nS    33       7       1  0  80   0 20476 22584 -      ?        00:01:43 php-fpm\n```\n\nRSS 欄位為子程序使用的記憶體大小，單位為KB，20476 約莫 20MB，但是因為每個子程序所使用的記憶體大小都不太一樣，所以我們可以使用下面的指令來求出子程序平均使用記憶體大小\n\n```\nps --no-headers -o \"rss,cmd\" -C php-fpm | awk '{ sum+=$1 } END { printf (\"%d%s\\n\", sum/NR/1024,\"Mb\") }'\n```\n\n至於 `pm.max_children` 應該要設定多少才合理，以下有一個計算公式\n\n```\npm.max_children = Total RAM / Max child process size\n```\n\n> 這邊的 Total RAM 需要扣除已經使用的記憶體，例如系統或其他程序使用後所剩餘的記憶體\n\n## pm.start_servers(初始行程數量)\n\n`pm.start_servers` 可設定 PHP-FPM 服務在一開始啟動時，要配置多少個行程\n\n`pm.start_servers` 同樣有一個計算公式可以參考\n\n```\npm.start_servers = min_spare_servers + (max_spare_servers - min_spare_servers) / 2\n```\n\n## pm.min_spare_servers(最小閒置行程數量)\n\n`pm.min_spare_servers` 設定 PHP-FPM 最小閒置行程的數量\n\n## pm.max_spare_servers(最大閒置行程數量)\n\n`pm.max_spare_servers` 設定 PHP-FPM 最大閒置行程的數量\n\n> 這邊需要注意的是 `pm.max_spare_servers` 的值只能小於等於 `pm.max_children`\n\n## pm.max_requests(單一行程可處理連線數)\n\n`pm.max_requests` 可設定單一 PHP-FPM 最多可以處理多少個連線，當一個行程處理的連線數達到設定值時，此行程會被 Kill 掉，而重新產生另一個新的行程\n\n## 參考資料\n\n- https://kejyuntw.gitbooks.io/ubuntu-learning-notes/content/web/php/web-php-max-children.html\n- https://support.plesk.com/hc/en-us/articles/360011988053-How-to-calculate-pm-max-children-value-\n- https://www.mdeditor.tw/pl/p9Vf/zh-tw\n","slug":"php-fpm-process-optimize","published":1,"updated":"2024-09-09T07:17:02.665Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5je0023k0lz61d65o06","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>近期公司內部 PHP-FPM 有頂到一些行程相關的上限，導致網頁要處理後端程式時無法處理，進而造成服務異常。 而這樣子的問題不外乎可以從 LOG 去看到一些觸發到這個問題的根本原因是什麼。</p>\n<p>以下列了兩個行程不夠時常見的 Error Log</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WARNING: [pool www] server reached pm.max_children setting (5), consider raising it</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WARNING: [pool www] seems busy (you may need to increase pm.start_servers, or pm.min/max_spare_servers), spawning 32 children, there are 0 idle, and 19 total child</span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<p>PHP-FPM 行程優化相關參數，以下為預設值，需要依照每台機器狀態不同去調教</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pm = dynamic</span><br><span class=\"line\">pm.max_children = 5</span><br><span class=\"line\">pm.start_servers = 2</span><br><span class=\"line\">pm.min_spare_servers = 1</span><br><span class=\"line\">pm.max_spare_servers = 3</span><br><span class=\"line\"></span><br><span class=\"line\">pm.max_requests = 500</span><br><span class=\"line\">pm.process_idle_timeout = 10s # 需搭配 pm = ondemand</span><br></pre></td></tr></table></figure>\n\n<p>以下會針對每個項目去解釋其用途</p>\n<h2 id=\"pm-Process-Manager\"><a href=\"#pm-Process-Manager\" class=\"headerlink\" title=\"pm (Process Manager)\"></a>pm (Process Manager)</h2><p>pm 為行程管理(Process Manager) 的縮寫，此參數主要是在設定 pm 要使用哪種模式來管理行程，可以區分兩大類型，共三種模式可以選擇，預設是使用 dynamic</p>\n<h3 id=\"固定行程數量\"><a href=\"#固定行程數量\" class=\"headerlink\" title=\"固定行程數量\"></a>固定行程數量</h3><ul>\n<li>static: 設定此模式，只有 <code>pm.max_children</code> 參數會生效，行程數量則根據 <code>pm.max_children</code>，效能較好，因為 child process 會保持一個固定的數量，但是比較佔記憶體，因為即便請求較少量時，依然會佔用，所以較不建議使用此模式</li>\n</ul>\n<h3 id=\"動態行程數量\"><a href=\"#動態行程數量\" class=\"headerlink\" title=\"動態行程數量\"></a>動態行程數量</h3><p>皆根據 <code>pm.max_children</code>、<code>pm.start_servers</code>、<code>pm.min_spare_servers</code>、<code>pm.max_spare_servers</code> 動態調整</p>\n<ul>\n<li>dynamic: 根據使用量用多寡開行程，但當使用量比較低時，會保留固定行程(根據 <code>pm.min_spare_servers</code> 或 <code>pm.max_spare_servers</code>)，隨時等著接收新的連線</li>\n<li>ondemand: 用多少量就開多少行程</li>\n</ul>\n<h4 id=\"dynamic-實際運作\"><a href=\"#dynamic-實際運作\" class=\"headerlink\" title=\"dynamic 實際運作\"></a>dynamic 實際運作</h4><p>當我們設定 <code>pm = dynamic</code> 並啟動時，首先會產生一定數量的行程(根據 <code>pm.start_servers</code>)，此參數可以想像成是最小數量的子程序，而最大數量的子程序則根據 <code>pm.max_children</code>，有了最大和最小子程序數量，也就是說服務過程中子程序數量會在最大和最小子程序數量間變化。</p>\n<p>而閒置的子程序數量則由 <code>pm.min_spare_servers</code>、<code>pm.max_spare_servers</code> 控制，超過 <code>pm.max_spare_servers</code> 的閒置子程序則會被 Kill。</p>\n<p>因為 dynamic 模式可以針對伺服器的回應做最大的優化，但相反的代價是可能造成更多記憶體的佔用，這邊舉例來說，假設 <code>pm.max_spare_servers = 10</code>、<code>pm.max_children = 20</code>，在某個尖峰時段，這時候最大數量的子程序 20 個都處於忙碌狀態，0個閒置的子程序，過了尖峰時段，請求下降，而當初忙碌的 20 個子程序目前處於閒置狀態，此時 PHP-FPM 只會 Kill 掉 10 個子程序，而最後剩下 10 個閒置的子程序來等待請求，這也就是會造成在尖峰後請求數大量減少後，記憶體卻沒有大量降低的主要原因，而如果把主機重啟，記憶體則會將得更低，這是因為重啟用子程序數量會變成最小閒置行程數量(<code>pm.min_spare_servers</code>)</p>\n<h4 id=\"ondemand-實際運作\"><a href=\"#ondemand-實際運作\" class=\"headerlink\" title=\"ondemand 實際運作\"></a>ondemand 實際運作</h4><p><code>pm = ondemand</code> 的運作方式與 dynamic 恰好相反，dynamic 針對伺服器的回應做最大的優化，而 ondemand 則是最佳化記憶體。</p>\n<p>而運作方式是，每個閒置的子程序在持續閒置超過 <code>pm.process_idle_timeout</code> 設定的時間，就會被 Kill 掉，這樣的模式讓主機在尖峰時期過後可以自然地降低記憶體的使用率，如果長時間都沒有請求連線時，只會有一個 PHP-FPM 主程序。</p>\n<p>那壞處則是，如果遇到尖峰時期，或 <code>pm.process_idle_timeout</code> 設定得太短的話，會造成伺服器頻繁的建立子程序，而造成效能不佳</p>\n<h2 id=\"pm-max-children-最大行程數量\"><a href=\"#pm-max-children-最大行程數量\" class=\"headerlink\" title=\"pm.max_children(最大行程數量)\"></a>pm.max_children(最大行程數量)</h2><p><code>pm.max_children</code> 參數在 <code>pm</code> 等於 <code>static</code> 即為開啟的行程數，而在 <code>dynamic</code> 與 <code>ondemand</code> 模式下，則是代表最大可開啟的行程數量。</p>\n<p>最大行程數量的多寡是根據本身主機的記憶體大小來決定，當記憶體越大時，就可以設定較多的行程數量。 此設定值如果設太小的話會造成處理請求的速度下降，設定太大的話會造成當機，因為記憶體耗盡，所以要依硬體資源來調較。</p>\n<p>可以利用以下指令去查詢行程使用的記憶體量</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ps -ylC php-fpm --sort:rss</span><br><span class=\"line\"></span><br><span class=\"line\">S   UID     PID    PPID  C PRI  NI   RSS    SZ WCHAN  TTY          TIME CMD</span><br><span class=\"line\">S     0       1       0  0  80   0  4760 20195 do_epo ?        00:02:11 php-fpm</span><br><span class=\"line\">S    33       9       1  0  80   0 20260 22581 -      ?        00:01:20 php-fpm</span><br><span class=\"line\">S    33       8       1  0  80   0 20464 22582 -      ?        00:01:42 php-fpm</span><br><span class=\"line\">S    33       7       1  0  80   0 20476 22584 -      ?        00:01:43 php-fpm</span><br></pre></td></tr></table></figure>\n\n<p>RSS 欄位為子程序使用的記憶體大小，單位為KB，20476 約莫 20MB，但是因為每個子程序所使用的記憶體大小都不太一樣，所以我們可以使用下面的指令來求出子程序平均使用記憶體大小</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ps --no-headers -o &quot;rss,cmd&quot; -C php-fpm | awk &#39;&#123; sum+&#x3D;$1 &#125; END &#123; printf (&quot;%d%s\\n&quot;, sum&#x2F;NR&#x2F;1024,&quot;Mb&quot;) &#125;&#39;</span><br></pre></td></tr></table></figure>\n\n<p>至於 <code>pm.max_children</code> 應該要設定多少才合理，以下有一個計算公式</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pm.max_children &#x3D; Total RAM &#x2F; Max child process size</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>這邊的 Total RAM 需要扣除已經使用的記憶體，例如系統或其他程序使用後所剩餘的記憶體</p>\n</blockquote>\n<h2 id=\"pm-start-servers-初始行程數量\"><a href=\"#pm-start-servers-初始行程數量\" class=\"headerlink\" title=\"pm.start_servers(初始行程數量)\"></a>pm.start_servers(初始行程數量)</h2><p><code>pm.start_servers</code> 可設定 PHP-FPM 服務在一開始啟動時，要配置多少個行程</p>\n<p><code>pm.start_servers</code> 同樣有一個計算公式可以參考</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pm.start_servers &#x3D; min_spare_servers + (max_spare_servers - min_spare_servers) &#x2F; 2</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"pm-min-spare-servers-最小閒置行程數量\"><a href=\"#pm-min-spare-servers-最小閒置行程數量\" class=\"headerlink\" title=\"pm.min_spare_servers(最小閒置行程數量)\"></a>pm.min_spare_servers(最小閒置行程數量)</h2><p><code>pm.min_spare_servers</code> 設定 PHP-FPM 最小閒置行程的數量</p>\n<h2 id=\"pm-max-spare-servers-最大閒置行程數量\"><a href=\"#pm-max-spare-servers-最大閒置行程數量\" class=\"headerlink\" title=\"pm.max_spare_servers(最大閒置行程數量)\"></a>pm.max_spare_servers(最大閒置行程數量)</h2><p><code>pm.max_spare_servers</code> 設定 PHP-FPM 最大閒置行程的數量</p>\n<blockquote>\n<p>這邊需要注意的是 <code>pm.max_spare_servers</code> 的值只能小於等於 <code>pm.max_children</code></p>\n</blockquote>\n<h2 id=\"pm-max-requests-單一行程可處理連線數\"><a href=\"#pm-max-requests-單一行程可處理連線數\" class=\"headerlink\" title=\"pm.max_requests(單一行程可處理連線數)\"></a>pm.max_requests(單一行程可處理連線數)</h2><p><code>pm.max_requests</code> 可設定單一 PHP-FPM 最多可以處理多少個連線，當一個行程處理的連線數達到設定值時，此行程會被 Kill 掉，而重新產生另一個新的行程</p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://kejyuntw.gitbooks.io/ubuntu-learning-notes/content/web/php/web-php-max-children.html\">https://kejyuntw.gitbooks.io/ubuntu-learning-notes/content/web/php/web-php-max-children.html</a></li>\n<li><a href=\"https://support.plesk.com/hc/en-us/articles/360011988053-How-to-calculate-pm-max-children-value-\">https://support.plesk.com/hc/en-us/articles/360011988053-How-to-calculate-pm-max-children-value-</a></li>\n<li><a href=\"https://www.mdeditor.tw/pl/p9Vf/zh-tw\">https://www.mdeditor.tw/pl/p9Vf/zh-tw</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>近期公司內部 PHP-FPM 有頂到一些行程相關的上限，導致網頁要處理後端程式時無法處理，進而造成服務異常。 而這樣子的問題不外乎可以從 LOG 去看到一些觸發到這個問題的根本原因是什麼。</p>\n<p>以下列了兩個行程不夠時常見的 Error Log</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WARNING: [pool www] server reached pm.max_children setting (5), consider raising it</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WARNING: [pool www] seems busy (you may need to increase pm.start_servers, or pm.min/max_spare_servers), spawning 32 children, there are 0 idle, and 19 total child</span><br></pre></td></tr></table></figure>","more":"<p>PHP-FPM 行程優化相關參數，以下為預設值，需要依照每台機器狀態不同去調教</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pm = dynamic</span><br><span class=\"line\">pm.max_children = 5</span><br><span class=\"line\">pm.start_servers = 2</span><br><span class=\"line\">pm.min_spare_servers = 1</span><br><span class=\"line\">pm.max_spare_servers = 3</span><br><span class=\"line\"></span><br><span class=\"line\">pm.max_requests = 500</span><br><span class=\"line\">pm.process_idle_timeout = 10s # 需搭配 pm = ondemand</span><br></pre></td></tr></table></figure>\n\n<p>以下會針對每個項目去解釋其用途</p>\n<h2 id=\"pm-Process-Manager\"><a href=\"#pm-Process-Manager\" class=\"headerlink\" title=\"pm (Process Manager)\"></a>pm (Process Manager)</h2><p>pm 為行程管理(Process Manager) 的縮寫，此參數主要是在設定 pm 要使用哪種模式來管理行程，可以區分兩大類型，共三種模式可以選擇，預設是使用 dynamic</p>\n<h3 id=\"固定行程數量\"><a href=\"#固定行程數量\" class=\"headerlink\" title=\"固定行程數量\"></a>固定行程數量</h3><ul>\n<li>static: 設定此模式，只有 <code>pm.max_children</code> 參數會生效，行程數量則根據 <code>pm.max_children</code>，效能較好，因為 child process 會保持一個固定的數量，但是比較佔記憶體，因為即便請求較少量時，依然會佔用，所以較不建議使用此模式</li>\n</ul>\n<h3 id=\"動態行程數量\"><a href=\"#動態行程數量\" class=\"headerlink\" title=\"動態行程數量\"></a>動態行程數量</h3><p>皆根據 <code>pm.max_children</code>、<code>pm.start_servers</code>、<code>pm.min_spare_servers</code>、<code>pm.max_spare_servers</code> 動態調整</p>\n<ul>\n<li>dynamic: 根據使用量用多寡開行程，但當使用量比較低時，會保留固定行程(根據 <code>pm.min_spare_servers</code> 或 <code>pm.max_spare_servers</code>)，隨時等著接收新的連線</li>\n<li>ondemand: 用多少量就開多少行程</li>\n</ul>\n<h4 id=\"dynamic-實際運作\"><a href=\"#dynamic-實際運作\" class=\"headerlink\" title=\"dynamic 實際運作\"></a>dynamic 實際運作</h4><p>當我們設定 <code>pm = dynamic</code> 並啟動時，首先會產生一定數量的行程(根據 <code>pm.start_servers</code>)，此參數可以想像成是最小數量的子程序，而最大數量的子程序則根據 <code>pm.max_children</code>，有了最大和最小子程序數量，也就是說服務過程中子程序數量會在最大和最小子程序數量間變化。</p>\n<p>而閒置的子程序數量則由 <code>pm.min_spare_servers</code>、<code>pm.max_spare_servers</code> 控制，超過 <code>pm.max_spare_servers</code> 的閒置子程序則會被 Kill。</p>\n<p>因為 dynamic 模式可以針對伺服器的回應做最大的優化，但相反的代價是可能造成更多記憶體的佔用，這邊舉例來說，假設 <code>pm.max_spare_servers = 10</code>、<code>pm.max_children = 20</code>，在某個尖峰時段，這時候最大數量的子程序 20 個都處於忙碌狀態，0個閒置的子程序，過了尖峰時段，請求下降，而當初忙碌的 20 個子程序目前處於閒置狀態，此時 PHP-FPM 只會 Kill 掉 10 個子程序，而最後剩下 10 個閒置的子程序來等待請求，這也就是會造成在尖峰後請求數大量減少後，記憶體卻沒有大量降低的主要原因，而如果把主機重啟，記憶體則會將得更低，這是因為重啟用子程序數量會變成最小閒置行程數量(<code>pm.min_spare_servers</code>)</p>\n<h4 id=\"ondemand-實際運作\"><a href=\"#ondemand-實際運作\" class=\"headerlink\" title=\"ondemand 實際運作\"></a>ondemand 實際運作</h4><p><code>pm = ondemand</code> 的運作方式與 dynamic 恰好相反，dynamic 針對伺服器的回應做最大的優化，而 ondemand 則是最佳化記憶體。</p>\n<p>而運作方式是，每個閒置的子程序在持續閒置超過 <code>pm.process_idle_timeout</code> 設定的時間，就會被 Kill 掉，這樣的模式讓主機在尖峰時期過後可以自然地降低記憶體的使用率，如果長時間都沒有請求連線時，只會有一個 PHP-FPM 主程序。</p>\n<p>那壞處則是，如果遇到尖峰時期，或 <code>pm.process_idle_timeout</code> 設定得太短的話，會造成伺服器頻繁的建立子程序，而造成效能不佳</p>\n<h2 id=\"pm-max-children-最大行程數量\"><a href=\"#pm-max-children-最大行程數量\" class=\"headerlink\" title=\"pm.max_children(最大行程數量)\"></a>pm.max_children(最大行程數量)</h2><p><code>pm.max_children</code> 參數在 <code>pm</code> 等於 <code>static</code> 即為開啟的行程數，而在 <code>dynamic</code> 與 <code>ondemand</code> 模式下，則是代表最大可開啟的行程數量。</p>\n<p>最大行程數量的多寡是根據本身主機的記憶體大小來決定，當記憶體越大時，就可以設定較多的行程數量。 此設定值如果設太小的話會造成處理請求的速度下降，設定太大的話會造成當機，因為記憶體耗盡，所以要依硬體資源來調較。</p>\n<p>可以利用以下指令去查詢行程使用的記憶體量</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ps -ylC php-fpm --sort:rss</span><br><span class=\"line\"></span><br><span class=\"line\">S   UID     PID    PPID  C PRI  NI   RSS    SZ WCHAN  TTY          TIME CMD</span><br><span class=\"line\">S     0       1       0  0  80   0  4760 20195 do_epo ?        00:02:11 php-fpm</span><br><span class=\"line\">S    33       9       1  0  80   0 20260 22581 -      ?        00:01:20 php-fpm</span><br><span class=\"line\">S    33       8       1  0  80   0 20464 22582 -      ?        00:01:42 php-fpm</span><br><span class=\"line\">S    33       7       1  0  80   0 20476 22584 -      ?        00:01:43 php-fpm</span><br></pre></td></tr></table></figure>\n\n<p>RSS 欄位為子程序使用的記憶體大小，單位為KB，20476 約莫 20MB，但是因為每個子程序所使用的記憶體大小都不太一樣，所以我們可以使用下面的指令來求出子程序平均使用記憶體大小</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ps --no-headers -o &quot;rss,cmd&quot; -C php-fpm | awk &#39;&#123; sum+&#x3D;$1 &#125; END &#123; printf (&quot;%d%s\\n&quot;, sum&#x2F;NR&#x2F;1024,&quot;Mb&quot;) &#125;&#39;</span><br></pre></td></tr></table></figure>\n\n<p>至於 <code>pm.max_children</code> 應該要設定多少才合理，以下有一個計算公式</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pm.max_children &#x3D; Total RAM &#x2F; Max child process size</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>這邊的 Total RAM 需要扣除已經使用的記憶體，例如系統或其他程序使用後所剩餘的記憶體</p>\n</blockquote>\n<h2 id=\"pm-start-servers-初始行程數量\"><a href=\"#pm-start-servers-初始行程數量\" class=\"headerlink\" title=\"pm.start_servers(初始行程數量)\"></a>pm.start_servers(初始行程數量)</h2><p><code>pm.start_servers</code> 可設定 PHP-FPM 服務在一開始啟動時，要配置多少個行程</p>\n<p><code>pm.start_servers</code> 同樣有一個計算公式可以參考</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pm.start_servers &#x3D; min_spare_servers + (max_spare_servers - min_spare_servers) &#x2F; 2</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"pm-min-spare-servers-最小閒置行程數量\"><a href=\"#pm-min-spare-servers-最小閒置行程數量\" class=\"headerlink\" title=\"pm.min_spare_servers(最小閒置行程數量)\"></a>pm.min_spare_servers(最小閒置行程數量)</h2><p><code>pm.min_spare_servers</code> 設定 PHP-FPM 最小閒置行程的數量</p>\n<h2 id=\"pm-max-spare-servers-最大閒置行程數量\"><a href=\"#pm-max-spare-servers-最大閒置行程數量\" class=\"headerlink\" title=\"pm.max_spare_servers(最大閒置行程數量)\"></a>pm.max_spare_servers(最大閒置行程數量)</h2><p><code>pm.max_spare_servers</code> 設定 PHP-FPM 最大閒置行程的數量</p>\n<blockquote>\n<p>這邊需要注意的是 <code>pm.max_spare_servers</code> 的值只能小於等於 <code>pm.max_children</code></p>\n</blockquote>\n<h2 id=\"pm-max-requests-單一行程可處理連線數\"><a href=\"#pm-max-requests-單一行程可處理連線數\" class=\"headerlink\" title=\"pm.max_requests(單一行程可處理連線數)\"></a>pm.max_requests(單一行程可處理連線數)</h2><p><code>pm.max_requests</code> 可設定單一 PHP-FPM 最多可以處理多少個連線，當一個行程處理的連線數達到設定值時，此行程會被 Kill 掉，而重新產生另一個新的行程</p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://kejyuntw.gitbooks.io/ubuntu-learning-notes/content/web/php/web-php-max-children.html\">https://kejyuntw.gitbooks.io/ubuntu-learning-notes/content/web/php/web-php-max-children.html</a></li>\n<li><a href=\"https://support.plesk.com/hc/en-us/articles/360011988053-How-to-calculate-pm-max-children-value-\">https://support.plesk.com/hc/en-us/articles/360011988053-How-to-calculate-pm-max-children-value-</a></li>\n<li><a href=\"https://www.mdeditor.tw/pl/p9Vf/zh-tw\">https://www.mdeditor.tw/pl/p9Vf/zh-tw</a></li>\n</ul>"},{"title":"SSH 連線出現「WARNING:REMOTE HOST IDENTIFICATION HAS CHANGED!」","abbrlink":"67cc021f","date":"2021-08-09T02:48:45.000Z","_content":"\n\n## 前言\n\n在 Linux 環境中，我們常常使用 SSH 來與目標主機做連線，有時候因為目標主機的異動而導致我們後續連線時會出現 WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED這樣子的警示訊息，導致我們無法順利連線，為何會有這樣子的訊息，又該如何解決，可以參考以下內容\n\n<!--more-->\n\n## 連線原理\n\nSSH 連接遠端主機時，會檢查主機的 Public key，如果是第一次連線該主機，會顯示該主機的 public key fingerprint，詢問使用者信任該主機並繼續連線\n\n> A public key fingerprint is a short sequence of bytes used to identify a longer public key.\n\n```text\nThe authenticity of host '192.168.26.11 (192.168.26.11)' can't be established.\nRSA key fingerprint is a3:ca:ad:95:a1:45:d2:57:3a:e9:e7:75:a8:4c:1f:9f.\nAre you sure you want to continue connecting (yes/no)?\n```\n\n當選擇 yes，就會將該主機的 Public key 追加到本機 `~/.ssh/known_hosts` 中，當第二次連到該台主機時，就不會再出現相關訊息\n\n## 解決方式\n\n這樣子的 Public key 檢查是一個重要的安全機制，可以防範中間人攻擊等問題，但有時候因爲某些原因，導致該 IP 的 Public key 改變了，這時候使用 SSH 連線時，會出現以下錯誤訊息\n\n```text\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\nIT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!\nSomeone could be eavesdropping on you right now (man-in-the-middle attack)!\nIt is also possible that the RSA host key has just been changed.\nThe fingerprint for the RSA key sent by the remote host is\ne9:0c:36:89:7f:3c:07:71:09:5a:9f:28:8c:44:e9:05.\nPlease contact your system administrator.\nAdd correct host key in /home/tonyjhang/.ssh/known_hosts to get rid of this message.\nOffending key in /home/tonyjhang/.ssh/known_hosts:81\nRSA host key for 192.168.26.11 has changed and you have requested strict checking.\nHost key verification failed.\n```\n\n有三種解決方式\n\n1. 根據上述訊息，將第 81 行刪除，重新連線，主機會重新傳送一份 public key fingerprint\n\n```text\nOffending key in /home/tonyjhang/.ssh/known_hosts:81\n```\n\n2. 把整個 `~/.ssh/known_hosts` 刪除，這是最「不建議」的做法，可能會導致自動化失效或連線到其他主機的問題\n3. 使用 `ssh-keygen -R` 的指令，將 `~/.ssh/known_hosts` 內的所有資訊，轉存一份到 `~/.ssh/known_hosts.old`，並且將 `~/.ssh/known_hosts` 內的目標主機項目移除，使用方式如下\n\n```bash\n$ ssh-keygen -R 192.168.26.11\n\n# Host 192.168.26.11 found: line 60\n/Users/tony_jhang/.ssh/known_hosts updated.\nOriginal contents retained as /Users/tony_jhang/.ssh/known_hosts.old\n```\n\n> Original contents retained as /Users/tony_jhang/.ssh/known_hosts.old → 原始內容有被保存到 known_hosts.old\n\n## 參考資料\n\n- https://en.wikipedia.org/wiki/Public_key_fingerprint\n","source":"_posts/ssh-connect-alert.md","raw":"---\ntitle: 'SSH 連線出現「WARNING:REMOTE HOST IDENTIFICATION HAS CHANGED!」'\ntags:\n  - Linux\n  - SSH\n  - fingerprint\n  - known_hosts\ncategories:\n  - Linux\nabbrlink: 67cc021f\ndate: 2021-08-09 10:48:45\n---\n\n\n## 前言\n\n在 Linux 環境中，我們常常使用 SSH 來與目標主機做連線，有時候因為目標主機的異動而導致我們後續連線時會出現 WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED這樣子的警示訊息，導致我們無法順利連線，為何會有這樣子的訊息，又該如何解決，可以參考以下內容\n\n<!--more-->\n\n## 連線原理\n\nSSH 連接遠端主機時，會檢查主機的 Public key，如果是第一次連線該主機，會顯示該主機的 public key fingerprint，詢問使用者信任該主機並繼續連線\n\n> A public key fingerprint is a short sequence of bytes used to identify a longer public key.\n\n```text\nThe authenticity of host '192.168.26.11 (192.168.26.11)' can't be established.\nRSA key fingerprint is a3:ca:ad:95:a1:45:d2:57:3a:e9:e7:75:a8:4c:1f:9f.\nAre you sure you want to continue connecting (yes/no)?\n```\n\n當選擇 yes，就會將該主機的 Public key 追加到本機 `~/.ssh/known_hosts` 中，當第二次連到該台主機時，就不會再出現相關訊息\n\n## 解決方式\n\n這樣子的 Public key 檢查是一個重要的安全機制，可以防範中間人攻擊等問題，但有時候因爲某些原因，導致該 IP 的 Public key 改變了，這時候使用 SSH 連線時，會出現以下錯誤訊息\n\n```text\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\nIT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!\nSomeone could be eavesdropping on you right now (man-in-the-middle attack)!\nIt is also possible that the RSA host key has just been changed.\nThe fingerprint for the RSA key sent by the remote host is\ne9:0c:36:89:7f:3c:07:71:09:5a:9f:28:8c:44:e9:05.\nPlease contact your system administrator.\nAdd correct host key in /home/tonyjhang/.ssh/known_hosts to get rid of this message.\nOffending key in /home/tonyjhang/.ssh/known_hosts:81\nRSA host key for 192.168.26.11 has changed and you have requested strict checking.\nHost key verification failed.\n```\n\n有三種解決方式\n\n1. 根據上述訊息，將第 81 行刪除，重新連線，主機會重新傳送一份 public key fingerprint\n\n```text\nOffending key in /home/tonyjhang/.ssh/known_hosts:81\n```\n\n2. 把整個 `~/.ssh/known_hosts` 刪除，這是最「不建議」的做法，可能會導致自動化失效或連線到其他主機的問題\n3. 使用 `ssh-keygen -R` 的指令，將 `~/.ssh/known_hosts` 內的所有資訊，轉存一份到 `~/.ssh/known_hosts.old`，並且將 `~/.ssh/known_hosts` 內的目標主機項目移除，使用方式如下\n\n```bash\n$ ssh-keygen -R 192.168.26.11\n\n# Host 192.168.26.11 found: line 60\n/Users/tony_jhang/.ssh/known_hosts updated.\nOriginal contents retained as /Users/tony_jhang/.ssh/known_hosts.old\n```\n\n> Original contents retained as /Users/tony_jhang/.ssh/known_hosts.old → 原始內容有被保存到 known_hosts.old\n\n## 參考資料\n\n- https://en.wikipedia.org/wiki/Public_key_fingerprint\n","slug":"ssh-connect-alert","published":1,"updated":"2024-09-09T07:17:02.666Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5jf0027k0lz4hin7w69","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在 Linux 環境中，我們常常使用 SSH 來與目標主機做連線，有時候因為目標主機的異動而導致我們後續連線時會出現 WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED這樣子的警示訊息，導致我們無法順利連線，為何會有這樣子的訊息，又該如何解決，可以參考以下內容</p>\n<span id=\"more\"></span>\n\n<h2 id=\"連線原理\"><a href=\"#連線原理\" class=\"headerlink\" title=\"連線原理\"></a>連線原理</h2><p>SSH 連接遠端主機時，會檢查主機的 Public key，如果是第一次連線該主機，會顯示該主機的 public key fingerprint，詢問使用者信任該主機並繼續連線</p>\n<blockquote>\n<p>A public key fingerprint is a short sequence of bytes used to identify a longer public key.</p>\n</blockquote>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">The authenticity of host &#x27;192.168.26.11 (192.168.26.11)&#x27; can&#x27;t be established.</span><br><span class=\"line\">RSA key fingerprint is a3:ca:ad:95:a1:45:d2:57:3a:e9:e7:75:a8:4c:1f:9f.</span><br><span class=\"line\">Are you sure you want to continue connecting (yes/no)?</span><br></pre></td></tr></table></figure>\n\n<p>當選擇 yes，就會將該主機的 Public key 追加到本機 <code>~/.ssh/known_hosts</code> 中，當第二次連到該台主機時，就不會再出現相關訊息</p>\n<h2 id=\"解決方式\"><a href=\"#解決方式\" class=\"headerlink\" title=\"解決方式\"></a>解決方式</h2><p>這樣子的 Public key 檢查是一個重要的安全機制，可以防範中間人攻擊等問題，但有時候因爲某些原因，導致該 IP 的 Public key 改變了，這時候使用 SSH 連線時，會出現以下錯誤訊息</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class=\"line\">@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class=\"line\">IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!</span><br><span class=\"line\">Someone could be eavesdropping on you right now (man-in-the-middle attack)!</span><br><span class=\"line\">It is also possible that the RSA host key has just been changed.</span><br><span class=\"line\">The fingerprint for the RSA key sent by the remote host is</span><br><span class=\"line\">e9:0c:36:89:7f:3c:07:71:09:5a:9f:28:8c:44:e9:05.</span><br><span class=\"line\">Please contact your system administrator.</span><br><span class=\"line\">Add correct host key in /home/tonyjhang/.ssh/known_hosts to get rid of this message.</span><br><span class=\"line\">Offending key in /home/tonyjhang/.ssh/known_hosts:81</span><br><span class=\"line\">RSA host key for 192.168.26.11 has changed and you have requested strict checking.</span><br><span class=\"line\">Host key verification failed.</span><br></pre></td></tr></table></figure>\n\n<p>有三種解決方式</p>\n<ol>\n<li>根據上述訊息，將第 81 行刪除，重新連線，主機會重新傳送一份 public key fingerprint</li>\n</ol>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Offending key in /home/tonyjhang/.ssh/known_hosts:81</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>把整個 <code>~/.ssh/known_hosts</code> 刪除，這是最「不建議」的做法，可能會導致自動化失效或連線到其他主機的問題</li>\n<li>使用 <code>ssh-keygen -R</code> 的指令，將 <code>~/.ssh/known_hosts</code> 內的所有資訊，轉存一份到 <code>~/.ssh/known_hosts.old</code>，並且將 <code>~/.ssh/known_hosts</code> 內的目標主機項目移除，使用方式如下</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ssh-keygen -R 192.168.26.11</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Host 192.168.26.11 found: line 60</span></span><br><span class=\"line\">/Users/tony_jhang/.ssh/known_hosts updated.</span><br><span class=\"line\">Original contents retained as /Users/tony_jhang/.ssh/known_hosts.old</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Original contents retained as /Users/tony_jhang/.ssh/known_hosts.old → 原始內容有被保存到 known_hosts.old</p>\n</blockquote>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://en.wikipedia.org/wiki/Public_key_fingerprint\">https://en.wikipedia.org/wiki/Public_key_fingerprint</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在 Linux 環境中，我們常常使用 SSH 來與目標主機做連線，有時候因為目標主機的異動而導致我們後續連線時會出現 WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED這樣子的警示訊息，導致我們無法順利連線，為何會有這樣子的訊息，又該如何解決，可以參考以下內容</p>","more":"<h2 id=\"連線原理\"><a href=\"#連線原理\" class=\"headerlink\" title=\"連線原理\"></a>連線原理</h2><p>SSH 連接遠端主機時，會檢查主機的 Public key，如果是第一次連線該主機，會顯示該主機的 public key fingerprint，詢問使用者信任該主機並繼續連線</p>\n<blockquote>\n<p>A public key fingerprint is a short sequence of bytes used to identify a longer public key.</p>\n</blockquote>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">The authenticity of host &#x27;192.168.26.11 (192.168.26.11)&#x27; can&#x27;t be established.</span><br><span class=\"line\">RSA key fingerprint is a3:ca:ad:95:a1:45:d2:57:3a:e9:e7:75:a8:4c:1f:9f.</span><br><span class=\"line\">Are you sure you want to continue connecting (yes/no)?</span><br></pre></td></tr></table></figure>\n\n<p>當選擇 yes，就會將該主機的 Public key 追加到本機 <code>~/.ssh/known_hosts</code> 中，當第二次連到該台主機時，就不會再出現相關訊息</p>\n<h2 id=\"解決方式\"><a href=\"#解決方式\" class=\"headerlink\" title=\"解決方式\"></a>解決方式</h2><p>這樣子的 Public key 檢查是一個重要的安全機制，可以防範中間人攻擊等問題，但有時候因爲某些原因，導致該 IP 的 Public key 改變了，這時候使用 SSH 連線時，會出現以下錯誤訊息</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class=\"line\">@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class=\"line\">IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!</span><br><span class=\"line\">Someone could be eavesdropping on you right now (man-in-the-middle attack)!</span><br><span class=\"line\">It is also possible that the RSA host key has just been changed.</span><br><span class=\"line\">The fingerprint for the RSA key sent by the remote host is</span><br><span class=\"line\">e9:0c:36:89:7f:3c:07:71:09:5a:9f:28:8c:44:e9:05.</span><br><span class=\"line\">Please contact your system administrator.</span><br><span class=\"line\">Add correct host key in /home/tonyjhang/.ssh/known_hosts to get rid of this message.</span><br><span class=\"line\">Offending key in /home/tonyjhang/.ssh/known_hosts:81</span><br><span class=\"line\">RSA host key for 192.168.26.11 has changed and you have requested strict checking.</span><br><span class=\"line\">Host key verification failed.</span><br></pre></td></tr></table></figure>\n\n<p>有三種解決方式</p>\n<ol>\n<li>根據上述訊息，將第 81 行刪除，重新連線，主機會重新傳送一份 public key fingerprint</li>\n</ol>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Offending key in /home/tonyjhang/.ssh/known_hosts:81</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>把整個 <code>~/.ssh/known_hosts</code> 刪除，這是最「不建議」的做法，可能會導致自動化失效或連線到其他主機的問題</li>\n<li>使用 <code>ssh-keygen -R</code> 的指令，將 <code>~/.ssh/known_hosts</code> 內的所有資訊，轉存一份到 <code>~/.ssh/known_hosts.old</code>，並且將 <code>~/.ssh/known_hosts</code> 內的目標主機項目移除，使用方式如下</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ssh-keygen -R 192.168.26.11</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Host 192.168.26.11 found: line 60</span></span><br><span class=\"line\">/Users/tony_jhang/.ssh/known_hosts updated.</span><br><span class=\"line\">Original contents retained as /Users/tony_jhang/.ssh/known_hosts.old</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Original contents retained as /Users/tony_jhang/.ssh/known_hosts.old → 原始內容有被保存到 known_hosts.old</p>\n</blockquote>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://en.wikipedia.org/wiki/Public_key_fingerprint\">https://en.wikipedia.org/wiki/Public_key_fingerprint</a></li>\n</ul>"},{"title":"TIME_WAIT狀態如何產生","abbrlink":"ab6fcbda","date":"2021-08-17T07:29:31.000Z","_content":"\n\n## 前言\n\n之前 Maintain A團隊的 K8s 時，有發生過 golang 寫的服務太多的 TIME_WAIT 導致 Pod 無法建立新的連線。 近期 Maintain B團隊的服務時，因為線上人數變多，擔心 Nginx 向 Upstream 發請求時，會不會造成太多的連線，然後有過多的 TIME_WAIT 現象，因為預設 Nginx 向 Upstream 發送請求是使用 http/1.0，會導致連線無法複用，所以當連線一多時，就很容易發生過多的 TIME_WAIT 狀態。\n\n所以本篇主要是在講解 TCP 協定在「建立連線」與「關閉連線」的過程，只要了解運作過程，就會知道 TIME_WAIT 狀態到底是如何產生的\n\n<!--more-->\n\n## TCP 建立連線\n\n依據 IETF 的標準文件 [rfc793](http://www.rfc-editor.org/rfc/rfc793.txt) 中所描述的情形，可分為以下四種不同狀況\n\n- Basic 3-Way Handshake for Connection Synchronization\n- Simultaneous Connection Synchronization\n- Recovery from Old Duplicate SYN\n- Half-Open Connection Discovery\n\n以下僅針對第一個 Basic 3-Way Handshake for Connection Synchronization 進行說明\n\n通常 TCP 連線建立流程，需要經過三向交握(three-way handshaking) 來建立連線\n\n![](mk-20240119120657.png)\n\n1. Server 建立 TCB，開啟監聽連線，進入 LISTENING 狀態\n2. Client 主動發出連線請求 SYN，進入 SYN_SENT 狀態，並等待回應\n3. Server 收到 SYN 要求，回應連線 SYN,ACK，並進入 SYN_RCVD 狀態\n4. Client 收到 SYN,ACK 確認完成連線進入 ESTABLISHED 狀態，並送出 ACK\n5. Server 收到 ACK 確認連線完成，同時也進入 ESTABLISHED 狀態\n\n名詞解釋：\n- CLOSED：已關閉連線，表示該主機的連線呈現關閉中\n- LISTENING：監聽狀態，表示該主機被動等待連線請求\n- SYN_SENT：表示已送出 SYN 訊息，並等待對方回應\n- SYN_RCVD：表示已接收到對方的 SYN 訊息，並且送出 SYN,ACK，等待對方回應\n- ESTABLISHED：表示已完成雙方連線的建立，可開始傳輸資料\n- TCB：傳輸控制區塊(Transmission Control Block)，用來儲存 Server 端有關 TCP 的所有資訊\n- SYN：Synchronous，表示與對方建立連線的請求\n- ACK：Acknowledgement，表示發送的數據已收到無誤\n\n「TCP建立連線」狀態流程圖\n\n![](mk-20240119120730.png)\n\n## TCP 關閉連線\n\n依據 IETF 的標準文件 [rfc793](http://www.rfc-editor.org/rfc/rfc793.txt) 中所描述的情形，可分為以下二種不同狀況\n\n- Normal Close Sequence\n- Simultaneous Close Sequence\n\n以下僅針對第一個 Normal Close Sequence 進行說明\n\nTCP 關閉流程如下，需要經過四次交握 (four-way handshaking)，來確認雙方都停止收發數據，**要注意的是可以是由 server 發起主動關閉，或是 client 發起主動關閉**，但是「通常」都是 client 發起，因此下圖使用 TCP A 與 TCP B 表示，：\n\n![](mk-20240119120822.png)\n\n1. TCP A：準備關閉連線，發出 FIN，進入 FIN_WAIT_1 狀態\n2. TCP B：收到 FIN，並回傳 ACK，進入 CLOSE_WAIT 狀態，並通知 Application 連線準備關閉\n3. TCP A：收到 ACK，進入 FIN_WAIT_2 狀態，並等待對方發出 FIN\n4. TCP B：確認 Application 處理完斷線請求，發出 FIN，並進入狀態 LAST_ACK\n5. TCP A：收到 FIN，並回傳 ACK，進入 TIME_WAIT 狀態，等待 2MSL 時間後正式關閉連線\n6. TCP B：收到 ACK，便直接關閉連線，進入 CLOSED 狀態\n\n名詞解釋：\n- ESTABLISHED：表示已完成雙方連線的建立，可開始傳輸資料\n- CLOSE_WAIT：等待連線關閉狀態，等待 Application 回應\n- LAST_ACK：等待連線關閉狀態，等待對方回傳 ACK 後關閉連線\n- FIN_WAIT_1：等待連線關閉狀態，等待對方回傳 ACK\n- FIN_WAIT_2：等待連線關閉狀態，等待對方回傳 FIN\n- TIME_WAIT：等待2MSL，保證遠端有收到其 ACK 關閉連線 (網路延遲問題)\n- CLOSED：已關閉連線\n- FIN：FINISH，表示關閉連線的請求\n- ACK：Acknowledgement，表示發送的數據已收到無誤\n\n「TCP關閉連線」狀態流程圖\n\n![](mk-20240119120856.png)\n\n最後發送 ACK 時，會進入 TIME_WAIT 狀態，要等 2MSL 時間後，這條連接才真正消失，所以從這邊知道「主動關閉連線」的一方會進入 TIME_WAIT 狀態\n\n> 什麼是 MSL 時間\n> 最大分段壽命 MSL(Maximum Segment Lifetime)，是 TCP 協定規定封包在網絡中最長生存時間，超出時間後封包就會被丟棄。\n>\n> RFC793 定義 MSL 為 2 分鐘，不過實際上不同的作業系統可能有不同的設定，以 Linux 為例，通常是 30 秒，2MSL 就是 60 秒\n\n## 為何 TIME_WAIT 狀態要等待 2MSL 的時間呢?\n\nClient/Server 都完成了四次交握，代表 Client/Server 都同意關閉連線，照理說應該可以直接回到 CLOSED 狀態(就像是建立連線時 SYN_SEND 狀態到 ESTABLISH 狀態那樣)，但是這邊我們必須要假設網路傳輸是不可靠的，因為我們無法保證最後傳送的 ACK 對方一定會收到，傳輸過程中可能因為種種原因(例如：網路延遲、丟包等...) 導致對方一直處於 LAST_ACK 狀態下的 SOCKET 因為逾時而未收到 ACK 而重發 FIN，所以 TIME_WAIT 狀態的作用就是用來重發可能遺失的 ACK。\n\nTIME_WAIT 狀態，是為了避免因為網路傳輸的種種原因而造成的 TCP 傳輸不可靠，而 TIME_WAIT 狀態可以最大限度的提升網路傳輸的可靠性。\n\n## 完整 TCP「建立連線」與「關閉連線」之狀態圖\n\n![](mk-20240119120922.png)\n\n## 參考資料\n\n- https://dev.twsiyuan.com/2017/09/tcp-states.html\n- https://www.gushiciku.cn/pl/p0aJ/zh-tw\n","source":"_posts/tcp-ip-time-wait.md","raw":"---\ntitle: TIME_WAIT狀態如何產生\ntags:\n  - TCP\ncategories: TCP/IP\nabbrlink: ab6fcbda\ndate: 2021-08-17 15:29:31\n---\n\n\n## 前言\n\n之前 Maintain A團隊的 K8s 時，有發生過 golang 寫的服務太多的 TIME_WAIT 導致 Pod 無法建立新的連線。 近期 Maintain B團隊的服務時，因為線上人數變多，擔心 Nginx 向 Upstream 發請求時，會不會造成太多的連線，然後有過多的 TIME_WAIT 現象，因為預設 Nginx 向 Upstream 發送請求是使用 http/1.0，會導致連線無法複用，所以當連線一多時，就很容易發生過多的 TIME_WAIT 狀態。\n\n所以本篇主要是在講解 TCP 協定在「建立連線」與「關閉連線」的過程，只要了解運作過程，就會知道 TIME_WAIT 狀態到底是如何產生的\n\n<!--more-->\n\n## TCP 建立連線\n\n依據 IETF 的標準文件 [rfc793](http://www.rfc-editor.org/rfc/rfc793.txt) 中所描述的情形，可分為以下四種不同狀況\n\n- Basic 3-Way Handshake for Connection Synchronization\n- Simultaneous Connection Synchronization\n- Recovery from Old Duplicate SYN\n- Half-Open Connection Discovery\n\n以下僅針對第一個 Basic 3-Way Handshake for Connection Synchronization 進行說明\n\n通常 TCP 連線建立流程，需要經過三向交握(three-way handshaking) 來建立連線\n\n![](mk-20240119120657.png)\n\n1. Server 建立 TCB，開啟監聽連線，進入 LISTENING 狀態\n2. Client 主動發出連線請求 SYN，進入 SYN_SENT 狀態，並等待回應\n3. Server 收到 SYN 要求，回應連線 SYN,ACK，並進入 SYN_RCVD 狀態\n4. Client 收到 SYN,ACK 確認完成連線進入 ESTABLISHED 狀態，並送出 ACK\n5. Server 收到 ACK 確認連線完成，同時也進入 ESTABLISHED 狀態\n\n名詞解釋：\n- CLOSED：已關閉連線，表示該主機的連線呈現關閉中\n- LISTENING：監聽狀態，表示該主機被動等待連線請求\n- SYN_SENT：表示已送出 SYN 訊息，並等待對方回應\n- SYN_RCVD：表示已接收到對方的 SYN 訊息，並且送出 SYN,ACK，等待對方回應\n- ESTABLISHED：表示已完成雙方連線的建立，可開始傳輸資料\n- TCB：傳輸控制區塊(Transmission Control Block)，用來儲存 Server 端有關 TCP 的所有資訊\n- SYN：Synchronous，表示與對方建立連線的請求\n- ACK：Acknowledgement，表示發送的數據已收到無誤\n\n「TCP建立連線」狀態流程圖\n\n![](mk-20240119120730.png)\n\n## TCP 關閉連線\n\n依據 IETF 的標準文件 [rfc793](http://www.rfc-editor.org/rfc/rfc793.txt) 中所描述的情形，可分為以下二種不同狀況\n\n- Normal Close Sequence\n- Simultaneous Close Sequence\n\n以下僅針對第一個 Normal Close Sequence 進行說明\n\nTCP 關閉流程如下，需要經過四次交握 (four-way handshaking)，來確認雙方都停止收發數據，**要注意的是可以是由 server 發起主動關閉，或是 client 發起主動關閉**，但是「通常」都是 client 發起，因此下圖使用 TCP A 與 TCP B 表示，：\n\n![](mk-20240119120822.png)\n\n1. TCP A：準備關閉連線，發出 FIN，進入 FIN_WAIT_1 狀態\n2. TCP B：收到 FIN，並回傳 ACK，進入 CLOSE_WAIT 狀態，並通知 Application 連線準備關閉\n3. TCP A：收到 ACK，進入 FIN_WAIT_2 狀態，並等待對方發出 FIN\n4. TCP B：確認 Application 處理完斷線請求，發出 FIN，並進入狀態 LAST_ACK\n5. TCP A：收到 FIN，並回傳 ACK，進入 TIME_WAIT 狀態，等待 2MSL 時間後正式關閉連線\n6. TCP B：收到 ACK，便直接關閉連線，進入 CLOSED 狀態\n\n名詞解釋：\n- ESTABLISHED：表示已完成雙方連線的建立，可開始傳輸資料\n- CLOSE_WAIT：等待連線關閉狀態，等待 Application 回應\n- LAST_ACK：等待連線關閉狀態，等待對方回傳 ACK 後關閉連線\n- FIN_WAIT_1：等待連線關閉狀態，等待對方回傳 ACK\n- FIN_WAIT_2：等待連線關閉狀態，等待對方回傳 FIN\n- TIME_WAIT：等待2MSL，保證遠端有收到其 ACK 關閉連線 (網路延遲問題)\n- CLOSED：已關閉連線\n- FIN：FINISH，表示關閉連線的請求\n- ACK：Acknowledgement，表示發送的數據已收到無誤\n\n「TCP關閉連線」狀態流程圖\n\n![](mk-20240119120856.png)\n\n最後發送 ACK 時，會進入 TIME_WAIT 狀態，要等 2MSL 時間後，這條連接才真正消失，所以從這邊知道「主動關閉連線」的一方會進入 TIME_WAIT 狀態\n\n> 什麼是 MSL 時間\n> 最大分段壽命 MSL(Maximum Segment Lifetime)，是 TCP 協定規定封包在網絡中最長生存時間，超出時間後封包就會被丟棄。\n>\n> RFC793 定義 MSL 為 2 分鐘，不過實際上不同的作業系統可能有不同的設定，以 Linux 為例，通常是 30 秒，2MSL 就是 60 秒\n\n## 為何 TIME_WAIT 狀態要等待 2MSL 的時間呢?\n\nClient/Server 都完成了四次交握，代表 Client/Server 都同意關閉連線，照理說應該可以直接回到 CLOSED 狀態(就像是建立連線時 SYN_SEND 狀態到 ESTABLISH 狀態那樣)，但是這邊我們必須要假設網路傳輸是不可靠的，因為我們無法保證最後傳送的 ACK 對方一定會收到，傳輸過程中可能因為種種原因(例如：網路延遲、丟包等...) 導致對方一直處於 LAST_ACK 狀態下的 SOCKET 因為逾時而未收到 ACK 而重發 FIN，所以 TIME_WAIT 狀態的作用就是用來重發可能遺失的 ACK。\n\nTIME_WAIT 狀態，是為了避免因為網路傳輸的種種原因而造成的 TCP 傳輸不可靠，而 TIME_WAIT 狀態可以最大限度的提升網路傳輸的可靠性。\n\n## 完整 TCP「建立連線」與「關閉連線」之狀態圖\n\n![](mk-20240119120922.png)\n\n## 參考資料\n\n- https://dev.twsiyuan.com/2017/09/tcp-states.html\n- https://www.gushiciku.cn/pl/p0aJ/zh-tw\n","slug":"tcp-ip-time-wait","published":1,"updated":"2024-09-09T07:17:02.666Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoc5jg002ak0lz5w4i7frh","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>之前 Maintain A團隊的 K8s 時，有發生過 golang 寫的服務太多的 TIME_WAIT 導致 Pod 無法建立新的連線。 近期 Maintain B團隊的服務時，因為線上人數變多，擔心 Nginx 向 Upstream 發請求時，會不會造成太多的連線，然後有過多的 TIME_WAIT 現象，因為預設 Nginx 向 Upstream 發送請求是使用 http/1.0，會導致連線無法複用，所以當連線一多時，就很容易發生過多的 TIME_WAIT 狀態。</p>\n<p>所以本篇主要是在講解 TCP 協定在「建立連線」與「關閉連線」的過程，只要了解運作過程，就會知道 TIME_WAIT 狀態到底是如何產生的</p>\n<span id=\"more\"></span>\n\n<h2 id=\"TCP-建立連線\"><a href=\"#TCP-建立連線\" class=\"headerlink\" title=\"TCP 建立連線\"></a>TCP 建立連線</h2><p>依據 IETF 的標準文件 <a href=\"http://www.rfc-editor.org/rfc/rfc793.txt\">rfc793</a> 中所描述的情形，可分為以下四種不同狀況</p>\n<ul>\n<li>Basic 3-Way Handshake for Connection Synchronization</li>\n<li>Simultaneous Connection Synchronization</li>\n<li>Recovery from Old Duplicate SYN</li>\n<li>Half-Open Connection Discovery</li>\n</ul>\n<p>以下僅針對第一個 Basic 3-Way Handshake for Connection Synchronization 進行說明</p>\n<p>通常 TCP 連線建立流程，需要經過三向交握(three-way handshaking) 來建立連線</p>\n<p><img src=\"mk-20240119120657.png\"></p>\n<ol>\n<li>Server 建立 TCB，開啟監聽連線，進入 LISTENING 狀態</li>\n<li>Client 主動發出連線請求 SYN，進入 SYN_SENT 狀態，並等待回應</li>\n<li>Server 收到 SYN 要求，回應連線 SYN,ACK，並進入 SYN_RCVD 狀態</li>\n<li>Client 收到 SYN,ACK 確認完成連線進入 ESTABLISHED 狀態，並送出 ACK</li>\n<li>Server 收到 ACK 確認連線完成，同時也進入 ESTABLISHED 狀態</li>\n</ol>\n<p>名詞解釋：</p>\n<ul>\n<li>CLOSED：已關閉連線，表示該主機的連線呈現關閉中</li>\n<li>LISTENING：監聽狀態，表示該主機被動等待連線請求</li>\n<li>SYN_SENT：表示已送出 SYN 訊息，並等待對方回應</li>\n<li>SYN_RCVD：表示已接收到對方的 SYN 訊息，並且送出 SYN,ACK，等待對方回應</li>\n<li>ESTABLISHED：表示已完成雙方連線的建立，可開始傳輸資料</li>\n<li>TCB：傳輸控制區塊(Transmission Control Block)，用來儲存 Server 端有關 TCP 的所有資訊</li>\n<li>SYN：Synchronous，表示與對方建立連線的請求</li>\n<li>ACK：Acknowledgement，表示發送的數據已收到無誤</li>\n</ul>\n<p>「TCP建立連線」狀態流程圖</p>\n<p><img src=\"mk-20240119120730.png\"></p>\n<h2 id=\"TCP-關閉連線\"><a href=\"#TCP-關閉連線\" class=\"headerlink\" title=\"TCP 關閉連線\"></a>TCP 關閉連線</h2><p>依據 IETF 的標準文件 <a href=\"http://www.rfc-editor.org/rfc/rfc793.txt\">rfc793</a> 中所描述的情形，可分為以下二種不同狀況</p>\n<ul>\n<li>Normal Close Sequence</li>\n<li>Simultaneous Close Sequence</li>\n</ul>\n<p>以下僅針對第一個 Normal Close Sequence 進行說明</p>\n<p>TCP 關閉流程如下，需要經過四次交握 (four-way handshaking)，來確認雙方都停止收發數據，<strong>要注意的是可以是由 server 發起主動關閉，或是 client 發起主動關閉</strong>，但是「通常」都是 client 發起，因此下圖使用 TCP A 與 TCP B 表示，：</p>\n<p><img src=\"mk-20240119120822.png\"></p>\n<ol>\n<li>TCP A：準備關閉連線，發出 FIN，進入 FIN_WAIT_1 狀態</li>\n<li>TCP B：收到 FIN，並回傳 ACK，進入 CLOSE_WAIT 狀態，並通知 Application 連線準備關閉</li>\n<li>TCP A：收到 ACK，進入 FIN_WAIT_2 狀態，並等待對方發出 FIN</li>\n<li>TCP B：確認 Application 處理完斷線請求，發出 FIN，並進入狀態 LAST_ACK</li>\n<li>TCP A：收到 FIN，並回傳 ACK，進入 TIME_WAIT 狀態，等待 2MSL 時間後正式關閉連線</li>\n<li>TCP B：收到 ACK，便直接關閉連線，進入 CLOSED 狀態</li>\n</ol>\n<p>名詞解釋：</p>\n<ul>\n<li>ESTABLISHED：表示已完成雙方連線的建立，可開始傳輸資料</li>\n<li>CLOSE_WAIT：等待連線關閉狀態，等待 Application 回應</li>\n<li>LAST_ACK：等待連線關閉狀態，等待對方回傳 ACK 後關閉連線</li>\n<li>FIN_WAIT_1：等待連線關閉狀態，等待對方回傳 ACK</li>\n<li>FIN_WAIT_2：等待連線關閉狀態，等待對方回傳 FIN</li>\n<li>TIME_WAIT：等待2MSL，保證遠端有收到其 ACK 關閉連線 (網路延遲問題)</li>\n<li>CLOSED：已關閉連線</li>\n<li>FIN：FINISH，表示關閉連線的請求</li>\n<li>ACK：Acknowledgement，表示發送的數據已收到無誤</li>\n</ul>\n<p>「TCP關閉連線」狀態流程圖</p>\n<p><img src=\"mk-20240119120856.png\"></p>\n<p>最後發送 ACK 時，會進入 TIME_WAIT 狀態，要等 2MSL 時間後，這條連接才真正消失，所以從這邊知道「主動關閉連線」的一方會進入 TIME_WAIT 狀態</p>\n<blockquote>\n<p>什麼是 MSL 時間<br>最大分段壽命 MSL(Maximum Segment Lifetime)，是 TCP 協定規定封包在網絡中最長生存時間，超出時間後封包就會被丟棄。</p>\n<p>RFC793 定義 MSL 為 2 分鐘，不過實際上不同的作業系統可能有不同的設定，以 Linux 為例，通常是 30 秒，2MSL 就是 60 秒</p>\n</blockquote>\n<h2 id=\"為何-TIME-WAIT-狀態要等待-2MSL-的時間呢\"><a href=\"#為何-TIME-WAIT-狀態要等待-2MSL-的時間呢\" class=\"headerlink\" title=\"為何 TIME_WAIT 狀態要等待 2MSL 的時間呢?\"></a>為何 TIME_WAIT 狀態要等待 2MSL 的時間呢?</h2><p>Client/Server 都完成了四次交握，代表 Client/Server 都同意關閉連線，照理說應該可以直接回到 CLOSED 狀態(就像是建立連線時 SYN_SEND 狀態到 ESTABLISH 狀態那樣)，但是這邊我們必須要假設網路傳輸是不可靠的，因為我們無法保證最後傳送的 ACK 對方一定會收到，傳輸過程中可能因為種種原因(例如：網路延遲、丟包等…) 導致對方一直處於 LAST_ACK 狀態下的 SOCKET 因為逾時而未收到 ACK 而重發 FIN，所以 TIME_WAIT 狀態的作用就是用來重發可能遺失的 ACK。</p>\n<p>TIME_WAIT 狀態，是為了避免因為網路傳輸的種種原因而造成的 TCP 傳輸不可靠，而 TIME_WAIT 狀態可以最大限度的提升網路傳輸的可靠性。</p>\n<h2 id=\"完整-TCP「建立連線」與「關閉連線」之狀態圖\"><a href=\"#完整-TCP「建立連線」與「關閉連線」之狀態圖\" class=\"headerlink\" title=\"完整 TCP「建立連線」與「關閉連線」之狀態圖\"></a>完整 TCP「建立連線」與「關閉連線」之狀態圖</h2><p><img src=\"mk-20240119120922.png\"></p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://dev.twsiyuan.com/2017/09/tcp-states.html\">https://dev.twsiyuan.com/2017/09/tcp-states.html</a></li>\n<li><a href=\"https://www.gushiciku.cn/pl/p0aJ/zh-tw\">https://www.gushiciku.cn/pl/p0aJ/zh-tw</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>之前 Maintain A團隊的 K8s 時，有發生過 golang 寫的服務太多的 TIME_WAIT 導致 Pod 無法建立新的連線。 近期 Maintain B團隊的服務時，因為線上人數變多，擔心 Nginx 向 Upstream 發請求時，會不會造成太多的連線，然後有過多的 TIME_WAIT 現象，因為預設 Nginx 向 Upstream 發送請求是使用 http/1.0，會導致連線無法複用，所以當連線一多時，就很容易發生過多的 TIME_WAIT 狀態。</p>\n<p>所以本篇主要是在講解 TCP 協定在「建立連線」與「關閉連線」的過程，只要了解運作過程，就會知道 TIME_WAIT 狀態到底是如何產生的</p>","more":"<h2 id=\"TCP-建立連線\"><a href=\"#TCP-建立連線\" class=\"headerlink\" title=\"TCP 建立連線\"></a>TCP 建立連線</h2><p>依據 IETF 的標準文件 <a href=\"http://www.rfc-editor.org/rfc/rfc793.txt\">rfc793</a> 中所描述的情形，可分為以下四種不同狀況</p>\n<ul>\n<li>Basic 3-Way Handshake for Connection Synchronization</li>\n<li>Simultaneous Connection Synchronization</li>\n<li>Recovery from Old Duplicate SYN</li>\n<li>Half-Open Connection Discovery</li>\n</ul>\n<p>以下僅針對第一個 Basic 3-Way Handshake for Connection Synchronization 進行說明</p>\n<p>通常 TCP 連線建立流程，需要經過三向交握(three-way handshaking) 來建立連線</p>\n<p><img src=\"mk-20240119120657.png\"></p>\n<ol>\n<li>Server 建立 TCB，開啟監聽連線，進入 LISTENING 狀態</li>\n<li>Client 主動發出連線請求 SYN，進入 SYN_SENT 狀態，並等待回應</li>\n<li>Server 收到 SYN 要求，回應連線 SYN,ACK，並進入 SYN_RCVD 狀態</li>\n<li>Client 收到 SYN,ACK 確認完成連線進入 ESTABLISHED 狀態，並送出 ACK</li>\n<li>Server 收到 ACK 確認連線完成，同時也進入 ESTABLISHED 狀態</li>\n</ol>\n<p>名詞解釋：</p>\n<ul>\n<li>CLOSED：已關閉連線，表示該主機的連線呈現關閉中</li>\n<li>LISTENING：監聽狀態，表示該主機被動等待連線請求</li>\n<li>SYN_SENT：表示已送出 SYN 訊息，並等待對方回應</li>\n<li>SYN_RCVD：表示已接收到對方的 SYN 訊息，並且送出 SYN,ACK，等待對方回應</li>\n<li>ESTABLISHED：表示已完成雙方連線的建立，可開始傳輸資料</li>\n<li>TCB：傳輸控制區塊(Transmission Control Block)，用來儲存 Server 端有關 TCP 的所有資訊</li>\n<li>SYN：Synchronous，表示與對方建立連線的請求</li>\n<li>ACK：Acknowledgement，表示發送的數據已收到無誤</li>\n</ul>\n<p>「TCP建立連線」狀態流程圖</p>\n<p><img src=\"mk-20240119120730.png\"></p>\n<h2 id=\"TCP-關閉連線\"><a href=\"#TCP-關閉連線\" class=\"headerlink\" title=\"TCP 關閉連線\"></a>TCP 關閉連線</h2><p>依據 IETF 的標準文件 <a href=\"http://www.rfc-editor.org/rfc/rfc793.txt\">rfc793</a> 中所描述的情形，可分為以下二種不同狀況</p>\n<ul>\n<li>Normal Close Sequence</li>\n<li>Simultaneous Close Sequence</li>\n</ul>\n<p>以下僅針對第一個 Normal Close Sequence 進行說明</p>\n<p>TCP 關閉流程如下，需要經過四次交握 (four-way handshaking)，來確認雙方都停止收發數據，<strong>要注意的是可以是由 server 發起主動關閉，或是 client 發起主動關閉</strong>，但是「通常」都是 client 發起，因此下圖使用 TCP A 與 TCP B 表示，：</p>\n<p><img src=\"mk-20240119120822.png\"></p>\n<ol>\n<li>TCP A：準備關閉連線，發出 FIN，進入 FIN_WAIT_1 狀態</li>\n<li>TCP B：收到 FIN，並回傳 ACK，進入 CLOSE_WAIT 狀態，並通知 Application 連線準備關閉</li>\n<li>TCP A：收到 ACK，進入 FIN_WAIT_2 狀態，並等待對方發出 FIN</li>\n<li>TCP B：確認 Application 處理完斷線請求，發出 FIN，並進入狀態 LAST_ACK</li>\n<li>TCP A：收到 FIN，並回傳 ACK，進入 TIME_WAIT 狀態，等待 2MSL 時間後正式關閉連線</li>\n<li>TCP B：收到 ACK，便直接關閉連線，進入 CLOSED 狀態</li>\n</ol>\n<p>名詞解釋：</p>\n<ul>\n<li>ESTABLISHED：表示已完成雙方連線的建立，可開始傳輸資料</li>\n<li>CLOSE_WAIT：等待連線關閉狀態，等待 Application 回應</li>\n<li>LAST_ACK：等待連線關閉狀態，等待對方回傳 ACK 後關閉連線</li>\n<li>FIN_WAIT_1：等待連線關閉狀態，等待對方回傳 ACK</li>\n<li>FIN_WAIT_2：等待連線關閉狀態，等待對方回傳 FIN</li>\n<li>TIME_WAIT：等待2MSL，保證遠端有收到其 ACK 關閉連線 (網路延遲問題)</li>\n<li>CLOSED：已關閉連線</li>\n<li>FIN：FINISH，表示關閉連線的請求</li>\n<li>ACK：Acknowledgement，表示發送的數據已收到無誤</li>\n</ul>\n<p>「TCP關閉連線」狀態流程圖</p>\n<p><img src=\"mk-20240119120856.png\"></p>\n<p>最後發送 ACK 時，會進入 TIME_WAIT 狀態，要等 2MSL 時間後，這條連接才真正消失，所以從這邊知道「主動關閉連線」的一方會進入 TIME_WAIT 狀態</p>\n<blockquote>\n<p>什麼是 MSL 時間<br>最大分段壽命 MSL(Maximum Segment Lifetime)，是 TCP 協定規定封包在網絡中最長生存時間，超出時間後封包就會被丟棄。</p>\n<p>RFC793 定義 MSL 為 2 分鐘，不過實際上不同的作業系統可能有不同的設定，以 Linux 為例，通常是 30 秒，2MSL 就是 60 秒</p>\n</blockquote>\n<h2 id=\"為何-TIME-WAIT-狀態要等待-2MSL-的時間呢\"><a href=\"#為何-TIME-WAIT-狀態要等待-2MSL-的時間呢\" class=\"headerlink\" title=\"為何 TIME_WAIT 狀態要等待 2MSL 的時間呢?\"></a>為何 TIME_WAIT 狀態要等待 2MSL 的時間呢?</h2><p>Client/Server 都完成了四次交握，代表 Client/Server 都同意關閉連線，照理說應該可以直接回到 CLOSED 狀態(就像是建立連線時 SYN_SEND 狀態到 ESTABLISH 狀態那樣)，但是這邊我們必須要假設網路傳輸是不可靠的，因為我們無法保證最後傳送的 ACK 對方一定會收到，傳輸過程中可能因為種種原因(例如：網路延遲、丟包等…) 導致對方一直處於 LAST_ACK 狀態下的 SOCKET 因為逾時而未收到 ACK 而重發 FIN，所以 TIME_WAIT 狀態的作用就是用來重發可能遺失的 ACK。</p>\n<p>TIME_WAIT 狀態，是為了避免因為網路傳輸的種種原因而造成的 TCP 傳輸不可靠，而 TIME_WAIT 狀態可以最大限度的提升網路傳輸的可靠性。</p>\n<h2 id=\"完整-TCP「建立連線」與「關閉連線」之狀態圖\"><a href=\"#完整-TCP「建立連線」與「關閉連線」之狀態圖\" class=\"headerlink\" title=\"完整 TCP「建立連線」與「關閉連線」之狀態圖\"></a>完整 TCP「建立連線」與「關閉連線」之狀態圖</h2><p><img src=\"mk-20240119120922.png\"></p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://dev.twsiyuan.com/2017/09/tcp-states.html\">https://dev.twsiyuan.com/2017/09/tcp-states.html</a></li>\n<li><a href=\"https://www.gushiciku.cn/pl/p0aJ/zh-tw\">https://www.gushiciku.cn/pl/p0aJ/zh-tw</a></li>\n</ul>"},{"title":"Kubernetes 更新 ConfigMap 或 Secret 自動重啟 Pod","abbrlink":"1a2eedde","date":"2024-09-09T07:25:09.000Z","_content":"\n\n## 前言\n\n有在使用 K8s 的朋友，後期應該都會遇到一個問題，內部服務有一些設定檔是使用 ConfigMap 單獨掛出來，或是一些機敏資料是使用 Secret 掛出來，當這些單獨掛出來的資料有異動重新 `kubectl apply`，主要服務卻沒有辦法自動重啟(因為大部分都需要重啟才能吃到新的設定Ex: Nginx)，這時候只能手動將服務砍掉讓它重啟，這使得使用上有那麼一點不便利，如果當要修改的設定檔一多，所耗費的時間也就越多，如果能夠讓設定檔有異動時，服務可以自動重啟，那就再好不過了。\n\n<!-- more -->\n\n為了解決這個問題，下面將要介紹一款開源的套件 Reloader，將它安裝在 K8s 內，並在 `annatation` 多加一些設定，Reloader 就會自動幫你偵測服務所掛載的 Configmap/Secret 資料是否有異動，當有異動時就會幫忙將做 Rolling Update\n\n## Reloader的安裝\n\n安裝 Reloader\n\n```\nkubectl apply -f https://raw.githubusercontent.com/stakater/Reloader/master/deployments/kubernetes/reloader.yaml\n```\n\n在預設下，Reloader 會部署在 `default` 的 namespace 且會幫你監視「所有 namespace」的 `Secret`、`ConfigMap` 是否有異動\n\n> By default, Reloader gets deployed in `default` namespace and watches changes `secrets` and `configmaps` in all namespaces.\n\n安裝後，在 K8s `default` namespace 會多一個 stakater-reloader 服務\n\n## Reloader的使用\n\n安裝後，我們必須告訴 Reloader，要請他幫我們監視哪個服務所掛載的 `Secret` 或 `ConfigMap`，\n\n假設 Deployment 名字是 foo，而他掛一個 ConfigMap 名稱叫 foo-configmap，然後在 deployment Object 的 annotation 加上主要設定，如下\n\n```yaml\nkind: Deployment\nmetadata:\n  annotations:\n    configmap.reloader.stakater.com/reload: \"foo-configmap\"\n```\n\n同樣的，如果要監視 `Secret` 也是一樣的方式，只是 annotation 要稍微改一下，由 `configmap.reloader.stakater.com/reload` 改成 `secret.reloader.stakater.com/reload`，冒號後面的值則是帶入 `Secret` 名稱\n\n```yaml\nkind: Deployment\nmetadata:\n  annotations:\n    secret.reloader.stakater.com/reload: \"foo-secret\"\n```\n\n如果 Deployment 同時掛載多個 `Secret` 或 `ConfigMap`，則以逗號分開，例如\n\n```yaml\nkind: Deployment\nmetadata:\n  annotations:\n    configmap.reloader.stakater.com/reload: \"foo-configmap,bar-configmap,baz-configmap\"\n```\n\n當然也可以讓 Reloader 自行判斷，`reloader.stakater.com/auto: \"true\"` 會自行判斷 Deployment 是否有掛載 ConfigMap 或 Secret 當掛載的資料有異動時會自動重啟 Pod\n\n> `reloader.stakater.com/auto: \"true\"` will only reload the pod, if the configmap or secret is used (as a volume mount or as an env) in `DeploymentConfigs/Deployment/Daemonsets/Statefulsets`\n\n```yaml\nkind: Deployment\nmetadata:\n  annotations:\n    reloader.stakater.com/auto: \"true\"\n```\n\n## Reloader的實際應用\n\n如果懶得自己寫 YAML 的朋友，可以拿下面的 Nginx 範例部署到環境內做測試，Deployment/ConfigMap 都部署後，可以試著修改 ConfigMap 中 Nginx 設定檔內容，在重新部署，就會發現 Nginx 神奇的自己重新啟動。\n\nDeployment\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-reloader-test\n  namespace: default\n  labels:\n    app: nginx-reloader-test\n    annotations:\n      configmap.reloader.stakater.com/reload: \"nginx-config\"\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: nginx-reloader-test\n  template:\n    metadata:\n      labels:\n        app: nginx-reloader-test\n    spec:\n      restartPolicy: Always\n      containers:\n      - name: nginx-reloader-test\n        image: nginx:1.21.1\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 80\n        volumeMounts:\n        - name: nginx-conf-volume\n          mountPath: /etc/nginx/conf.d\n      volumes:\n      - name: nginx-conf-volume\n        configMap:\n          name: nginx-config\n```\n\nConfiMap\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: nginx-config\ndata:\n  nginx.conf: |\n    server {\n        listen       80;\n        server_name  localhost;\n        root   /usr/share/nginx/html;\n        index  index.php index.html index.htm;\n\n        # redirect server error pages to the static page /50x.html\n        error_page   500 502 503 504  /50x.html;\n        location = /50x.html {\n            root   /usr/share/nginx/html;\n        }\n\n        location / {\n            try_files $uri $uri/ =404;\n        }\n    }\n```\n\n## 文後討論\n\n官方 GitHub 底下還有蠻多可以調整的參數，如果有特殊需求的朋友，可以到 [官方GitHub](https://github.com/stakater/Reloader) 去挖寶，或許會找到你所需要，尤其是在 NOTES 的區塊，可以考慮好好讀一下\n\nhttps://github.com/stakater/Reloader#notes\n\n## 參考資料\n\n- https://github.com/stakater/Reloader\n","source":"_posts/stakater-reloader.md","raw":"---\ntitle: Kubernetes 更新 ConfigMap 或 Secret 自動重啟 Pod\ntags:\n  - GKE\n  - K8s\n  - kubernetes\n  - opensource\ncategories:\n  - GKE\nabbrlink: 1a2eedde\ndate: 2024-09-09 15:25:09\n---\n\n\n## 前言\n\n有在使用 K8s 的朋友，後期應該都會遇到一個問題，內部服務有一些設定檔是使用 ConfigMap 單獨掛出來，或是一些機敏資料是使用 Secret 掛出來，當這些單獨掛出來的資料有異動重新 `kubectl apply`，主要服務卻沒有辦法自動重啟(因為大部分都需要重啟才能吃到新的設定Ex: Nginx)，這時候只能手動將服務砍掉讓它重啟，這使得使用上有那麼一點不便利，如果當要修改的設定檔一多，所耗費的時間也就越多，如果能夠讓設定檔有異動時，服務可以自動重啟，那就再好不過了。\n\n<!-- more -->\n\n為了解決這個問題，下面將要介紹一款開源的套件 Reloader，將它安裝在 K8s 內，並在 `annatation` 多加一些設定，Reloader 就會自動幫你偵測服務所掛載的 Configmap/Secret 資料是否有異動，當有異動時就會幫忙將做 Rolling Update\n\n## Reloader的安裝\n\n安裝 Reloader\n\n```\nkubectl apply -f https://raw.githubusercontent.com/stakater/Reloader/master/deployments/kubernetes/reloader.yaml\n```\n\n在預設下，Reloader 會部署在 `default` 的 namespace 且會幫你監視「所有 namespace」的 `Secret`、`ConfigMap` 是否有異動\n\n> By default, Reloader gets deployed in `default` namespace and watches changes `secrets` and `configmaps` in all namespaces.\n\n安裝後，在 K8s `default` namespace 會多一個 stakater-reloader 服務\n\n## Reloader的使用\n\n安裝後，我們必須告訴 Reloader，要請他幫我們監視哪個服務所掛載的 `Secret` 或 `ConfigMap`，\n\n假設 Deployment 名字是 foo，而他掛一個 ConfigMap 名稱叫 foo-configmap，然後在 deployment Object 的 annotation 加上主要設定，如下\n\n```yaml\nkind: Deployment\nmetadata:\n  annotations:\n    configmap.reloader.stakater.com/reload: \"foo-configmap\"\n```\n\n同樣的，如果要監視 `Secret` 也是一樣的方式，只是 annotation 要稍微改一下，由 `configmap.reloader.stakater.com/reload` 改成 `secret.reloader.stakater.com/reload`，冒號後面的值則是帶入 `Secret` 名稱\n\n```yaml\nkind: Deployment\nmetadata:\n  annotations:\n    secret.reloader.stakater.com/reload: \"foo-secret\"\n```\n\n如果 Deployment 同時掛載多個 `Secret` 或 `ConfigMap`，則以逗號分開，例如\n\n```yaml\nkind: Deployment\nmetadata:\n  annotations:\n    configmap.reloader.stakater.com/reload: \"foo-configmap,bar-configmap,baz-configmap\"\n```\n\n當然也可以讓 Reloader 自行判斷，`reloader.stakater.com/auto: \"true\"` 會自行判斷 Deployment 是否有掛載 ConfigMap 或 Secret 當掛載的資料有異動時會自動重啟 Pod\n\n> `reloader.stakater.com/auto: \"true\"` will only reload the pod, if the configmap or secret is used (as a volume mount or as an env) in `DeploymentConfigs/Deployment/Daemonsets/Statefulsets`\n\n```yaml\nkind: Deployment\nmetadata:\n  annotations:\n    reloader.stakater.com/auto: \"true\"\n```\n\n## Reloader的實際應用\n\n如果懶得自己寫 YAML 的朋友，可以拿下面的 Nginx 範例部署到環境內做測試，Deployment/ConfigMap 都部署後，可以試著修改 ConfigMap 中 Nginx 設定檔內容，在重新部署，就會發現 Nginx 神奇的自己重新啟動。\n\nDeployment\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-reloader-test\n  namespace: default\n  labels:\n    app: nginx-reloader-test\n    annotations:\n      configmap.reloader.stakater.com/reload: \"nginx-config\"\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: nginx-reloader-test\n  template:\n    metadata:\n      labels:\n        app: nginx-reloader-test\n    spec:\n      restartPolicy: Always\n      containers:\n      - name: nginx-reloader-test\n        image: nginx:1.21.1\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 80\n        volumeMounts:\n        - name: nginx-conf-volume\n          mountPath: /etc/nginx/conf.d\n      volumes:\n      - name: nginx-conf-volume\n        configMap:\n          name: nginx-config\n```\n\nConfiMap\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: nginx-config\ndata:\n  nginx.conf: |\n    server {\n        listen       80;\n        server_name  localhost;\n        root   /usr/share/nginx/html;\n        index  index.php index.html index.htm;\n\n        # redirect server error pages to the static page /50x.html\n        error_page   500 502 503 504  /50x.html;\n        location = /50x.html {\n            root   /usr/share/nginx/html;\n        }\n\n        location / {\n            try_files $uri $uri/ =404;\n        }\n    }\n```\n\n## 文後討論\n\n官方 GitHub 底下還有蠻多可以調整的參數，如果有特殊需求的朋友，可以到 [官方GitHub](https://github.com/stakater/Reloader) 去挖寶，或許會找到你所需要，尤其是在 NOTES 的區塊，可以考慮好好讀一下\n\nhttps://github.com/stakater/Reloader#notes\n\n## 參考資料\n\n- https://github.com/stakater/Reloader\n","slug":"stakater-reloader","published":1,"updated":"2024-09-09T07:25:09.369Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0uoibru0000nylz89xxa7sy","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>有在使用 K8s 的朋友，後期應該都會遇到一個問題，內部服務有一些設定檔是使用 ConfigMap 單獨掛出來，或是一些機敏資料是使用 Secret 掛出來，當這些單獨掛出來的資料有異動重新 <code>kubectl apply</code>，主要服務卻沒有辦法自動重啟(因為大部分都需要重啟才能吃到新的設定Ex: Nginx)，這時候只能手動將服務砍掉讓它重啟，這使得使用上有那麼一點不便利，如果當要修改的設定檔一多，所耗費的時間也就越多，如果能夠讓設定檔有異動時，服務可以自動重啟，那就再好不過了。</p>\n<span id=\"more\"></span>\n\n<p>為了解決這個問題，下面將要介紹一款開源的套件 Reloader，將它安裝在 K8s 內，並在 <code>annatation</code> 多加一些設定，Reloader 就會自動幫你偵測服務所掛載的 Configmap/Secret 資料是否有異動，當有異動時就會幫忙將做 Rolling Update</p>\n<h2 id=\"Reloader的安裝\"><a href=\"#Reloader的安裝\" class=\"headerlink\" title=\"Reloader的安裝\"></a>Reloader的安裝</h2><p>安裝 Reloader</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;stakater&#x2F;Reloader&#x2F;master&#x2F;deployments&#x2F;kubernetes&#x2F;reloader.yaml</span><br></pre></td></tr></table></figure>\n\n<p>在預設下，Reloader 會部署在 <code>default</code> 的 namespace 且會幫你監視「所有 namespace」的 <code>Secret</code>、<code>ConfigMap</code> 是否有異動</p>\n<blockquote>\n<p>By default, Reloader gets deployed in <code>default</code> namespace and watches changes <code>secrets</code> and <code>configmaps</code> in all namespaces.</p>\n</blockquote>\n<p>安裝後，在 K8s <code>default</code> namespace 會多一個 stakater-reloader 服務</p>\n<h2 id=\"Reloader的使用\"><a href=\"#Reloader的使用\" class=\"headerlink\" title=\"Reloader的使用\"></a>Reloader的使用</h2><p>安裝後，我們必須告訴 Reloader，要請他幫我們監視哪個服務所掛載的 <code>Secret</code> 或 <code>ConfigMap</code>，</p>\n<p>假設 Deployment 名字是 foo，而他掛一個 ConfigMap 名稱叫 foo-configmap，然後在 deployment Object 的 annotation 加上主要設定，如下</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">configmap.reloader.stakater.com/reload:</span> <span class=\"string\">&quot;foo-configmap&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>同樣的，如果要監視 <code>Secret</code> 也是一樣的方式，只是 annotation 要稍微改一下，由 <code>configmap.reloader.stakater.com/reload</code> 改成 <code>secret.reloader.stakater.com/reload</code>，冒號後面的值則是帶入 <code>Secret</code> 名稱</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">secret.reloader.stakater.com/reload:</span> <span class=\"string\">&quot;foo-secret&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>如果 Deployment 同時掛載多個 <code>Secret</code> 或 <code>ConfigMap</code>，則以逗號分開，例如</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">configmap.reloader.stakater.com/reload:</span> <span class=\"string\">&quot;foo-configmap,bar-configmap,baz-configmap&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>當然也可以讓 Reloader 自行判斷，<code>reloader.stakater.com/auto: &quot;true&quot;</code> 會自行判斷 Deployment 是否有掛載 ConfigMap 或 Secret 當掛載的資料有異動時會自動重啟 Pod</p>\n<blockquote>\n<p><code>reloader.stakater.com/auto: &quot;true&quot;</code> will only reload the pod, if the configmap or secret is used (as a volume mount or as an env) in <code>DeploymentConfigs/Deployment/Daemonsets/Statefulsets</code></p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">reloader.stakater.com/auto:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Reloader的實際應用\"><a href=\"#Reloader的實際應用\" class=\"headerlink\" title=\"Reloader的實際應用\"></a>Reloader的實際應用</h2><p>如果懶得自己寫 YAML 的朋友，可以拿下面的 Nginx 範例部署到環境內做測試，Deployment/ConfigMap 都部署後，可以試著修改 ConfigMap 中 Nginx 設定檔內容，在重新部署，就會發現 Nginx 神奇的自己重新啟動。</p>\n<p>Deployment</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-reloader-test</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx-reloader-test</span></span><br><span class=\"line\">    <span class=\"attr\">annotations:</span></span><br><span class=\"line\">      <span class=\"attr\">configmap.reloader.stakater.com/reload:</span> <span class=\"string\">&quot;nginx-config&quot;</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-reloader-test</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx-reloader-test</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx-reloader-test</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx:1.21.1</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx-conf-volume</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/nginx/conf.d</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx-conf-volume</span></span><br><span class=\"line\">        <span class=\"attr\">configMap:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">nginx-config</span></span><br></pre></td></tr></table></figure>\n\n<p>ConfiMap</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-config</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">nginx.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"string\">server</span> &#123;</span><br><span class=\"line\">        <span class=\"string\">listen</span>       <span class=\"number\">80</span><span class=\"string\">;</span></span><br><span class=\"line\">        <span class=\"string\">server_name</span>  <span class=\"string\">localhost;</span></span><br><span class=\"line\">        <span class=\"string\">root</span>   <span class=\"string\">/usr/share/nginx/html;</span></span><br><span class=\"line\">        <span class=\"string\">index</span>  <span class=\"string\">index.php</span> <span class=\"string\">index.html</span> <span class=\"string\">index.htm;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># redirect server error pages to the static page /50x.html</span></span><br><span class=\"line\">        <span class=\"string\">error_page</span>   <span class=\"number\">500</span> <span class=\"number\">502</span> <span class=\"number\">503</span> <span class=\"number\">504</span>  <span class=\"string\">/50x.html;</span></span><br><span class=\"line\">        <span class=\"string\">location</span> <span class=\"string\">=</span> <span class=\"string\">/50x.html</span> &#123;</span><br><span class=\"line\">            <span class=\"string\">root</span>   <span class=\"string\">/usr/share/nginx/html;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"string\">location</span> <span class=\"string\">/</span> &#123;</span><br><span class=\"line\">            <span class=\"string\">try_files</span> <span class=\"string\">$uri</span> <span class=\"string\">$uri/</span> <span class=\"string\">=404;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>官方 GitHub 底下還有蠻多可以調整的參數，如果有特殊需求的朋友，可以到 <a href=\"https://github.com/stakater/Reloader\">官方GitHub</a> 去挖寶，或許會找到你所需要，尤其是在 NOTES 的區塊，可以考慮好好讀一下</p>\n<p><a href=\"https://github.com/stakater/Reloader#notes\">https://github.com/stakater/Reloader#notes</a></p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://github.com/stakater/Reloader\">https://github.com/stakater/Reloader</a></li>\n</ul>\n","site":{"data":{"post-body-end":"<div>\n  <script type=\"text/javascript\">\n    document.write(\n      \"<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/winds6206/button?referrer=\" +\n      encodeURIComponent(location.href.split(\"?\")[0].split(\"#\")[0]) + \"'></iframe>\");\n  </script>\n<div>\n","sidebar":"\n","styles":".links-of-recent-posts {\n  font-size: 0.8125em;\n  margin-top: 20px;\n}\n.links-of-recent-posts-title {\n  font-size: 1.03em;\n  font-weight: 600;\n  margin-top: 0;\n}\n.links-of-recent-posts-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n"}},"excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>有在使用 K8s 的朋友，後期應該都會遇到一個問題，內部服務有一些設定檔是使用 ConfigMap 單獨掛出來，或是一些機敏資料是使用 Secret 掛出來，當這些單獨掛出來的資料有異動重新 <code>kubectl apply</code>，主要服務卻沒有辦法自動重啟(因為大部分都需要重啟才能吃到新的設定Ex: Nginx)，這時候只能手動將服務砍掉讓它重啟，這使得使用上有那麼一點不便利，如果當要修改的設定檔一多，所耗費的時間也就越多，如果能夠讓設定檔有異動時，服務可以自動重啟，那就再好不過了。</p>","more":"<p>為了解決這個問題，下面將要介紹一款開源的套件 Reloader，將它安裝在 K8s 內，並在 <code>annatation</code> 多加一些設定，Reloader 就會自動幫你偵測服務所掛載的 Configmap/Secret 資料是否有異動，當有異動時就會幫忙將做 Rolling Update</p>\n<h2 id=\"Reloader的安裝\"><a href=\"#Reloader的安裝\" class=\"headerlink\" title=\"Reloader的安裝\"></a>Reloader的安裝</h2><p>安裝 Reloader</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;stakater&#x2F;Reloader&#x2F;master&#x2F;deployments&#x2F;kubernetes&#x2F;reloader.yaml</span><br></pre></td></tr></table></figure>\n\n<p>在預設下，Reloader 會部署在 <code>default</code> 的 namespace 且會幫你監視「所有 namespace」的 <code>Secret</code>、<code>ConfigMap</code> 是否有異動</p>\n<blockquote>\n<p>By default, Reloader gets deployed in <code>default</code> namespace and watches changes <code>secrets</code> and <code>configmaps</code> in all namespaces.</p>\n</blockquote>\n<p>安裝後，在 K8s <code>default</code> namespace 會多一個 stakater-reloader 服務</p>\n<h2 id=\"Reloader的使用\"><a href=\"#Reloader的使用\" class=\"headerlink\" title=\"Reloader的使用\"></a>Reloader的使用</h2><p>安裝後，我們必須告訴 Reloader，要請他幫我們監視哪個服務所掛載的 <code>Secret</code> 或 <code>ConfigMap</code>，</p>\n<p>假設 Deployment 名字是 foo，而他掛一個 ConfigMap 名稱叫 foo-configmap，然後在 deployment Object 的 annotation 加上主要設定，如下</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">configmap.reloader.stakater.com/reload:</span> <span class=\"string\">&quot;foo-configmap&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>同樣的，如果要監視 <code>Secret</code> 也是一樣的方式，只是 annotation 要稍微改一下，由 <code>configmap.reloader.stakater.com/reload</code> 改成 <code>secret.reloader.stakater.com/reload</code>，冒號後面的值則是帶入 <code>Secret</code> 名稱</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">secret.reloader.stakater.com/reload:</span> <span class=\"string\">&quot;foo-secret&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>如果 Deployment 同時掛載多個 <code>Secret</code> 或 <code>ConfigMap</code>，則以逗號分開，例如</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">configmap.reloader.stakater.com/reload:</span> <span class=\"string\">&quot;foo-configmap,bar-configmap,baz-configmap&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>當然也可以讓 Reloader 自行判斷，<code>reloader.stakater.com/auto: &quot;true&quot;</code> 會自行判斷 Deployment 是否有掛載 ConfigMap 或 Secret 當掛載的資料有異動時會自動重啟 Pod</p>\n<blockquote>\n<p><code>reloader.stakater.com/auto: &quot;true&quot;</code> will only reload the pod, if the configmap or secret is used (as a volume mount or as an env) in <code>DeploymentConfigs/Deployment/Daemonsets/Statefulsets</code></p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">reloader.stakater.com/auto:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Reloader的實際應用\"><a href=\"#Reloader的實際應用\" class=\"headerlink\" title=\"Reloader的實際應用\"></a>Reloader的實際應用</h2><p>如果懶得自己寫 YAML 的朋友，可以拿下面的 Nginx 範例部署到環境內做測試，Deployment/ConfigMap 都部署後，可以試著修改 ConfigMap 中 Nginx 設定檔內容，在重新部署，就會發現 Nginx 神奇的自己重新啟動。</p>\n<p>Deployment</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-reloader-test</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx-reloader-test</span></span><br><span class=\"line\">    <span class=\"attr\">annotations:</span></span><br><span class=\"line\">      <span class=\"attr\">configmap.reloader.stakater.com/reload:</span> <span class=\"string\">&quot;nginx-config&quot;</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-reloader-test</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx-reloader-test</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx-reloader-test</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx:1.21.1</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx-conf-volume</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/nginx/conf.d</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx-conf-volume</span></span><br><span class=\"line\">        <span class=\"attr\">configMap:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">nginx-config</span></span><br></pre></td></tr></table></figure>\n\n<p>ConfiMap</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-config</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">nginx.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"string\">server</span> &#123;</span><br><span class=\"line\">        <span class=\"string\">listen</span>       <span class=\"number\">80</span><span class=\"string\">;</span></span><br><span class=\"line\">        <span class=\"string\">server_name</span>  <span class=\"string\">localhost;</span></span><br><span class=\"line\">        <span class=\"string\">root</span>   <span class=\"string\">/usr/share/nginx/html;</span></span><br><span class=\"line\">        <span class=\"string\">index</span>  <span class=\"string\">index.php</span> <span class=\"string\">index.html</span> <span class=\"string\">index.htm;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># redirect server error pages to the static page /50x.html</span></span><br><span class=\"line\">        <span class=\"string\">error_page</span>   <span class=\"number\">500</span> <span class=\"number\">502</span> <span class=\"number\">503</span> <span class=\"number\">504</span>  <span class=\"string\">/50x.html;</span></span><br><span class=\"line\">        <span class=\"string\">location</span> <span class=\"string\">=</span> <span class=\"string\">/50x.html</span> &#123;</span><br><span class=\"line\">            <span class=\"string\">root</span>   <span class=\"string\">/usr/share/nginx/html;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"string\">location</span> <span class=\"string\">/</span> &#123;</span><br><span class=\"line\">            <span class=\"string\">try_files</span> <span class=\"string\">$uri</span> <span class=\"string\">$uri/</span> <span class=\"string\">=404;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"文後討論\"><a href=\"#文後討論\" class=\"headerlink\" title=\"文後討論\"></a>文後討論</h2><p>官方 GitHub 底下還有蠻多可以調整的參數，如果有特殊需求的朋友，可以到 <a href=\"https://github.com/stakater/Reloader\">官方GitHub</a> 去挖寶，或許會找到你所需要，尤其是在 NOTES 的區塊，可以考慮好好讀一下</p>\n<p><a href=\"https://github.com/stakater/Reloader#notes\">https://github.com/stakater/Reloader#notes</a></p>\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料\"></a>參考資料</h2><ul>\n<li><a href=\"https://github.com/stakater/Reloader\">https://github.com/stakater/Reloader</a></li>\n</ul>"}],"PostAsset":[{"_id":"source/_posts/github-pages/mk-20240119120313.png","slug":"mk-20240119120313.png","post":"cm0uoc5j50010k0lze1tq1hir","modified":0,"renderable":0},{"_id":"source/_posts/ftp-in-kubernetes/mk-20240119114134.png","slug":"mk-20240119114134.png","post":"cm0uoc5j4000wk0lzfcyu69ou","modified":0,"renderable":0},{"_id":"source/_posts/ftp-in-kubernetes/mk-20240119114200.png","slug":"mk-20240119114200.png","post":"cm0uoc5j4000wk0lzfcyu69ou","modified":0,"renderable":0},{"_id":"source/_posts/ftp-in-kubernetes/mk-20240119114218.png","slug":"mk-20240119114218.png","post":"cm0uoc5j4000wk0lzfcyu69ou","modified":0,"renderable":0},{"_id":"source/_posts/ftp-in-kubernetes/mk-20240119114239.png","slug":"mk-20240119114239.png","post":"cm0uoc5j4000wk0lzfcyu69ou","modified":0,"renderable":0},{"_id":"source/_posts/ftp-in-kubernetes/mk-20240119114300.png","slug":"mk-20240119114300.png","post":"cm0uoc5j4000wk0lzfcyu69ou","modified":0,"renderable":0},{"_id":"source/_posts/gke-workload-identity/mk-20240118163311.png","slug":"mk-20240118163311.png","post":"cm0uoc5j60014k0lz7ucreg7u","modified":0,"renderable":0},{"_id":"source/_posts/hexo-Disqus-feature/mk-20240119114707.png","slug":"mk-20240119114707.png","post":"cm0uoc5j7001bk0lz7zpp8e7d","modified":0,"renderable":0},{"_id":"source/_posts/tcp-ip-time-wait/mk-20240119120657.png","slug":"mk-20240119120657.png","post":"cm0uoc5jg002ak0lz5w4i7frh","modified":0,"renderable":0},{"_id":"source/_posts/tcp-ip-time-wait/mk-20240119120730.png","slug":"mk-20240119120730.png","post":"cm0uoc5jg002ak0lz5w4i7frh","modified":0,"renderable":0},{"_id":"source/_posts/tcp-ip-time-wait/mk-20240119120822.png","slug":"mk-20240119120822.png","post":"cm0uoc5jg002ak0lz5w4i7frh","modified":0,"renderable":0},{"_id":"source/_posts/tcp-ip-time-wait/mk-20240119120856.png","slug":"mk-20240119120856.png","post":"cm0uoc5jg002ak0lz5w4i7frh","modified":0,"renderable":0},{"_id":"source/_posts/tcp-ip-time-wait/mk-20240119120922.png","slug":"mk-20240119120922.png","post":"cm0uoc5jg002ak0lz5w4i7frh","modified":0,"renderable":0}],"PostCategory":[{"post_id":"cm0uoc5ik0001k0lzb1se7eom","category_id":"cm0uoc5ip0004k0lz5ojzgucv","_id":"cm0uoc5ix000ek0lzgv7y2ud7"},{"post_id":"cm0uoc5io0003k0lz4z9ubsbd","category_id":"cm0uoc5iu000ak0lz93lphm6h","_id":"cm0uoc5j1000nk0lzc3dt6m9s"},{"post_id":"cm0uoc5is0007k0lz4taafnwh","category_id":"cm0uoc5ix000fk0lzei0icuye","_id":"cm0uoc5j2000rk0lzdwfo4u3v"},{"post_id":"cm0uoc5j0000mk0lz8zum81xn","category_id":"cm0uoc5ip0004k0lz5ojzgucv","_id":"cm0uoc5j4000xk0lzftv190lj"},{"post_id":"cm0uoc5iu0009k0lz24h6hocu","category_id":"cm0uoc5iz000kk0lzb0hohbn7","_id":"cm0uoc5j50011k0lz4zh480j0"},{"post_id":"cm0uoc5j3000uk0lzg6na64te","category_id":"cm0uoc5ip0004k0lz5ojzgucv","_id":"cm0uoc5j60015k0lz7wpcaap4"},{"post_id":"cm0uoc5j4000wk0lzfcyu69ou","category_id":"cm0uoc5iu000ak0lz93lphm6h","_id":"cm0uoc5j70019k0lzawdc5lzp"},{"post_id":"cm0uoc5iw000dk0lz9wt89aqf","category_id":"cm0uoc5j3000tk0lzh2zqfxbo","_id":"cm0uoc5j8001ck0lz5df90qcd"},{"post_id":"cm0uoc5j60014k0lz7ucreg7u","category_id":"cm0uoc5iu000ak0lz93lphm6h","_id":"cm0uoc5j8001ek0lzhzn26e3p"},{"post_id":"cm0uoc5iy000hk0lzg5ckfw8j","category_id":"cm0uoc5j50012k0lz3bs7gx2n","_id":"cm0uoc5ja001ik0lz9i6v497b"},{"post_id":"cm0uoc5j70018k0lz77913jkb","category_id":"cm0uoc5ix000fk0lzei0icuye","_id":"cm0uoc5ja001kk0lzdeex1ksu"},{"post_id":"cm0uoc5j7001bk0lz7zpp8e7d","category_id":"cm0uoc5ix000fk0lzei0icuye","_id":"cm0uoc5jb001nk0lza3bh185g"},{"post_id":"cm0uoc5iy000ik0lzfndaa6b0","category_id":"cm0uoc5j7001ak0lzhd779el1","_id":"cm0uoc5jc001qk0lz8dw19q0a"},{"post_id":"cm0uoc5j8001dk0lzgprm8613","category_id":"cm0uoc5ix000fk0lzei0icuye","_id":"cm0uoc5jd001uk0lz75ocgfr4"},{"post_id":"cm0uoc5j9001hk0lze9df2u8m","category_id":"cm0uoc5ix000fk0lzei0icuye","_id":"cm0uoc5jd001xk0lzh1ijd1qm"},{"post_id":"cm0uoc5j2000pk0lze92c4ml1","category_id":"cm0uoc5j7001ak0lzhd779el1","_id":"cm0uoc5je0021k0lz8i39bj0q"},{"post_id":"cm0uoc5ja001jk0lz121u1gqd","category_id":"cm0uoc5ix000fk0lzei0icuye","_id":"cm0uoc5jf0024k0lzdgk821lw"},{"post_id":"cm0uoc5jb001mk0lzep013wtt","category_id":"cm0uoc5ix000fk0lzei0icuye","_id":"cm0uoc5jf0028k0lz8b37h7vj"},{"post_id":"cm0uoc5jb001pk0lzhqj0ajs0","category_id":"cm0uoc5j7001ak0lzhd779el1","_id":"cm0uoc5jg002bk0lze04x90ig"},{"post_id":"cm0uoc5jc001tk0lz22gt1832","category_id":"cm0uoc5ix000fk0lzei0icuye","_id":"cm0uoc5jg002dk0lz1b0b4y15"},{"post_id":"cm0uoc5jd001wk0lz6hc251xq","category_id":"cm0uoc5iz000kk0lzb0hohbn7","_id":"cm0uoc5jh002hk0lzenwqgze8"},{"post_id":"cm0uoc5je0020k0lzh54zaukk","category_id":"cm0uoc5iu000ak0lz93lphm6h","_id":"cm0uoc5jh002jk0lzb248b8a8"},{"post_id":"cm0uoc5je0023k0lz61d65o06","category_id":"cm0uoc5iz000kk0lzb0hohbn7","_id":"cm0uoc5jh002mk0lz1oka19ju"},{"post_id":"cm0uoc5jf0027k0lz4hin7w69","category_id":"cm0uoc5j7001ak0lzhd779el1","_id":"cm0uoc5jh002ok0lz0cbmeeqy"},{"post_id":"cm0uoc5jg002ak0lz5w4i7frh","category_id":"cm0uoc5jh002gk0lz8hrzdzl6","_id":"cm0uoc5ji002rk0lz861ve6wo"},{"post_id":"cm0uoibru0000nylz89xxa7sy","category_id":"cm0uoc5iu000ak0lz93lphm6h","_id":"cm0uoibry0003nylz2xwue3te"}],"PostTag":[{"post_id":"cm0uoc5ik0001k0lzb1se7eom","tag_id":"cm0uoc5ir0005k0lz5zvbge4x","_id":"cm0uoc5j1000ok0lz8x1b0mho"},{"post_id":"cm0uoc5ik0001k0lzb1se7eom","tag_id":"cm0uoc5iv000bk0lzctmf1rvk","_id":"cm0uoc5j2000qk0lz46rucm8k"},{"post_id":"cm0uoc5ik0001k0lzb1se7eom","tag_id":"cm0uoc5ix000gk0lz045r42h2","_id":"cm0uoc5j4000vk0lzes1s6g6s"},{"post_id":"cm0uoc5j3000uk0lzg6na64te","tag_id":"cm0uoc5ir0005k0lz5zvbge4x","_id":"cm0uoc5j4000yk0lz006wbmsg"},{"post_id":"cm0uoc5j3000uk0lzg6na64te","tag_id":"cm0uoc5iv000bk0lzctmf1rvk","_id":"cm0uoc5j60013k0lzeh77duct"},{"post_id":"cm0uoc5j3000uk0lzg6na64te","tag_id":"cm0uoc5ix000gk0lz045r42h2","_id":"cm0uoc5j60016k0lz7yhyaq77"},{"post_id":"cm0uoc5io0003k0lz4z9ubsbd","tag_id":"cm0uoc5ir0005k0lz5zvbge4x","_id":"cm0uoc5jb001ok0lzf45pc70c"},{"post_id":"cm0uoc5io0003k0lz4z9ubsbd","tag_id":"cm0uoc5j2000sk0lzdon2b5mg","_id":"cm0uoc5jc001rk0lzcc83che0"},{"post_id":"cm0uoc5io0003k0lz4z9ubsbd","tag_id":"cm0uoc5ix000gk0lz045r42h2","_id":"cm0uoc5jd001vk0lz079r7qco"},{"post_id":"cm0uoc5io0003k0lz4z9ubsbd","tag_id":"cm0uoc5j60017k0lzcba19ndh","_id":"cm0uoc5jd001yk0lzbzr10s2w"},{"post_id":"cm0uoc5io0003k0lz4z9ubsbd","tag_id":"cm0uoc5j9001fk0lze6ph6d65","_id":"cm0uoc5je0022k0lzfen5f8sb"},{"post_id":"cm0uoc5jc001tk0lz22gt1832","tag_id":"cm0uoc5ja001lk0lz4rid2pa8","_id":"cm0uoc5jf0025k0lzax1o5i03"},{"post_id":"cm0uoc5jc001tk0lz22gt1832","tag_id":"cm0uoc5jc001sk0lz0p4q7qls","_id":"cm0uoc5jf0029k0lz431mf2rk"},{"post_id":"cm0uoc5is0007k0lz4taafnwh","tag_id":"cm0uoc5ja001lk0lz4rid2pa8","_id":"cm0uoc5jg002ck0lz3txmbdfn"},{"post_id":"cm0uoc5is0007k0lz4taafnwh","tag_id":"cm0uoc5jc001sk0lz0p4q7qls","_id":"cm0uoc5jg002fk0lz37k2cjx7"},{"post_id":"cm0uoc5je0020k0lzh54zaukk","tag_id":"cm0uoc5ir0005k0lz5zvbge4x","_id":"cm0uoc5jh002ik0lzctqd3z9r"},{"post_id":"cm0uoc5je0020k0lzh54zaukk","tag_id":"cm0uoc5j2000sk0lzdon2b5mg","_id":"cm0uoc5jh002kk0lz7vxyanqh"},{"post_id":"cm0uoc5je0020k0lzh54zaukk","tag_id":"cm0uoc5ix000gk0lz045r42h2","_id":"cm0uoc5jh002nk0lz3qmuc7y4"},{"post_id":"cm0uoc5je0020k0lzh54zaukk","tag_id":"cm0uoc5j60017k0lzcba19ndh","_id":"cm0uoc5jh002pk0lzcx20c96o"},{"post_id":"cm0uoc5je0020k0lzh54zaukk","tag_id":"cm0uoc5j9001fk0lze6ph6d65","_id":"cm0uoc5ji002sk0lzfe160xrp"},{"post_id":"cm0uoc5it0008k0lz1hbgfhpt","tag_id":"cm0uoc5ja001lk0lz4rid2pa8","_id":"cm0uoc5ji002vk0lz6djsd2lk"},{"post_id":"cm0uoc5it0008k0lz1hbgfhpt","tag_id":"cm0uoc5jf0026k0lzg2v48q80","_id":"cm0uoc5ji002wk0lzfigw8g75"},{"post_id":"cm0uoc5it0008k0lz1hbgfhpt","tag_id":"cm0uoc5jg002ek0lz4tbwfvun","_id":"cm0uoc5ji002yk0lzep7eeonu"},{"post_id":"cm0uoc5it0008k0lz1hbgfhpt","tag_id":"cm0uoc5jh002lk0lz0nxu2trk","_id":"cm0uoc5ji002zk0lz76yd14zc"},{"post_id":"cm0uoc5it0008k0lz1hbgfhpt","tag_id":"cm0uoc5jh002qk0lzht24em1j","_id":"cm0uoc5ji0031k0lz1uo98ei0"},{"post_id":"cm0uoc5it0008k0lz1hbgfhpt","tag_id":"cm0uoc5jc001sk0lz0p4q7qls","_id":"cm0uoc5jj0032k0lzaz5vdk5n"},{"post_id":"cm0uoc5iu0009k0lz24h6hocu","tag_id":"cm0uoc5ji002uk0lz0g7p9zsw","_id":"cm0uoc5jj0034k0lz53tn6fw3"},{"post_id":"cm0uoc5iu0009k0lz24h6hocu","tag_id":"cm0uoc5ji002xk0lzbfzke7n9","_id":"cm0uoc5jj0035k0lza5exc4jf"},{"post_id":"cm0uoc5iu0009k0lz24h6hocu","tag_id":"cm0uoc5ji0030k0lz1pls8h43","_id":"cm0uoc5jj0037k0lzcx3fh2m7"},{"post_id":"cm0uoc5iw000dk0lz9wt89aqf","tag_id":"cm0uoc5jk003ck0lz1ooggb9d","_id":"cm0uoc5jl003nk0lz29mvayk8"},{"post_id":"cm0uoc5iw000dk0lz9wt89aqf","tag_id":"cm0uoc5jk003fk0lzbtg6bj31","_id":"cm0uoc5jl003ok0lz17agesmc"},{"post_id":"cm0uoc5iw000dk0lz9wt89aqf","tag_id":"cm0uoc5jk003ik0lzgox31j9s","_id":"cm0uoc5jl003qk0lzhuvbgsyx"},{"post_id":"cm0uoc5iy000hk0lzg5ckfw8j","tag_id":"cm0uoc5jl003lk0lzddypb6x5","_id":"cm0uoc5jl003uk0lzaznv2iik"},{"post_id":"cm0uoc5iy000hk0lzg5ckfw8j","tag_id":"cm0uoc5jl003pk0lza3ct219y","_id":"cm0uoc5jm003vk0lz8uvh1r31"},{"post_id":"cm0uoc5iy000hk0lzg5ckfw8j","tag_id":"cm0uoc5jl003rk0lz0dic6yyo","_id":"cm0uoc5jm003xk0lzfbif9bl8"},{"post_id":"cm0uoc5iy000hk0lzg5ckfw8j","tag_id":"cm0uoc5ji0030k0lz1pls8h43","_id":"cm0uoc5jm003yk0lz7y143l0l"},{"post_id":"cm0uoc5iy000ik0lzfndaa6b0","tag_id":"cm0uoc5jl003tk0lz6hoxgwrx","_id":"cm0uoc5jm0042k0lzfadpgu1l"},{"post_id":"cm0uoc5iy000ik0lzfndaa6b0","tag_id":"cm0uoc5jm003wk0lz9xcufacp","_id":"cm0uoc5jm0043k0lz3adifkwj"},{"post_id":"cm0uoc5iy000ik0lzfndaa6b0","tag_id":"cm0uoc5jm003zk0lz2astdqp4","_id":"cm0uoc5jm0045k0lzaqachfmo"},{"post_id":"cm0uoc5iy000ik0lzfndaa6b0","tag_id":"cm0uoc5jm0040k0lz31ijfprp","_id":"cm0uoc5jm0046k0lzd5v09zin"},{"post_id":"cm0uoc5j0000mk0lz8zum81xn","tag_id":"cm0uoc5j2000sk0lzdon2b5mg","_id":"cm0uoc5jn0048k0lzatbnh9ym"},{"post_id":"cm0uoc5j0000mk0lz8zum81xn","tag_id":"cm0uoc5ir0005k0lz5zvbge4x","_id":"cm0uoc5jn0049k0lzae0c6sv6"},{"post_id":"cm0uoc5j0000mk0lz8zum81xn","tag_id":"cm0uoc5ix000gk0lz045r42h2","_id":"cm0uoc5jn004bk0lzf5q9hxq4"},{"post_id":"cm0uoc5j0000mk0lz8zum81xn","tag_id":"cm0uoc5jm0044k0lz54je7c50","_id":"cm0uoc5jn004ck0lzbcqt4hx5"},{"post_id":"cm0uoc5j2000pk0lze92c4ml1","tag_id":"cm0uoc5jn0047k0lz7e906drq","_id":"cm0uoc5jo004jk0lz24y69l8b"},{"post_id":"cm0uoc5j2000pk0lze92c4ml1","tag_id":"cm0uoc5jn004ak0lzfyb44c3f","_id":"cm0uoc5jo004kk0lz037f5lcu"},{"post_id":"cm0uoc5j2000pk0lze92c4ml1","tag_id":"cm0uoc5jl003rk0lz0dic6yyo","_id":"cm0uoc5jp004mk0lz6jale1qn"},{"post_id":"cm0uoc5j2000pk0lze92c4ml1","tag_id":"cm0uoc5jn004ek0lz05jhe0x2","_id":"cm0uoc5jp004nk0lzdujpcb5n"},{"post_id":"cm0uoc5j2000pk0lze92c4ml1","tag_id":"cm0uoc5jo004fk0lz76wv7egd","_id":"cm0uoc5jp004pk0lz21zc5gwe"},{"post_id":"cm0uoc5j2000pk0lze92c4ml1","tag_id":"cm0uoc5jo004gk0lz4iyg50yw","_id":"cm0uoc5jp004qk0lz0retgwf1"},{"post_id":"cm0uoc5j2000pk0lze92c4ml1","tag_id":"cm0uoc5jo004hk0lz4ju653wu","_id":"cm0uoc5jp004sk0lzgtgtfuw3"},{"post_id":"cm0uoc5j4000wk0lzfcyu69ou","tag_id":"cm0uoc5j2000sk0lzdon2b5mg","_id":"cm0uoc5jp004tk0lzeo1g9hz6"},{"post_id":"cm0uoc5j4000wk0lzfcyu69ou","tag_id":"cm0uoc5ir0005k0lz5zvbge4x","_id":"cm0uoc5jp004vk0lzhigig7v0"},{"post_id":"cm0uoc5j4000wk0lzfcyu69ou","tag_id":"cm0uoc5ix000gk0lz045r42h2","_id":"cm0uoc5jp004wk0lzhce5d9pk"},{"post_id":"cm0uoc5j4000wk0lzfcyu69ou","tag_id":"cm0uoc5j60017k0lzcba19ndh","_id":"cm0uoc5jp004yk0lz6lzq3o79"},{"post_id":"cm0uoc5j4000wk0lzfcyu69ou","tag_id":"cm0uoc5j9001fk0lze6ph6d65","_id":"cm0uoc5jp004zk0lz0te93u3b"},{"post_id":"cm0uoc5j4000wk0lzfcyu69ou","tag_id":"cm0uoc5jp004ok0lz26mvbzs9","_id":"cm0uoc5jq0051k0lz2g9jg4ys"},{"post_id":"cm0uoc5j50010k0lze1tq1hir","tag_id":"cm0uoc5ja001lk0lz4rid2pa8","_id":"cm0uoc5jq0053k0lz2pxe60iz"},{"post_id":"cm0uoc5j50010k0lze1tq1hir","tag_id":"cm0uoc5jf0026k0lzg2v48q80","_id":"cm0uoc5jq0054k0lz0keo3k8t"},{"post_id":"cm0uoc5j50010k0lze1tq1hir","tag_id":"cm0uoc5jg002ek0lz4tbwfvun","_id":"cm0uoc5jq0056k0lz10x07gez"},{"post_id":"cm0uoc5j50010k0lze1tq1hir","tag_id":"cm0uoc5jc001sk0lz0p4q7qls","_id":"cm0uoc5jq0057k0lzdvondt4q"},{"post_id":"cm0uoc5j60014k0lz7ucreg7u","tag_id":"cm0uoc5ir0005k0lz5zvbge4x","_id":"cm0uoc5jq0059k0lzd84x1d1t"},{"post_id":"cm0uoc5j60014k0lz7ucreg7u","tag_id":"cm0uoc5j2000sk0lzdon2b5mg","_id":"cm0uoc5jq005ak0lz49f4hs00"},{"post_id":"cm0uoc5j60014k0lz7ucreg7u","tag_id":"cm0uoc5ix000gk0lz045r42h2","_id":"cm0uoc5jr005ck0lz6hsgf2va"},{"post_id":"cm0uoc5j60014k0lz7ucreg7u","tag_id":"cm0uoc5j60017k0lzcba19ndh","_id":"cm0uoc5jr005dk0lzdgy59b39"},{"post_id":"cm0uoc5j60014k0lz7ucreg7u","tag_id":"cm0uoc5j9001fk0lze6ph6d65","_id":"cm0uoc5jr005fk0lz36oygkwg"},{"post_id":"cm0uoc5j70018k0lz77913jkb","tag_id":"cm0uoc5ja001lk0lz4rid2pa8","_id":"cm0uoc5jr005gk0lz2kcsbhd7"},{"post_id":"cm0uoc5j70018k0lz77913jkb","tag_id":"cm0uoc5jc001sk0lz0p4q7qls","_id":"cm0uoc5jr005ik0lzd3bw5q7y"},{"post_id":"cm0uoc5j7001bk0lz7zpp8e7d","tag_id":"cm0uoc5ja001lk0lz4rid2pa8","_id":"cm0uoc5jr005lk0lzhsqxg09k"},{"post_id":"cm0uoc5j7001bk0lz7zpp8e7d","tag_id":"cm0uoc5jc001sk0lz0p4q7qls","_id":"cm0uoc5jr005mk0lz42qugbrc"},{"post_id":"cm0uoc5j7001bk0lz7zpp8e7d","tag_id":"cm0uoc5jr005jk0lz19ff5pg5","_id":"cm0uoc5js005ok0lz4yg67tz6"},{"post_id":"cm0uoc5j8001dk0lzgprm8613","tag_id":"cm0uoc5ja001lk0lz4rid2pa8","_id":"cm0uoc5js005qk0lz67juevre"},{"post_id":"cm0uoc5j8001dk0lzgprm8613","tag_id":"cm0uoc5jc001sk0lz0p4q7qls","_id":"cm0uoc5js005rk0lz8w682nw2"},{"post_id":"cm0uoc5j9001hk0lze9df2u8m","tag_id":"cm0uoc5ja001lk0lz4rid2pa8","_id":"cm0uoc5jv005uk0lzfx6uar29"},{"post_id":"cm0uoc5j9001hk0lze9df2u8m","tag_id":"cm0uoc5jc001sk0lz0p4q7qls","_id":"cm0uoc5jw005vk0lz3ndt0hp3"},{"post_id":"cm0uoc5ja001jk0lz121u1gqd","tag_id":"cm0uoc5ja001lk0lz4rid2pa8","_id":"cm0uoc5jw005yk0lz65ikh6sf"},{"post_id":"cm0uoc5ja001jk0lz121u1gqd","tag_id":"cm0uoc5jc001sk0lz0p4q7qls","_id":"cm0uoc5jw005zk0lz4c5ac8gx"},{"post_id":"cm0uoc5jb001mk0lzep013wtt","tag_id":"cm0uoc5ja001lk0lz4rid2pa8","_id":"cm0uoc5jw0061k0lz2oe22rwk"},{"post_id":"cm0uoc5jb001mk0lzep013wtt","tag_id":"cm0uoc5jc001sk0lz0p4q7qls","_id":"cm0uoc5jw0062k0lz5awb0yff"},{"post_id":"cm0uoc5jb001pk0lzhqj0ajs0","tag_id":"cm0uoc5jw0060k0lz5kek5mx5","_id":"cm0uoc5jx006ak0lzf8yt3mxm"},{"post_id":"cm0uoc5jb001pk0lzhqj0ajs0","tag_id":"cm0uoc5jw0063k0lzbc0tbysr","_id":"cm0uoc5jx006bk0lzfly7gzfd"},{"post_id":"cm0uoc5jb001pk0lzhqj0ajs0","tag_id":"cm0uoc5jw0064k0lzhfp1apj0","_id":"cm0uoc5jx006dk0lz6kv7f3ak"},{"post_id":"cm0uoc5jb001pk0lzhqj0ajs0","tag_id":"cm0uoc5jw0065k0lz5uoa4t3j","_id":"cm0uoc5jx006ek0lzc32oc7f1"},{"post_id":"cm0uoc5jb001pk0lzhqj0ajs0","tag_id":"cm0uoc5jm0040k0lz31ijfprp","_id":"cm0uoc5jx006gk0lz6zxk3f17"},{"post_id":"cm0uoc5jb001pk0lzhqj0ajs0","tag_id":"cm0uoc5ji0030k0lz1pls8h43","_id":"cm0uoc5jx006hk0lz1dz2dals"},{"post_id":"cm0uoc5jb001pk0lzhqj0ajs0","tag_id":"cm0uoc5jx0068k0lzaq8w3k9v","_id":"cm0uoc5jy006jk0lzfvlp3qh3"},{"post_id":"cm0uoc5jd001wk0lz6hc251xq","tag_id":"cm0uoc5ji002xk0lzbfzke7n9","_id":"cm0uoc5jy006kk0lzbxnwfow8"},{"post_id":"cm0uoc5jd001wk0lz6hc251xq","tag_id":"cm0uoc5ji002uk0lz0g7p9zsw","_id":"cm0uoc5jy006mk0lz1o4w4e0y"},{"post_id":"cm0uoc5je0023k0lz61d65o06","tag_id":"cm0uoc5ji002xk0lzbfzke7n9","_id":"cm0uoc5jy006nk0lzct588nbs"},{"post_id":"cm0uoc5je0023k0lz61d65o06","tag_id":"cm0uoc5ji002uk0lz0g7p9zsw","_id":"cm0uoc5jy006pk0lz6yp37gom"},{"post_id":"cm0uoc5jf0027k0lz4hin7w69","tag_id":"cm0uoc5jm0040k0lz31ijfprp","_id":"cm0uoc5jy006tk0lz5kkj2jsy"},{"post_id":"cm0uoc5jf0027k0lz4hin7w69","tag_id":"cm0uoc5jy006ok0lzckua80a9","_id":"cm0uoc5jy006uk0lz49zu84gg"},{"post_id":"cm0uoc5jf0027k0lz4hin7w69","tag_id":"cm0uoc5jy006qk0lzf9ztfu1z","_id":"cm0uoc5jy006vk0lz0ry3fxvm"},{"post_id":"cm0uoc5jf0027k0lz4hin7w69","tag_id":"cm0uoc5jy006rk0lz7fc31gje","_id":"cm0uoc5jz006wk0lzfz1qhtm6"},{"post_id":"cm0uoc5jg002ak0lz5w4i7frh","tag_id":"cm0uoc5jy006sk0lz2r8wdvvh","_id":"cm0uoc5jz006xk0lz1bthd34d"},{"post_id":"cm0uoibru0000nylz89xxa7sy","tag_id":"cm0uoc5j2000sk0lzdon2b5mg","_id":"cm0uoibrx0001nylz4xlve5m2"},{"post_id":"cm0uoibru0000nylz89xxa7sy","tag_id":"cm0uoc5j60017k0lzcba19ndh","_id":"cm0uoibrx0002nylz2c9t7xxk"},{"post_id":"cm0uoibru0000nylz89xxa7sy","tag_id":"cm0uoc5jj0038k0lzb8so8b0k","_id":"cm0uoibry0004nylzcif997p5"},{"post_id":"cm0uoibru0000nylz89xxa7sy","tag_id":"cm0uoc5jj003bk0lz3dtj0wru","_id":"cm0uoibry0005nylz3rjp0ghw"}],"Tag":[{"name":"GCP","_id":"cm0uoc5ir0005k0lz5zvbge4x"},{"name":"Cloud SQL","_id":"cm0uoc5iv000bk0lzctmf1rvk"},{"name":"Google Cloud Platform","_id":"cm0uoc5ix000gk0lz045r42h2"},{"name":"GKE","_id":"cm0uoc5j2000sk0lzdon2b5mg"},{"name":"K8s","_id":"cm0uoc5j60017k0lzcba19ndh"},{"name":"Kubernetes","_id":"cm0uoc5j9001fk0lze6ph6d65"},{"name":"Hexo","_id":"cm0uoc5ja001lk0lz4rid2pa8"},{"name":"blog","_id":"cm0uoc5jc001sk0lz0p4q7qls"},{"name":"GitHub","_id":"cm0uoc5jf0026k0lzg2v48q80"},{"name":"GitHub Pages","_id":"cm0uoc5jg002ek0lz4tbwfvun"},{"name":"Domain","_id":"cm0uoc5jh002lk0lz0nxu2trk"},{"name":"DNS","_id":"cm0uoc5jh002qk0lzht24em1j"},{"name":"PHP","_id":"cm0uoc5ji002uk0lz0g7p9zsw"},{"name":"PHP-FPM","_id":"cm0uoc5ji002xk0lzbfzke7n9"},{"name":"Nginx","_id":"cm0uoc5ji0030k0lz1pls8h43"},{"name":"kubernetes","_id":"cm0uoc5jj0038k0lzb8so8b0k"},{"name":"stakater","_id":"cm0uoc5jj0039k0lza5ledl6q"},{"name":"reloader","_id":"cm0uoc5jj003ak0lzdxyg3hlg"},{"name":"opensource","_id":"cm0uoc5jj003bk0lz3dtj0wru"},{"name":"Mac","_id":"cm0uoc5jk003ck0lz1ooggb9d"},{"name":"homebrew","_id":"cm0uoc5jk003fk0lzbtg6bj31"},{"name":"brew","_id":"cm0uoc5jk003ik0lzgox31j9s"},{"name":"HSTS","_id":"cm0uoc5jl003lk0lzddypb6x5"},{"name":"SSL","_id":"cm0uoc5jl003pk0lza3ct219y"},{"name":"HTTPS","_id":"cm0uoc5jl003rk0lz0dic6yyo"},{"name":"Bash","_id":"cm0uoc5jl003tk0lz6hoxgwrx"},{"name":"Auto Completion","_id":"cm0uoc5jm003wk0lz9xcufacp"},{"name":"Bash Completion","_id":"cm0uoc5jm003zk0lz2astdqp4"},{"name":"Linux","_id":"cm0uoc5jm0040k0lz31ijfprp"},{"name":"Cloud NAT","_id":"cm0uoc5jm0044k0lz54je7c50"},{"name":"openssl","_id":"cm0uoc5jn0047k0lz7e906drq"},{"name":"CA","_id":"cm0uoc5jn004ak0lzfyb44c3f"},{"name":"SSL憑證","_id":"cm0uoc5jn004ek0lz05jhe0x2"},{"name":"certificate","_id":"cm0uoc5jo004fk0lz76wv7egd"},{"name":"SHA256","_id":"cm0uoc5jo004gk0lz4iyg50yw"},{"name":"SHA-2","_id":"cm0uoc5jo004hk0lz4ju653wu"},{"name":"FTP","_id":"cm0uoc5jp004ok0lz26mvbzs9"},{"name":"Disqus","_id":"cm0uoc5jr005jk0lz19ff5pg5"},{"name":"htpasswd","_id":"cm0uoc5jw0060k0lz5kek5mx5"},{"name":"MD5","_id":"cm0uoc5jw0063k0lzbc0tbysr"},{"name":"SHA1","_id":"cm0uoc5jw0064k0lzhfp1apj0"},{"name":"Bcrypt","_id":"cm0uoc5jw0065k0lz5uoa4t3j"},{"name":"Apache","_id":"cm0uoc5jx0068k0lzaq8w3k9v"},{"name":"SSH","_id":"cm0uoc5jy006ok0lzckua80a9"},{"name":"fingerprint","_id":"cm0uoc5jy006qk0lzf9ztfu1z"},{"name":"known_hosts","_id":"cm0uoc5jy006rk0lz7fc31gje"},{"name":"TCP","_id":"cm0uoc5jy006sk0lz2r8wdvvh"}]}}